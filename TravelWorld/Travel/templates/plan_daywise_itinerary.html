{% extends 'itinerary_base.html' %}
{% load static %}
{% load booking_tags %}
{% load widget_tweaks %}

{% load custom_tags %}
{% block nav_title %}Build Itinerary{% endblock %}

{% block body %}
<script>
    window.EXISTING_HOTEL_BOOKINGS = [
        {% for day, data in saved_items_by_day.items %}
            {% for booking in data.hotel_bookings %}
                {
                    id: "{{ booking.id }}",  // To ignore self when editing
                    hotelId: "{{ booking.hotel.id|default:'' }}",
                    hotelName: "{{ booking.hotel.name|default:''|escapejs }}",
                    customName: "{{ booking.custom_hotel_name|default:''|escapejs }}",
                    option: "{{ booking.option }}"
                },
            {% endfor %}
        {% endfor %}
    ];
</script>

<script>
    window.EXISTING_HOUSEBOAT_BOOKINGS = [
        {% for day, data in saved_items_by_day.items %}
            {% for booking in data.houseboat_bookings %}
                {
                    id: "{{ booking.id }}",
                    houseboatId: "{{ booking.houseboat.id }}",
                    option: "{{ booking.option }}"
                },
            {% endfor %}
        {% endfor %}
    ];
</script>

<h2 class="mb-4">itinerary Plan Days for: {{ itinerary.name }}</h2>
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        background-color: #f5f7fa;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    .page-wrapper {
        padding: 2rem;
        max-width: 1400px;
        margin: 0 auto;
    }

    .page-header {
        margin-bottom: 2rem;
    }

    .page-header h2 {
        font-size: 1.5rem;
        font-weight: 600;
        color: #212529;
    }

    .days-destinations-box {
        background: white;
        border: 2px solid #d0d0d0;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .days-destinations-box h4 {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 1.5rem;
        color: #212529;
    }

    .days-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 1rem;
    }

    .day-item-wrapper {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .day-item-label {
        font-size: 0.9rem;
        font-weight: 600;
        color: #212529;
    }

    .day-item-select {
        padding: 0.75rem;
        border: 2px solid #ccc;
        border-radius: 6px;
        font-size: 0.9rem;
        background: #f8f9fa;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .day-item-select:hover {
        border-color: #999;
        background: white;
        transform: translateY(-1px);
    }

    .day-item-select:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        background: white;
    }

    /* ===================================== */
    /* THREE COLUMN SECTION - FIXED HEIGHT */
    /* ===================================== */
    .three-column-box {
        background: white;
        border: 2px solid #d0d0d0;
        border-radius: 12px;
        display: grid;
        grid-template-columns: 220px 1fr 320px;
        gap: 0;
        overflow: hidden; /* Prevent page scroll */
        
        /* ðŸ”¥ KEY FIX: Height constraint to force internal scrolling */
        height: calc(100vh - 150px);
        min-height: 500px;
        
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    /* ===================================== */
    /* LEFT COLUMN - DAYS LIST */
    /* ===================================== */
    .days-list-column {
        background: #f0f4ff;
        border-right: 2px solid #d0d0d0;
        padding: 0;
        
        /* ðŸ”¥ Allow internal scrolling */
        overflow-y: auto;
        height: 100%;
        
        scrollbar-width: thin;
        scrollbar-color: #c8d8f0 transparent;
    }

    .days-list-column::-webkit-scrollbar {
        width: 6px;
    }

    .days-list-column::-webkit-scrollbar-track {
        background: transparent;
    }

    .days-list-column::-webkit-scrollbar-thumb {
        background: #c8d8f0;
        border-radius: 3px;
    }

    .days-list-column h5 {
        padding: 1.2rem 1.5rem;
        margin: 0;
        font-size: 1rem;
        font-weight: 700;
        color: #2d2d2d;
        background: #dceaff;
        border-bottom: 2px solid #c8d8f0;
        position: sticky;
        top: 0;
        z-index: 5;
    }

    .day-list-item {
        padding: 1rem 1.5rem;
        cursor: pointer;
        font-size: 0.95rem;
        color: #3a3a3a;
        border-bottom: 1px solid #d8dee6;
        border-left: 4px solid transparent;
        transition: all 0.2s ease-in-out;
        background: transparent;
        display: block;
    }

    /* âœ… Remove link styling for day-list-item links */
    a.day-list-item {
        text-decoration: none;
        color: #3a3a3a;
    }

    a.day-list-item:hover {
        text-decoration: none;
        color: #3a3a3a;
    }

    a.day-list-item:focus {
        text-decoration: none;
        color: #3a3a3a;
        outline: none;
    }

    .day-list-item:hover {
        background: #e3edff;
        border-left-color: #667eea;
    }

    .day-list-item.active {
        background: #ffffff;
        font-weight: 700;
        border-left-color: #667eea;
        color: #1f1f1f;
        box-shadow: inset 0 0 8px rgba(102, 126, 234, 0.1);
    }

    .day-number {
        font-weight: 700;
        margin-bottom: 0.25rem;
    }

    .day-destination {
        font-size: 0.85rem;
        color: #666;
    }

    .day-list-item.active .day-destination {
        color: #667eea;
    }

    .day-list-item.custom-terms-link {
        margin-top: 1.5rem;
        border-top: 2px solid #c8d8f0;
        padding-top: 0.5rem;
        background: linear-gradient(135deg, #f0f4ff 0%, #e3edff 100%);
        border-left-color: #667eea;
    }

    .day-list-item.custom-terms-link:hover {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-left-color: #5568d3;
        transform: translateX(3px);
    }

    .day-list-item.custom-terms-link .day-number {
        color: #2d2d2d;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 700;
    }

    .day-list-item.custom-terms-link .day-number i {
        font-size: 0.95rem;
        color: #667eea;
    }

    .day-list-item.custom-terms-link .day-destination {
        color: #667eea;
    }

    .day-list-item.custom-terms-link:hover .day-number {
        color: #ffffff;
    }

    .day-list-item.custom-terms-link:hover .day-number i {
        color: #ffffff;
    }

    .day-list-item.custom-terms-link:hover .day-destination {
        color: rgba(255, 255, 255, 0.9);
    }

    /* ===================================== */
    /* MIDDLE COLUMN - CONTENT */
    /* ===================================== */
    .content-column {
        border-right: 2px solid #d0d0d0;
        padding: 0;
        
        /* ðŸ”¥ Allow internal scrolling */
        overflow-y: auto;
        height: 100%;
        
        scrollbar-width: thin;
        scrollbar-color: #ddd transparent;
    }

    .content-column::-webkit-scrollbar {
        width: 8px;
    }

    .content-column::-webkit-scrollbar-thumb {
        background: #ddd;
        border-radius: 4px;
    }

    /* DAY HEADER (STICKY inside scroll area) */
    .day-content-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1.25rem 1.5rem;
        border-bottom: 3px solid #5568d3;
        
        /* ðŸ”¥ Sticky header */
        position: sticky;
        top: 0;
        z-index: 10;
        
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .day-header-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 1rem;
        flex-wrap: wrap;
    }

    .day-header-left h4 {
        font-size: 1.3rem;
        font-weight: 700;
        margin: 0 0 0.25rem 0;
        color: white;
    }

    .day-header-left p {
        margin: 0;
        font-size: 0.9rem;
        opacity: 0.95;
    }

    .day-header-right {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        align-items: center;
    }

    /* BULK DELETE BUTTON */
    .btn-smart-delete {
        padding: 0.5rem 1rem;
        font-size: 0.85rem;
        font-weight: 600;
        border: 2px solid rgba(255,255,255,0.3);
        background: rgba(255,255,255,0.15);
        color: white;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        white-space: nowrap;
        text-decoration: none;
    }

    .btn-smart-delete:hover {
        background: rgba(255,255,255,0.25);
        border-color: rgba(255,255,255,0.5);
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        color: white;
    }

    .btn-smart-delete:active {
        transform: translateY(0);
    }

    .btn-smart-delete i {
        font-size: 0.9rem;
    }

    /* CONTENT BODY */
    .day-content-body {
        padding: 1.5rem;
        background: #fafbfc;
    }

    .section-group {
        margin-bottom: 1.5rem;
    }

    .section-group-title {
        font-size: 0.85rem;
        font-weight: 700;
        color: #667eea;
        margin-bottom: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .item-list {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .item-card {
        background: white;
        padding: 1rem;
        border-radius: 8px;
        border: 1px solid #e0e0e0;
        font-size: 0.9rem;
        transition: all 0.2s ease;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }

    .item-card:hover {
        border-color: #667eea;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.1);
        transform: translateY(-2px);
    }

    .empty-content {
        text-align: center;
        padding: 3rem 2rem;
        color: #999;
    }

    .empty-icon {
        font-size: 3rem;
        opacity: 0.3;
        margin-bottom: 1rem;
    }

    /* ===================================== */
    /* RIGHT COLUMN - ADD ITEMS */
    /* ===================================== */
    .add-items-column {
        padding: 1.5rem;
        
        /* ðŸ”¥ Allow internal scrolling */
        overflow-y: auto;
        height: 100%;
        
        background: #f9fafb;
        scrollbar-width: thin;
    }

    .add-items-column::-webkit-scrollbar {
        width: 6px;
    }

    .add-items-column::-webkit-scrollbar-thumb {
        background: #ddd;
        border-radius: 3px;
    }

    .add-items-title {
        font-size: 1rem;
        font-weight: 700;
        color: #212529;
        margin-bottom: 1rem;
    }

    .section-selector-box {
        margin-bottom: 1.5rem;
    }

    .section-selector-box label {
        display: block;
        font-size: 0.9rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: #212529;
    }

    .section-selector-box select {
        width: 100%;
        padding: 0.75rem;
        border: 2px solid #ccc;
        border-radius: 6px;
        font-size: 0.9rem;
        background: white;
        cursor: pointer;
        transition: all 0.2s;
    }

    .section-selector-box select:hover {
        border-color: #999;
    }

    .section-selector-box select:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .available-items-box {
        background: white;
        padding: 1rem;
        border-radius: 8px;
        border: 1px solid #e0e0e0;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .available-items-box h6 {
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-weight: 700;
    }


    /* For large screens - modals slide in from right */
    @media (min-width: 992px) {
        .modal.modal-right .modal-dialog {
            position: fixed;
            margin: 0;
            width: 500px;
            max-width: 90%;
            height: 100%;
            right: 0;
            top: 0;
            transform: translate3d(100%, 0, 0);
            transition: transform 0.3s ease-out;
        }

        .modal.modal-right.show .modal-dialog {
            transform: translate3d(0, 0, 0);
        }

        .modal.modal-right .modal-content {
            height: 100%;
            overflow-y: auto;
            border-radius: 0;
            border: none;
            box-shadow: -2px 0 10px rgba(0,0,0,0.2);
        }

        .modal.modal-right .modal-body {
            max-height: calc(100vh - 180px);
            overflow-y: auto;
        }

        /* Keep background visible with semi-transparent backdrop */
        .modal.modal-right + .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.3);
        }

        /* Wider modal for hotel/houseboat booking (more fields) */
        .modal.modal-right.modal-wide .modal-dialog {
            width: 650px;
            max-width: 95%;
        }

        /* Extra wide for very complex forms */
        .modal.modal-right.modal-extra-wide .modal-dialog {
            width: 800px;
            max-width: 95%;
        }
    }

    /* For smaller screens - keep centered */
    @media (max-width: 991px) {
        .modal.modal-right .modal-dialog {
            margin: 1.75rem auto;
        }
    }

    /* ===================================== */
    /* RESPONSIVE DESIGN */
    /* ===================================== */
    @media (max-width: 1400px) {
        .three-column-box {
            grid-template-columns: 200px 1fr 280px;
        }
    }

    @media (max-width: 1200px) {
        .three-column-box {
            grid-template-columns: 180px 1fr 260px;
        }
    }

    @media (max-width: 992px) {
        .page-wrapper {
            padding: 1rem;
        }

        .three-column-box {
            grid-template-columns: 1fr;
            /* Reset height for mobile to allow natural scrolling */
            height: auto;
            min-height: auto;
            overflow: visible;
        }

        .days-list-column {
            border-right: none;
            border-bottom: 2px solid #d0d0d0;
            max-height: 200px;
            overflow-x: auto;
            overflow-y: hidden;
            display: flex;
            gap: 0.5rem;
            padding: 1rem;
        }

        .days-list-column h5 {
            display: none;
        }

        .day-list-item {
            padding: 0.75rem 1.25rem;
            white-space: nowrap;
            border-bottom: 4px solid transparent;
            border-left: none;
            min-width: 120px;
            border-radius: 8px 8px 0 0;
        }

        .day-list-item.active {
            border-bottom-color: #667eea;
        }

        /* Custom terms button responsive */
        .day-list-item.custom-terms-link {
            margin-top: 0;
            margin-left: 0.5rem;
            border-top: none;
            border-bottom: 4px solid #ff9800;
        }

        .content-column {
            border-right: none;
            border-bottom: 2px solid #d0d0d0;
            height: auto; /* Allow growth on mobile */
            overflow-y: visible;
        }

        .day-header-row {
            flex-direction: column;
            align-items: flex-start;
        }

        .day-header-right {
            width: 100%;
            justify-content: flex-start;
        }

        .add-items-column {
            max-height: 500px;
            height: auto;
            overflow-y: visible;
        }
    }

    @media (max-width: 576px) {
        .days-grid {
            grid-template-columns: repeat(2, 1fr);
        }

        .day-list-item {
            min-width: 100px;
            padding: 0.6rem 1rem;
            font-size: 0.85rem;
        }

        .btn-smart-delete span {
            display: none;
        }

        .btn-smart-delete {
            padding: 0.5rem;
        }
    }

    /* ===================================== */
    /* UTILITY CLASSES */
    /* ===================================== */
    .fw-semibold {
        font-weight: 600;
    }

    .fw-bold {
        font-weight: 700;
    }

    .text-muted {
        color: #6c757d !important;
    }

    .badge {
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .bg-success {
        background-color: #28a745 !important;
        color: white;
    }

    .bg-danger {
        background-color: #dc3545 !important;
        color: white;
    }

    .bg-warning {
        background-color: #ffc107 !important;
        color: #212529;
    }

    .bg-info {
        background-color: #17a2b8 !important;
        color: white;
    }

    .bg-primary {
        background-color: #007bff !important;
        color: white;
    }

    .bg-secondary {
        background-color: #6c757d !important;
        color: white;
    }

    /* ===================================== */
    /* SMOOTH ANIMATIONS */
    /* ===================================== */
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .item-card {
        animation: fadeIn 0.3s ease-out;
    }

    /* Print Styles */
    @media print {
        .add-items-column,
        .days-list-column,
        .day-header-right,
        .btn-group,
        .btn-group-vertical {
            display: none !important;
        }

        .three-column-box {
            grid-template-columns: 1fr;
            height: auto;
            overflow: visible;
        }

        .content-column {
            border: none;
            height: auto;
            overflow: visible;
        }
    }

    /* PACKAGE TERMS MODAL STYLES */

    .bg-gradient-purple {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .modal-extra-wide .modal-dialog {
        max-width: 900px;
    }

    .nav-tabs .nav-link {
        color: #667eea;
        font-weight: 600;
    }

    .nav-tabs .nav-link.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-color: #667eea;
    }

    .nav-tabs .nav-link:hover {
        color: #5568d3;
    }

    .ckeditor-field {
        width: 100%;
        min-height: 200px;
    }

    #termsAlertContainer .alert {
        margin-bottom: 1rem;
    }

    .form-label.fw-bold {
        font-size: 0.95rem;
        color: #333;
    }

    /* Loading state for save button */
    .btn-loading {
        position: relative;
        pointer-events: none;
        opacity: 0.7;
    }

    .btn-loading::after {
        content: "";
        position: absolute;
        width: 16px;
        height: 16px;
        top: 50%;
        left: 50%;
        margin-left: -8px;
        margin-top: -8px;
        border: 2px solid #ffffff;
        border-radius: 50%;
        border-top-color: transparent;
        animation: spinner 0.6s linear infinite;
    }

    @keyframes spinner {
        to {transform: rotate(360deg);}
    }

        /* Search Styles */
    .search-container {
        margin-bottom: 1.5rem;
        position: relative;
    }

    .search-input-wrapper {
        position: relative;
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }

    .search-box {
        flex-grow: 1;
        padding: 0.75rem 1rem 0.75rem 2.5rem;
        border: 2px solid #ddd;
        border-radius: 6px;
        font-size: 0.9rem;
        transition: all 0.2s;
    }

    .search-box:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        background: white;
    }

    .search-icon {
        position: absolute;
        left: 0.75rem;
        color: #999;
        pointer-events: none;
    }

    .clear-search-btn {
        padding: 0.5rem 0.75rem;
        border: 1px solid #ddd;
        background: white;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
        display: none;
    }

    .clear-search-btn:hover {
        background: #f5f5f5;
        border-color: #999;
    }

    .clear-search-btn.show {
        display: block;
    }

    /* Results counter */
    .search-results-info {
        font-size: 0.85rem;
        color: #666;
        margin-top: 0.5rem;
        padding-left: 0.5rem;
    }

    .search-results-info.no-results {
        color: #dc3545;
    }

    /* Item visibility */
    .item-card.hidden-by-search {
        display: none;
    }

    .item-card.visible-by-search {
        animation: fadeIn 0.2s ease-in;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(-5px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* No results message */
    .no-results-message {
        text-align: center;
        padding: 2rem;
        color: #999;
        display: none;
    }

    .no-results-message.show {
        display: block;
    }

    .no-results-message i {
        font-size: 3rem;
        opacity: 0.3;
        margin-bottom: 1rem;
        display: block;
    }
    /* Make modal taller and content scrollable */
    .edit-day-modal .modal-content {
        max-height: 90vh;
    }

    .edit-day-modal .modal-body {
        max-height: 70vh;
        overflow-y: auto;
    }

    /* Smooth scrolling */
    .edit-day-modal .modal-body {
        scrollbar-width: thin;
        scrollbar-color: #ccc #f5f5f5;
    }

    .edit-day-modal .modal-body::-webkit-scrollbar {
        width: 8px;
    }

    .edit-day-modal .modal-body::-webkit-scrollbar-track {
        background: #f5f5f5;
    }

    .edit-day-modal .modal-body::-webkit-scrollbar-thumb {
        background: #ccc;
        border-radius: 4px;
    }

    .edit-day-modal .modal-body::-webkit-scrollbar-thumb:hover {
        background: #999;
    }
    /* Custom Toggle Switch */
    .custom-toggle {
        position: relative;
        display: inline-block;
        width: 60px;
        height: 30px;
    }

    .custom-toggle input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #dc3545;
        transition: 0.4s;
        border-radius: 30px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    .slider:before {
        position: absolute;
        content: "";
        height: 22px;
        width: 22px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: 0.4s;
        border-radius: 50%;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .custom-toggle input:checked + .slider {
        background-color: #28a745;
    }

    .custom-toggle input:checked + .slider:before {
        transform: translateX(30px);
    }

    .custom-toggle input:focus + .slider {
        box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.25);
    }

    .slider:hover {
        opacity: 0.9;
    }

    /* Active status colors */
    .text-status-active {
        color: #28a745;
    }

    .text-status-inactive {
        color: #dc3545;
    }

    /* Modal gradient header */
    .bg-gradient-purple {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }


    /* ========================================= */
/* ðŸŽ¨ HOTEL OPTION COLOR THEMES (Simple & Decent) */
/* ========================================= */

/* 1. Standard (Clean Grey/Blue) */
.style-standard {
    background-color: #f8f9fa !important; /* Very light grey */
    border-left: 5px solid #6c757d !important; /* Grey border */
}

/* 2. Deluxe (Fresh Mint/Teal) */
.style-deluxe {
    background-color: #e6fffa !important; /* Light mint */
    border-left: 5px solid #319795 !important; /* Teal border */
}

/* 3. Premium (Royal Lavender) */
.style-premium {
    background-color: #f3e8ff !important; /* Light lavender */
    border-left: 5px solid #805ad5 !important; /* Purple border */
}

/* 4. Luxury (Rich Gold/Cream) */
.style-luxury {
    background-color: #fffaf0 !important; /* Warm cream */
    border-left: 5px solid #dd6b20 !important; /* Orange/Gold border */
}
</style>





<!-- DAYS & DESTINATIONS SECTION -->
{% if can_manage_destinations %}
<div class="days-destinations-box">
    <h4><i class="fas fa-map-marked-alt me-2"></i>Days & Destinations</h4>
    <div class="days-grid">
        {% for day in days %}
        <form method="post" class="day-form">
            {% csrf_token %}
            <input type="hidden" name="form_type" value="destination_select">
            <input type="hidden" name="day_number" value="{{ day }}">

            <div class="day-item-wrapper">
                <label class="day-item-label">Day {{ day }}:</label>
                <select name="destination" class="auto-save-destination day-item-select" id="destination-day-{{ day }}" required>
                    <option value="">-- Select --</option>
                    {% for dest in destinations %}
                        <option value="{{ dest.id }}"
                                {# âœ… FIXED: Use saved_items_by_day instead of plans #}
                                {% for saved_day, day_data in saved_items_by_day.items %}
                                    {% if saved_day == day and day_data.destination and day_data.destination.id == dest.id %}
                                        selected
                                    {% endif %}
                                {% endfor %}>
                            {{ dest.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
        </form>
        {% endfor %}
    </div>
</div>
{% endif %}





<!-- THREE COLUMN LAYOUT -->
<div class="three-column-box">

    <!-- LEFT COLUMN: DAYS NAVIGATION -->
<div class="days-list-column">
    <h5><i class="fas fa-calendar-alt me-2"></i>Days</h5>

    {% for day in days %}
        {% with day_plan=plans|get_item:day %}
        <div class="day-list-item {% if day == context_day_number %}active{% endif %}"
             data-day="{{ day }}"
             onclick="selectDay({{ day }})"
             role="button"
             tabindex="0">
            <div class="day-number">Day {{ day }}</div>
            {% if day_plan and day_plan.destination %}
                <div class="day-destination">
                    <i class="fas fa-map-marker-alt me-1"></i>{{ day_plan.destination.name }}
                </div>
            {% else %}
                <div class="day-destination text-muted">
                    <i class="fas fa-question-circle me-1"></i>No destination
                </div>
            {% endif %}
        </div>
        {% endwith %}
    {% endfor %}

     <!-- âœ… CUSTOM TERMS - MODAL TRIGGER -->
    {% if user_type == 'superuser' or current_user.role == 'admin' or current_user.role == 'manager' %}
        <a href="#"
           class="day-list-item custom-terms-link"
           role="button"
           tabindex="0"
           data-bs-toggle="modal"
           data-bs-target="#packageTermsModal"
           onclick="loadPackageTerms({{ itinerary.id }})">
            <div class="day-number">
                <i class="fas fa-file-contract"></i>
                <span>Package Terms</span>
            </div>
            <div class="day-destination">
                <i class="fas fa-cog me-1"></i>Customize terms
            </div>
        </a>
    {% endif %}

</div>



    <!-- CENTER COLUMN: DAY CONTENT -->
    <div class="content-column">
        {% if context_day_number %}
            {% for day in days %}
                <div class="day-content" id="day-content-{{ day }}"
                     style="{% if day != context_day_number %}display: none;{% endif %}">

                    {% with day_data=saved_items_by_day|get_item:day %}

                        <!-- DAY HEADER -->
                        <div class="day-content-header">
                            <div class="day-header-row">
                                <div class="day-header-left">
                                    <h4>
                                        <i class="fas fa-calendar-day me-2"></i>Day {{ day }}
                                    </h4>
                                    {% if day_data.destination %}
                                        <p>
                                            <i class="fas fa-map-marker-alt me-1"></i>{{ day_data.destination }}
                                        </p>
                                    {% else %}
                                        <p>
                                            <i class="fas fa-exclamation-triangle me-1"></i>No destination selected
                                        </p>
                                    {% endif %}
                                </div>

                                <!-- âœ… BULK DELETE DROPDOWN - WITH BOTH OPTIONS -->
                                <div class="day-header-right">
                                    {% if total_counts.day_plans > 0 or total_counts.hotels > 0 or total_counts.activities > 0 or total_counts.houseboats > 0 or total_counts.vehicles > 0 %}
                                    <div class="dropdown">
                                        <button class="btn-smart-delete dropdown-toggle"
                                                type="button"
                                                id="bulkDeleteDropdown{{ day }}"
                                                data-bs-toggle="dropdown"
                                                aria-expanded="false">
                                            <i class="fas fa-trash-alt"></i>
                                            <span>Bulk Delete</span>
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="bulkDeleteDropdown{{ day }}">

                                            <!-- âœ… DIRECT DELETE OPTIONS (FAST) -->
                                            {% if total_counts.day_plans > 0 %}
                                            <li>
                                                <form method="post" onsubmit="return confirm('âš ï¸ Delete ALL {{ total_counts.day_plans }} day plans from ALL days?');" style="margin: 0;">
                                                    {% csrf_token %}
                                                    <input type="hidden" name="form_type" value="bulk_delete_all_day_plans">
                                                    <button type="submit" class="dropdown-item text-danger">
                                                        <i class="fas fa-fire me-2"></i>
                                                        ðŸ”¥ Delete ALL Day Plans ({{ total_counts.day_plans }})
                                                    </button>
                                                </form>
                                            </li>
                                            {% endif %}

                                            {% if total_counts.hotels > 0 %}
                                            <li>
                                                <form method="post" onsubmit="return confirm('âš ï¸ Delete ALL {{ total_counts.hotels }} hotels from ALL days?');" style="margin: 0;">
                                                    {% csrf_token %}
                                                    <input type="hidden" name="form_type" value="bulk_delete_all_hotels">
                                                    <button type="submit" class="dropdown-item text-danger">
                                                        <i class="fas fa-fire me-2"></i>
                                                        ðŸ”¥ Delete ALL Hotels ({{ total_counts.hotels }})
                                                    </button>
                                                </form>
                                            </li>
                                            {% endif %}

                                            {% if total_counts.activities > 0 %}
                                            <li>
                                                <form method="post" onsubmit="return confirm('âš ï¸ Delete ALL {{ total_counts.activities }} activities?');" style="margin: 0;">
                                                    {% csrf_token %}
                                                    <input type="hidden" name="form_type" value="bulk_delete_all_activities">
                                                    <button type="submit" class="dropdown-item text-danger">
                                                        <i class="fas fa-fire me-2"></i>
                                                        ðŸ”¥ Delete ALL Activities ({{ total_counts.activities }})
                                                    </button>
                                                </form>
                                            </li>
                                            {% endif %}

                                            {% if total_counts.houseboats > 0 %}
                                            <li>
                                                <form method="post" onsubmit="return confirm('âš ï¸ Delete ALL {{ total_counts.houseboats }} houseboats?');" style="margin: 0;">
                                                    {% csrf_token %}
                                                    <input type="hidden" name="form_type" value="bulk_delete_all_houseboats">
                                                    <button type="submit" class="dropdown-item text-danger">
                                                        <i class="fas fa-fire me-2"></i>
                                                        ðŸ”¥ Delete ALL Houseboats ({{ total_counts.houseboats }})
                                                    </button>
                                                </form>
                                            </li>
                                            {% endif %}

                                            {% if total_counts.vehicles > 0 %}
                                            <li>
                                                <form method="post" onsubmit="return confirm('âš ï¸ Delete ALL {{ total_counts.vehicles }} vehicles?');" style="margin: 0;">
                                                    {% csrf_token %}
                                                    <input type="hidden" name="form_type" value="bulk_delete_all_vehicles">
                                                    <button type="submit" class="dropdown-item text-danger">
                                                        <i class="fas fa-fire me-2"></i>
                                                        ðŸ”¥ Delete ALL Vehicles ({{ total_counts.vehicles }})
                                                    </button>
                                                </form>
                                            </li>
                                            {% endif %}

                                            <!-- âœ… DIVIDER -->
                                            <li><hr class="dropdown-divider"></li>

                                            <!-- âœ… SELECTIVE DELETE OPTIONS (WITH MODAL) -->
                                            {% if total_counts.hotels > 0 %}
                                            <li>
                                                <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#bulkDeleteHotelsModal">
                                                    <i class="fas fa-check-square me-2 text-primary"></i>
                                                    Choose Specific Hotels...
                                                </a>
                                            </li>
                                            {% endif %}

                                            {% if total_counts.activities > 0 %}
                                            <li>
                                                <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#bulkDeleteActivitiesModal">
                                                    <i class="fas fa-check-square me-2 text-warning"></i>
                                                    Choose Specific Activities...
                                                </a>
                                            </li>
                                            {% endif %}

                                            {% if total_counts.houseboats > 0 %}
                                            <li>
                                                <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#bulkDeleteHouseboatsModal">
                                                    <i class="fas fa-check-square me-2 text-info"></i>
                                                    Choose Specific Houseboats...
                                                </a>
                                            </li>
                                            {% endif %}

                                            {% if total_counts.vehicles > 0 %}
                                            <li>
                                                <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#bulkDeleteVehiclesModal">
                                                    <i class="fas fa-check-square me-2 text-secondary"></i>
                                                    Choose Specific Vehicles...
                                                </a>
                                            </li>
                                            {% endif %}

                                        </ul>
                                    </div>
                                    {% endif %}
                                </div>

                            </div>
                        </div>


                        <!-- CONTENT BODY -->
                        <div class="day-content-body">
                            <!-- DAY ITINERARY SECTION -->
                            {% if day_data.day_plan and day_data.day_plan.title %}
                                <div class="section-group">
                                    <div class="section-group-title">
                                        <i class="fas fa-route me-2"></i>Day Itinerary
                                    </div>
                                    <div class="item-card">
                                        <div class="d-flex justify-content-between align-items-start gap-2">
                                            <div class="flex-grow-1">
                                                <strong class="d-block mb-1">{{ day_data.day_plan.title }}</strong>
                                                {% if day_data.day_plan.description %}
                                                    <p class="mb-0 text-muted small">{{ day_data.day_plan.description }}</p>
                                                {% endif %}
                                            </div>

                                            {% if day_data.day_plan.image %}
                                                <img src="{{ day_data.day_plan.image.url }}"
                                                    alt="{{ day_data.day_plan.title }}"
                                                    class="rounded me-2"
                                                    style="width:60px;height:60px;object-fit:cover;">
                                            {% endif %}

                                            <div class="btn-group-vertical" role="group">


                                                {# EDIT button â€“ opens edit modal, but backend will NOT touch master template itinerary #}
                                                <button type="button"
                                                        class="btn btn-sm btn-outline-secondary"
                                                        data-bs-toggle="modal"
                                                        data-bs-target="#editDayDisplayModal"
                                                        onclick="openEditDayDisplay(
                                                            '{{ day }}',
                                                            '{{ day_data.day_plan.title|escapejs }}',
                                                            '{{ day_data.day_plan.description|escapejs }}'
                                                        )"
                                                        title="Edit text for this day only">
                                                    <i class="fas fa-edit"></i>
                                                </button>

                                                {# DELETE button â€“ clears title/description/image only for this day #}
                                                <form method="post"
                                                    style="display:inline;margin:0;"
                                                    onsubmit="return confirm('âš ï¸ Remove Day Itinerary?\n\nâœ… Destination ({{ day_data.destination }}) will remain\nâœ… All bookings will be preserved\n\nOnly the itinerary title/description/image for this day will be removed.\n\nContinue?')">
                                                    {% csrf_token %}
                                                    <input type="hidden" name="form_type" value="delete_day_itinerary">
                                                    <input type="hidden" name="day_number" value="{{ day }}">
                                                    <button type="submit"
                                                            class="btn btn-sm btn-outline-danger w-100"
                                                            title="Delete Day Itinerary Only">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endif %}



                            <!-- SAVED ITEMS SECTION -->
                            <div class="section-group">
                                <div class="section-group-title">
                                    <i class="fas fa-bookmark me-2"></i>Saved Items
                                </div>
                                <div class="item-list">
                                    {% if day_data.hotel_bookings %}
                                        {% for booking in day_data.hotel_bookings %}
                                            
                                            <div class="item-card mb-2
                                                {% if booking.option == 'option_1' %}style-standard
                                                {% elif booking.option == 'option_2' %}style-deluxe
                                                {% elif booking.option == 'option_3' %}style-premium
                                                {% elif booking.option == 'option_4' %}style-luxury
                                                {% endif %}">
                                                
                                                <div class="d-flex justify-content-between align-items-start gap-2">
                                                    <div class="flex-grow-1">
                                                        
                                                        <div class="fw-bold text-dark mb-1 d-flex align-items-center flex-wrap">
                                                            <i class="fas fa-hotel me-2"></i>
                                                            {% if booking.hotel %}
                                                                {{ booking.hotel.name }}
                                                            {% else %}
                                                                {{ booking.custom_hotel_name }}
                                                                <span class="badge bg-warning text-dark ms-1" style="font-size: 0.7em;">Demo</span>
                                                            {% endif %}
                                                            
                                                            <span class="badge bg-white text-dark border ms-2 shadow-sm" 
                                                                style="font-size: 0.75em; font-weight: 600;">
                                                                {{ booking.get_option_display }}
                                                            </span>
                                                        </div>

                                                        <small class="text-muted d-block mb-1">
                                                            <i class="fas fa-bed me-1"></i>
                                                            {% if booking.room_type %}
                                                                {{ booking.room_type.name }}
                                                            {% elif booking.custom_room_type %}
                                                                {{ booking.custom_room_type }}
                                                                <span class="badge bg-warning text-dark ms-1" style="font-size: 0.65em;">Manual</span>
                                                            {% else %}
                                                                <em>No room type</em>
                                                            {% endif %}
                                                                â€¢ 
                                                            <i class="fas fa-utensils me-1"></i>{{ booking.meal_plan.name }}
                                                        </small>

                                                        <small class="d-block mb-1">
                                                            <span class="text-success fw-semibold">
                                                                <i class="fas fa-sign-in-alt me-1"></i>In: {{ booking.check_in_date|date:"d M" }}
                                                            </span>
                                                            <span class="text-danger fw-semibold ms-2">
                                                                <i class="fas fa-sign-out-alt me-1"></i>Out: {{ booking.check_out_date|date:"d M" }}
                                                            </span>
                                                        </small>

                                                        <div class="mb-1">
                                                            <span class="badge bg-white text-dark border">
                                                                {{ booking.num_double_beds }} Room(s)
                                                            </span>
                                                            {% if booking.extra_beds > 0 %}
                                                                <span class="badge bg-white text-dark border">+ {{ booking.extra_beds }} Extra Bed</span>
                                                            {% endif %}
                                                            {% if booking.child_with_bed > 0 %}
                                                                <span class="badge bg-white text-dark border">+ {{ booking.child_with_bed }} CWB</span>
                                                            {% endif %}
                                                            {% if booking.child_without_bed > 0 %}
                                                                <span class="badge bg-white text-dark border">+ {{ booking.child_without_bed }} CNB</span>
                                                            {% endif %}
                                                        </div>

                                                        {% if booking.inclusion_items.count > 0 %}
                                                            <small class="text-muted d-block mt-2 pt-2 border-top border-secondary">
                                                                <i class="fas fa-star text-warning me-1"></i>
                                                                <strong>Inclusions:</strong>
                                                                {% for item in booking.inclusion_items.all %}
                                                                    <span class="badge bg-white text-dark border">
                                                                        {{ item.special_inclusion.name }} ({{ item.num_adults }}A)
                                                                    </span>
                                                                {% endfor %}
                                                            </small>
                                                        {% endif %}
                                                    </div>

                                                    <div class="btn-group-vertical" role="group" style="min-width: 60px;">
                                                        <button type="button"
                                                                class="btn btn-sm btn-light border"
                                                                data-booking-id="{{ booking.id }}"
                                                                data-item-type="hotel"
                                                                
                                                                data-is-demo="{% if booking.hotel %}false{% else %}true{% endif %}"
                                                                data-custom-hotel-name="{{ booking.custom_hotel_name|default:'' }}"
                                                                
                                                                data-hotel-id="{{ booking.hotel.id|default:'' }}"
                                                                data-hotel-name="{{ booking.hotel.name|default:'' }}"
                                                                data-destination-id="{{ booking.destination.id }}"
                                                                data-destination-name="{{ booking.destination.name }}"
                                                                data-day-number="{{ day }}"
                                                                data-category="{{ booking.category }}"
                                                                
                                                                data-room-type-id="{{ booking.room_type.id|default:'' }}"
                                                                data-custom-room-type="{{ booking.custom_room_type|default:'' }}"
                                                                
                                                                data-meal-plan-id="{{ booking.meal_plan.id }}"
                                                                data-option="{{ booking.option }}"
                                                                data-num-double-beds="{{ booking.num_double_beds }}"
                                                                data-child-with-bed="{{ booking.child_with_bed }}"
                                                                data-child-without-bed="{{ booking.child_without_bed }}"
                                                                data-extra-beds="{{ booking.extra_beds }}"
                                                                data-check-in="{{ booking.check_in_date|date:'Y-m-d' }}"
                                                                data-check-in-time="{% if booking.check_in_time %}{{ booking.check_in_time|time:'H:i' }}{% else %}14:00{% endif %}"
                                                                data-check-out="{{ booking.check_out_date|date:'Y-m-d' }}"
                                                                data-check-out-time="{% if booking.check_out_time %}{{ booking.check_out_time|time:'H:i' }}{% else %}11:00{% endif %}"
                                                                onclick="editHotelBooking({{ booking.id }}, true)"
                                                                title="Edit Hotel Booking">
                                                            <i class="fas fa-edit text-primary"></i>
                                                        </button>
                                                        <form method="post"
                                                            action="{% url 'delete_hotel_booking' booking.id %}"
                                                            onsubmit="return confirm('Delete this hotel booking?\n\nHotel: {{ booking.hotel.name }}\nCheck-in: {{ booking.check_in_date|date:'M d, Y' }}\n\nThis cannot be undone!');"
                                                            class="m-0">
                                                            {% csrf_token %}
                                                            <button type="submit" class="btn btn-sm btn-light border text-danger w-100" title="Delete Hotel Booking">
                                                                <i class="fas fa-trash"></i>
                                                            </button>
                                                        </form>
                                                    </div>
                                                </div>
                                            </div>
                                        {% endfor %}
                                    {% endif %}


                                  {% if day_data.houseboat_bookings %}
    {% for booking in day_data.houseboat_bookings %}
        
        <div class="item-card mb-2
            {% if booking.option == 'option1' or booking.option == 'option_1' %}style-standard
            {% elif booking.option == 'option2' or booking.option == 'option_2' %}style-deluxe
            {% elif booking.option == 'option3' or booking.option == 'option_3' %}style-premium
            {% elif booking.option == 'option4' or booking.option == 'option_4' %}style-luxury
            {% endif %}">
            
            <div class="d-flex justify-content-between align-items-start gap-2">
                <div class="flex-grow-1">
                    
                    <div class="fw-bold text-dark mb-1 d-flex align-items-center flex-wrap">
                        <i class="fas fa-ship me-2 text-info"></i>{{ booking.houseboat.name }}
                        
                        <span class="badge bg-white text-dark border ms-2 shadow-sm" 
                              style="font-size: 0.75em; font-weight: 600;">
                            {{ booking.get_option_display }}
                        </span>
                    </div>

                    <small class="text-muted d-block mb-1">
                        <i class="fas fa-bed me-1"></i>{{ booking.room_type.name }} â€¢
                        <i class="fas fa-utensils me-1"></i>{{ booking.meal_plan.name }}
                    </small>

                    <small class="d-block mb-1">
                        <span class="text-success fw-semibold">
                            <i class="fas fa-sign-in-alt me-1"></i>In: {{ booking.check_in_date|date:"d M" }}
                        </span>
                        <span class="text-danger fw-semibold ms-2">
                            <i class="fas fa-sign-out-alt me-1"></i>Out: {{ booking.check_out_date|date:"d M" }}
                        </span>
                    </small>

                    <div class="mb-1">
                        {% if booking.num_one_bed_rooms > 0 %}
                            <span class="badge bg-white text-dark border">{{ booking.num_one_bed_rooms }} x 1-Bed</span>
                        {% endif %}
                        {% if booking.num_two_bed_rooms > 0 %}
                            <span class="badge bg-white text-dark border">{{ booking.num_two_bed_rooms }} x 2-Bed</span>
                        {% endif %}
                        {% if booking.num_three_bed_rooms > 0 %}
                            <span class="badge bg-white text-dark border">{{ booking.num_three_bed_rooms }} x 3-Bed</span>
                        {% endif %}
                        {% if booking.num_four_bed_rooms > 0 %}
                            <span class="badge bg-white text-dark border">{{ booking.num_four_bed_rooms }} x 4-Bed</span>
                        {% endif %}
                        {% if booking.num_five_bed_rooms > 0 %}
                            <span class="badge bg-white text-dark border">{{ booking.num_five_bed_rooms }} x 5-Bed</span>
                        {% endif %}
                        {% if booking.num_six_bed_rooms > 0 %}
                            <span class="badge bg-white text-dark border">{{ booking.num_six_bed_rooms }} x 6-Bed</span>
                        {% endif %}
                        {% if booking.num_seven_bed_rooms > 0 %}
                            <span class="badge bg-white text-dark border">{{ booking.num_seven_bed_rooms }} x 7-Bed</span>
                        {% endif %}
                        {% if booking.num_eight_bed_rooms > 0 %}
                            <span class="badge bg-white text-dark border">{{ booking.num_eight_bed_rooms }} x 8-Bed</span>
                        {% endif %}
                        {% if booking.num_nine_bed_rooms > 0 %}
                            <span class="badge bg-white text-dark border">{{ booking.num_nine_bed_rooms }} x 9-Bed</span>
                        {% endif %}
                        {% if booking.num_ten_bed_rooms > 0 %}
                            <span class="badge bg-white text-dark border">{{ booking.num_ten_bed_rooms }} x 10-Bed</span>
                        {% endif %}
                        {% if booking.num_extra_beds > 0 %}
                            <span class="badge bg-white text-dark border">+ {{ booking.num_extra_beds }} Extra Bed</span>
                        {% endif %}
                    </div>

                    {% if booking.inclusion_items.count > 0 %}
                        <small class="text-muted d-block mt-2 pt-2 border-top border-secondary">
                            <i class="fas fa-star text-warning me-1"></i>
                            <strong>Inclusions:</strong>
                            {% for item in booking.inclusion_items.all %}
                                <span class="badge bg-white text-dark border">
                                    {{ item.special_inclusion.name }} ({{ item.num_adults }}A)
                                </span>
                            {% endfor %}
                        </small>
                    {% endif %}
                </div>

                <div class="btn-group-vertical" role="group" style="min-width: 60px;">
                    {% with day_plan=plans|get_item:context_day_number %}
                    <button type="button"
                            class="btn btn-sm btn-light border"
                            data-bs-toggle="modal"
                            data-bs-target="#houseboatBookingModal"
                            
                            data-booking-id="{{ booking.id }}"
                            data-houseboat-id="{{ booking.houseboat.id }}"
                            data-houseboat-name="{{ booking.houseboat.name|escapejs }}"
                            data-day-number="{{ day }}"
                            
                            data-destination-id="{{ day_plan.destination.id }}" 
                            data-destination-name="{{ day_plan.destination.name|escapejs }}"
                            
                            data-option="{{ booking.option }}" 
                            data-check-in-date="{{ booking.check_in_date|date:'Y-m-d' }}"
                            data-check-out-date="{{ booking.check_out_date|date:'Y-m-d' }}"
                            
                            data-room-type-id="{{ booking.room_type.id }}"
                            data-meal-plan-id="{{ booking.meal_plan.id }}"
                            
                            data-num-one-bed="{{ booking.num_one_bed_rooms|default:0 }}"
                            data-num-two-bed="{{ booking.num_two_bed_rooms|default:0 }}"
                            data-num-three-bed="{{ booking.num_three_bed_rooms|default:0 }}"
                            data-num-four-bed="{{ booking.num_four_bed_rooms|default:0 }}"
                            data-num-five-bed="{{ booking.num_five_bed_rooms|default:0 }}"
                            data-num-six-bed="{{ booking.num_six_bed_rooms|default:0 }}"
                            data-num-seven-bed="{{ booking.num_seven_bed_rooms|default:0 }}"
                            data-num-eight-bed="{{ booking.num_eight_bed_rooms|default:0 }}"
                            data-num-nine-bed="{{ booking.num_nine_bed_rooms|default:0 }}"
                            data-num-ten-bed="{{ booking.num_ten_bed_rooms|default:0 }}"
                            data-num-extra-beds="{{ booking.num_extra_beds|default:0 }}"
                            
                            onclick="editHouseboatBooking({{ booking.id }})"
                            title="Edit Houseboat Booking">
                        <i class="fas fa-edit text-info"></i>
                    </button>
                    {% endwith %}

                    <form method="post"
                        action="{% url 'delete_houseboat_booking' booking.id %}"
                        onsubmit="return confirm('Delete this houseboat booking?\n\nHouseboat: {{ booking.houseboat.name }}\nCheck-in: {{ booking.check_in_date|date:'M d, Y' }}\n\nThis cannot be undone!');"
                        class="m-0">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-sm btn-light border text-danger w-100" title="Delete Houseboat Booking">
                            <i class="fas fa-trash"></i>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    {% endfor %}
{% endif %}




                                    <!-- âœ… VEHICLES SECTION - IMPROVED -->
                                    {% if day_data.vehicle_bookings %}
                                        {% for booking in day_data.vehicle_bookings %}
                                            <div class="item-card">
                                                <div class="d-flex justify-content-between align-items-start gap-2">
                                                    <div class="flex-grow-1">
                                                        <!-- Vehicle Name -->
                                                        <div class="fw-bold text-danger mb-1">
                                                            <i class="fas fa-car me-2"></i>{{ booking.vehicle.name }}
                                                        </div>

                                                        <!-- Pickup Date -->
                                                        <small class="text-muted d-block mb-1">
                                                            <i class="fas fa-calendar-alt me-1"></i>Pickup: {{ booking.pickup_date|date:"d M Y" }}
                                                        </small>

                                                        <!-- Details Badges -->
                                                        <div class="mb-1">
                                                            <span class="badge bg-danger">
                                                                <i class="fas fa-users me-1"></i>{{ booking.num_passengers }} Passenger(s)
                                                            </span>
                                                            {% if booking.total_km %}
                                                                <span class="badge bg-secondary">
                                                                    <i class="fas fa-road me-1"></i>{{ booking.total_km }} km
                                                                </span>
                                                            {% endif %}
                                                        </div>
                                                    </div>

                                                    <!-- Action Buttons -->
                                                    <div class="btn-group-vertical" role="group" style="min-width: 60px;">
                                                        <button type="button"
                                                                class="btn btn-sm btn-outline-danger"
                                                                data-booking-id="{{ booking.id }}"
                                                                data-vehicle-id="{{ booking.vehicle.id }}"
                                                                data-vehicle-name="{{ booking.vehicle.name|escapejs }}"
                                                                data-destination-id="{{ booking.destination.id }}"
                                                                data-day-number="{{ day }}"
                                                                data-pickup-date="{{ booking.pickup_date|date:'Y-m-d' }}"
                                                                data-num-passengers="{{ booking.num_passengers }}"
                                                                data-total-km="{{ booking.total_km|default:0 }}"
                                                                onclick="editVehicleBooking(this)"
                                                                title="Edit Vehicle Booking">
                                                                <i class="fas fa-edit"></i>
                                                        </button>
                                                        <form method="post"
                                                            action="{% url 'delete_vehicle_booking' booking.id %}"
                                                            onsubmit="return confirm('Delete this vehicle booking?\n\nVehicle: {{ booking.vehicle.name }}\nPickup: {{ booking.pickup_date|date:'M d, Y' }}\n\nThis cannot be undone!');"
                                                            class="m-0">
                                                            {% csrf_token %}
                                                            <button type="submit" class="btn btn-sm btn-outline-danger w-100" title="Delete Vehicle Booking">
                                                                <i class="fas fa-trash"></i>
                                                            </button>
                                                        </form>
                                                    </div>
                                                </div>
                                            </div>
                                        {% endfor %}
                                    {% endif %}

                                    <!-- âœ… STANDALONE INCLUSIONS SECTION - IMPROVED -->
                                    {% if day_data.standalone_inclusions %}
                                        {% for inclusion in day_data.standalone_inclusions %}
                                            <div class="item-card">
                                                <div class="d-flex justify-content-between align-items-start gap-2">
                                                    <div class="flex-grow-1">
                                                        <!-- Inclusion Name -->
                                                        <div class="fw-bold text-warning mb-1">
                                                            <i class="fas fa-star me-2"></i>{{ inclusion.special_inclusion.name }}
                                                        </div>

                                                        <!-- Additional Details (if you have them) -->
                                                        {% if inclusion.num_adults or inclusion.num_children %}
                                                            <small class="text-muted d-block">
                                                                <i class="fas fa-users me-1"></i>
                                                                {% if inclusion.num_adults %}{{ inclusion.num_adults }} Adult(s){% endif %}
                                                                {% if inclusion.num_adults and inclusion.num_children %}, {% endif %}
                                                                {% if inclusion.num_children %}{{ inclusion.num_children }} Child(ren){% endif %}
                                                            </small>
                                                        {% endif %}
                                                    </div>

                                                    <!-- Action Buttons -->
                                                    <div class="btn-group-vertical" role="group" style="min-width: 60px;">
                                                        <button type="button"
                                                            class="btn btn-sm btn-outline-warning"
                                                            data-bs-toggle="modal"
                                                            data-bs-target="#standaloneInclusionModal"
                                                            onclick="editStandaloneInclusion({{ inclusion.id }})"
                                                            title="Edit Standalone Inclusion">
                                                            <i class="fas fa-edit"></i>
                                                        </button>
                                                        <form method="post"
                                                            action="{% url 'delete_standalone_inclusion' inclusion.id %}"
                                                            onsubmit="return confirm('Delete this inclusion?\n\nInclusion: {{ inclusion.special_inclusion.name }}\n\nThis cannot be undone!');"
                                                            class="m-0">
                                                            {% csrf_token %}
                                                            <button type="submit" class="btn btn-sm btn-outline-danger w-100" title="Delete Inclusion">
                                                                <i class="fas fa-trash"></i>
                                                            </button>
                                                        </form>
                                                    </div>
                                                </div>
                                            </div>
                                        {% endfor %}
                                    {% endif %}


                                    <!-- EMPTY STATE -->
                                    {% if not day_data.hotel_bookings and not day_data.activity_bookings and not day_data.vehicle_bookings and not day_data.houseboat_bookings and not day_data.standalone_inclusions %}
                                        <div class="text-center text-muted py-4">
                                            <i class="fas fa-inbox fa-3x opacity-25 mb-3"></i>
                                            <p class="mb-1 fw-semibold">No items added yet</p>
                                            <small class="text-muted">Use the panel on the right to add items</small>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    {% endwith %}
                </div>
            {% endfor %}
        {% else %}
            <div class="empty-content">
                <div class="empty-icon"><i class="fas fa-hand-pointer"></i></div>
                <p class="mb-1">Select a day to view details</p>
                <small class="text-muted">Click on a day from the left panel</small>
            </div>
        {% endif %}
    </div>

   <!-- RIGHT COLUMN: ADD ITEMS -->
    <div class="add-items-column">
        <div class="add-items-title">
            <i class="fas fa-plus-circle me-2"></i>Add Items to Day {{ context_day_number|default:"?" }}
        </div>

        {% if context_day_number %}
            {% with day_plan=plans|get_item:context_day_number %}
                {% if day_plan and day_plan.destination %}
                    <div class="alert alert-info py-2 mb-3 small">
                        <i class="fas fa-map-marker-alt me-1"></i>
                        <strong>Destination:</strong> {{ day_plan.destination.name }}
                    </div>
                {% else %}
                    <div class="alert alert-warning py-2 mb-3 small">
                        <i class="fas fa-exclamation-triangle me-1"></i>
                        <strong>Warning:</strong> Please select a destination for Day {{ context_day_number }} first
                    </div>
                {% endif %}
            {% endwith %}

            <!-- SECTION SELECTOR -->
            <div class="section-selector-box">
                <form method="post" id="sectionSelectForm">
                    {% csrf_token %}
                    <input type="hidden" name="form_type" value="section_select">
                    <input type="hidden" name="day_number" id="selectedDayNumber" value="{{ context_day_number }}">

                    <label class="form-label fw-semibold">
                        <i class="fas fa-filter me-1"></i>Choose Section
                    </label>
                    <select name="section" id="sectionSelect" class="form-select">
                        <option value="">-- Choose Section --</option>
                        <option value="day_itinerary" {% if selected_section == 'day_itinerary' %}selected{% endif %}>ðŸ“‹ Day Itinerary</option>
                        <option value="hotels" {% if selected_section == 'hotels' %}selected{% endif %}>ðŸ¨ Hotels</option>
                        <option value="houseboats" {% if selected_section == 'houseboats' %}selected{% endif %}>ðŸš¢ Houseboats</option>
                        <option value="activities" {% if selected_section == 'activities' %}selected{% endif %}>ðŸŽ¯ Activities</option>
                        <option value="vehicles" {% if selected_section == 'vehicles' %}selected{% endif %}>ðŸš— Vehicles</option>
                        <option value="standalone_inclusions" {% if selected_section == 'standalone_inclusions' %}selected{% endif %}>â­ Standalone Services</option>
                    </select>
                </form>
            </div>


<!-- AVAILABLE ITEMS LIST -->
{% if section_data or selected_section == 'hotels' %}
    <div class="available-items-box mt-3">
        <h6 class="text-primary mb-3">
            <i class="fas fa-list me-2"></i>Available Items
            <span class="badge bg-primary">{{ section_data|length }}</span>
        </h6>

        <!-- SEARCH CONTAINER -->
    <div class="search-container">
        <div class="search-input-wrapper">
            <i class="fas fa-search search-icon"></i>
            <input
                type="text"
                class="search-box"
                id="availableItemsSearch"
                placeholder="Search items by name, type, or destination..."
                autocomplete="off">
            <button type="button" class="clear-search-btn" id="clearSearchBtn" title="Clear search">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="search-results-info" id="searchResultsInfo"></div>
    </div>

    <!-- NO RESULTS MESSAGE -->
    <div class="no-results-message" id="noResultsMessage">
        <i class="fas fa-search"></i>
        <p><strong>No items found</strong></p>
        <small>Try different search keywords</small>
    </div>

        <!-- Day Itinerary -->
        {% if selected_section == 'day_itinerary' %}
            {% for item in section_data %}
                <div class="item-card mb-2">
                    <div class="d-flex justify-content-between align-items-start gap-2">
                        <div class="flex-grow-1">
                            {% if item.is_pinned %}
                                <span class="badge bg-warning text-dark mb-1">ðŸ“Œ Pinned</span>
                            {% endif %}
                            <div class="fw-bold">{{ item.name }}</div>
                            <small class="text-muted">{{ item.details|truncatewords:15 }}</small>
                        </div>
                        <button type="button"
                                class="btn btn-sm btn-primary"
                                data-bs-toggle="modal"
                                data-bs-target="#previewDayItineraryModal"
                                onclick="previewDayItinerary('{{ item.id }}', '{{ item.name|escapejs }}', '{{ item.details|escapejs }}', '{% if item.image %}{{ item.image.url }}{% endif %}', '{{ context_day_number }}')"
                                title="View details before adding">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
            {% endfor %}


        <!-- âœ… Hotels Section - WITH MASTER BOOKING -->
        {% elif selected_section == 'hotels' %}
            {% with day_plan=plans|get_item:context_day_number %}

                <!-- âœ… MASTER BOOKING - Book ANY Hotel (No Pricing Required) -->
                <div class="item-card mb-3 border-0 shadow-sm" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <div class="d-flex justify-content-between align-items-center gap-2 p-2">
                        <div class="flex-grow-1">
                            <div class="fw-bold d-flex align-items-center">
                                <i class="fas fa-star me-2"></i>
                                Add Hotel Manually
                            </div>

                        </div>
                        <button type="button"
                                class="btn btn-light d-flex flex-column align-items-center justify-content-center shadow-sm"
                                style="width: 60px; height: 60px; border-radius: 10px; font-weight: 600;"
                                onclick="BookingSystem.openMasterBookingModal('{{ day_plan.destination.id }}', '{{ day_plan.destination.name|escapejs }}', {{ context_day_number }})">
                            <i class="fas fa-plus mb-1 fs-5"></i>
                            <span style="font-size: 0.7rem;">Book</span>
                        </button>
                    </div>
                </div>

                <!-- âœ… DIVIDER -->
                {% if section_data %}
                <div class="text-center my-3">
                    <small class="text-muted text-uppercase fw-semibold" style="font-size: 0.65rem; letter-spacing: 1.5px;">
                        <span style="display: inline-block; width: 35%; height: 1px; background: #dee2e6; vertical-align: middle;"></span>
                        <span style="padding: 0 12px;">OR CHOOSE FROM PRICED HOTELS</span>
                        <span style="display: inline-block; width: 35%; height: 1px; background: #dee2e6; vertical-align: middle;"></span>
                    </small>
                </div>
                {% endif %}

                <!-- âœ… PRICED HOTELS (Regular Green Book Buttons) -->
                {% if section_data %}
                    {% for hotel in section_data %}
                        <div class="item-card mb-2">
                            <div class="d-flex justify-content-between align-items-center gap-2">
                                <div class="flex-grow-1">
                                    <div class="fw-bold">{{ hotel.name }}</div>
                                    <small class="text-success">
                                        <i class="fas fa-check-circle me-1"></i>{{ hotel.destination.name }} â€¢ Pricing available
                                    </small>
                                </div>
                                <button type="button"
                                        class="btn btn-success d-flex flex-column align-items-center justify-content-center"
                                        style="width: 60px; height: 60px; border-radius: 10px; font-weight: 600;"
                                        onclick="BookingSystem.open('hotel', {hotelId: '{{ hotel.id }}', hotelName: '{{ hotel.name|escapejs }}', destinationId: '{{ hotel.destination.id }}', destinationName: '{{ hotel.destination.name|escapejs }}', dayNumber: {{ context_day_number|default:1 }}})">
                                    <i class="fas fa-plus mb-1"></i>
                                    <span style="font-size: 0.7rem;">Book</span>
                                </button>
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>No hotels with pricing found</strong>
                        <p class="mb-0 small mt-2">Use the "Book Any Hotel" button above to select from all available hotels.</p>
                    </div>
                {% endif %}

            {% endwith %}

        <!-- Houseboats -->
        {% elif selected_section == 'houseboats' %}
            {% for houseboat in section_data %}
                <div class="item-card mb-2">
                    <div class="d-flex justify-content-between align-items-center gap-2">
                        <div class="flex-grow-1">
                            <div class="fw-bold">{{ houseboat.name }}</div>
                            <small class="text-muted">{{ houseboat.houseboat_type }}</small>
                        </div>
                            {% with day_plan=plans|get_item:context_day_number %} 
                                <button type="button"
                                        class="btn btn-sm btn-info book-houseboat-btn"
                                        
                                        data-houseboat-id="{{ houseboat.id }}"
                                        data-houseboat-name="{{ houseboat.name|escapejs }}"
                                        data-day-number="{{ context_day_number|default:'1' }}"
                                        
                                        {# âœ… 1. ADD THESE DATA ATTRIBUTES #}
                                        data-destination-id="{{ day_plan.destination.id }}"
                                        data-destination-name="{{ day_plan.destination.name|escapejs }}"
                                        
                                        {# âœ… 2. PASS DESTINATION ID AND NAME IN ONCLICK #}
                                        onclick="openHouseboatModal(
                                            {{ houseboat.id }}, 
                                            '{{ houseboat.name|escapejs }}', 
                                            {{ context_day_number|default:1 }},
                                            '{{ day_plan.destination.id }}', 
                                            '{{ day_plan.destination.name|escapejs }}'
                                        )">
                                    <i class="fas fa-plus me-1"></i>Book
                                </button>
                            {% endwith %}
                    </div>
                </div>
            {% endfor %}

        <!-- Activities -->
        {% elif selected_section == 'activities' %}
            {% for activity in section_data %}
                <div class="item-card mb-2">
                    <div class="d-flex justify-content-between align-items-center gap-2">
                        <div class="flex-grow-1">
                            <div class="fw-bold">{{ activity.name }}</div>
                            <small class="text-muted">{{ activity.activity_type }}</small>
                        </div>
                        <button type="button"
                                class="btn btn-sm btn-warning book-activity-btn"
                                data-activity-id="{{ activity.id }}"
                                data-activity-name="{{ activity.name|escapejs }}"
                                data-day-number="{{ context_day_number|default:'1' }}"
                                onclick="openActivityModal({{ activity.id }}, '{{ activity.name|escapejs }}', {{ context_day_number|default:1 }})">
                            <i class="fas fa-plus me-1"></i>Book
                        </button>
                    </div>
                </div>
            {% endfor %}

        <!-- Vehicles -->
        {% elif selected_section == 'vehicles' %}
            {% with day_plan=plans|get_item:context_day_number %}
                {% for vehicle in section_data %}
                    <div class="item-card mb-2">
                        <div class="d-flex justify-content-between align-items-center gap-2">
                            <div class="flex-grow-1">
                                <div class="fw-bold">{{ vehicle.name }}</div>
                                <small class="text-muted">{{ vehicle.vehicle_type }}</small>
                            </div>
                            <button type="button"
                                    class="btn btn-sm btn-danger book-vehicle-btn"
                                    data-bs-toggle="modal"
                                    data-bs-target="#bookVehicleModal"
                                    data-vehicle-id="{{ vehicle.id }}"
                                    data-vehicle-name="{{ vehicle.name|escapejs }}"
                                    data-day-number="{{ context_day_number|default:'1' }}"
                                    data-destination-id="{{ day_plan.destination.id|default:'' }}"
                                    onclick="openVehicleModal(this)">
                                <i class="fas fa-plus me-1"></i>Book
                            </button>
                        </div>
                    </div>
                {% endfor %}
            {% endwith %}

        <!-- Standalone Inclusions -->
        {% elif selected_section == 'standalone_inclusions' %}
            {% for inclusion in section_data %}
                <div class="item-card mb-2">
                    <div class="d-flex justify-content-between align-items-center gap-2">
                        <div class="flex-grow-1">
                            <div class="fw-bold">{{ inclusion.name }}</div>
                            <small class="text-muted">{{ inclusion.get_price_display }}</small>
                        </div>
                        <button type="button"
                                class="btn btn-sm btn-secondary book-standalone-btn"
                                data-inclusion-id="{{ inclusion.id }}"
                                data-inclusion-name="{{ inclusion.name|escapejs }}"
                                data-day-number="{{ context_day_number|default:'1' }}"
                                onclick="openStandaloneModal({{ inclusion.id }}, '{{ inclusion.name|escapejs }}', {{ context_day_number|default:1 }})">
                            <i class="fas fa-plus me-1"></i>Add
                        </button>
                    </div>
                </div>
            {% endfor %}
        {% endif %}
    </div>

{% elif selected_section %}
    <div class="alert alert-info mt-3">
        <i class="fas fa-info-circle me-2"></i>No items found for this section
    </div>
{% endif %}

{% else %}
    <div class="alert alert-warning mt-3">
        <i class="fas fa-exclamation-triangle me-2"></i>
        <strong>Please select a day first</strong>
        <p class="mb-0 small mt-2">Click on a day from the left panel to start adding items.</p>
    </div>
{% endif %}




<script>
// Simple day selector function
function selectDay(dayNumber) {
    const url = new URL(window.location.href);
    url.searchParams.set('day', dayNumber);
    window.location.href = url.toString();
}
</script>



<!-- âœ… PACKAGE TERMS MODAL - COMPLETE VERSION -->
<div class="modal fade modal-right modal-extra-wide" id="packageTermsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-gradient-purple">
                <h5 class="modal-title text-white">
                    <i class="fas fa-file-contract me-2"></i>
                    Customize Package Terms
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
                <!-- Loading Spinner -->
                <div id="termsLoadingSpinner" class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3 text-muted">Loading package terms...</p>
                </div>

                <!-- Alert Messages -->
                <div id="termsAlertContainer"></div>

                <!-- Form Container -->
                <form id="packageTermsForm" style="display: none;">
                    {% csrf_token %}
                    <input type="hidden" id="itinerary_id" name="itinerary_id">

                    <!-- Info Banner -->
                    <div class="alert alert-info mb-4">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Note:</strong> Changes will only affect this itinerary. Default terms remain unchanged.
                    </div>

                    <!-- Tabs Navigation -->
                    <ul class="nav nav-tabs mb-3" id="termsTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="inclusions-tab" data-bs-toggle="tab" data-bs-target="#inclusions" type="button">
                                <i class="fas fa-check-circle me-1"></i> Inclusions
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="exclusions-tab" data-bs-toggle="tab" data-bs-target="#exclusions" type="button">
                                <i class="fas fa-times-circle me-1"></i> Exclusions
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="policies-tab" data-bs-toggle="tab" data-bs-target="#policies" type="button">
                                <i class="fas fa-file-alt me-1"></i> Policies
                            </button>
                        </li>
                    </ul>

                    <!-- Tabs Content -->
                    <div class="tab-content" id="termsTabContent">
                        <!-- Inclusions Tab -->
                        <div class="tab-pane fade show active" id="inclusions">
                            <div class="mb-4">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-check-circle text-success me-1"></i> Package Inclusion
                                </label>
                                <textarea name="package_inclusion" id="package_inclusion" class="ckeditor-field"></textarea>
                            </div>
                        </div>

                        <!-- Exclusions Tab -->
                        <div class="tab-pane fade" id="exclusions">
                            <div class="mb-4">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-times-circle text-danger me-1"></i> Package Exclusion
                                </label>
                                <textarea name="package_exclusion" id="package_exclusion" class="ckeditor-field"></textarea>
                            </div>
                        </div>

                        <!-- Policies Tab -->
                        <div class="tab-pane fade" id="policies">
                            <div class="mb-4">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-file-contract me-1"></i> Terms and Conditions
                                </label>
                                <textarea name="terms_and_conditions" id="terms_and_conditions" class="ckeditor-field"></textarea>
                            </div>

                            <div class="mb-4">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-credit-card me-1"></i> Payment Policy
                                </label>
                                <textarea name="payment_policy" id="payment_policy" class="ckeditor-field"></textarea>
                            </div>

                            <div class="mb-4">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-ban me-1"></i> Cancellation Policy
                                </label>
                                <textarea name="cancellation_policy" id="cancellation_policy" class="ckeditor-field"></textarea>
                            </div>

                            <div class="mb-4">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-money-bill-wave me-1"></i> Refund Policy
                                </label>
                                <textarea name="refund_policy" id="refund_policy" class="ckeditor-field"></textarea>
                            </div>

                            <div class="mb-4">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-file-alt me-1"></i> Required Documents
                                </label>
                                <textarea name="list_of_documents" id="list_of_documents" class="ckeditor-field"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- âœ… ACTIVE STATUS - CUSTOM TOGGLE -->
                    <div class="card border-0 bg-light mt-4">
                        <div class="card-body">
                            <div class="d-flex align-items-center justify-content-between">
                                <div>
                                    <h6 class="mb-1 fw-bold">
                                        <i class="fas fa-power-off me-2" id="statusIcon"></i>
                                        <span id="statusText">Active Status</span>
                                    </h6>
                                    <small class="text-muted">Use these custom terms for this itinerary</small>
                                </div>
                                <div>
                                    <label class="custom-toggle mb-0">
                                        <input type="checkbox" id="is_active" name="is_active" checked>
                                        <span class="slider"></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i> Cancel
                </button>
                <button type="button" class="btn btn-primary" id="saveTermsBtn" onclick="savePackageTerms()">
                    <i class="fas fa-save me-1"></i> Save Changes
                </button>
            </div>
        </div>
    </div>
</div>







<div class="modal fade modal-right modal-wide" id="hotelBookingModal" tabindex="-1" aria-labelledby="hotelBookingModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" id="hotelBookingForm" action="">
                {% csrf_token %}
                <input type="hidden" name="booking_id" id="modalBookingId">
                <input type="hidden" name="inclusions_data" id="inclusionsData">
                <input type="hidden" name="hotel_id" id="modalHotelId">
                <input type="hidden" name="day_number" id="modalDayNumber">
                <input type="hidden" name="destination" id="modalDestination">
                <input type="hidden" id="modalDestinationNameHidden">
                <input type="hidden" name="is_hotel_change" id="isHotelChange" value="false">
                <input type="hidden" name="is_demo_mode" id="isDemoMode" value="false">

                <div class="modal-header bg-primary text-white sticky-top" style="z-index: 1050;">
                    <h5 class="modal-title" id="hotelBookingModalLabel">
                        <i class="fas fa-hotel me-2"></i>Hotel Booking Details
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body">
                    <div id="hotelModeSection" class="mb-4 p-3 rounded" style="display: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <label class="form-label fw-bold mb-2 text-white">
                            <i class="fas fa-sliders-h me-2"></i>Selection Mode
                        </label>
                        <select id="hotelModeSelector" class="form-select form-select-lg" onchange="BookingSystem.switchHotelSelectionMode(this.value)">
                            <option value="master" selected>ðŸ” Master Mode - All Hotels</option>
                            <option value="manual">ðŸ“ Manual Mode - Priced Hotels Only</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="form-label fw-semibold mb-0">
                                <i class="fas fa-building me-2 text-primary"></i>Hotel Name *
                            </label>
                            <button type="button" class="btn btn-sm btn-outline-warning" id="toggleDemoHotelBtn" onclick="toggleHotelInputMode()">
                                <i class="fas fa-magic me-1"></i> Add Manual Hotel
                            </button>
                        </div>

                        <div id="hotelSelectContainer">
                            <select id="modalHotelNameDropdown" class="form-select form-select-lg" onchange="handleHotelChange(this); validateDuplicateHotel();" required>
                                <option value="">-- Select Hotel --</option>
                            </select>
                            <small class="text-muted d-block mt-1" id="hotelFieldHint">
                                <i class="fas fa-info-circle me-1"></i>Loading available hotels...
                            </small>
                        </div>

                        <div id="hotelInputContainer" style="display: none;">
                            <input type="text" id="modalCustomHotelName" name="custom_hotel_name" class="form-control form-control-lg border-warning" placeholder="Enter Custom Hotel Name (e.g. Grand Plaza Demo)">
                            <small class="text-warning d-block mt-1">
                                <i class="fas fa-exclamation-circle me-1"></i>This is a temporary/demo booking.
                            </small>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="modalDestinationName" class="form-label fw-semibold">
                            <i class="fas fa-map-marker-alt me-2 text-danger"></i>Destination *
                        </label>
                        <input type="text" class="form-control bg-light" id="modalDestinationName" readonly placeholder="Loading...">
                        <small class="text-muted d-block mt-1">
                            <i class="fas fa-lock me-1"></i>Destination is locked to the selected day
                        </small>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="hotelCategory" class="form-label fw-semibold">
                                <i class="fas fa-star me-2 text-warning"></i>Category *
                            </label>
                            <select class="form-select" id="hotelCategory" name="category" required>
                                <option value="">-- Select Category --</option>
                                <option value="1 Star">1 Star</option>
                                <option value="2 Star">2 Star</option>
                                <option value="3 Star">3 Star</option>
                                <option value="4 Star">4 Star</option>
                                <option value="5 Star">5 Star</option>
                            </select>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <label for="roomType" class="form-label fw-semibold mb-0">
                                    <i class="fas fa-door-open me-2 text-info"></i>Room Type *
                                </label>
                                <button type="button" class="btn btn-link btn-sm p-0 text-decoration-none" onclick="toggleRoomTypeMode()">
                                    <small id="roomToggleText" class="fw-bold"><i class="fas fa-pen"></i> Type Manually</small>
                                </button>
                            </div>

                            <div id="roomSelectContainer">
                                <select name="room_type" id="roomType" class="form-select" required disabled>
                                    <option value="">-- Select hotel first --</option>
                                </select>
                                <small class="text-muted d-block mt-1">
                                    <i class="fas fa-info-circle me-1"></i>Auto-loads based on hotel
                                </small>
                            </div>

                            <div id="roomInputContainer" style="display:none;">
                                <input type="text" name="custom_room_type" id="customRoomType" class="form-control" placeholder="e.g., Honeymoon Suite">
                                <small class="text-warning d-block mt-1">
                                    <i class="fas fa-keyboard me-1"></i>Manual entry
                                </small>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="mealPlan" class="form-label fw-semibold">
                                <i class="fas fa-utensils me-2 text-success"></i>Meal Plan *
                            </label>
                            <select class="form-select" id="mealPlan" name="meal_plan" required disabled>
                                <option value="">-- Select hotel first --</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="hotelOption" class="form-label fw-semibold">
                                <i class="fas fa-list-alt me-2 text-secondary"></i>Hotel Option
                            </label>
                            <select name="option" class="form-select" id="hotelOption" onchange="validateDuplicateHotel()">
                                <option value="option_1">Standard</option>
                                <option value="option_2">Deluxe</option>
                                <option value="option_3">Premium</option>
                                <option value="option_4">Luxury</option>
                            </select>
                        </div>
                    </div>

                    <div class="border p-3 rounded bg-light mb-3">
                        <h6 class="mb-3 fw-bold">
                            <i class="fas fa-calendar-check me-2 text-success"></i>Check-in & Check-out Details
                        </h6>
                        {% if itinerary.travel_from and itinerary.travel_to %}
                        <div class="alert alert-info py-2 mb-3">
                            <small>
                                <i class="fas fa-info-circle me-1"></i>
                                <strong>Itinerary:</strong> {{ itinerary.travel_from|date:"d M Y" }} to {{ itinerary.travel_to|date:"d M Y" }}
                            </small>
                        </div>
                        {% endif %}
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="checkinDate" class="form-label fw-semibold">Check-in Date *</label>
                                <input type="date" name="check_in_date" class="form-control" id="checkinDate" required>
                            </div>
                            <div class="col-md-6">
                                <label for="checkinTime" class="form-label fw-semibold">Check-in Time *</label>
                                <input type="time" name="check_in_time" class="form-control" id="checkinTime" value="14:00" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <label for="checkoutDate" class="form-label fw-semibold">Check-out Date *</label>
                                <input type="date" name="check_out_date" class="form-control" id="checkoutDate" required>
                            </div>
                            <div class="col-md-6">
                                <label for="checkoutTime" class="form-label fw-semibold">Check-out Time *</label>
                                <input type="time" name="check_out_time" class="form-control" id="checkoutTime" value="11:00" required>
                            </div>
                        </div>
                    </div>

                    <div class="border p-3 rounded bg-light mb-4">
                        <h6 class="mb-3 fw-bold">
                            <i class="fas fa-bed me-2 text-info"></i>Room Configuration
                        </h6>
                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label for="numDoubleBeds" class="form-label fw-semibold">Double Beds *</label>
                                <input type="number" name="num_double_beds" id="numDoubleBeds" class="form-control" value="0" min="0" required>
                            </div>
                            <div class="col-md-6">
                                <label for="extraBeds" class="form-label fw-semibold">Extra Beds</label>
                                <input type="number" name="extra_beds" id="extraBeds" class="form-control" value="0" min="0">
                            </div>
                        </div>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="childWithBed" class="form-label fw-semibold">Children with Bed</label>
                                <input type="number" name="child_with_bed" id="childWithBed" class="form-control" value="0" min="0">
                            </div>
                            <div class="col-md-6">
                                <label for="childWithoutBed" class="form-label fw-semibold">Children without Bed</label>
                                <input type="number" name="child_without_bed" id="childWithoutBed" class="form-control" value="0" min="0">
                            </div>
                        </div>
                    </div>

                    <div class="border p-3 rounded bg-light mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="mb-0 fw-bold">
                                <i class="fas fa-star me-2 text-warning"></i>Special Inclusions (Optional)
                            </h6>
                            <button type="button" class="btn btn-sm btn-primary" id="addHotelInclusionBtn">
                                <i class="fas fa-plus me-1"></i> Add Inclusion
                            </button>
                        </div>
                        <div id="hotelInclusionsContainer">
                            <div class="text-center text-muted py-4" id="noHotelInclusionsMessage">
                                <i class="fas fa-info-circle me-2"></i>
                                No inclusions added yet
                            </div>
                        </div>
                        <div id="hotelInclusionsSummary" class="mt-3 p-3 bg-white rounded border" style="display: none;">
                            <div class="d-flex justify-content-between align-items-center">
                                <strong class="text-primary">
                                    <i class="fas fa-calculator me-2"></i>Total Inclusions Cost:
                                </strong>
                                <strong id="hotelTotalInclusionCost" class="text-success fs-5">â‚¹0.00</strong>
                            </div>
                            <small class="text-muted d-block mt-2" id="hotelInclusionsSummaryText"></small>
                        </div>
                    </div>
                </div>

                <div id="duplicateHotelWarning" class="alert alert-danger mx-3 mb-3" style="display: none; animation: fadeIn 0.3s;">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-exclamation-triangle fa-2x me-3"></i>
                        <div>
                            <strong>Duplicate Booking Detected!</strong><br>
                            This hotel is already booked with the <span id="duplicateOptionName" class="fw-bold"></span> option.
                            Please choose a different hotel or option.
                        </div>
                    </div>
                </div>

                <div class="modal-footer sticky-bottom bg-white border-top" style="z-index: 1050;">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Close
                    </button>
                    <button type="submit" class="btn btn-primary" id="btnSaveBooking">
                        <i class="fas fa-save me-2"></i>Save Booking
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>





<!-- âœ… ACTIVITY BOOKING MODAL - EDITED FOR ITINERARY -->
<div class="modal fade" id="activityBookingModal" tabindex="-1" aria-hidden="true"
     data-url-edit-prototype="{% url 'update_activity_booking' 9999 %}">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action=""> {% csrf_token %}
                <div class="modal-header bg-warning">
                    <h5 class="modal-title" id="activityBookingModalLabel">
                        <i class="fas fa-map me-2"></i>Book Activity
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- ITINERARY DATA -->
                    <input type="hidden" id="itineraryTravelFrom" value="{{ itinerary.travel_from|date:'Y-m-d' }}">
                    <input type="hidden" id="itineraryTravelTo" value="{{ itinerary.travel_to|date:'Y-m-d' }}">
                    <input type="hidden" id="itineraryDefaultAdults" value="{{ itinerary.adults|default:'2' }}">
                    <input type="hidden" id="itineraryDefaultChildren" value="{{ itinerary.childrens|default:'0' }}">

                    <input type="hidden" name="activity_id" id="modalActivityId">
                    <input type="hidden" name="day_number" id="modalActivityDayNumber">

                    <div class="mb-3">
                        <strong><i class="fas fa-star me-2 text-warning"></i>Activity:</strong> <span id="modalActivityName"></span>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-semibold">Date *</label>
                        <input type="date" name="booking_date" class="form-control"
                               min="{{ itinerary.travel_from|date:'Y-m-d' }}"
                               max="{{ itinerary.travel_to|date:'Y-m-d' }}"
                               required>
                        <small class="text-muted">Within itinerary dates</small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-semibold">Time *</label>
                        <input type="time" name="booking_time" class="form-control" required>
                    </div>

                    <div class="row mb-3">
                        <div class="col">
                            <label class="form-label fw-semibold">Adults</label>
                            <input type="number" name="num_adults" class="form-control" min="1" value="1">
                        </div>
                        <div class="col">
                            <label class="form-label fw-semibold">Children</label>
                            <input type="number" name="num_children" class="form-control" min="0" value="0">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-semibold">Notes</label>
                        <textarea name="notes" class="form-control" rows="2" placeholder="Any special requests..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-check me-1"></i>Confirm Booking
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- âœ… VEHICLE BOOKING MODAL - RIGHT SIDEBAR VERSION -->
<div class="modal fade modal-right" id="bookVehicleModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{% url 'create_vehicle_booking' itinerary.id %}" id="vehicleBookingForm">
                {% csrf_token %}


                <!-- âœ… HIDDEN FIELDS FOR ITINERARY DATA -->
                <input type="hidden" id="itineraryStartDate" value="{{ itinerary.travel_from|date:'Y-m-d' }}">
                <input type="hidden" id="itineraryEndDate" value="{{ itinerary.travel_to|date:'Y-m-d' }}">
                <input type="hidden" id="itineraryDays" value="{{ itinerary.no_of_days }}">
                <input type="hidden" id="itineraryDefaultAdults" value="{{ itinerary.adults|default:'2' }}">
                <input type="hidden" id="itineraryDefaultChildren" value="{{ itinerary.childrens|default:'0' }}">

                <!-- âœ… HIDDEN FIELDS FOR FORM SUBMISSION -->
                <input type="hidden" name="booking_id" id="vehicleBookingId" value="">
                <!-- <input type="hidden" name="is_vehicle_change" id="isVehicleChange" value="false"> -->

                <input type="hidden" name="vehicle_id" id="modalVehicleId">
                <input type="hidden" name="day_number" id="vehicleDayNumber">
                <input type="hidden" name="destination_id" id="modalVehicleDestinationId">

                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-car me-2"></i>Book Vehicle
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">

                    <!-- âœ… CURRENT VEHICLE (READONLY VIEW) -->
                    <!-- âœ… VEHICLE DROPDOWN (ALWAYS VISIBLE) -->
                    <div class="mb-3">
                        <label class="form-label fw-semibold">
                            <i class="fas fa-car me-1 text-danger"></i>Select Vehicle *
                        </label>

                        <select id="modalVehicleDropdown"
                                class="form-select"
                                required
                                onchange="BookingSystem.onVehicleSelectFromDropdown(this)">
                            <option value="">-- Select Vehicle --</option>
                        </select>

                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            Vehicle list is based on selected destination
                        </small>
                    </div>


                    <!-- âœ… CHANGE VEHICLE DROPDOWN (HIDDEN INITIALLY) -->
                    <div class="mb-3" id="vehicleChangeContainer" style="display:none;">
                        <label class="form-label fw-semibold">
                            <i class="fas fa-exchange-alt me-1 text-primary"></i>Select New Vehicle *
                        </label>
                        <select id="modalVehicleDropdown"
                            class="form-select"
                            onchange="BookingSystem.onVehicleSelectFromDropdown(this)">

                            <option value="">Loading vehicles...</option>
                        </select>
                        <small class="text-muted">
                            <i class="fas fa-warning me-1"></i>
                            Changing vehicle will update only this dayâ€™s booking
                        </small>
                    </div>

                    <!-- âœ… PICKUP DATE -->
                    <div class="mb-3">
                        <label for="vehiclePickupDate" class="form-label fw-semibold">
                            <i class="fas fa-calendar me-1 text-primary"></i>Pickup Date *
                        </label>
                        <input type="date"
                               name="pickup_date"
                               id="vehiclePickupDate"
                               class="form-control"
                               min="{{ itinerary.travel_from|date:'Y-m-d' }}"
                               max="{{ itinerary.travel_to|date:'Y-m-d' }}"
                               required>
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            Must be within itinerary dates
                        </small>
                    </div>

                    <!-- âœ… NUMBER OF PASSENGERS -->
                    <div class="mb-3">
                        <label for="vehicleNumPassengers" class="form-label fw-semibold">
                            <i class="fas fa-users me-1 text-success"></i>Number of Passengers *
                        </label>
                        <input type="number"
                               name="num_passengers"
                               id="vehicleNumPassengers"
                               class="form-control"
                               min="1"
                               max="50"
                               required>
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            Total number of people travelling
                        </small>
                    </div>

                    <!-- âœ… TOTAL KILOMETERS -->
                    <div class="mb-3">
                        <label for="vehicleTotalKm" class="form-label fw-semibold">
                            <i class="fas fa-road me-1 text-warning"></i>Total Kilometers
                            <span class="badge bg-secondary ms-2">Optional</span>
                        </label>
                        <input type="number"
                               name="total_km"
                               id="vehicleTotalKm"
                               class="form-control"
                               min="0"
                               step="0.1"
                               placeholder="e.g., 150"
                               required>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Cancel
                    </button>
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-save me-1"></i>Save Booking
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>


<div class="modal fade modal-right modal-wide" id="houseboatBookingModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="" id="houseboatBookingForm">
                {% csrf_token %}

                <input type="hidden" name="houseboat_id" id="modalHouseboatId">
                <input type="hidden" name="day_number" id="houseboatmodalDayNumber">
                <input type="hidden" name="inclusions_data" id="houseboatInclusionsData">
                <input type="hidden" name="destination_id" id="modalHouseboatDestination">
                <input type="hidden" id="houseboatBookingId" name="booking_id">

                <div class="modal-header bg-info text-white sticky-top" style="z-index: 1050;">
                    <h5 class="modal-title" id="houseboatBookingModalLabel">
                        <i class="fas fa-ship me-2"></i>Houseboat Booking
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body">

                    <div class="alert alert-info mb-2">
                        <strong><i class="fas fa-ship me-2"></i>Houseboat:</strong>
                        <span id="modalHouseboatName" class="fs-5">Loading...</span>
                    </div>

                    <div class="alert alert-light border mb-3 py-2">
                        <div class="d-flex align-items-center text-dark">
                            <i class="fas fa-map-marker-alt text-danger me-2 fs-5"></i>
                            <div>
                                <small class="text-muted d-block" style="line-height: 1;">Location</small>
                                <strong id="modalHouseboatDestinationDisplay" class="fs-6">--</strong>
                            </div>
                        </div>
                    </div>

                    {% if itinerary.travel_from and itinerary.travel_to %}
                    <div class="alert alert-secondary py-2 mb-3">
                        <small>
                            <i class="fas fa-info-circle me-1"></i>
                            <strong>Itinerary:</strong> {{ itinerary.travel_from|date:"d M Y" }} to {{ itinerary.travel_to|date:"d M Y" }}
                        </small>
                    </div>
                    {% endif %}

                    <div class="border p-3 rounded bg-light mb-3">
                        <h6 class="mb-3 fw-bold">
                            <i class="fas fa-calendar-check me-2 text-success"></i>Check-in & Check-out
                        </h6>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="houseboatCheckIn" class="form-label fw-semibold">
                                    Check-in Date *
                                    <span class="badge bg-secondary">Auto-set by Day</span>
                                </label>
                                <input type="date" name="check_in_date" class="form-control" id="houseboatCheckIn" required>
                                <small class="text-muted d-block mt-1">
                                    <i class="fas fa-lock me-1"></i>Based on selected day number
                                </small>
                            </div>
                            <div class="col-md-6">
                                <label for="houseboatCheckOut" class="form-label fw-semibold">
                                    Check-out Date *
                                    <span class="badge bg-success">Editable</span>
                                </label>
                                <input type="date" name="check_out_date" class="form-control" id="houseboatCheckOut" required>
                                <small class="text-muted d-block mt-1">
                                    <i class="fas fa-edit me-1"></i>You can change this date
                                </small>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label for="houseboatOption" class="form-label fw-semibold">
                                <i class="fas fa-tags me-1 text-primary"></i>Pricing Option *
                            </label>
                            <select name="option" class="form-select" id="houseboatOption" onchange="validateDuplicateHouseboat()" required>
                                <option value="option1">Standard</option>
                                <option value="option2">Deluxe</option>
                                <option value="option3">Premium</option>
                                <option value="option4">Luxury</option>
                            </select>
                            <small class="text-muted d-block mt-1">Select pricing option for this houseboat</small>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="houseboatMealPlan" class="form-label fw-semibold">
                                <i class="fas fa-utensils me-1 text-success"></i>Meal Plan *
                            </label>
                            <select name="meal_plan" class="form-select" id="houseboatMealPlan" required disabled>
                                <option value="">-- Select dates first --</option>
                            </select>
                            <small class="text-muted d-block mt-1">Auto-loads based on dates</small>
                        </div>
                        <div class="col-md-6">
                            <label for="houseboatRoomType" class="form-label fw-semibold">
                                <i class="fas fa-bed me-1 text-info"></i>Room Type *
                            </label>
                            <select name="room_type" class="form-select" id="houseboatRoomType" required disabled>
                                <option value="">-- Select dates first --</option>
                            </select>
                            <small class="text-muted d-block mt-1">Auto-loads based on dates</small>
                        </div>
                    </div>

                    <div class="border p-3 rounded bg-light mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="mb-0 fw-bold">
                                <i class="fas fa-star me-2 text-warning"></i>Special Inclusions (Optional)
                            </h6>
                            <button type="button" class="btn btn-sm btn-primary" id="addHouseboatInclusionBtn">
                                <i class="fas fa-plus me-1"></i> Add Inclusion
                            </button>
                        </div>

                        <div id="houseboatInclusionsContainer">
                            <div class="text-center text-muted py-4" id="houseboatNoInclusionsMessage">
                                <i class="fas fa-info-circle me-2"></i>
                                No inclusions added yet. Click "Add Inclusion" button above.
                            </div>
                        </div>

                        <div id="houseboatInclusionsSummary" class="mt-3 p-3 bg-white rounded border" style="display: none;">
                            <div class="d-flex justify-content-between align-items-center">
                                <strong class="text-primary">
                                    <i class="fas fa-calculator me-2"></i>Total Inclusions Cost:
                                </strong>
                                <strong id="houseboatTotalInclusionCost" class="text-success fs-5">â‚¹0.00</strong>
                            </div>
                            <small class="text-muted d-block mt-2" id="houseboatInclusionsSummaryText"></small>
                        </div>
                    </div>

                    <div class="border p-3 rounded bg-light mb-3">
                        <h6 class="mb-3 fw-bold">
                            <i class="fas fa-door-open me-2 text-info"></i>Room Configuration
                        </h6>
                        <div class="row g-3">
                            <div class="col-md-3"><label class="form-label small fw-semibold">1-Bed</label><input type="number" name="num_one_bed_rooms" class="form-control form-control-sm houseboat-room-input" value="0" min="0"></div>
                            <div class="col-md-3"><label class="form-label small fw-semibold">2-Bed</label><input type="number" name="num_two_bed_rooms" class="form-control form-control-sm houseboat-room-input" value="0" min="0"></div>
                            <div class="col-md-3"><label class="form-label small fw-semibold">3-Bed</label><input type="number" name="num_three_bed_rooms" class="form-control form-control-sm houseboat-room-input" value="0" min="0"></div>
                            <div class="col-md-3"><label class="form-label small fw-semibold">4-Bed</label><input type="number" name="num_four_bed_rooms" class="form-control form-control-sm houseboat-room-input" value="0" min="0"></div>
                            
                            <div class="col-md-3"><label class="form-label small fw-semibold">5-Bed</label><input type="number" name="num_five_bed_rooms" class="form-control form-control-sm houseboat-room-input" value="0" min="0"></div>
                            <div class="col-md-3"><label class="form-label small fw-semibold">6-Bed</label><input type="number" name="num_six_bed_rooms" class="form-control form-control-sm houseboat-room-input" value="0" min="0"></div>
                            <div class="col-md-3"><label class="form-label small fw-semibold">7-Bed</label><input type="number" name="num_seven_bed_rooms" class="form-control form-control-sm houseboat-room-input" value="0" min="0"></div>
                            <div class="col-md-3"><label class="form-label small fw-semibold">8-Bed</label><input type="number" name="num_eight_bed_rooms" class="form-control form-control-sm houseboat-room-input" value="0" min="0"></div>

                            <div class="col-md-3"><label class="form-label small fw-semibold">9-Bed</label><input type="number" name="num_nine_bed_rooms" class="form-control form-control-sm houseboat-room-input" value="0" min="0"></div>
                            <div class="col-md-3"><label class="form-label small fw-semibold">10-Bed</label><input type="number" name="num_ten_bed_rooms" class="form-control form-control-sm houseboat-room-input" value="0" min="0"></div>
                            <div class="col-md-3"><label class="form-label small fw-semibold text-danger">Extra Beds</label><input type="number" name="num_extra_beds" class="form-control form-control-sm" value="0" min="0"></div>
                        </div>
                    </div>
                </div>

                <div id="duplicateHouseboatWarning" class="alert alert-danger mx-3 mb-3" style="display: none; animation: fadeIn 0.3s;">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-exclamation-triangle fa-2x me-3"></i>
                        <div>
                            <strong>Duplicate Booking Detected!</strong><br>
                            This houseboat is already booked with the <span id="duplicateHouseboatOptionName" class="fw-bold"></span> option.
                        </div>
                    </div>
                </div>

                <div class="modal-footer sticky-bottom bg-white border-top" style="z-index: 1050;">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Close
                    </button>
                    <button type="submit" class="btn btn-info text-white">
                        <i class="fas fa-save me-1"></i>Save Booking
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>



<template id="houseboatInclusionRowTemplate">
    <div class="houseboat-inclusion-row border rounded p-3 mb-3 bg-white shadow-sm">
        <div class="d-flex justify-content-between align-items-start mb-2">
            <h6 class="mb-0 text-primary">
                <i class="fas fa-gift me-2"></i>Inclusion #<span class="houseboat-inclusion-number"></span>
            </h6>
            <button type="button" class="btn btn-sm btn-danger remove-houseboat-inclusion-btn">
                <i class="fas fa-trash"></i> Remove
            </button>
        </div>

        <div class="row g-2">
            <div class="col-md-6">
                <label class="form-label small fw-semibold">Special Inclusion *</label>
                <select class="form-select form-select-sm houseboat-inclusion-select" required>
                    <option value="">-- Select Inclusion --</option>
                </select>
                <small class="text-muted houseboat-pricing-info"></small>
            </div>

            <div class="col-md-3">
                <label class="form-label small fw-semibold">Adults</label>
                <input type="number" class="form-control form-control-sm houseboat-inclusion-adults"
                       value="0" min="0" max="50">
            </div>

            <div class="col-md-3">
                <label class="form-label small fw-semibold">Children</label>
                <input type="number" class="form-control form-control-sm houseboat-inclusion-children"
                       value="0" min="0" max="50">
            </div>
        </div>

        <div class="mt-2 p-2 bg-light rounded">
            <div class="d-flex justify-content-between align-items-center">
                <small class="text-muted">
                    <i class="fas fa-calculator me-1"></i>Price:
                </small>
                <strong class="text-success houseboat-inclusion-price">â‚¹0.00</strong>
            </div>
        </div>
    </div>
</template>



<!-- âœ… STANDALONE INCLUSION BOOKING MODAL - EDITED FOR ITINERARY âœ… -->
<div class="modal fade" id="standaloneInclusionModal" tabindex="-1" aria-hidden="true"
     data-url-edit-prototype="{% url 'update_standalone_inclusion' 9999 %}">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <form method="POST" action="{% url 'create_standalone_inclusion' itinerary.id %}" id="standaloneInclusionForm">
        {% csrf_token %}

        <!-- ITINERARY DATA - EDITED âœ… -->
        <input type="hidden" id="itineraryTravelFrom" value="{{ itinerary.travel_from|date:'Y-m-d' }}">
        <input type="hidden" id="itineraryTravelTo" value="{{ itinerary.travel_to|date:'Y-m-d' }}">
        <input type="hidden" id="itineraryDefaultAdults" value="{{ itinerary.adults|default:'2' }}">
        <input type="hidden" id="itineraryDefaultChildren" value="{{ itinerary.childrens|default:'0' }}">

        <!-- Hidden Fields -->
        <input type="hidden" name="booking_id" id="standaloneBookingId">
        <input type="hidden" name="special_inclusion_id" id="standaloneInclusionId">
        <input type="hidden" name="day_number" id="standaloneDayNumber">

        <!-- Modal Header -->
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title" id="standaloneInclusionModalLabel">
            <i class="fas fa-mountain me-2"></i>Book Standalone Activity/Service
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>

        <!-- Modal Body -->
        <div class="modal-body">

          <!-- Activity Name Display -->
          <div class="alert alert-info mb-3">
            <strong><i class="fas fa-info-circle me-2"></i>Activity:</strong>
            <span id="standaloneInclusionName" class="fs-5">N/A</span>
          </div>

          <!-- Booking Date & Time -->
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="standaloneBookingDate" class="form-label fw-semibold">
                <i class="fas fa-calendar-alt me-1"></i>Booking Date *
              </label>
              <input type="date"
                     name="booking_date"
                     id="standaloneBookingDate"
                     class="form-control"
                     min="{{ itinerary.travel_from|date:'Y-m-d' }}"
                     max="{{ itinerary.travel_to|date:'Y-m-d' }}"
                     required>
              <small class="text-muted">Within itinerary dates</small>
            </div>
            <div class="col-md-6">
              <label for="standaloneBookingTime" class="form-label fw-semibold">
                <i class="fas fa-clock me-1"></i>Booking Time
              </label>
              <input type="time"
                     name="booking_time"
                     id="standaloneBookingTime"
                     class="form-control">
              <small class="text-muted">Optional</small>
            </div>
          </div>

          <!-- Participants -->
          <div class="border p-3 rounded bg-light mb-3">
            <h6 class="mb-3 fw-bold">
              <i class="fas fa-users me-2 text-primary"></i>Participants
            </h6>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="standaloneNumAdults" class="form-label fw-semibold">
                  <i class="fas fa-user me-1"></i>Number of Adults *
                </label>
                <input type="number"
                       name="num_adults"
                       id="standaloneNumAdults"
                       class="form-control"
                       min="0"
                       value="1"
                       onchange="calculateStandalonePrice()"
                       required>
              </div>
              <div class="col-md-6 mb-3">
                <label for="standaloneNumChildren" class="form-label fw-semibold">
                  <i class="fas fa-child me-1"></i>Number of Children
                </label>
                <input type="number"
                       name="num_children"
                       id="standaloneNumChildren"
                       class="form-control"
                       min="0"
                       value="0"
                       onchange="calculateStandalonePrice()">
              </div>
            </div>
          </div>

          <!-- Pricing Information (Auto-calculated) -->
          <div class="border p-3 rounded bg-white mb-3" id="standalonePricingInfo" style="display: none;">
            <h6 class="mb-3 fw-bold">
              <i class="fas fa-calculator me-2 text-success"></i>Pricing Breakdown
            </h6>
            <div class="pricing-breakdown">
              <div class="d-flex justify-content-between mb-2">
                <span><i class="fas fa-user me-1 text-primary"></i>Adults (<span id="adultCount">0</span> Ã— â‚¹<span id="adultUnitPrice">0.00</span>):</span>
                <strong class="text-success">â‚¹<span id="adultTotal">0.00</span></strong>
              </div>
              <div class="d-flex justify-content-between mb-2">
                <span><i class="fas fa-child me-1 text-info"></i>Children (<span id="childCount">0</span> Ã— â‚¹<span id="childUnitPrice">0.00</span>):</span>
                <strong class="text-success">â‚¹<span id="childTotal">0.00</span></strong>
              </div>
              <hr class="my-2">
              <div class="d-flex justify-content-between">
                <strong class="text-dark fs-5"><i class="fas fa-rupee-sign me-1"></i>Total Amount:</strong>
                <strong class="text-success fs-4">â‚¹<span id="totalAmount">0.00</span></strong>
              </div>
            </div>
            <div class="alert alert-info mt-3 mb-0">
              <small><i class="fas fa-info-circle me-1"></i>Markup will be applied in the pricing section</small>
            </div>
          </div>

          <!-- Notes -->
          <div class="mb-3">
            <label for="standaloneNotes" class="form-label fw-semibold">
              <i class="fas fa-sticky-note me-1"></i>Special Notes (Optional)
            </label>
            <textarea name="notes"
                      id="standaloneNotes"
                      class="form-control"
                      rows="3"
                      placeholder="Any special instructions, requirements, or preferences...">
            </textarea>
          </div>

        </div>

        <!-- Modal Footer -->
        <div class="modal-footer bg-light">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="fas fa-times me-1"></i>Cancel
          </button>
          <button type="submit" class="btn btn-success">
            <i class="fas fa-check-circle me-1"></i>Confirm Booking
          </button>
        </div>
      </form>
    </div>
  </div>
</div>


<!-- âœ… BULK DELETE HOTELS MODAL -->
<div class="modal fade" id="bulkDeleteHotelsModal" tabindex="-1" aria-labelledby="bulkDeleteHotelsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="bulkDeleteHotelsModalLabel">
                    <i class="fas fa-trash-alt me-2"></i>Delete Hotel Bookings
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <form method="post" action="{% url 'bulk_delete_hotels' itinerary.id %}">
                {% csrf_token %}

                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Warning:</strong> Selected hotels will be permanently deleted from ALL days. This action cannot be undone.
                    </div>

                    <!-- Hotels List Grouped by Day -->
                    <div class="table-responsive">
                        <table class="table table-hover table-sm">
                            <thead class="table-light">
                                <tr>
                                    <th width="40">
                                        <input type="checkbox" class="form-check-input" id="selectAllHotels">
                                    </th>
                                    <th width="60">Day</th>
                                    <th>Hotel Name</th>
                                    <th>Check-in</th>
                                    <th>Check-out</th>
                                    <th>Rooms</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for day_num, day_data in saved_items_by_day.items %}
                                    {% if day_data.hotel_bookings %}
                                        {% for booking in day_data.hotel_bookings %}
                                        <tr>
                                            <td>
                                                <input type="checkbox"
                                                       class="form-check-input hotel-checkbox"
                                                       name="hotel_ids"
                                                       value="{{ booking.id }}">
                                            </td>
                                            <td>
                                                <span class="badge bg-primary">Day {{ day_num }}</span>
                                            </td>
                                            <td>
                                                <strong>{{ booking.hotel.name }}</strong>
                                                <br><small class="text-muted">{{ booking.hotel.destination.name }}</small>
                                            </td>
                                            <td><small>{{ booking.check_in_date|date:"d M" }}</small></td>
                                            <td><small>{{ booking.check_out_date|date:"d M" }}</small></td>
                                            <td><span class="badge bg-success">{{ booking.num_double_beds }}</span></td>
                                        </tr>
                                        {% endfor %}
                                    {% endif %}
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Selection Summary -->
                    <div class="mt-3 p-3 bg-light rounded">
                        <strong><span id="hotelSelectionCount">0</span></strong> hotel booking(s) selected for deletion
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Cancel
                    </button>
                    <button type="submit"
                            class="btn btn-danger"
                            id="deleteHotelsBtn"
                            disabled>
                        <i class="fas fa-trash me-2"></i>Delete Selected Hotels
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- âœ… BULK DELETE ACTIVITIES MODAL -->
<div class="modal fade" id="bulkDeleteActivitiesModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title">
                    <i class="fas fa-trash-alt me-2"></i>Delete Activity Bookings
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <form method="post" action="{% url 'bulk_delete_activities' itinerary.id %}">
                {% csrf_token %}

                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Warning:</strong> Selected activities will be permanently deleted from ALL days.
                    </div>

                    <div class="table-responsive">
                        <table class="table table-hover table-sm">
                            <thead class="table-light">
                                <tr>
                                    <th width="40">
                                        <input type="checkbox" class="form-check-input" id="selectAllActivities">
                                    </th>
                                    <th width="60">Day</th>
                                    <th>Activity Name</th>
                                    <th>Date</th>
                                    <th>Time</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for day_num, day_data in saved_items_by_day.items %}
                                    {% if day_data.activity_bookings %}
                                        {% for booking in day_data.activity_bookings %}
                                        <tr>
                                            <td>
                                                <input type="checkbox"
                                                       class="form-check-input activity-checkbox"
                                                       name="activity_ids"
                                                       value="{{ booking.id }}">
                                            </td>
                                            <td>
                                                <span class="badge bg-primary">Day {{ day_num }}</span>
                                            </td>
                                            <td>
                                                <strong>{{ booking.activity.name }}</strong>
                                                <br><small class="text-muted">{{ booking.activity.destination.name }}</small>
                                            </td>
                                            <td><small>{{ booking.booking_date|date:"d M Y" }}</small></td>
                                            <td><small>{{ booking.activity_time|default:"--" }}</small></td>
                                        </tr>
                                        {% endfor %}
                                    {% endif %}
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <div class="mt-3 p-3 bg-light rounded">
                        <strong><span id="activitySelectionCount">0</span></strong> activity booking(s) selected
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning text-dark" id="deleteActivitiesBtn" disabled>
                        <i class="fas fa-trash me-2"></i>Delete Selected Activities
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- âœ… BULK DELETE HOUSEBOATS MODAL -->
<div class="modal fade" id="bulkDeleteHouseboatsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">
                    <i class="fas fa-trash-alt me-2"></i>Delete Houseboat Bookings
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <form method="post" action="{% url 'bulk_delete_houseboats' itinerary.id %}">
                {% csrf_token %}

                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Warning:</strong> Selected houseboats will be permanently deleted from ALL days.
                    </div>

                    <div class="table-responsive">
                        <table class="table table-hover table-sm">
                            <thead class="table-light">
                                <tr>
                                    <th width="40">
                                        <input type="checkbox" class="form-check-input" id="selectAllHouseboats">
                                    </th>
                                    <th width="60">Day</th>
                                    <th>Houseboat Name</th>
                                    <th>Check-in</th>
                                    <th>Check-out</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for day_num, day_data in saved_items_by_day.items %}
                                    {% if day_data.houseboat_bookings %}
                                        {% for booking in day_data.houseboat_bookings %}
                                        <tr>
                                            <td>
                                                <input type="checkbox"
                                                       class="form-check-input houseboat-checkbox"
                                                       name="houseboat_ids"
                                                       value="{{ booking.id }}">
                                            </td>
                                            <td>
                                                <span class="badge bg-primary">Day {{ day_num }}</span>
                                            </td>
                                            <td>
                                                <strong>{{ booking.houseboat.name }}</strong>
                                                <br><small class="text-muted">{{ booking.houseboat.destination.name }}</small>
                                            </td>
                                            <td><small>{{ booking.check_in_date|date:"d M" }}</small></td>
                                            <td><small>{{ booking.check_out_date|date:"d M" }}</small></td>
                                        </tr>
                                        {% endfor %}
                                    {% endif %}
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <div class="mt-3 p-3 bg-light rounded">
                        <strong><span id="houseboatSelectionCount">0</span></strong> houseboat booking(s) selected
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-info text-white" id="deleteHouseboatsBtn" disabled>
                        <i class="fas fa-trash me-2"></i>Delete Selected Houseboats
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>


<!-- âœ… BULK DELETE DAY ITINERARIES MODAL -->
<div class="modal fade" id="bulkDeleteItinerariesModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-trash-alt me-2"></i>Delete Day Itineraries
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <form method="post" action="{% url 'bulk_delete_day_itineraries' itinerary.id %}">
                {% csrf_token %}

                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Warning:</strong> Selected day itineraries will be permanently deleted from ALL days.
                    </div>

                    <div class="table-responsive">
                        <table class="table table-hover table-sm">
                            <thead class="table-light">
                                <tr>
                                    <th width="40">
                                        <input type="checkbox" class="form-check-input" id="selectAllItineraries">
                                    </th>
                                    <th width="60">Day</th>
                                    <th>Itinerary Title</th>
                                    <th>Description</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for day_num, day_data in saved_items_by_day.items %}
                                    {% if day_data.day_plan and day_data.day_plan.title %}
                                    <tr>
                                        <td>
                                            <input type="checkbox"
                                                   class="form-check-input itinerary-checkbox"
                                                   name="day_plan_ids"
                                                   value="{{ day_data.day_plan.id }}">
                                        </td>
                                        <td>
                                            <span class="badge bg-primary">Day {{ day_num }}</span>
                                        </td>
                                        <td>
                                            <strong>{{ day_data.day_plan.title }}</strong>
                                        </td>
                                        <td>
                                            <small class="text-muted">
                                                {{ day_data.day_plan.description|truncatewords:10|default:"No description" }}
                                            </small>
                                        </td>
                                    </tr>
                                    {% endif %}
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <div class="mt-3 p-3 bg-light rounded">
                        <strong><span id="itinerarySelectionCount">0</span></strong> day itinerary/ies selected
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="deleteItinerariesBtn" disabled>
                        <i class="fas fa-trash me-2"></i>Delete Selected Day Plans
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>


<!-- âœ… BULK DELETE VEHICLES MODAL -->
<div class="modal fade" id="bulkDeleteVehiclesModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-secondary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-trash-alt me-2"></i>Delete Vehicle Bookings
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <form method="post" action="{% url 'bulk_delete_vehicles' itinerary.id %}">
                {% csrf_token %}

                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Warning:</strong> Selected vehicles will be permanently deleted from ALL days.
                    </div>

                    <div class="table-responsive">
                        <table class="table table-hover table-sm">
                            <thead class="table-light">
                                <tr>
                                    <th width="40">
                                        <input type="checkbox" class="form-check-input" id="selectAllVehicles">
                                    </th>
                                    <th width="60">Day</th>
                                    <th>Vehicle Name</th>
                                    <th>Type</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for day_num, day_data in saved_items_by_day.items %}
                                    {% if day_data.vehicle_bookings %}
                                        {% for booking in day_data.vehicle_bookings %}
                                        <tr>
                                            <td>
                                                <input type="checkbox"
                                                       class="form-check-input vehicle-checkbox"
                                                       name="vehicle_ids"
                                                       value="{{ booking.id }}">
                                            </td>
                                            <td>
                                                <span class="badge bg-primary">Day {{ day_num }}</span>
                                            </td>
                                            <td><strong>{{ booking.vehicle.name }}</strong></td>
                                            <td><small>{{ booking.vehicle.vehicle_type }}</small></td>
                                        </tr>
                                        {% endfor %}
                                    {% endif %}
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <div class="mt-3 p-3 bg-light rounded">
                        <strong><span id="vehicleSelectionCount">0</span></strong> vehicle booking(s) selected
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-secondary" id="deleteVehiclesBtn" disabled>
                        <i class="fas fa-trash me-2"></i>Delete Selected Vehicles
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>





<!-- PREVIEW DAY ITINERARY MODAL - Before Adding -->
<div class="modal fade" id="previewDayItineraryModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-route me-2"></i>Preview Day Itinerary
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Itinerary Image -->
                <div id="previewItineraryImageContainer" style="display: none;" class="text-center mb-4">
                    <img id="previewItineraryImage" src="" alt="Itinerary Image"
                         class="img-fluid rounded shadow" style="max-height: 350px; object-fit: cover;">
                </div>

                <!-- Itinerary Title -->
                <div class="mb-4">
                    <label class="form-label fw-bold text-primary">
                        <i class="fas fa-heading me-2"></i>Title
                    </label>
                    <div class="p-3 bg-light rounded border">
                        <h5 id="previewItineraryTitle" class="mb-0"></h5>
                    </div>
                </div>

                <!-- Itinerary Description -->
                <div class="mb-4">
                    <label class="form-label fw-bold text-primary">
                        <i class="fas fa-file-alt me-2"></i>Description
                    </label>
                    <div class="p-3 bg-light rounded border" style="max-height: 300px; overflow-y: auto;">
                        <p id="previewItineraryDescription" class="mb-0" style="white-space: pre-line;"></p>
                    </div>
                </div>

                <!-- Day Information -->
                <div class="alert alert-success mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>This itinerary will be added to Day <span id="previewDayNumber"></span></strong>
                </div>

                <!-- Hidden Form for Submission -->
                <form method="post" id="addDayItineraryForm" style="display: none;">
                    {% csrf_token %}
                    <input type="hidden" name="form_type" value="select_day_itinerary">
                    <input type="hidden" name="day_number" id="previewDayNumberInput">
                    <input type="hidden" name="day_itinerary_id" id="previewItineraryIdInput">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-arrow-left me-2"></i>Back
                </button>
                <button type="button" class="btn btn-success" onclick="confirmAddDayItinerary()">
                    <i class="fas fa-check me-2"></i>OK, Add to Day
                </button>
            </div>
        </div>
    </div>
</div>


<!-- EDIT DAY DISPLAY MODAL (wider, taller, with image support) -->
<div class="modal fade" id="editDayDisplayModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg edit-day-modal">
        <div class="modal-content">
            <form method="post" enctype="multipart/form-data" id="editDayDisplayForm">
                {% csrf_token %}
                <input type="hidden" name="form_type" value="edit_day_details">
                <input type="hidden" name="day_number" id="editDayNumberInput">
                <input type="hidden" name="remove_image" id="editRemoveImageFlag" value="0">

                <div class="modal-header bg-secondary text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-edit me-2"></i>
                        Edit Day <span id="editDayNumberLabel"></span> Itinerary
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                    <!-- Title -->
                    <div class="mb-3">
                        <label class="form-label fw-semibold">
                            <i class="fas fa-heading me-2 text-primary"></i>Title
                        </label>
                        <input type="text"
                               name="title"
                               id="editDayTitleInput"
                               class="form-control"
                               placeholder="e.g., Arrival at Kochi - Sightseeing"
                               required>
                    </div>

                    <!-- Description -->
                    <div class="mb-3">
                        <label class="form-label fw-semibold">
                            <i class="fas fa-file-alt me-2 text-primary"></i>Description
                        </label>
                        <textarea name="description"
                                  id="editDayDescriptionInput"
                                  class="form-control"
                                  rows="8"
                                  style="min-height: 220px;"
                                  placeholder="Detailed itinerary for this day..."></textarea>
                    </div>

                    <!-- âœ… IMAGE SECTION -->
                    <div class="mb-3">
                        <label class="form-label fw-semibold">
                            <i class="fas fa-image me-2 text-primary"></i>Itinerary Image
                        </label>

                        <!-- Current Image Preview -->
                        <div id="editCurrentImagePreview" class="mb-3" style="display: none;">
                            <div class="card border-primary">
                                <div class="card-header bg-light py-2">
                                    <small class="text-muted fw-semibold">
                                        <i class="fas fa-image me-1"></i>Current Image
                                    </small>
                                </div>
                                <div class="card-body p-2">
                                    <div class="d-flex align-items-center gap-3">
                                        <img id="editCurrentImageThumbnail"
                                             src=""
                                             alt="Current"
                                             class="rounded border shadow-sm"
                                             style="width: 100px; height: 100px; object-fit: cover;">
                                        <div class="flex-grow-1">
                                            <button type="button"
                                                    class="btn btn-sm btn-danger"
                                                    id="editRemoveCurrentImageBtn"
                                                    onclick="removeEditCurrentImage()">
                                                <i class="fas fa-trash me-1"></i>Remove Image
                                            </button>
                                            <small class="text-muted d-block mt-2">
                                                Click to remove the current image
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Upload New Image -->
                        <div class="mb-2">
                            <input type="file"
                                   class="form-control"
                                   id="editDayImageInput"
                                   name="image"
                                   accept="image/jpeg,image/jpg,image/png,image/webp"
                                   onchange="previewEditNewImage(event)">
                            <small class="text-muted d-block mt-1">
                                <i class="fas fa-info-circle me-1"></i>
                                Upload JPG, PNG, or WebP (max 5MB). New upload replaces current image.
                            </small>
                        </div>

                        <!-- New Image Preview -->
                        <div id="editNewImagePreview" class="mt-2" style="display: none;">
                            <div class="card border-success">
                                <div class="card-header bg-light py-2">
                                    <small class="text-success fw-semibold">
                                        <i class="fas fa-check-circle me-1"></i>New Image Preview
                                    </small>
                                </div>
                                <div class="card-body p-2 text-center">
                                    <img id="editNewImageThumbnail"
                                         src=""
                                         alt="Preview"
                                         class="img-fluid rounded border shadow-sm"
                                         style="max-height: 250px; max-width: 100%;">
                                    <button type="button"
                                            class="btn btn-sm btn-outline-secondary mt-2"
                                            onclick="clearEditNewImage()">
                                        <i class="fas fa-times me-1"></i>Clear
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Info Alert -->
                    <div class="alert alert-info mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Note:</strong> Changes apply only to this specific day.
                        The original template remains unchanged.
                    </div>
                </div>

                <div class="modal-footer bg-light">
                    <button type="button"
                            class="btn btn-outline-secondary"
                            data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Cancel
                    </button>
                    <button type="submit"
                            class="btn btn-success">
                        <i class="fas fa-save me-1"></i>Save for this Day
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>




<script>
function enableHotelChangeMode() {
    console.log('ðŸ”„ Enabling hotel change mode...');

    const bookingId = document.getElementById('modalBookingId').value;
    console.log('ðŸ“‹ Booking ID:', bookingId);

    if (!bookingId) {
        console.error('âŒ No booking ID found!');
        alert('Error: Booking ID not found. Please close and reopen the modal.');
        return;
    }

    // UI Updates
    document.getElementById('modalHotelName').style.display = 'none';
    document.getElementById('hotelChangeContainer').style.display = 'block';
    document.getElementById('btnEnableHotelChange').style.display = 'none';
    document.getElementById('isHotelChange').value = 'true';

    console.log('âœ… UI updated - container visible');

    // Fetch available hotels
    const select = document.getElementById('modalHotelNameDropdown');

    if (!select) {
        console.error('âŒ Dropdown element not found!');
        return;
    }

    select.innerHTML = '<option value="">â³ Loading available hotels...</option>';
    console.log('ðŸ” Fetching hotels from server...');

    // Call the View you created in Step 1
    const url = `{% url 'get_available_hotels_for_change' %}?booking_id=${bookingId}`;
    console.log('ðŸŒ Fetch URL:', url);

    fetch(url)
        .then(response => {
            console.log('ðŸ“¡ Response status:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('âœ… Data received:', data);

            select.innerHTML = '<option value="">-- Select New Hotel --</option>';

            if (data.hotels && data.hotels.length > 0) {
                console.log(`ðŸ“‹ Found ${data.hotels.length} hotels`);

                data.hotels.forEach(hotel => {
                    const option = document.createElement('option');
                    option.value = hotel.id;
                    option.textContent = `${hotel.name} (${hotel.category})`;
                    select.appendChild(option);
                });

                console.log('âœ… Dropdown populated successfully');

                // Update hint
                document.getElementById('hotelFieldHint').innerHTML =
                    `<i class="fas fa-check-circle text-success me-1"></i>${data.hotels.length} hotel(s) found. Select one to change.`;
            } else {
                console.warn('âš ï¸ No hotels found');
                select.innerHTML = '<option value="">âŒ No other hotels with pricing found</option>';
                select.disabled = true;

                document.getElementById('hotelFieldHint').innerHTML =
                    '<i class="fas fa-exclamation-triangle text-warning me-1"></i>No alternative hotels available for these dates';
            }
        })
        .catch(error => {
            console.error('âŒ Fetch error:', error);
            select.innerHTML = `<option value="">âš ï¸ Error: ${error.message}</option>`;
            select.disabled = true;

            document.getElementById('hotelFieldHint').innerHTML =
                `<i class="fas fa-times-circle text-danger me-1"></i>Error loading hotels. Check console for details.`;

            // Show user-friendly alert
            alert(`Failed to load available hotels:\n\n${error.message}\n\nPlease check:\n1. URL configuration in urls.py\n2. View function exists\n3. Database has hotels with pricing`);
        });
}
function handleHotelChange(selectElement) {
    const newHotelId = selectElement.value;
    const checkIn = document.getElementById('checkinDate').value;
    const checkOut = document.getElementById('checkoutDate').value;

    console.log('ðŸ”„ Hotel changed to ID:', newHotelId);

    if (!newHotelId) {
        document.getElementById('modalHotelId').value = '';
        document.getElementById('hotelCategory').value = '';
        document.getElementById('hotelFieldHint').innerHTML =
            '<i class="fas fa-info-circle me-1"></i>Select a hotel to continue';
        return;
    }

    // Update Hidden Hotel ID
    document.getElementById('modalHotelId').value = newHotelId;
    document.getElementById('isHotelChange').value = 'true';

    // âœ… SWITCH FORM ACTION TO CHANGE HOTEL VIEW
    const form = document.getElementById('hotelBookingForm');
    form.action = "{% url 'change_hotel_booking' %}";
    console.log('ðŸ”€ Form action switched to:', form.action);

    // Get selected option details
    const selectedOption = selectElement.options[selectElement.selectedIndex];
    const hotelText = selectedOption.textContent;

    // Visual feedback
    document.getElementById('hotelFieldHint').innerHTML =
        `<i class="fas fa-check-circle text-success me-1"></i>Selected: <strong>${hotelText}</strong>`;

    // Load room types and meal plans for the new hotel
    if (checkIn && checkOut && newHotelId) {
        console.log('ðŸ“‹ Loading room types for new hotel...');
        BookingSystem.loadHotelRoomTypes(newHotelId, checkIn, checkOut);
    }

    console.log('âœ… Hotel change registered');
}
</script>

<script>
    // ============================================================
    // âœ… 1. TOGGLE FUNCTION: SWITCH BETWEEN DEMO & DB MODES
    // ============================================================
    function toggleHotelInputMode() {
        const selectContainer = document.getElementById('hotelSelectContainer');
        const inputContainer = document.getElementById('hotelInputContainer');
        const toggleBtn = document.getElementById('toggleDemoHotelBtn');
        const isDemoInput = document.getElementById('isDemoMode');
        
        const dropdown = document.getElementById('modalHotelNameDropdown');
        const customInput = document.getElementById('modalCustomHotelName');
        const hiddenHotelId = document.getElementById('modalHotelId');
        
        const destinationId = document.getElementById('modalDestination').value;
        const checkIn = document.getElementById('checkinDate').value;
        const checkOut = document.getElementById('checkoutDate').value;

        if (selectContainer.style.display !== 'none') {
            // ðŸ‘‰ SWITCHING TO: DEMO MODE (Text Box)
            console.log("ðŸ”„ Switching to Demo Mode");
            selectContainer.style.display = 'none';
            inputContainer.style.display = 'block';
            
            toggleBtn.innerHTML = '<i class="fas fa-list me-1"></i> Select Real Hotel';
            toggleBtn.classList.remove('btn-outline-warning');
            toggleBtn.classList.add('btn-outline-primary');
            
            isDemoInput.value = 'true';
            hiddenHotelId.value = ""; 
            
            dropdown.value = ""; 
            dropdown.removeAttribute('required'); 
            customInput.setAttribute('required', 'true'); 
            
            unlockDropdownsForDemo();
        } else {
            // ðŸ‘ˆ SWITCHING BACK TO: DATABASE MODE (Dropdown)
            console.log("ðŸ”„ Switching back to Database Mode");
            selectContainer.style.display = 'block';
            inputContainer.style.display = 'none';
            
            toggleBtn.innerHTML = '<i class="fas fa-magic me-1"></i> Use Demo Hotel';
            toggleBtn.classList.add('btn-outline-warning');
            toggleBtn.classList.remove('btn-outline-primary');
            
            isDemoInput.value = 'false';
            
            customInput.value = ""; 
            customInput.removeAttribute('required');
            dropdown.setAttribute('required', 'true');
            
            if (dropdown.options.length <= 1 && destinationId) {
                console.log("ðŸ” Fetching hotels for Destination ID:", destinationId);
                const hint = document.getElementById('hotelFieldHint');
                if(hint) hint.innerHTML = '<i class="fas fa-sync fa-spin me-1"></i>Loading hotels...';
                
                if (typeof BookingSystem !== 'undefined') {
                     BookingSystem.loadHotelsByMode('master', destinationId, checkIn, checkOut);
                }
            }
        }
    }

    // ============================================================
    // âœ… 2. UNLOCK HELPER: GENERIC OPTIONS FOR DEMO
    // ============================================================
    function unlockDropdownsForDemo() {
        const roomSelect = document.getElementById('roomType');
        const mealSelect = document.getElementById('mealPlan');
        
        if(roomSelect) {
            roomSelect.disabled = false;
            roomSelect.innerHTML = `
                <option value="">-- Select Room Category --</option>
                <option value="1">Standard Room</option>
                <option value="2">Deluxe Room</option>
                <option value="3">Super Deluxe</option>
                <option value="4">Premium Room</option>
                <option value="5">Suite</option>
            `; 
        }
        
        if(mealSelect) {
            mealSelect.disabled = false;
            mealSelect.innerHTML = `
                <option value="">-- Select Meal Plan --</option>
                <option value="1">CPAI (Breakfast Only)</option>
                <option value="2">MAPAI (Breakfast + Dinner)</option>
                <option value="3">APAI (All Meals)</option>
            `;
        }
    }

    // ============================================================
    // âœ… 3. EDIT HOTEL FUNCTION (FIXED FOR MANUAL ROOM TYPE)
    // ============================================================
    function editHotelBooking(bookingId, auto_show_dropdown = true) {
        console.log('ðŸ“ Opening hotel booking for edit:', bookingId);
        
        // 1. Find the button using data attribute
        const button = document.querySelector(`button[data-booking-id="${bookingId}"][data-item-type="hotel"]`) || 
                       document.querySelector(`button[data-booking-id="${bookingId}"]`);
        
        if (!button) {
            console.error('âŒ Button not found for booking ID:', bookingId);
            return;
        }
        
        // 2. Extract Data
        const dataset = button.dataset;
        const isDemo = button.getAttribute('data-is-demo') === 'true'; 
        const customName = button.getAttribute('data-custom-hotel-name') || '';
        
        // ðŸ”¥ CRITICAL: Extract Custom Room Type
        const customRoomType = button.getAttribute('data-custom-room-type') || '';
        console.log("ðŸ” Custom Room Type Found:", customRoomType);

        // 3. Populate Form via BookingSystem (Base Data)
        if (typeof BookingSystem !== 'undefined') {
            BookingSystem.open('hotel', {
                bookingId: bookingId,
                hotelId: dataset.hotelId,
                hotelName: dataset.hotelName,
                destinationId: dataset.destinationId,
                destinationName: dataset.destinationName,
                dayNumber: dataset.dayNumber,
                checkIn: dataset.checkIn,
                checkInTime: dataset.checkInTime,
                checkOut: dataset.checkOut,
                checkOutTime: dataset.checkOutTime,
                category: dataset.category,
                option: dataset.option,
                roomTypeId: customRoomType ? null : dataset.roomTypeId, // Pass null if manual
                mealPlanId: dataset.mealPlanId,
                numDoubleBeds: dataset.numDoubleBeds,
                extraBeds: dataset.extraBeds,
                childWithBed: dataset.childWithBed,
                childWithoutBed: dataset.childWithoutBed
            }, true);
        }

        // 4. Handle Demo vs Real Hotel Mode
        const selectContainer = document.getElementById('hotelSelectContainer');
        const inputContainer = document.getElementById('hotelInputContainer');
        const toggleBtn = document.getElementById('toggleDemoHotelBtn');
        const demoInput = document.getElementById('modalCustomHotelName');
        const demoHidden = document.getElementById('isDemoMode');
        const dropdown = document.getElementById('modalHotelNameDropdown');
        const hotelIdInput = document.getElementById('modalHotelId');

        if (isDemo) {
            // Demo Mode Logic
            selectContainer.style.display = 'none';
            inputContainer.style.display = 'block';
            demoInput.value = customName;
            demoHidden.value = 'true';
            hotelIdInput.value = ""; 
            
            toggleBtn.innerHTML = '<i class="fas fa-list me-1"></i> Select Real Hotel';
            toggleBtn.classList.remove('btn-outline-warning');
            toggleBtn.classList.add('btn-outline-primary');
            
            dropdown.removeAttribute('required');
            demoInput.setAttribute('required', 'true');
            
            if (typeof unlockDropdownsForDemo === 'function') unlockDropdownsForDemo();

            // Restore dropdown values if NOT in manual mode
            setTimeout(() => {
                if(!customRoomType && dataset.roomTypeId) {
                     document.getElementById('roomType').value = dataset.roomTypeId;
                }
                if(dataset.mealPlanId) document.getElementById('mealPlan').value = dataset.mealPlanId;
            }, 100);

        } else {
            // Real Hotel Logic
            selectContainer.style.display = 'block';
            inputContainer.style.display = 'none';
            demoHidden.value = 'false';
            
            toggleBtn.innerHTML = '<i class="fas fa-magic me-1"></i> Use Demo Hotel';
            toggleBtn.classList.add('btn-outline-warning');
            toggleBtn.classList.remove('btn-outline-primary');
            
            dropdown.setAttribute('required', 'true');
            demoInput.removeAttribute('required');

            if (dropdown) {
                dropdown.disabled = false;
                dropdown.innerHTML = `<option value="${dataset.hotelId}" selected>${dataset.hotelName} (Current)</option>`;
                
                fetch(`{% url 'get_available_hotels_for_change' %}?booking_id=${bookingId}`)
                    .then(r => r.json())
                    .then(d => {
                        if (d.hotels && d.hotels.length > 0) {
                            dropdown.innerHTML = '<option value="">-- Change Hotel --</option>';
                            if (!d.hotels.some(h => h.id == dataset.hotelId)) {
                                 dropdown.innerHTML += `<option value="${dataset.hotelId}" selected>${dataset.hotelName} (Current)</option>`;
                            }
                            d.hotels.forEach(h => {
                                const sel = h.id == dataset.hotelId ? 'selected' : '';
                                dropdown.innerHTML += `<option value="${h.id}" ${sel}>${h.name} (${h.category})</option>`;
                            });
                        }
                    })
                    .catch(e => console.error(e));
            }
            
            // Trigger Room Load ONLY if not manual
            if (dataset.hotelId && dataset.checkIn && dataset.checkOut && !customRoomType) {
                if(typeof BookingSystem !== 'undefined') {
                    BookingSystem.loadHotelRoomTypes(
                        dataset.hotelId, dataset.checkIn, dataset.checkOut, dataset.roomTypeId, dataset.mealPlanId
                    );
                }
            }
        }
        
        // 5. Show Modal
        const modal = document.getElementById('hotelBookingModal');
        const bsModal = new bootstrap.Modal(modal);
        
        // ðŸ”¥ CRITICAL FIX: Apply manual room type in multiple stages to handle async operations
        
        // Stage 1: Immediate application when modal starts showing
        modal.addEventListener('shown.bs.modal', function handleRoomTypeImmediate() {
            console.log("ðŸŽ¯ Stage 1: Modal shown, applying room type immediately");
            applyManualRoomType(customRoomType);
        }, { once: true });
        
        // Stage 2: Re-apply after delay to override any async BookingSystem operations
        modal.addEventListener('shown.bs.modal', function handleRoomTypeDelayed() {
            setTimeout(() => {
                console.log("ðŸŽ¯ Stage 2: Re-applying room type after delay");
                applyManualRoomType(customRoomType);
            }, 200); // Wait for BookingSystem async operations
        }, { once: true });
        
        // Helper function to apply manual room type settings
        function applyManualRoomType(customRoomTypeValue) {
            const roomSelectContainer = document.getElementById('roomSelectContainer');
            const roomInputContainer = document.getElementById('roomInputContainer');
            const roomInput = document.getElementById('customRoomType');
            const roomSelect = document.getElementById('roomType');
            const roomToggleText = document.getElementById('roomToggleText');
            
            if (customRoomTypeValue && customRoomTypeValue.trim() !== "") {
                // ðŸ‘‰ Show Manual Input & Set Value
                console.log("âš¡ Applying Manual Room Type:", customRoomTypeValue);
                
                if(roomSelectContainer) roomSelectContainer.style.display = 'none';
                if(roomInputContainer) roomInputContainer.style.display = 'block';
                
                if(roomInput) {
                    roomInput.value = customRoomTypeValue;
                    roomInput.setAttribute('required', 'true');
                }
                if(roomSelect) {
                    roomSelect.removeAttribute('required');
                    roomSelect.value = "";
                }
                if(roomToggleText) {
                    roomToggleText.innerHTML = '<i class="fas fa-list"></i> Select from List';
                    roomToggleText.classList.add('text-danger');
                }
                
                console.log("âœ… Manual room type applied!");
            } else {
                // ðŸ‘ˆ Show Dropdown (Default)
                console.log("ðŸ‘‰ Using standard dropdown mode");
                
                if(roomSelectContainer) roomSelectContainer.style.display = 'block';
                if(roomInputContainer) roomInputContainer.style.display = 'none';
                if(roomToggleText) {
                    roomToggleText.innerHTML = '<i class="fas fa-pen"></i> Type Manually';
                    roomToggleText.classList.remove('text-danger');
                }
            }
        }
        
        bsModal.show();
    }

    // ============================================================
    // âœ… 4. TOGGLE ROOM TYPE (Select vs Manual)
    // ============================================================
    function toggleRoomTypeMode() {
        const selectContainer = document.getElementById('roomSelectContainer');
        const inputContainer = document.getElementById('roomInputContainer');
        const select = document.getElementById('roomType');
        const input = document.getElementById('customRoomType');
        const toggleText = document.getElementById('roomToggleText');

        if (selectContainer.style.display !== 'none') {
            // ðŸ‘‰ Switch to Manual Input
            selectContainer.style.display = 'none';
            inputContainer.style.display = 'block';
            
            select.removeAttribute('required');
            select.value = ""; 
            input.setAttribute('required', 'true');
            
            if(toggleText) {
                toggleText.innerHTML = '<i class="fas fa-list"></i> Select from List';
                toggleText.classList.add('text-danger');
            }
        } else {
            // ðŸ‘ˆ Switch back to Dropdown
            selectContainer.style.display = 'block';
            inputContainer.style.display = 'none';
            
            input.removeAttribute('required');
            input.value = ""; 
            select.setAttribute('required', 'true');
            
            if(toggleText) {
                toggleText.innerHTML = '<i class="fas fa-pen"></i> Type Manually';
                toggleText.classList.remove('text-danger');
            }
        }
    }

    // ============================================================
    // 5. RESET LISTENER (Cleanup on Close)
    // ============================================================
    document.addEventListener('DOMContentLoaded', function() {
        const modalElement = document.getElementById('hotelBookingModal');
        
        if (modalElement) {
            modalElement.addEventListener('hidden.bs.modal', function () {
                console.log("ðŸ§¹ Resetting Modal UI");
                const selectContainer = document.getElementById('hotelSelectContainer');
                const inputContainer = document.getElementById('hotelInputContainer');
                const toggleBtn = document.getElementById('toggleDemoHotelBtn');
                const customInput = document.getElementById('modalCustomHotelName');
                const isDemoInput = document.getElementById('isDemoMode');

                // Force display back to Default (Dropdown)
                if(selectContainer) selectContainer.style.display = 'block';
                if(inputContainer) inputContainer.style.display = 'none';
                
                if(toggleBtn) {
                    toggleBtn.innerHTML = '<i class="fas fa-magic me-1"></i> Use Demo Hotel';
                    toggleBtn.classList.add('btn-outline-warning');
                    toggleBtn.classList.remove('btn-outline-primary');
                }
                
                if(customInput) customInput.value = "";
                if(isDemoInput) isDemoInput.value = "false";
                
                // Clear IDs
                document.getElementById('modalBookingId').value = '';
                document.getElementById('modalHotelId').value = '';
                
                // Reset Room Type Mode
                const roomSelect = document.getElementById('roomSelectContainer');
                const roomInput = document.getElementById('roomInputContainer');
                if(roomSelect) roomSelect.style.display = 'block';
                if(roomInput) roomInput.style.display = 'none';
                document.getElementById('customRoomType').value = "";
            });
        }
    });
</script>








<!-- âœ… LOAD CKEDITOR -->
<script src="https://cdn.ckeditor.com/4.16.2/standard/ckeditor.js"></script>

<!-- âœ… PACKAGE TERMS MODAL JAVASCRIPT -->
<script>
let ckEditorInstances = {};

// Initialize CKEditor for modal
function initializeCKEditors() {
    const fields = [
        'package_inclusion',
        'package_exclusion',
        'terms_and_conditions',
        'payment_policy',
        'cancellation_policy',
        'refund_policy',
        'list_of_documents'
    ];

    fields.forEach(fieldId => {
        if (CKEDITOR.instances[fieldId]) {
            CKEDITOR.instances[fieldId].destroy();
        }

        ckEditorInstances[fieldId] = CKEDITOR.replace(fieldId, {
            height: 200,
            versionCheck: false,
            toolbar: [
                ['Bold', 'Italic', 'Underline'],
                ['NumberedList', 'BulletedList'],
                ['Link', 'Unlink'],
                ['RemoveFormat']
            ]
        });
    });
}

// Load package terms
function loadPackageTerms(itineraryId) {
    console.log('Loading terms for itinerary:', itineraryId);

    document.getElementById('itinerary_id').value = itineraryId;
    document.getElementById('termsLoadingSpinner').style.display = 'block';
    document.getElementById('packageTermsForm').style.display = 'none';
    document.getElementById('termsAlertContainer').innerHTML = '';

    fetch(`/itinerary/${itineraryId}/get-package-terms/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Set active status
                document.getElementById('is_active').checked = data.terms.is_active;
                updateToggleDisplay(data.terms.is_active);

                // Initialize CKEditors if not already done
                if (Object.keys(ckEditorInstances).length === 0) {
                    initializeCKEditors();
                }

                // Set CKEditor values
                setTimeout(() => {
                    Object.keys(ckEditorInstances).forEach(fieldId => {
                        if (data.terms[fieldId]) {
                            ckEditorInstances[fieldId].setData(data.terms[fieldId]);
                        }
                    });
                }, 500);

                document.getElementById('termsLoadingSpinner').style.display = 'none';
                document.getElementById('packageTermsForm').style.display = 'block';
            } else {
                showAlert('danger', 'Error loading package terms');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('termsLoadingSpinner').style.display = 'none';
            showAlert('danger', 'Failed to load package terms: ' + error.message);
        });
}

// Save package terms
function savePackageTerms() {
    const itineraryId = document.getElementById('itinerary_id').value;
    const saveBtn = document.getElementById('saveTermsBtn');

    console.log('Saving terms for itinerary:', itineraryId);

    // Disable button and show loading
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Saving...';

    // Collect form data
    const formData = new FormData();
    formData.append('itinerary_id', itineraryId);
    formData.append('is_active', document.getElementById('is_active').checked);
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

    // Get CKEditor data
    Object.keys(ckEditorInstances).forEach(fieldId => {
        formData.append(fieldId, ckEditorInstances[fieldId].getData());
    });

    fetch(`/itinerary/${itineraryId}/save-package-terms/`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        saveBtn.disabled = false;
        saveBtn.innerHTML = '<i class="fas fa-save me-1"></i> Save Changes';

        if (data.success) {
            showAlert('success', 'âœ… ' + data.message);
            setTimeout(() => {
                const modalElement = document.getElementById('packageTermsModal');
                const modal = bootstrap.Modal.getInstance(modalElement);
                if (modal) {
                    modal.hide();
                }
            }, 1500);
        } else {
            showAlert('danger', 'âŒ ' + (data.message || 'Error saving package terms'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        saveBtn.disabled = false;
        saveBtn.innerHTML = '<i class="fas fa-save me-1"></i> Save Changes';
        showAlert('danger', 'âŒ Failed to save package terms: ' + error.message);
    });
}

// Show alert message
function showAlert(type, message) {
    const alertHTML = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    document.getElementById('termsAlertContainer').innerHTML = alertHTML;

    // Auto dismiss success messages
    if (type === 'success') {
        setTimeout(() => {
            const alert = document.querySelector('#termsAlertContainer .alert');
            if (alert) {
                const bsAlert = bootstrap.Alert.getInstance(alert);
                if (bsAlert) {
                    bsAlert.close();
                }
            }
        }, 5000);
    }
}

// Update toggle display
function updateToggleDisplay(isActive) {
    const icon = document.getElementById('statusIcon');
    const text = document.getElementById('statusText');

    if (isActive) {
        icon.className = 'fas fa-check-circle me-2 text-status-active';
        text.textContent = 'Active - Custom Terms Enabled';
        text.className = 'fw-bold text-status-active';
    } else {
        icon.className = 'fas fa-times-circle me-2 text-status-inactive';
        text.textContent = 'Inactive - Using Default Terms';
        text.className = 'fw-bold text-status-inactive';
    }
}

// Initialize toggle listener on page load
document.addEventListener('DOMContentLoaded', function() {
    const toggleElement = document.getElementById('is_active');

    if (toggleElement) {
        // Initialize display
        updateToggleDisplay(toggleElement.checked);

        // Listen for changes
        toggleElement.addEventListener('change', function() {
            updateToggleDisplay(this.checked);
            console.log('Toggle changed to:', this.checked);
        });
    }
});

// Clean up when modal is closed
document.getElementById('packageTermsModal').addEventListener('hidden.bs.modal', function () {
    document.getElementById('termsAlertContainer').innerHTML = '';
});

</script>









<script>
// âœ… Function to populate edit modal with existing data
function editDayItinerary(dayPlanId, dayNumber) {
    console.log('Editing day itinerary:', dayPlanId, dayNumber);

    // Set day number
    document.getElementById('editDayNumberInput').value = dayNumber;
    document.getElementById('editDayNumberLabel').textContent = dayNumber;

    // Reset flags and previews
    document.getElementById('editRemoveImageFlag').value = '0';
    document.getElementById('editNewImagePreview').style.display = 'none';
    document.getElementById('editDayImageInput').value = '';

    // Fetch current day plan data
    fetch(`/itinerary/get-dayplan/${dayPlanId}/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Populate title
                document.getElementById('editDayTitleInput').value = data.title || '';

                // Populate description
                document.getElementById('editDayDescriptionInput').value = data.description || '';

                // Handle current image
                const currentImagePreview = document.getElementById('editCurrentImagePreview');
                const currentImageThumbnail = document.getElementById('editCurrentImageThumbnail');

                if (data.image_url) {
                    currentImageThumbnail.src = data.image_url;
                    currentImagePreview.style.display = 'block';
                } else {
                    currentImagePreview.style.display = 'none';
                }

                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('editDayDisplayModal'));
                modal.show();
            } else {
                alert('Error: ' + (data.error || 'Failed to load day plan'));
            }
        })
        .catch(error => {
            console.error('Fetch error:', error);
            alert('Failed to load day itinerary data');
        });
}

// âœ… Preview new image when selected
function previewEditNewImage(event) {
    const file = event.target.files[0];
    if (file) {
        // Check file size (5MB max)
        if (file.size > 5 * 1024 * 1024) {
            alert('Image size must be less than 5MB');
            event.target.value = '';
            return;
        }

        // Check file type
        const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp'];
        if (!validTypes.includes(file.type)) {
            alert('Please upload a valid image (JPG, PNG, or WebP)');
            event.target.value = '';
            return;
        }

        // Preview image
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('editNewImageThumbnail').src = e.target.result;
            document.getElementById('editNewImagePreview').style.display = 'block';
        };
        reader.readAsDataURL(file);
    }
}

// âœ… Remove current image
function removeEditCurrentImage() {
    if (confirm('Are you sure you want to remove the current image?')) {
        document.getElementById('editRemoveImageFlag').value = '1';
        document.getElementById('editCurrentImagePreview').style.display = 'none';
        alert('Image will be removed when you save.');
    }
}

// âœ… Clear new image selection
function clearEditNewImage() {
    document.getElementById('editDayImageInput').value = '';
    document.getElementById('editNewImagePreview').style.display = 'none';
}
</script>






<script>
// Preview Day Itinerary before adding
function previewDayItinerary(itineraryId, title, description, imageUrl, dayNumber) {
    console.log('Previewing Day Itinerary:', { itineraryId, title, description, imageUrl, dayNumber });

    // Set day number
    document.getElementById('previewDayNumber').textContent = dayNumber;
    document.getElementById('previewDayNumberInput').value = dayNumber;
    document.getElementById('previewItineraryIdInput').value = itineraryId;

    // Set title
    document.getElementById('previewItineraryTitle').textContent = title || 'No title available';

    // Set description
    const descElement = document.getElementById('previewItineraryDescription');
    descElement.textContent = description || 'No description available';

    // Handle image display
    const imageContainer = document.getElementById('previewItineraryImageContainer');
    const imageElement = document.getElementById('previewItineraryImage');

    if (imageUrl && imageUrl.trim() !== '') {
        imageElement.src = imageUrl;
        imageElement.alt = title;
        imageContainer.style.display = 'block';
    } else {
        imageContainer.style.display = 'none';
    }
}

// Confirm and submit the form to add day itinerary
function confirmAddDayItinerary() {
    const form = document.getElementById('addDayItineraryForm');
    if (form) {
        form.submit();
    }
}

function openEditDayDisplay(dayNumber, title, description) {
    document.getElementById('editDayNumberInput').value = dayNumber;
    document.getElementById('editDayNumberLabel').textContent = dayNumber;

    document.getElementById('editDayTitleInput').value = title || '';
    document.getElementById('editDayDescriptionInput').value = description || '';
}

</script>






<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>


<!-- âœ… BACKUP: JavaScript to set destinations if template fails -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Get saved destinations from backend
    const savedDestinations = {
        {% for day_num, day_data in saved_items_by_day.items %}
            {{ day_num }}: {{ day_data.destination.id|default:'null' }},
        {% endfor %}
    };

    // Set each dropdown value
    {% for day in days %}
        const select{{ day }} = document.getElementById('destination-day-{{ day }}');
        if (select{{ day }} && savedDestinations[{{ day }}]) {
            select{{ day }}.value = savedDestinations[{{ day }}];
        }
    {% endfor %}
});
</script>


<script>
// ============================================================
// COMPLETE UNIFIED BOOKING SYSTEM - WITH MASTER BOOKING
// ============================================================

const BookingSystem = {
    config: {
        urls: {
            // AJAX endpoints
            hotelInclusions: '/get-hotel-inclusions/',
            houseboatInclusions: '/get-houseboat-inclusions/',

            // Create URLs
            createHotel: '{% url "create_hotel_booking" itinerary.id %}',
            createActivity: '{% url "create_activity_booking" itinerary.id %}',
            createVehicle: '{% url "create_vehicle_booking" itinerary.id %}',
            createHouseboat: '{% url "create_houseboat_booking" itinerary.id %}',
            createStandalone: '{% url "create_standalone_inclusion" itinerary.id %}',

            // Update URLs
            updateHotel: '/hotel-booking/0/update/',
            updateActivity: '/activity-booking/0/update/',
            updateVehicle: '/vehicle-booking/update/0/',
            updateHouseboat: '/houseboat-booking/0/update/',
            updateStandalone: '/standalone-inclusion/0/update/'
        },
        itinerary: {
            adults: {{ itinerary.adults|default:2 }},
            children: {{ itinerary.childrens|default:0 }},
            infants: {{ itinerary.infants|default:0 }},
            travelFrom: '{{ itinerary.travel_from|date:"Y-m-d" }}',
            travelTo: '{{ itinerary.travel_to|date:"Y-m-d" }}'
        }
    },

    inclusionCounters: {
        hotel: 0,
        houseboat: 0
    },

    // ============================================================
    // HELPER: Check if a day is the last day of itinerary
    // ============================================================
    isLastDay(dayNumber) {
        if (!this.config.itinerary.travelFrom || !this.config.itinerary.travelTo) {
            return false;
        }

        const travelFromDate = new Date(this.config.itinerary.travelFrom);
        const travelToDate = new Date(this.config.itinerary.travelTo);

        const checkinDate = new Date(travelFromDate);
        checkinDate.setDate(checkinDate.getDate() + (dayNumber - 1));

        const checkInStr = checkinDate.toISOString().split('T')[0];
        const travelToStr = travelToDate.toISOString().split('T')[0];

        return checkInStr === travelToStr;
    },

    // ============================================================
    // HELPER: Calculate date for specific day number
    // ============================================================
    calculateDateForDay(dayNumber) {
        if (!this.config.itinerary.travelFrom) {
            console.error('âŒ Travel from date is not set!');
            return null;
        }

        const startDate = new Date(this.config.itinerary.travelFrom);
        const targetDate = new Date(startDate);
        targetDate.setDate(startDate.getDate() + (parseInt(dayNumber) - 1));

        return targetDate.toISOString().split('T')[0];
    },

    // ============================================================
    // UTILITY: Clean up modal state
    // ============================================================
    cleanupModal(modal) {
        const existingBackdrops = document.querySelectorAll('.modal-backdrop');
        existingBackdrops.forEach(backdrop => backdrop.remove());
        document.body.classList.remove('modal-open');
        document.body.style.overflow = '';
        modal.classList.remove('show');
        modal.style.display = 'none';
    },

    // ============================================================
    // UTILITY: Clear room and meal plan dropdowns
    // ============================================================
    clearRoomMealDropdowns() {
        const roomType = document.getElementById('roomType');
        const mealPlan = document.getElementById('mealPlan');

        if (roomType) {
            roomType.innerHTML = '<option value="">-- Select hotel first --</option>';
            roomType.disabled = true;
        }
        if (mealPlan) {
            mealPlan.innerHTML = '<option value="">-- Select hotel first --</option>';
            mealPlan.disabled = true;
        }
    },

    // ============================================================
    // UTILITY: Force close all modals and clean up
    // ============================================================
    closeAllModals() {
        const openModals = document.querySelectorAll('.modal.show');
        openModals.forEach(modal => {
            const bsModal = bootstrap.Modal.getInstance(modal);
            if (bsModal) {
                bsModal.hide();
            }
            modal.classList.remove('show');
            modal.style.display = 'none';
            modal.setAttribute('aria-hidden', 'true');
            modal.removeAttribute('aria-modal');
        });

        const backdrops = document.querySelectorAll('.modal-backdrop');
        backdrops.forEach(backdrop => backdrop.remove());

        document.body.classList.remove('modal-open');
        document.body.style.overflow = '';
        document.body.style.paddingRight = '';

        console.log('âœ… All modals forcefully closed and cleaned up');
    },


    // ============================================================
    // âœ… NEW: OPEN MASTER BOOKING MODAL (Book Any Hotel)
    // ============================================================
    openMasterBookingModal(destinationId, destinationName, dayNumber) {
        console.log('ðŸ¨ Opening Master Booking Modal:', { destinationId, destinationName, dayNumber });

        const modal = document.getElementById('hotelBookingModal');
        const form = modal?.querySelector('form');

        if (!modal || !form) {
            console.error('âŒ Modal or form not found');
            return;
        }

        // Clean up
        this.cleanupModal(modal);

        // Reset form
        form.reset();
        form.action = this.config.urls.createHotel;

        // âœ… STEP 1: Show modal FIRST
        const bsModal = new bootstrap.Modal(modal, { backdrop: 'static', keyboard: true });
        bsModal.show();

        // âœ… STEP 2: Wait for modal to render, THEN populate fields
        setTimeout(() => {
            // Set hidden fields
            document.getElementById('modalDayNumber').value = dayNumber;
            document.getElementById('modalDestination').value = destinationId;
            document.getElementById('modalDestinationNameHidden').value = destinationName;
            document.getElementById('modalBookingId').value = '';
            document.getElementById('modalHotelId').value = '';
            document.getElementById('hotelCategory').value = '';

            // Set destination display
            document.getElementById('modalDestinationName').value = destinationName;

            // Calculate dates
            const checkIn = this.calculateDateForDay(dayNumber);
            const checkOut = this.config.itinerary.travelTo;
            document.getElementById('checkinDate').value = checkIn;
            document.getElementById('checkoutDate').value = checkOut;
            document.getElementById('checkinTime').value = '14:00';
            document.getElementById('checkoutTime').value = '11:00';

            // Show mode selector and transform field to dropdown
            const modeSection = document.getElementById('hotelModeSection');
            if (modeSection) modeSection.style.display = 'block';

            const modeSelector = document.getElementById('hotelModeSelector');
            if (modeSelector) modeSelector.value = 'master';

            this.transformHotelFieldToDropdown('master');

            // Clear room/meal dropdowns
            this.clearRoomMealDropdowns();

            // Load ALL hotels (Master mode)
            this.loadHotelsByMode('master', destinationId, checkIn, checkOut);

            console.log('âœ… Master Booking Modal opened and populated');
        }, 200); // â±ï¸ Wait 200ms for modal to fully render
    },


    // ============================================================
    // âœ… NEW: SWITCH BETWEEN MASTER/MANUAL MODE
    // ============================================================
    switchHotelSelectionMode(mode) {
        console.log('ðŸ”„ Switching to mode:', mode);

        const destinationId = document.getElementById('modalDestination').value;
        const checkIn = document.getElementById('checkinDate').value;
        const checkOut = document.getElementById('checkoutDate').value;

        if (!destinationId) {
            console.error('âŒ No destination ID found');
            return;
        }

        // Clear current selection
        document.getElementById('modalHotelId').value = '';
        document.getElementById('hotelCategory').value = '';
        this.clearRoomMealDropdowns();

        // Update UI for mode
        this.transformHotelFieldToDropdown(mode);

        // Load hotels based on mode
        this.loadHotelsByMode(mode, destinationId, checkIn, checkOut);
    },

    // ============================================================
    // âœ… NEW: TRANSFORM HOTEL FIELD TO DROPDOWN
    // ============================================================
    transformHotelFieldToDropdown(mode) {
        const inputField = document.getElementById('modalHotelName');
        const dropdownField = document.getElementById('modalHotelNameDropdown');
        const badge = document.getElementById('hotelSelectionBadge');
        const hint = document.getElementById('hotelFieldHint');

        // Hide input, show dropdown
        if (inputField) inputField.style.display = 'none';
        if (dropdownField) {
            dropdownField.style.display = 'block';
            dropdownField.innerHTML = '<option value="">â³ Loading hotels...</option>';
        }

        // Update badge
        if (badge) {
            badge.style.display = 'inline-block';
            if (mode === 'master') {
                badge.className = 'badge bg-purple ms-2';
                badge.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                badge.innerHTML = '<i class="fas fa-star me-1"></i>Master Mode';
            } else {
                badge.className = 'badge bg-success ms-2';
                badge.innerHTML = '<i class="fas fa-dollar-sign me-1"></i>Manual Mode';
            }
        }

        // Update hint
        if (hint) {
            if (mode === 'master') {
                hint.innerHTML = '<i class="fas fa-info-circle me-1 text-info"></i>Showing ALL hotels (no pricing filter)';
            } else {
                hint.innerHTML = '<i class="fas fa-check-circle me-1 text-success"></i>Showing hotels with active pricing only';
            }
        }
    },

    // ============================================================
    // âœ… NEW: TRANSFORM BACK TO READONLY INPUT (For regular booking)
    // ============================================================
    transformDropdownToReadonlyField(hotelName = null, hotelId = null, isLocked = true) {
        const dropdownField = document.getElementById('modalHotelNameDropdown');
        const badge = document.getElementById('hotelSelectionBadge');
        const hint = document.getElementById('hotelFieldHint');
        const modeSection = document.getElementById('hotelModeSection');

        // Show dropdown, set lock state
        if (dropdownField) {
            dropdownField.style.display = 'block';
            dropdownField.disabled = isLocked;
            dropdownField.innerHTML = ''; // Clear options

            if (hotelName && hotelId) {
                const option = document.createElement('option');
                option.value = hotelId;
                option.textContent = hotelName;
                option.selected = true;
                dropdownField.appendChild(option);
                // Also update hidden ID
                const hiddenId = document.getElementById('modalHotelId');
                if (hiddenId) hiddenId.value = hotelId;
            } else {
                 dropdownField.innerHTML = '<option value="">Selected Hotel</option>';
            }
        }

        // Hide UI elements not needed for specific selection, UNLESS unlocked (changing)
        if (badge && isLocked) badge.style.display = 'none';
        if (modeSection) modeSection.style.display = 'none';

        if (hint) {
            hint.innerHTML = isLocked
                ? '<i class="fas fa-lock me-1"></i>Selected Hotel (Fixed)'
                : '<i class="fas fa-sync fa-spin me-1"></i>Loading hotels for change...';
        }
    },

    // ============================================================
    // âœ… NEW: LOAD HOTELS BY MODE
    // ============================================================
    async loadHotelsByMode(mode, destinationId, checkIn, checkOut) {
        const dropdown = document.getElementById('modalHotelNameDropdown');
        const hint = document.getElementById('hotelFieldHint');

        if (!dropdown) return;

        dropdown.innerHTML = '<option value="">â³ Loading hotels...</option>';
        dropdown.disabled = true;

        try {
            let url;
            if (mode === 'master') {
                // Master Mode: ALL hotels
                url = `/api/hotels/by-destination/?destination_id=${destinationId}`;
            } else {
                // Manual Mode: Priced hotels only
                url = `/hotel/get-priced-hotels/?destination=${destinationId}&checkin=${checkIn}&checkout=${checkOut}`;
            }

            const response = await fetch(url);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);

            const data = await response.json();

            if (data.success && data.hotels && data.hotels.length > 0) {
                dropdown.innerHTML = '<option value="">-- Select a hotel --</option>';

                data.hotels.forEach(hotel => {
                    const option = document.createElement('option');
                    option.value = hotel.id;
                    option.textContent = `${hotel.name}${hotel.category ? ' (' + hotel.category + ')' : ''}`;
                    option.dataset.hotelName = hotel.name;
                    option.dataset.category = hotel.category || '';
                    dropdown.appendChild(option);
                });

                dropdown.disabled = false;
                if (hint) {
                    const modeText = mode === 'master' ? '(all hotels)' : '(priced hotels)';
                    hint.innerHTML = `<i class="fas fa-check-circle text-success me-1"></i>${data.hotels.length} hotel(s) available ${modeText}`;
                }
                console.log(`âœ… Loaded ${data.hotels.length} hotels in ${mode} mode`);
            } else {
                dropdown.innerHTML = '<option value="">âŒ No hotels found</option>';
                dropdown.disabled = true;
                if (hint) hint.innerHTML = '<i class="fas fa-exclamation-triangle text-warning me-1"></i>No hotels found';
            }
        } catch (error) {
            console.error('âŒ Error loading hotels:', error);
            dropdown.innerHTML = '<option value="">âš ï¸ Error loading hotels</option>';
            dropdown.disabled = true;
            if (hint) hint.innerHTML = '<i class="fas fa-times-circle text-danger me-1"></i>Error loading hotels';
        }
    },

    // ============================================================
    // âœ… NEW: WHEN USER SELECTS HOTEL FROM DROPDOWN
    // ============================================================
    onHotelSelectFromDropdown(selectElement) {
        const hotelId = selectElement.value;

        if (!hotelId) {
            document.getElementById('modalHotelId').value = '';
            document.getElementById('hotelCategory').value = '';
            this.clearRoomMealDropdowns();
            return;
        }

        const selectedOption = selectElement.options[selectElement.selectedIndex];
        const hotelName = selectedOption.dataset.hotelName;
        const category = selectedOption.dataset.category;

        // Set values
        document.getElementById('modalHotelId').value = hotelId;
        document.getElementById('hotelCategory').value = category;
        document.getElementById('modalHotelName').value = hotelName; // Update hidden input

        console.log('âœ… Hotel selected:', { hotelId, hotelName, category });

        // Load room types
        const checkIn = document.getElementById('checkinDate').value;
        const checkOut = document.getElementById('checkoutDate').value;

        if (checkIn && checkOut) {
            this.loadHotelRoomTypes(hotelId, checkIn, checkOut);
        }
    },


    // ============================================================
    // WHEN USER SELECTS VEHICLE FROM DROPDOWN
    // ============================================================
    onVehicleSelectFromDropdown(selectElement) {
        const vehicleId = selectElement.value;

        if (!vehicleId) {
            document.getElementById('modalVehicleId').value = '';
            return;
        }

        const selectedOption = selectElement.options[selectElement.selectedIndex];
        const vehicleName = selectedOption.dataset.name;

        document.getElementById('modalVehicleId').value = vehicleId;

        const readonlyInput = document.getElementById('modalVehicleNameReadonly');
        if (readonlyInput) {
            readonlyInput.value = vehicleName;
        }

        console.log('âœ… Vehicle selected:', vehicleId, vehicleName);
    },
    
    // ============================================================
    // ðŸ§¹ RESET UI (Clears Errors & Fields) - PASTE THIS ABOVE "open"
    // ============================================================
    resetUI(type) {
        // --- 1. RESET HOTEL UI ---
        if (type === 'hotel') {
            const warningBox = document.getElementById('duplicateHotelWarning');
            const saveBtn = document.getElementById('btnSaveBooking');
            
            // Hide Hotel Warning
            if (warningBox) warningBox.style.display = 'none';
            
            // Reset Hotel Save Button
            if (saveBtn) {
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<i class="fas fa-save me-2"></i>Save Booking';
            }
            
            // Reset Modes (Check if functions exist to avoid errors)
            if (this.toggleHotelMode) this.toggleHotelMode('database');
            if (this.toggleRoomMode) this.toggleRoomMode('database');
            
            // Clear Inclusions
            const incContainer = document.getElementById('hotelInclusionsContainer');
            if(incContainer) incContainer.innerHTML = '<div class="text-center text-muted py-4"><i class="fas fa-info-circle me-2"></i>No inclusions added yet</div>';
            const summary = document.getElementById('hotelInclusionsSummary');
            if(summary) summary.style.display = 'none';
        }
        
        // --- 2. RESET HOUSEBOAT UI ---
        if (type === 'houseboat') {
            const warningBox = document.getElementById('duplicateHouseboatWarning');
            // Note: Houseboat form uses a generic submit button selector inside its form
            const saveBtn = document.querySelector('#houseboatBookingForm button[type="submit"]');

            // Hide Houseboat Warning
            if (warningBox) warningBox.style.display = 'none';

            // Reset Houseboat Save Button
            if (saveBtn) {
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<i class="fas fa-save me-1"></i>Save Booking';
            }

            // Clear Inclusions
            const incContainer = document.getElementById('houseboatInclusionsContainer');
            if(incContainer) incContainer.innerHTML = '<div class="text-center text-muted py-4" id="houseboatNoInclusionsMessage"><i class="fas fa-info-circle me-2"></i>No inclusions added yet. Click "Add Inclusion" button above.</div>';
            const summary = document.getElementById('houseboatInclusionsSummary');
            if(summary) summary.style.display = 'none';
            
            this.inclusionCounters.houseboat = 0;
        }
    },



    // ============================================================
    // MAIN OPEN FUNCTION
    // ============================================================
    // ============================================================
    // MAIN OPEN FUNCTION
    // ============================================================
    open(type, data, isEdit = false) {
        const modals = {
            hotel: 'hotelBookingModal',
            houseboat: 'houseboatBookingModal',
            activity: 'activityBookingModal',
            vehicle: 'bookVehicleModal',
            standalone: 'standaloneInclusionModal'
        };

        const modalId = modals[type];
        if (!modalId) {
            console.error('Invalid booking type:', type);
            return;
        }

        const dayNumber = parseInt(data.dayNumber);
        const isLastDay = this.isLastDay(dayNumber);

        // âœ… BLOCK HOTEL ON LAST DAY
        if (!isEdit && type === 'hotel' && isLastDay) {
            alert('âš ï¸ Hotel booking not available on the last day.\n\nGuests will check out from the previous day\'s hotel and proceed with departure activities.\n\nLast day is typically used for:\nâ€¢ Airport/station transfer\nâ€¢ Day cruise/sightseeing\nâ€¢ Shopping\nâ€¢ Departure');
            console.warn(`ðŸš« Blocked hotel booking on last day (Day ${dayNumber})`);
            return;
        }

        // âœ… SHOW WARNING FOR LAST DAY HOUSEBOAT
        if (!isEdit && type === 'houseboat' && isLastDay) {
            console.warn(`âš ï¸ Last day houseboat booking - Day cruise mode`);
            const confirmed = confirm('â„¹ï¸ Last Day Houseboat Booking\n\nThis will be a DAY CRUISE (same-day checkout):\n\nâ€¢ Check-in: Morning (e.g., 8:00 AM)\nâ€¢ Check-out: Evening (same day, e.g., 6:00 PM)\nâ€¢ No overnight stay\nâ€¢ Day cruise rate applies\n\nDo you want to continue?');
            if (!confirmed) {
                console.log('âœ… User cancelled last day houseboat booking');
                return;
            }
        }

        const modal = document.getElementById(modalId);
        const form = modal?.querySelector('form');

        if (!modal || !form) {
            console.error(`Modal or form not found for ${type}`);
            return;
        }

        // âœ… Clean up any existing modal state
        const existingBackdrops = document.querySelectorAll('.modal-backdrop');
        existingBackdrops.forEach(backdrop => backdrop.remove());

        document.body.classList.remove('modal-open');
        document.body.style.overflow = '';
        document.body.style.paddingRight = '';

        modal.classList.remove('show');
        modal.style.display = 'none';
        modal.setAttribute('aria-hidden', 'true');
        modal.removeAttribute('aria-modal');
        modal.removeAttribute('role');

        // âœ… CRITICAL ADDITION: Reset UI (Clears duplicate warnings)
        if (this.resetUI) {
            this.resetUI(type);
        }

        form.reset();

        const actionKey = isEdit ? `update${this.capitalize(type)}` : `create${this.capitalize(type)}`;
        let action = this.config.urls[actionKey];

        if (isEdit && data.bookingId) {
            action = action.replace('/0/', `/${data.bookingId}/`);
        }

        form.action = action;

        const title = modal.querySelector('.modal-title');
        if (title) {
            const icons = {
                hotel: 'fa-hotel',
                houseboat: 'fa-ship',
                activity: 'fa-hiking',
                vehicle: 'fa-car',
                standalone: 'fa-star'
            };
            const actionText = isEdit ? 'Edit' : 'Book';

            let titleText = `${actionText} ${this.capitalize(type)}`;
            if (!isEdit && type === 'houseboat' && isLastDay) {
                titleText = `${actionText} Houseboat Day Cruise`;
            }

            title.innerHTML = `<i class="fas ${icons[type]} me-2"></i>${titleText}`;
        }

        try {
            if (this.populate[type]) {
                this.populate[type](data, isEdit);
            }
        } catch (error) {
            console.error(`Error populating ${type} form:`, error);
        }

        if (type === 'hotel' || type === 'houseboat') {
            // Only clear inclusions if it is a NEW booking. 
            // Edit mode handles loading its own inclusions in the populate function/callbacks.
            if (!isEdit) {
                this.clearInclusions(type);
            }
        }

        try {
            const bsModal = new bootstrap.Modal(modal, {
                backdrop: 'static',
                keyboard: true
            });

            modal.addEventListener('hidden.bs.modal', function cleanupModal() {
                const backdrops = document.querySelectorAll('.modal-backdrop');
                backdrops.forEach(backdrop => backdrop.remove());

                document.body.classList.remove('modal-open');
                document.body.style.overflow = '';
                document.body.style.paddingRight = '';

                console.log('âœ… Modal closed and cleaned up');
            }, { once: true });

            bsModal.show();
            console.log(`âœ… ${type} modal opened`, isEdit ? '(EDIT mode)' : '(NEW mode)', data);
        } catch (error) {
            console.error(`Error showing modal:`, error);
            // Fallback cleanup if bootstrap fails
            const backdrops = document.querySelectorAll('.modal-backdrop');
            backdrops.forEach(backdrop => backdrop.remove());
            document.body.classList.remove('modal-open');
        }
    },

    // ============================================================
    // POPULATE FUNCTIONS
    // ============================================================
    populate: {
        hotel(data, isEdit) {
            // âœ… ENSURE FIELD IS HANDLED CORRECTLY (Locked for new, Unlocked for edit)
            BookingSystem.transformDropdownToReadonlyField(data.hotelName, data.hotelId, !isEdit);

            const setVal = (id, val) => {
                const el = document.getElementById(id);
                if (el) {
                    el.value = val || '';
                    console.log(`âœ… Set ${id} = ${val}`);
                } else {
                    console.warn(`âš ï¸ Element not found: ${id}`);
                }
            };
            const setText = (id, text) => {
                const el = document.getElementById(id);
                if (el) {
                    el.textContent = text || '';
                    console.log(`âœ… Set text ${id} = ${text}`);
                }
            };

            setVal('modalHotelId', data.hotelId);
            // setVal('modalHotelName', data.hotelName); // REMOVED: input deleted
            setVal('modalDayNumber', data.dayNumber);
            setVal('modalDestination', data.destinationId);
            setVal('modalDestinationName', data.destinationName);

            console.log('ðŸ¨ Populating hotel form:', data);

            if (isEdit) {
                console.log('ðŸ“ EDIT MODE');

                setVal('modalBookingId', data.bookingId);
                setVal('checkinDate', data.checkIn);
                setVal('checkoutDate', data.checkOut);
                setVal('checkinTime', data.checkInTime || '14:00');
                setVal('checkoutTime', data.checkOutTime || '11:00');
                setVal('numDoubleBeds', data.numDoubleBeds || 0);
                setVal('extraBeds', data.extraBeds || 0);
                setVal('childWithBed', data.childWithBed || 0);
                setVal('childWithoutBed', data.childWithoutBed || 0);
                setVal('hotelOption', data.option || 'option_1');
                setVal('hotelCategory', data.category);

                const checkinDateField = document.getElementById('checkinDate');
                if (checkinDateField) {
                    checkinDateField.readOnly = true;
                    checkinDateField.disabled = false;
                    checkinDateField.style.backgroundColor = '#e9ecef';
                    checkinDateField.style.cursor = 'not-allowed';
                    checkinDateField.style.pointerEvents = 'none';
                }

                const checkoutDateField = document.getElementById('checkoutDate');
                if (checkoutDateField) {
                    checkoutDateField.readOnly = false;
                    checkoutDateField.disabled = false;
                    checkoutDateField.style.backgroundColor = '#ffffff';
                    checkoutDateField.style.cursor = 'text';
                    checkoutDateField.style.pointerEvents = 'auto';

                    const nextDay = new Date(data.checkIn);
                    nextDay.setDate(nextDay.getDate() + 1);
                    checkoutDateField.min = nextDay.toISOString().split('T')[0];
                    checkoutDateField.max = BookingSystem.config.itinerary.travelTo;
                }

                if (data.hotelId && data.checkIn && data.checkOut) {
                    setTimeout(() => {
                        BookingSystem.loadHotelRoomTypes(
                            data.hotelId,
                            data.checkIn,
                            data.checkOut,
                            data.roomTypeId,
                            data.mealPlanId
                        );
                    }, 100);
                }
            } else {
                console.log('ðŸ†• NEW BOOKING MODE');

                try {
                    const dayNumber = parseInt(data.dayNumber);
                    const travelFromDate = new Date(BookingSystem.config.itinerary.travelFrom);
                    const checkinDate = new Date(travelFromDate);
                    checkinDate.setDate(checkinDate.getDate() + (dayNumber - 1));

                    const checkIn = checkinDate.toISOString().split('T')[0];
                    const checkOut = BookingSystem.config.itinerary.travelTo;

                    setVal('checkinDate', checkIn);
                    setVal('checkoutDate', checkOut);
                    setVal('checkinTime', '14:00');
                    setVal('checkoutTime', '11:00');

                    const checkinDateField = document.getElementById('checkinDate');
                    if (checkinDateField) {
                        checkinDateField.readOnly = true;
                        checkinDateField.disabled = false;
                        checkinDateField.style.backgroundColor = '#e9ecef';
                        checkinDateField.style.cursor = 'not-allowed';
                        checkinDateField.style.pointerEvents = 'none';
                    }

                    const checkoutDateField = document.getElementById('checkoutDate');
                    if (checkoutDateField) {
                        checkoutDateField.readOnly = false;
                        checkoutDateField.disabled = false;
                        checkoutDateField.style.backgroundColor = '#ffffff';
                        checkoutDateField.style.cursor = 'text';
                        checkoutDateField.style.pointerEvents = 'auto';

                        const minCheckout = new Date(checkinDate);
                        minCheckout.setDate(minCheckout.getDate() + 1);
                        checkoutDateField.min = minCheckout.toISOString().split('T')[0];
                        checkoutDateField.max = BookingSystem.config.itinerary.travelTo;
                    }

                    if (data.hotelId && checkIn && checkOut) {
                        setTimeout(() => {
                            BookingSystem.loadHotelRoomTypes(data.hotelId, checkIn, checkOut);
                        }, 100);
                    }

                } catch (error) {
                    console.error('âŒ Error calculating hotel dates:', error);
                }
            }
        },

        houseboat(data, isEdit) {
            const setVal = (id, val) => {
                const el = document.getElementById(id);
                if (el) {
                    el.value = val || '';
                }
            };
            const setText = (id, text) => {
                const el = document.getElementById(id);
                if (el) el.textContent = text || '';
            };

            // 1. Set Basic IDs
            setVal('modalHouseboatId', data.houseboatId);
            setVal('houseboatmodalDayNumber', data.dayNumber);
            setVal('houseboatOption', data.option || 'option1');

            // âœ… FIX 1: Set Hidden Destination ID (Crucial for Inclusions)
            setVal('modalHouseboatDestination', data.destinationId); 

            // âœ… FIX 2: Set Visual Destination Name (Crucial for Display)
            setText('modalHouseboatDestinationDisplay', data.destinationName || 'Unknown Location');

            // 3. Set Houseboat Name
            setText('modalHouseboatName', data.houseboatName);

            // 4. Date & Room Logic
            if (isEdit) {
                setVal('houseboatCheckIn', data.checkIn);
                setVal('houseboatCheckOut', data.checkOut);

                const checkinField = document.getElementById('houseboatCheckIn');
                if (checkinField) {
                    checkinField.readOnly = true;
                    checkinField.disabled = false;
                    checkinField.style.backgroundColor = '#e9ecef';
                    checkinField.style.cursor = 'not-allowed';
                    checkinField.style.pointerEvents = 'none';
                }

                const checkoutField = document.getElementById('houseboatCheckOut');
                if (checkoutField) {
                    checkoutField.readOnly = false;
                    checkoutField.disabled = false;
                    checkoutField.style.backgroundColor = '#ffffff';
                    checkoutField.style.pointerEvents = 'auto';

                    const nextDay = new Date(data.checkIn);
                    nextDay.setDate(nextDay.getDate() + 1);
                    checkoutField.min = nextDay.toISOString().split('T')[0];
                    checkoutField.max = BookingSystem.config.itinerary.travelTo;
                }

                const setRoomVal = (name, val) => {
                    const el = document.querySelector(`input[name="${name}"]`);
                    if (el) el.value = val || 0;
                };

                setRoomVal('num_one_bed_rooms', data.numOneBed);
                setRoomVal('num_two_bed_rooms', data.numTwoBed);
                setRoomVal('num_three_bed_rooms', data.numThreeBed);
                setRoomVal('num_four_bed_rooms', data.numFourBed);
                setRoomVal('num_five_bed_rooms', data.numFiveBed);
                setRoomVal('num_six_bed_rooms', data.numSixBed);
                setRoomVal('num_seven_bed_rooms', data.numSevenBed);
                setRoomVal('num_eight_bed_rooms', data.numEightBed);
                setRoomVal('num_nine_bed_rooms', data.numNineBed);
                setRoomVal('num_ten_bed_rooms', data.numTenBed);
                setRoomVal('num_extra_beds', data.numExtraBeds);

                // Load Options & Saved Inclusions
                if (data.houseboatId && data.checkIn && data.checkOut) {
                    setTimeout(() => {
                        BookingSystem.loadHouseboatOptions(
                            data.houseboatId,
                            data.checkIn,
                            data.checkOut,
                            data.roomTypeId,
                            data.mealPlanId
                        );
                    }, 100);
                    
                    // âœ… FIX 3: Load Saved Inclusions for Edit Mode
                    if (data.bookingId) {
                        loadExistingInclusions('houseboat', data.bookingId, data.destinationId, data.houseboatId);
                    }
                }
            } else {
                // NEW BOOKING MODE
                try {
                    const dayNumber = parseInt(data.dayNumber);
                    const travelFromDate = new Date(BookingSystem.config.itinerary.travelFrom);
                    
                    const checkinDate = new Date(travelFromDate);
                    checkinDate.setDate(checkinDate.getDate() + (dayNumber - 1));

                    const checkIn = checkinDate.toISOString().split('T')[0];
                    const itineraryEnd = BookingSystem.config.itinerary.travelTo;

                    const isLastDay = (checkIn === itineraryEnd);

                    if (isLastDay) {
                        setVal('houseboatCheckIn', checkIn);
                        setVal('houseboatCheckOut', checkIn);

                        const checkinField = document.getElementById('houseboatCheckIn');
                        if (checkinField) {
                            checkinField.readOnly = true;
                            checkinField.disabled = false;
                            checkinField.style.backgroundColor = '#e9ecef';
                            checkinField.style.cursor = 'not-allowed';
                            checkinField.style.pointerEvents = 'none';
                        }

                        const checkoutField = document.getElementById('houseboatCheckOut');
                        if (checkoutField) {
                            checkoutField.readOnly = true;
                            checkoutField.disabled = false;
                            checkoutField.style.backgroundColor = '#fff3cd';
                            checkoutField.style.cursor = 'not-allowed';
                            checkoutField.style.pointerEvents = 'none';
                            checkoutField.title = 'Last day - Same-day checkout (Day Cruise)';
                            checkoutField.min = checkIn;
                            checkoutField.max = checkIn;
                        }
                    } else {
                        // Standard Booking (Overnight)
                        const nextDay = new Date(checkinDate);
                        nextDay.setDate(nextDay.getDate() + 1);
                        
                        const itinEndDate = new Date(itineraryEnd);
                        let checkOut = nextDay.toISOString().split('T')[0];
                        
                        if (nextDay > itinEndDate) {
                             checkOut = itineraryEnd;
                        }

                        setVal('houseboatCheckIn', checkIn);
                        setVal('houseboatCheckOut', checkOut);

                        const checkinField = document.getElementById('houseboatCheckIn');
                        if (checkinField) {
                            checkinField.readOnly = true;
                            checkinField.disabled = false;
                            checkinField.style.backgroundColor = '#e9ecef';
                            checkinField.style.cursor = 'not-allowed';
                            checkinField.style.pointerEvents = 'none';
                        }

                        const checkoutField = document.getElementById('houseboatCheckOut');
                        if (checkoutField) {
                            checkoutField.readOnly = false;
                            checkoutField.disabled = false;
                            checkoutField.style.backgroundColor = '#ffffff';
                            checkoutField.style.pointerEvents = 'auto';

                            const minCheckout = new Date(checkinDate);
                            minCheckout.setDate(minCheckout.getDate() + 1);
                            checkoutField.min = minCheckout.toISOString().split('T')[0];
                            checkoutField.max = itineraryEnd;
                        }
                    }

                    // Reset room inputs
                    document.querySelectorAll('.houseboat-room-input').forEach(input => input.value = 0);
                    const extraBeds = document.querySelector('input[name="num_extra_beds"]');
                    if (extraBeds) extraBeds.value = 0;

                    // Trigger options load
                    const checkInVal = document.getElementById('houseboatCheckIn')?.value;
                    const checkOutVal = document.getElementById('houseboatCheckOut')?.value;

                    if (data.houseboatId && checkInVal && checkOutVal) {
                        setTimeout(() => {
                            BookingSystem.loadHouseboatOptions(
                                data.houseboatId,
                                checkInVal,
                                checkOutVal
                            );
                        }, 100);
                    }

                } catch (error) {
                    console.error('âŒ Error calculating houseboat dates:', error);
                }
            }
        },




        activity(data, isEdit) {
            const setVal = (id, val) => {
                const el = document.getElementById(id);
                if (el) el.value = val || '';
            };
            const setText = (id, text) => {
                const el = document.getElementById(id);
                if (el) el.textContent = text || '';
            };

            setVal('modalActivityId', data.activityId);
            setText('modalActivityName', data.activityName);
            setVal('modalActivityDayNumber', data.dayNumber);

            const form = document.getElementById('activityBookingModal')?.querySelector('form');
            if (!form) return;

            if (isEdit) {
                const dateField = form.querySelector('input[name="bookingdate"]');
                const timeField = form.querySelector('input[name="bookingtime"]');
                const adultsField = form.querySelector('input[name="numadults"]');
                const childrenField = form.querySelector('input[name="numchildren"]');
                const notesField = form.querySelector('textarea[name="notes"]');

                if (dateField) dateField.value = data.bookingDate || '';
                if (timeField) timeField.value = data.bookingTime || '10:00';
                if (adultsField) adultsField.value = data.numAdults || 1;
                if (childrenField) childrenField.value = data.numChildren || 0;
                if (notesField) notesField.value = data.notes || '';
            } else {
                const dateField = form.querySelector('input[name="bookingdate"]');
                const timeField = form.querySelector('input[name="bookingtime"]');
                const adultsField = form.querySelector('input[name="numadults"]');
                const childrenField = form.querySelector('input[name="numchildren"]');

                const pickupDate = BookingSystem.calculateDateForDay(data.dayNumber);

                if (dateField) dateField.value = pickupDate || BookingSystem.config.itinerary.travelFrom;
                if (timeField) timeField.value = '10:00';
                if (adultsField) adultsField.value = BookingSystem.config.itinerary.adults;
                if (childrenField) childrenField.value = BookingSystem.config.itinerary.children;
            }
        },

        vehicle(data, isEdit) {
            console.log('ðŸš— Populating vehicle form:', data, 'Edit mode:', isEdit);

            const setVal = (id, val) => {
                const el = document.getElementById(id);
                if (el) el.value = val || '';
            };

            setVal('modalVehicleId', data.vehicleId);
            setVal('vehicleDayNumber', data.dayNumber);
            setVal('modalVehicleDestinationId', data.destinationId);

            // Pickup & passengers
            if (isEdit) {
                setVal('vehicleBookingId', data.bookingId);
                setVal('vehiclePickupDate', data.pickupDate);
                setVal('vehicleNumPassengers', data.numPassengers);
                setVal('vehicleTotalKm', data.totalKm || '');
            } else {
                const pickupDate = BookingSystem.calculateDateForDay(data.dayNumber);
                setVal('vehiclePickupDate', pickupDate);
                setVal(
                    'vehicleNumPassengers',
                    BookingSystem.config.itinerary.adults + BookingSystem.config.itinerary.children
                );
            }

            // âœ… LOAD VEHICLES & PRESELECT CURRENT ONE (EDIT MODE)
            const destinationId = data.destinationId;
            const dropdown = document.getElementById('modalVehicleDropdown');

            if (destinationId && dropdown) {
                BookingSystem.loadVehiclesByDestination(destinationId);

                // Preselect current vehicle after load
                setTimeout(() => {
                    dropdown.value = data.vehicleId || '';
                    document.getElementById('modalVehicleId').value = data.vehicleId || '';
                }, 300);
            }
        },


        standalone(data, isEdit) {
            const setVal = (id, val) => {
                const el = document.getElementById(id);
                if (el) el.value = val || '';
            };
            const setText = (id, text) => {
                const el = document.getElementById(id);
                if (el) el.textContent = text || '';
            };

            setVal('standaloneInclusionId', data.inclusionId);
            setText('standaloneInclusionName', data.inclusionName);
            setVal('standaloneDayNumber', data.dayNumber);

            if (isEdit) {
                setVal('standaloneBookingId', data.bookingId);
                setVal('standaloneBookingDate', data.bookingDate);
                setVal('standaloneBookingTime', data.bookingTime || '10:00');
                setVal('standaloneNumAdults', data.numAdults || 1);
                setVal('standaloneNumChildren', data.numChildren || 0);

                const notesField = document.getElementById('standaloneNotes');
                if (notesField) notesField.value = data.notes || '';
            } else {
                setVal('standaloneBookingId', '');

                const bookingDate = BookingSystem.calculateDateForDay(data.dayNumber);

                setVal('standaloneBookingDate', bookingDate || BookingSystem.config.itinerary.travelFrom);
                setVal('standaloneBookingTime', '10:00');
                setVal('standaloneNumAdults', BookingSystem.config.itinerary.adults);
                setVal('standaloneNumChildren', BookingSystem.config.itinerary.children);
            }

            const pricingInfo = document.getElementById('standalonePricingInfo');
            if (pricingInfo) pricingInfo.style.display = 'none';
        }
    },

    // ============================================================
    // DYNAMIC DROPDOWN LOADERS
    // ============================================================
    async loadHotelRoomTypes(hotelId, checkIn, checkOut, selectedRoomTypeId = null, selectedMealPlanId = null) {
        const roomTypeSelect = document.getElementById('roomType');
        const mealPlanSelect = document.getElementById('mealPlan');

        if (!roomTypeSelect) {
            console.error('Room type select not found');
            return;
        }

        if (!hotelId || !checkIn || !checkOut) {
            roomTypeSelect.innerHTML = '<option value="">-- Select dates first --</option>';
            roomTypeSelect.disabled = true;
            if (mealPlanSelect) {
                mealPlanSelect.innerHTML = '<option value="">-- Select dates first --</option>';
                mealPlanSelect.disabled = true;
            }
            return;
        }

        roomTypeSelect.innerHTML = '<option value="">Loading...</option>';
        roomTypeSelect.disabled = true;

        if (mealPlanSelect) {
            mealPlanSelect.innerHTML = '<option value="">Loading...</option>';
            mealPlanSelect.disabled = true;
        }

        try {
            const url = `/hotel/${hotelId}/valid-options/?checkin=${checkIn}&checkout=${checkOut}`;
            const response = await fetch(url);

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();

            if (data.success && data.roomtypes && data.roomtypes.length > 0) {
                roomTypeSelect.innerHTML = '<option value="">-- Select Room Type --</option>';
                data.roomtypes.forEach(rt => {
                    const option = document.createElement('option');
                    option.value = rt.id;
                    option.textContent = rt.name;
                    if (selectedRoomTypeId && rt.id == selectedRoomTypeId) {
                        option.selected = true;
                    }
                    roomTypeSelect.appendChild(option);
                });
                roomTypeSelect.disabled = false;

                if (mealPlanSelect && data.mealplans && data.mealplans.length > 0) {
                    mealPlanSelect.innerHTML = '<option value="">-- Select Meal Plan --</option>';
                    data.mealplans.forEach(mp => {
                        const option = document.createElement('option');
                        option.value = mp.id;
                        option.textContent = mp.name;
                        if (selectedMealPlanId && mp.id == selectedMealPlanId) {
                            option.selected = true;
                        }
                        mealPlanSelect.appendChild(option);
                    });
                    mealPlanSelect.disabled = false;
                }
            } else {
                roomTypeSelect.innerHTML = '<option value="">No rooms available for selected dates</option>';
                roomTypeSelect.disabled = true;
                if (mealPlanSelect) {
                    mealPlanSelect.innerHTML = '<option value="">No meal plans available</option>';
                    mealPlanSelect.disabled = true;
                }
            }
        } catch (error) {
            console.error('âŒ Failed to load hotel options:', error);
            roomTypeSelect.innerHTML = '<option value="">Error loading options</option>';
            roomTypeSelect.disabled = true;
            if (mealPlanSelect) {
                mealPlanSelect.innerHTML = '<option value="">Error loading options</option>';
                mealPlanSelect.disabled = true;
            }
        }
    },

    async loadHouseboatOptions(houseboatId, checkIn, checkOut, selectedRoomTypeId = null, selectedMealPlanId = null) {
        const roomTypeSelect = document.getElementById('houseboatRoomType');
        const mealPlanSelect = document.getElementById('houseboatMealPlan');

        if (!houseboatId || !checkIn || !checkOut) {
            return;
        }

        if (roomTypeSelect) {
            roomTypeSelect.innerHTML = '<option value="">Loading...</option>';
            roomTypeSelect.disabled = true;
        }
        if (mealPlanSelect) {
            mealPlanSelect.innerHTML = '<option value="">Loading...</option>';
            mealPlanSelect.disabled = true;
        }

        const url = `/houseboat/${houseboatId}/valid-options/?checkin=${checkIn}&checkout=${checkOut}`;

        try {
            const response = await fetch(url);

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();

            if (data.success) {
                if (roomTypeSelect && data.roomtypes) {
                    roomTypeSelect.innerHTML = '<option value="">-- Select Room Type --</option>';
                    data.roomtypes.forEach(rt => {
                        const option = document.createElement('option');
                        option.value = rt.id;
                        option.textContent = rt.name;
                        if (selectedRoomTypeId && rt.id == selectedRoomTypeId) {
                            option.selected = true;
                        }
                        roomTypeSelect.appendChild(option);
                    });
                    roomTypeSelect.disabled = false;
                }

                if (mealPlanSelect && data.mealplans) {
                    mealPlanSelect.innerHTML = '<option value="">-- Select Meal Plan --</option>';
                    data.mealplans.forEach(mp => {
                        const option = document.createElement('option');
                        option.value = mp.id;
                        option.textContent = mp.name;
                        if (selectedMealPlanId && mp.id == selectedMealPlanId) {
                            option.selected = true;
                        }
                        mealPlanSelect.appendChild(option);
                    });
                    mealPlanSelect.disabled = false;
                }
            }
        } catch (error) {
            console.error('âŒ Error loading houseboat options:', error);
        }
    },


    // ============================================================
    // LOAD VEHICLES BY DESTINATION
    // ============================================================
    async loadVehiclesByDestination(destinationId) {
        const dropdown = document.getElementById('modalVehicleDropdown');
        const hint = document.getElementById('vehicleFieldHint');

        if (!dropdown || !destinationId) return;

        dropdown.innerHTML = '<option value="">â³ Loading vehicles...</option>';
        dropdown.disabled = true;

        try {
            const response = await fetch(`/api/vehicles/by-destination/?destination_id=${destinationId}`);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);

            const data = await response.json();

            if (data.success && data.vehicles.length > 0) {
                dropdown.innerHTML = '<option value="">-- Select Vehicle --</option>';

                data.vehicles.forEach(vehicle => {
                    const option = document.createElement('option');
                    option.value = vehicle.id;
                    option.textContent = `${vehicle.name} (${vehicle.vehicle_type})`;
                    option.dataset.name = vehicle.name;
                    dropdown.appendChild(option);
                });

                dropdown.disabled = false;
                if (hint) hint.textContent = `${data.vehicles.length} vehicle(s) available`;
            } else {
                dropdown.innerHTML = '<option value="">No vehicles found</option>';
                if (hint) hint.textContent = 'No vehicles available';
            }
        } catch (error) {
            console.error('âŒ Vehicle load error:', error);
            dropdown.innerHTML = '<option value="">Error loading vehicles</option>';
        }
    },

    // ============================================================
    // INCLUSION MANAGEMENT
    // ============================================================
    clearInclusions(type) {
        const containerId = type === 'hotel' ? 'inclusionsContainer' : 'houseboatInclusionsContainer';
        const container = document.getElementById(containerId);
        if (container) {
            container.innerHTML = '';
        }
        this.inclusionCounters[type] = 0;

        const noMsgId = type === 'hotel' ? 'noInclusionsMessage' : 'houseboatNoInclusionsMessage';
        const noMsg = document.getElementById(noMsgId);
        if (noMsg) noMsg.style.display = 'block';

        const summaryId = type === 'hotel' ? 'inclusionsSummary' : 'houseboatInclusionsSummary';
        const summary = document.getElementById(summaryId);
        if (summary) summary.style.display = 'none';
    },

    capitalize(str) {
        return str.charAt(0).toUpperCase() + str.slice(1);
    }
};

// ============================================================
// GLOBAL FUNCTIONS
// ============================================================

// âœ… Missing Helper for HTML onchange (REMOVED DUPLICATE)

function openHouseboatModal(houseboatId, houseboatName, dayNumber, destinationId, destinationName) {
    if (!dayNumber) {
        alert('Error: Day number is missing.');
        return;
    }
    
    // âœ… Pass destinationId and destinationName to the main system
    BookingSystem.open('houseboat', { 
        houseboatId: houseboatId, 
        houseboatName: houseboatName, 
        dayNumber: dayNumber, 
        destinationId: destinationId,      // <--- Crucial
        destinationName: destinationName   // <--- Crucial
    });
}


function editHouseboatBooking(bookingId) {
    // 1. Find the button that triggered the event (or find by ID)
    let btn = event.target.closest('button');
    
    // Fallback if event is not passed correctly or button not found directly
    if (!btn) {
        btn = document.querySelector(`button[data-booking-id="${bookingId}"][data-houseboat-id]`);
    }

    if (!btn) {
        console.error("âŒ Edit button not found for booking:", bookingId);
        return;
    }

    console.log("âœï¸ Editing Houseboat:", bookingId, "Dest:", btn.dataset.destinationName);

    // 2. Open Modal with ALL data (including Destination)
    BookingSystem.open('houseboat', {
        bookingId: bookingId,
        houseboatId: btn.dataset.houseboatId,
        houseboatName: btn.dataset.houseboatName,
        dayNumber: btn.dataset.dayNumber,
        
        // âœ… FIX: PASS DESTINATION DATA (Crucial for Inclusions to work)
        destinationId: btn.dataset.destinationId,
        destinationName: btn.dataset.destinationName,

        option: btn.dataset.option,
        checkIn: btn.dataset.checkInDate,
        checkOut: btn.dataset.checkOutDate,
        roomTypeId: btn.dataset.roomTypeId,
        mealPlanId: btn.dataset.mealPlanId,
        
        // Rooms configuration
        numOneBed: btn.dataset.numOneBed,
        numTwoBed: btn.dataset.numTwoBed,
        numThreeBed: btn.dataset.numThreeBed,
        numFourBed: btn.dataset.numFourBed,
        numFiveBed: btn.dataset.numFiveBed,
        numSixBed: btn.dataset.numSixBed,
        numSevenBed: btn.dataset.numSevenBed,
        numEightBed: btn.dataset.numEightBed,
        numNineBed: btn.dataset.numNineBed,
        numTenBed: btn.dataset.numTenBed,
        numExtraBeds: btn.dataset.numExtraBeds
    }, true); // true = isEdit mode
}

function openActivityModal(activityId, activityName, dayNumber) {
    BookingSystem.open('activity', { activityId, activityName, dayNumber });
}

function editActivityBooking(bookingId) {
    const btn = event.target.closest('button');
    if (!btn) return;

    BookingSystem.open('activity', {
        bookingId,
        activityId: btn.dataset.activityId,
        activityName: btn.dataset.activityName,
        dayNumber: btn.dataset.dayNumber,
        bookingDate: btn.dataset.bookingDate,
        bookingTime: btn.dataset.bookingTime,
        numAdults: btn.dataset.numAdults,
        numChildren: btn.dataset.numChildren,
        notes: btn.dataset.notes
    }, true);
}

function openStandaloneModal(inclusionId, inclusionName, dayNumber) {
    BookingSystem.open('standalone', { inclusionId, inclusionName, dayNumber });
}

function editStandaloneInclusion(bookingId) {
    const btn = event.target.closest('button');
    if (!btn) return;

    BookingSystem.open('standalone', {
        bookingId,
        inclusionId: btn.dataset.inclusionId,
        inclusionName: btn.dataset.inclusionName,
        dayNumber: btn.dataset.dayNumber,
        bookingDate: btn.dataset.bookingDate,
        bookingTime: btn.dataset.bookingTime,
        numAdults: btn.dataset.numAdults,
        numChildren: btn.dataset.numChildren,
        notes: btn.dataset.notes
    }, true);
}

// ============================================================
// âœ… VEHICLE MODAL FUNCTIONS (FIXED)
// ============================================================

function openVehicleModal(buttonElement) {
    console.log('ðŸš— Opening Vehicle Modal...');
    
    // 1. Extract Data
    const vehicleId = buttonElement.getAttribute('data-vehicle-id');
    const vehicleName = buttonElement.getAttribute('data-vehicle-name');
    const dayNumber = buttonElement.getAttribute('data-day-number');
    const destinationId = buttonElement.getAttribute('data-destination-id');

    // 2. Open Modal (Sets hidden fields & dates)
    BookingSystem.open('vehicle', {
        vehicleId: vehicleId,
        vehicleName: vehicleName,
        dayNumber: dayNumber,
        destinationId: destinationId
    });

    // 3. ðŸ”¥ CRITICAL FIX: Manually populate the dropdown
    // This ensures the vehicle name appears immediately without waiting for API
    const dropdown = document.getElementById('modalVehicleDropdown');
    if (dropdown) {
        dropdown.innerHTML = ''; // Clear loading message
        const option = document.createElement('option');
        option.value = vehicleId;
        option.textContent = vehicleName; // Show name immediately
        option.selected = true;
        dropdown.appendChild(option);
        dropdown.disabled = false;
    }
}

function editVehicleBooking(button) {
    console.log('âœï¸ Editing Vehicle Booking...');
    
    // Handle cases where 'button' might be an ID or the element itself (fixing previous confusion)
    let btn = button;
    if (!(button instanceof Element)) {
        // If passed as an ID or event, try to find the button
        btn = event.target.closest('button');
    }
    
    if (!btn) {
        console.error('âŒ Edit button not found');
        return;
    }

    const dataset = btn.dataset;

    // 1. Open Modal
    BookingSystem.open('vehicle', {
        bookingId: dataset.bookingId,
        vehicleId: dataset.vehicleId,
        vehicleName: dataset.vehicleName,
        dayNumber: dataset.dayNumber,
        destinationId: dataset.destinationId,
        pickupDate: dataset.pickupDate,
        numPassengers: dataset.numPassengers,
        totalKm: dataset.totalKm || ''
    }, true);

    // 2. ðŸ”¥ CRITICAL FIX: Pre-fill dropdown for editing
    // We show the current vehicle immediately so the user knows what they are editing
    const dropdown = document.getElementById('modalVehicleDropdown');
    if (dropdown) {
        dropdown.innerHTML = ''; 
        const option = document.createElement('option');
        option.value = dataset.vehicleId;
        option.textContent = dataset.vehicleName;
        option.selected = true;
        dropdown.appendChild(option);
        dropdown.disabled = false;
        
        // 3. Load other vehicles in background (Optional: allows changing vehicle)
        // We delay this slightly so the user sees the current one first
        if (dataset.destinationId) {
            setTimeout(() => {
                fetch(`/api/vehicles/by-destination/?destination_id=${dataset.destinationId}`)
                    .then(r => r.json())
                    .then(data => {
                        if (data.success && data.vehicles) {
                            dropdown.innerHTML = '<option value="">-- Change Vehicle --</option>';
                            
                            // Re-add Current Vehicle (if missing from API list)
                            if (!data.vehicles.some(v => v.id == dataset.vehicleId)) {
                                const currentOpt = document.createElement('option');
                                currentOpt.value = dataset.vehicleId;
                                currentOpt.textContent = dataset.vehicleName;
                                currentOpt.selected = true;
                                dropdown.appendChild(currentOpt);
                            }

                            // Add All Vehicles
                            data.vehicles.forEach(v => {
                                const opt = document.createElement('option');
                                opt.value = v.id;
                                opt.textContent = `${v.name} (${v.vehicle_type})`;
                                if (v.id == dataset.vehicleId) opt.selected = true;
                                dropdown.appendChild(opt);
                            });
                        }
                    });
            }, 500);
        }
    }
}

function selectDay(dayNumber) {
    const url = new URL(window.location.href);
    url.searchParams.set('day', dayNumber);
    window.location.href = url.toString();
}
// ============================================================
// INITIALIZE ON PAGE LOAD
// ============================================================

document.addEventListener('DOMContentLoaded', function() {
    console.log('Booking System Initializing...');

    if (typeof bootstrap === 'undefined') {
        console.error('Bootstrap is not loaded!');
        return;
    }

    console.log('Bootstrap loaded');
    console.log('Itinerary Config:', BookingSystem.config.itinerary);

    // Checkout date change handler for hotel
    const checkoutDate = document.getElementById('checkoutDate');
    if (checkoutDate) {
        checkoutDate.addEventListener('change', function() {
            const hotelId = document.getElementById('modalHotelId')?.value;
            const checkinDate = document.getElementById('checkinDate');
            const checkIn = checkinDate?.value;
            const checkOut = this.value;

            if (checkIn && checkOut && new Date(checkOut) <= new Date(checkIn)) {
                alert('Check-out date must be after check-in date! We require at least 1 night stay.');
                this.value = '';
                return;
            }

            const selectedRoomTypeId = document.getElementById('roomType')?.value || null;
            const selectedMealPlanId = document.getElementById('mealPlan')?.value || null;

            if (hotelId && checkIn && checkOut) {
                BookingSystem.loadHotelRoomTypes(
                    hotelId,
                    checkIn,
                    checkOut,
                    selectedRoomTypeId,
                    selectedMealPlanId
                );
            }
        });
    }

    // Checkout date change handler for houseboat
    const houseboatCheckOut = document.getElementById('houseboatCheckOut');
    if (houseboatCheckOut) {
        houseboatCheckOut.addEventListener('change', function() {
            const houseboatId = document.getElementById('modalHouseboatId')?.value;
            const houseboatCheckIn = document.getElementById('houseboatCheckIn');
            const checkIn = houseboatCheckIn?.value;
            const checkOut = this.value;

            if (checkIn && checkOut && new Date(checkOut) < new Date(checkIn)) {
                alert('Check-out date cannot be before check-in date!');
                this.value = checkIn;
                return;
            }

            const selectedRoomTypeId = document.getElementById('houseboatRoomType')?.value || null;
            const selectedMealPlanId = document.getElementById('houseboatMealPlan')?.value || null;

            if (houseboatId && checkIn && checkOut) {
                BookingSystem.loadHouseboatOptions(
                    houseboatId,
                    checkIn,
                    checkOut,
                    selectedRoomTypeId,
                    selectedMealPlanId
                );
            }
        });
    }

    // Section select auto-submit
    const sectionSelect = document.getElementById('sectionSelect');
    if (sectionSelect) {
        sectionSelect.addEventListener('change', function() {
            const form = document.getElementById('sectionSelectForm');
            if (form) form.submit();
        });
    }

    // Destination auto-save
    document.querySelectorAll('.auto-save-destination').forEach(select => {
        select.addEventListener('change', function() {
            const form = this.closest('form');
            if (form) form.submit();
        });
    });

    // Hotel modal open via delegation
    document.addEventListener('click', function(e) {
        const btn = e.target.closest('.open-hotel-modal');
        if (btn) {
            e.preventDefault();
            BookingSystem.open('hotel', {
                hotelId: btn.dataset.hotelId,
                hotelName: btn.dataset.hotelName,
                dayNumber: btn.dataset.dayNumber,
                destinationId: btn.dataset.destinationId,
                destinationName: btn.dataset.destinationName
            });
        }
    });

    // Modal close cleanup
    document.querySelectorAll('.modal .btn-close, .modal [data-bs-dismiss="modal"]').forEach(btn => {
        btn.addEventListener('click', function() {
            const modal = this.closest('.modal');
            if (modal) {
                const bsModal = bootstrap.Modal.getInstance(modal);
                if (bsModal) {
                    bsModal.hide();
                }
                setTimeout(() => {
                    BookingSystem.closeAllModals();
                }, 300);
            }
        });
    });

    // Escape key handler
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            setTimeout(() => {
                BookingSystem.closeAllModals();
            }, 300);
        }
    });

    console.log('Booking System Ready!');
    console.log('âœ… Master Booking feature ENABLED');
    console.log('âœ… Vehicle date auto-calculation ENABLED');
    console.log('âœ… Room type & meal plan PRESERVE on date change');
});

console.log('âœ… Unified Booking System Loaded - WITH MASTER BOOKING');
</script>








<script>
// ============================================================
// UNIVERSAL SPECIAL INCLUSIONS MANAGEMENT SCRIPT
// Works for: Hotels & Houseboats
// ============================================================

console.log('ðŸš€ Universal Inclusions Script Loading...');

// ============================================================
// GLOBAL STATE
// ============================================================
let currentModalType = null; // 'hotel' or 'houseboat'

// ============================================================
// INITIALIZE ON DOM READY
// ============================================================
document.addEventListener('DOMContentLoaded', function() {
    console.log('âœ… Universal Inclusions Script Loaded');

    // Setup both modals
    setupModal('hotel', 'hotelBookingModal', 'hotelBookingForm');
    setupModal('houseboat', 'houseboatBookingModal', 'houseboatBookingForm');
});

// ============================================================
// SETUP MODAL (GENERIC FUNCTION)
// ============================================================
function setupModal(type, modalId, formId) {
    const modal = document.getElementById(modalId);
    const form = document.getElementById(formId);

    if (!modal) {
        console.log(`âš ï¸ ${modalId} not found (may not be on this page)`);
        return;
    }

    console.log(`âœ… Setting up ${type} modal:`, modalId);

    // Setup form submission
    if (form) {
        form.addEventListener('submit', function(e) {
            console.log(`ðŸ“¤ ${type} form submitting...`);
            const inclusionsData = serializeInclusionsData(type);

            // Add hidden field with inclusions data
            let hiddenField = form.querySelector('input[name="inclusions_data"]');
            if (!hiddenField) {
                hiddenField = document.createElement('input');
                hiddenField.type = 'hidden';
                hiddenField.name = 'inclusions_data';
                form.appendChild(hiddenField);
            }
            hiddenField.value = inclusionsData;

            console.log(`âœ… ${type} inclusions data:`, inclusionsData);
        });
    }

    // Setup modal shown event
    modal.addEventListener('shown.bs.modal', function() {
        console.log(`ðŸ¨ ${type} modal opened`);
        currentModalType = type;

        // Initialize Add Inclusion button for this modal
        initializeAddInclusionButton(type);

        // Check for edit mode and load inclusions
        setTimeout(() => checkAndLoadInclusions(type), 100);
        setTimeout(() => checkAndLoadInclusions(type), 300);
        setTimeout(() => checkAndLoadInclusions(type), 600);
    });

    modal.addEventListener('hidden.bs.modal', function() {
        console.log(`ðŸšª ${type} modal closed`);
        if (currentModalType === type) {
            currentModalType = null;
        }
    });
}

// ============================================================
// CHECK AND LOAD INCLUSIONS (GENERIC)
// ============================================================
function checkAndLoadInclusions(type) {
    const prefix = type === 'hotel' ? 'hotel' : 'houseboat';

    // Try to find booking ID
    const bookingIdField =
        document.getElementById(`${prefix}BookingId`) ||
        document.getElementById('modalBookingId') ||
        document.getElementById('booking_id') ||
        document.querySelector(`#${prefix}BookingModal input[name="booking_id"]`) ||
        document.querySelector(`#${prefix}BookingModal input[type="hidden"][name*="booking"]`);

    // Try to find destination
    const destinationField =
        document.getElementById('modalHouseboatDestination') ||
        document.getElementById(`${prefix}Destination`) ||
        document.querySelector(`#${prefix}BookingModal select[name*="destination"]`) ||
        document.querySelector(`#${prefix}BookingModal input[name*="destination"]`);

    // Try to find hotel/houseboat ID
    const propertyIdField =
        document.getElementById(type === 'hotel' ? 'modalHotelId' : 'modalHouseboatId') ||
        document.getElementById(`${prefix}_id`) ||
        document.querySelector(`#${prefix}BookingModal input[name="${prefix}_id"]`);

    const bookingId = bookingIdField?.value;
    const destinationId = destinationField?.value;
    const propertyId = propertyIdField?.value;

    console.log(`ðŸ“‹ ${type} fields:`, {
        bookingId: bookingId || 'âŒ',
        destinationId: destinationId || 'âŒ',
        propertyId: propertyId || 'âŒ'
    });

    // EDIT MODE: Has booking ID
    if (bookingId && bookingId !== '' && destinationId && propertyId) {
        console.log(`âœ… ${type} EDIT MODE detected`);
        loadExistingInclusions(type, bookingId, destinationId, propertyId);
    } else {
        console.log(`â„¹ï¸ ${type} CREATE MODE (no existing inclusions)`);
    }
}


// ============================================================
// INITIALIZE ADD INCLUSION BUTTON (GENERIC) - âœ… FIXED
// ============================================================
function initializeAddInclusionButton(type) {
    const btnId = type === 'hotel' ? 'addHotelInclusionBtn' : 'addHouseboatInclusionBtn';
    let addInclusionBtn = document.getElementById(btnId);

    // Try alternate IDs if main one is missing
    if (!addInclusionBtn) {
        addInclusionBtn = document.querySelector(`#${type}BookingModal .add-inclusion-btn`) ||
                          document.querySelector(`#${type}BookingModal [data-action="add-inclusion"]`);
    }

    if (!addInclusionBtn) {
        console.warn(`âš ï¸ ${type} Add Inclusion button not found (ID: ${btnId})`);
        return;
    }

    console.log(`âœ… Found ${type} Add Inclusion button`);

    // Remove old listeners (Clone replace hack)
    const newBtn = addInclusionBtn.cloneNode(true);
    addInclusionBtn.parentNode.replaceChild(newBtn, addInclusionBtn);

    // Add new listener
    newBtn.addEventListener('click', function(e) {
        e.preventDefault();
        console.log(`ðŸŽ¯ ${type} Add Inclusion clicked`);

        // 1. Get the Property ID (Hotel ID or Houseboat ID)
        const propertyId = type === 'hotel'
            ? document.getElementById('modalHotelId')?.value
            : document.getElementById('modalHouseboatId')?.value;

        // 2. âœ… FIXED: Get the Destination ID dynamically based on type
        // Previous code was ONLY looking for 'modalHouseboatDestination'
        const destinationId = type === 'hotel'
            ? document.getElementById('modalDestination')?.value  // Correct ID for Hotel
            : document.getElementById('modalHouseboatDestination')?.value; // Correct ID for Houseboat

        console.log(`ðŸ” Debug ${type}: PropertyID=${propertyId}, DestID=${destinationId}`);

        if (!propertyId || !destinationId) {
            // Customize alert message based on missing fields
            let missing = [];
            if (!propertyId) missing.push(type);
            if (!destinationId) missing.push("destination");
            alert(`âš ï¸ Please select ${missing.join(" and ")} first!`);
            return;
        }

        fetchSpecialInclusions(type, destinationId, propertyId);
    });
}
// ============================================================
// FETCH SPECIAL INCLUSIONS (GENERIC)
// ============================================================
function fetchSpecialInclusions(type, destinationId, propertyId) {
    console.log(`ðŸ“¡ Fetching ${type} inclusions...`);

    const paramName = type === 'hotel' ? 'hotel' : 'houseboat';
    const url = `/api/get-special-inclusions/?destination=${destinationId}&${paramName}=${propertyId}`;

    console.log('ðŸ”— API URL:', url);

    fetch(url)
        .then(response => response.json())
        .then(data => {
            console.log(`âœ… ${type} inclusions loaded:`, data);

            if (data.success && data.inclusions && data.inclusions.length > 0) {
                addInclusionRow(type, data.inclusions);
            } else {
                alert(`â„¹ï¸ No special inclusions available for this ${type}.\n\nFound: ${data.inclusions ? data.inclusions.length : 0} inclusions`);
            }
        })
        .catch(error => {
            console.error(`âŒ Error loading ${type} inclusions:`, error);
            alert(`âŒ Error loading inclusions: ${error.message}`);
        });
}

// ============================================================
// ADD INCLUSION ROW (GENERIC)
// ============================================================
function addInclusionRow(type, inclusions) {
    const containerId = type === 'hotel' ? 'hotelInclusionsContainer' : 'houseboatInclusionsContainer';
    const container = document.getElementById(containerId);

    if (!container) {
        console.error(`âŒ ${type} inclusions container not found (ID: ${containerId})`);
        return;
    }

    const noMsgId = type === 'hotel' ? 'noHotelInclusionsMessage' : 'noHouseboatInclusionsMessage';
    const noMsg = document.getElementById(noMsgId);
    const summaryId = type === 'hotel' ? 'hotelInclusionsSummary' : 'houseboatInclusionsSummary';
    const summary = document.getElementById(summaryId);

    if (noMsg) noMsg.style.display = 'none';
    if (summary) summary.style.display = 'block';

    const rowNumber = container.querySelectorAll('.inclusion-row').length + 1;

    const row = document.createElement('div');
    row.className = 'inclusion-row border rounded p-3 mb-3 bg-white shadow-sm';
    row.dataset.rowNumber = rowNumber;
    row.dataset.type = type;

    row.innerHTML = `
        <div class="d-flex justify-content-between align-items-start mb-2">
            <h6 class="mb-0 text-primary">
                <i class="fas fa-gift me-2"></i>Inclusion #${rowNumber}
            </h6>
            <button type="button" class="btn btn-sm btn-danger remove-inclusion-btn">
                <i class="fas fa-trash"></i>
            </button>
        </div>

        <div class="row g-2">
            <div class="col-md-6">
                <label class="form-label small fw-semibold">
                    <i class="fas fa-star me-1 text-warning"></i>Special Inclusion
                </label>
                <select class="form-select form-select-sm inclusion-select" required>
                    <option value="">-- Select Inclusion --</option>
                    ${inclusions.map(inc => `
                        <option value="${inc.id}" 
                                data-adult-price="${inc.adult_price}" 
                                data-child-price="${inc.child_price}"
                                data-pricing-type="${inc.pricing_type}"
                                data-name="${inc.name}">
                            ${inc.name} - ${inc.pricing_type === 'free' ? 'FREE' : 'â‚¹' + parseFloat(inc.adult_price).toFixed(2)}
                        </option>
                    `).join('')}
                </select>
                <small class="text-muted d-block mt-1 inclusion-pricing-info"></small>
            </div>

            <div class="col-md-3">
                <label class="form-label small fw-semibold">
                    <i class="fas fa-user me-1"></i>Adults
                </label>
                <input type="number" class="form-control form-control-sm inclusion-adults" 
                       value="0" min="0" max="50">
            </div>

            <div class="col-md-3">
                <label class="form-label small fw-semibold">
                    <i class="fas fa-child me-1"></i>Children
                </label>
                <input type="number" class="form-control form-control-sm inclusion-children" 
                       value="0" min="0" max="50">
            </div>
        </div>

        <div class="mt-2 p-2 bg-light rounded">
            <div class="d-flex justify-content-between align-items-center">
                <small class="text-muted inclusion-breakdown">
                    <i class="fas fa-calculator me-1"></i>Select inclusion and enter quantities
                </small>
                <strong class="text-success inclusion-price">â‚¹0.00</strong>
            </div>
        </div>
    `;

    container.appendChild(row);
    attachInclusionRowEvents(type, row);
    updateInclusionsSummary(type);

    console.log(`âœ… Added ${type} inclusion row #${rowNumber}`);
}

// ============================================================
// ATTACH EVENT LISTENERS TO ROW (GENERIC)
// ============================================================
function attachInclusionRowEvents(type, row) {
    const removeBtn = row.querySelector('.remove-inclusion-btn');
    const select = row.querySelector('.inclusion-select');
    const adultsInput = row.querySelector('.inclusion-adults');
    const childrenInput = row.querySelector('.inclusion-children');

    removeBtn.addEventListener('click', () => removeInclusionRow(type, row));

    select.addEventListener('change', () => {
        updatePricingInfo(row);
        calculateInclusionRowPrice(type, row);
    });

    adultsInput.addEventListener('input', () => calculateInclusionRowPrice(type, row));
    childrenInput.addEventListener('input', () => calculateInclusionRowPrice(type, row));
}

// ============================================================
// UPDATE PRICING INFO DISPLAY
// ============================================================
function updatePricingInfo(row) {
    const select = row.querySelector('.inclusion-select');
    const pricingInfo = row.querySelector('.inclusion-pricing-info');

    const selectedOption = select.options[select.selectedIndex];
    const adultPrice = parseFloat(selectedOption.dataset.adultPrice || 0);
    const childPrice = parseFloat(selectedOption.dataset.childPrice || 0);
    const pricingType = selectedOption.dataset.pricingType || 'per_person';

    if (!selectedOption.value) {
        pricingInfo.textContent = '';
        return;
    }

    let infoText = '';
    if (pricingType === 'free') {
        infoText = 'ðŸŽ Complimentary (Free)';
    } else if (pricingType === 'per_person') {
        infoText = `Adult: â‚¹${adultPrice.toFixed(2)} | Child: â‚¹${childPrice.toFixed(2)} (per person)`;
    } else if (pricingType === 'per_room') {
        infoText = `â‚¹${adultPrice.toFixed(2)} per room`;
    } else if (pricingType === 'per_booking') {
        infoText = `â‚¹${adultPrice.toFixed(2)} per booking`;
    }

    pricingInfo.textContent = infoText;
}

// ============================================================
// CALCULATE PRICE FOR SINGLE ROW
// ============================================================
function calculateInclusionRowPrice(type, row) {
    const select = row.querySelector('.inclusion-select');
    const adultsInput = row.querySelector('.inclusion-adults');
    const childrenInput = row.querySelector('.inclusion-children');
    const priceDisplay = row.querySelector('.inclusion-price');
    const breakdownDisplay = row.querySelector('.inclusion-breakdown');

    const selectedOption = select.options[select.selectedIndex];
    const adultPrice = parseFloat(selectedOption.dataset.adultPrice || 0);
    const childPrice = parseFloat(selectedOption.dataset.childPrice || 0);
    const pricingType = selectedOption.dataset.pricingType || 'per_person';

    const adults = parseInt(adultsInput.value || 0);
    const children = parseInt(childrenInput.value || 0);

    let total = 0;
    let breakdown = '';

    if (!selectedOption.value) {
        priceDisplay.textContent = 'â‚¹0.00';
        breakdownDisplay.innerHTML = '<i class="fas fa-calculator me-1"></i>Select inclusion';
        return;
    }

    if (pricingType === 'free') {
        total = 0;
        breakdown = 'ðŸŽ FREE';
    } else if (pricingType === 'per_person') {
        total = (adultPrice * adults) + (childPrice * children);
        if (adults > 0 && children > 0) {
            breakdown = `${adults}A Ã— â‚¹${adultPrice.toFixed(2)} + ${children}C Ã— â‚¹${childPrice.toFixed(2)}`;
        } else if (adults > 0) {
            breakdown = `${adults}A Ã— â‚¹${adultPrice.toFixed(2)}`;
        } else if (children > 0) {
            breakdown = `${children}C Ã— â‚¹${childPrice.toFixed(2)}`;
        }
    } else if (pricingType === 'per_room') {
        total = adultPrice;
        breakdown = 'â‚¹' + adultPrice.toFixed(2) + ' per room';
    } else if (pricingType === 'per_booking') {
        total = adultPrice;
        breakdown = 'â‚¹' + adultPrice.toFixed(2) + ' per booking';
    }

    priceDisplay.textContent = `â‚¹${total.toFixed(2)}`;
    breakdownDisplay.innerHTML = `<i class="fas fa-calculator me-1"></i>${breakdown}`;

    updateInclusionsSummary(type);
}

// ============================================================
// REMOVE INCLUSION ROW (GENERIC)
// ============================================================
function removeInclusionRow(type, row) {
    const containerId = type === 'hotel' ? 'hotelInclusionsContainer' : 'houseboatInclusionsContainer';
    const container = document.getElementById(containerId);

    row.remove();
    renumberInclusionRows(type);
    updateInclusionsSummary(type);

    if (container && container.querySelectorAll('.inclusion-row').length === 0) {
        const noMsgId = type === 'hotel' ? 'noHotelInclusionsMessage' : 'noHouseboatInclusionsMessage';
        const noMsg = document.getElementById(noMsgId);
        if (noMsg) noMsg.style.display = 'block';

        const summaryId = type === 'hotel' ? 'hotelInclusionsSummary' : 'houseboatInclusionsSummary';
        const summary = document.getElementById(summaryId);
        if (summary) summary.style.display = 'none';
    }
}

// ============================================================
// RENUMBER ROWS (GENERIC)
// ============================================================
function renumberInclusionRows(type) {
    const containerId = type === 'hotel' ? 'hotelInclusionsContainer' : 'houseboatInclusionsContainer';
    const container = document.getElementById(containerId);
    if (!container) return;

    const rows = container.querySelectorAll('.inclusion-row');
    rows.forEach((row, index) => {
        const numberSpan = row.querySelector('.inclusion-number') || row.querySelector('h6');
        if (numberSpan) {
            numberSpan.innerHTML = `<i class="fas fa-gift me-2"></i>Inclusion #${index + 1}`;
        }
        row.dataset.rowNumber = index + 1;
    });
}

// ============================================================
// UPDATE SUMMARY (GENERIC)
// ============================================================
function updateInclusionsSummary(type) {
    const summaryId = type === 'hotel' ? 'hotelInclusionsSummary' : 'houseboatInclusionsSummary';
    const totalCostId = type === 'hotel' ? 'hotelTotalInclusionCost' : 'houseboatTotalInclusionCost';
    const summaryTextId = type === 'hotel' ? 'hotelInclusionsSummaryText' : 'houseboatInclusionsSummaryText';
    const containerId = type === 'hotel' ? 'hotelInclusionsContainer' : 'houseboatInclusionsContainer';

    const summary = document.getElementById(summaryId);
    const totalCostEl = document.getElementById(totalCostId);
    const summaryText = document.getElementById(summaryTextId);
    const container = document.getElementById(containerId);

    if (!container) return;

    let grandTotal = 0;
    let inclusionCount = 0;

    container.querySelectorAll('.inclusion-row').forEach(row => {
        const select = row.querySelector('.inclusion-select');
        if (!select || !select.value) return;

        const priceText = row.querySelector('.inclusion-price')?.textContent || 'â‚¹0.00';
        const price = parseFloat(priceText.replace('â‚¹', '').replace(',', ''));

        if (!isNaN(price)) {
            grandTotal += price;
            inclusionCount++;
        }
    });

    if (inclusionCount > 0 && summary) {
        summary.style.display = 'block';
        if (totalCostEl) totalCostEl.textContent = `â‚¹${grandTotal.toFixed(2)}`;
        if (summaryText) summaryText.textContent = `${inclusionCount} inclusion(s) added`;
    } else if (summary) {
        summary.style.display = 'none';
    }
}

// ============================================================
// SERIALIZE INCLUSIONS DATA (GENERIC)
// ============================================================
function serializeInclusionsData(type) {
    const containerId = type === 'hotel' ? 'hotelInclusionsContainer' : 'houseboatInclusionsContainer';
    const container = document.getElementById(containerId);

    if (!container) {
        console.warn(`âš ï¸ ${type} container not found`);
        return '[]';
    }

    const inclusions = [];

    container.querySelectorAll('.inclusion-row').forEach(row => {
        const select = row.querySelector('.inclusion-select');
        const adultsInput = row.querySelector('.inclusion-adults');
        const childrenInput = row.querySelector('.inclusion-children');

        const inclusionId = select?.value;
        const adults = parseInt(adultsInput?.value || 0);
        const children = parseInt(childrenInput?.value || 0);

        if (inclusionId && (adults > 0 || children > 0)) {
            inclusions.push({
                id: parseInt(inclusionId),
                adults: adults,
                children: children
            });
        }
    });

    console.log(`ðŸ“¦ ${type} serialized inclusions:`, inclusions);
    return JSON.stringify(inclusions);
}

// ============================================================
// LOAD EXISTING INCLUSIONS FOR EDIT MODE (GENERIC)
// ============================================================
function loadExistingInclusions(type, bookingId, destinationId, propertyId) {
    console.log(`ðŸ“¥ Loading existing ${type} inclusions for booking:`, bookingId);

    const endpoint = type === 'hotel'
        ? `/api/get-booking-inclusions/${bookingId}/`
        : `/api/get-houseboat-booking-inclusions/${bookingId}/`;

    fetch(endpoint)
        .then(response => response.json())
        .then(savedData => {
            console.log(`âœ… Saved ${type} inclusions:`, savedData);

            if (!savedData.success || !savedData.inclusions || savedData.inclusions.length === 0) {
                console.log(`â„¹ï¸ No saved ${type} inclusions`);
                return;
            }

            const paramName = type === 'hotel' ? 'hotel' : 'houseboat';
            const url = `/api/get-special-inclusions/?destination=${destinationId}&${paramName}=${propertyId}`;

            fetch(url)
                .then(response => response.json())
                .then(availableData => {
                    if (!availableData.success) return;

                    const containerId = type === 'hotel' ? 'hotelInclusionsContainer' : 'houseboatInclusionsContainer';
                    const container = document.getElementById(containerId);

                    if (!container) return;

                    container.innerHTML = '';

                    savedData.inclusions.forEach((savedInc, index) => {
                        addInclusionRow(type, availableData.inclusions);

                        const rows = container.querySelectorAll('.inclusion-row');
                        const lastRow = rows[rows.length - 1];

                        if (!lastRow) return;

                        const select = lastRow.querySelector('.inclusion-select');
                        const adultsInput = lastRow.querySelector('.inclusion-adults');
                        const childrenInput = lastRow.querySelector('.inclusion-children');

                        if (select) select.value = savedInc.inclusion_id;
                        if (adultsInput) adultsInput.value = savedInc.num_adults;
                        if (childrenInput) childrenInput.value = savedInc.num_children;

                        if (select) select.dispatchEvent(new Event('change'));
                    });

                    console.log(`ðŸŽ‰ Loaded ${savedData.inclusions.length} ${type} inclusions`);
                })
                .catch(error => console.error(`âŒ Error loading available ${type} inclusions:`, error));
        })
        .catch(error => console.error(`âŒ Error loading saved ${type} inclusions:`, error));
}

console.log('âœ… Universal Inclusions Script Ready! ðŸŽ‰');
</script>













<!-- ============================================ -->
<!-- CHANGE DETECTION & VERSIONING SYSTEM -->
<!-- ============================================ -->
<script>
(function() {
    'use strict';

    // ============================================
    // CONFIGURATION
    // ============================================
    const isFinalized = {{ itinerary.is_finalized|yesno:"true,false" }};
    const itineraryId = {{ itinerary.id }};

    console.log('ðŸ“‹ Itinerary Status:', isFinalized ? 'FINALIZED âœ…' : 'DRAFT ðŸ“');

    // Only track changes if itinerary is already finalized
    if (!isFinalized) {
        console.log('â„¹ï¸ Change tracking DISABLED (new/draft itinerary)');
        return; // Exit early - no tracking needed
    }

    console.log('ðŸ” Change tracking ENABLED (editing finalized itinerary)');

    // ============================================
    // CSRF TOKEN HELPER
    // ============================================
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // ============================================
    // MARK CHANGES IN SESSION
    // ============================================
    function markChanges(changeType) {
        console.log('ðŸ”” Marking change:', changeType);

        fetch(`/itinerary/${itineraryId}/mark-changes/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'X-Requested-With': 'XMLHttpRequest',
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                change_type: changeType,
                timestamp: new Date().toISOString()
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('âœ… Change marked in session');
                showChangeIndicator();
            } else {
                console.error('âŒ Failed to mark change:', data.message);
            }
        })
        .catch(error => {
            console.error('âŒ Error marking change:', error);
        });
    }

    // ============================================
    // VISUAL INDICATOR
    // ============================================
    function showChangeIndicator() {
        // Check if indicator already exists
        let indicator = document.getElementById('changes-indicator');

        if (!indicator) {
            // Create floating indicator
            indicator = document.createElement('div');
            indicator.id = 'changes-indicator';
            indicator.innerHTML = `
                <div style="position: fixed; bottom: 20px; right: 20px; z-index: 9999;
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            color: white; padding: 15px 25px; border-radius: 10px;
                            box-shadow: 0 4px 15px rgba(0,0,0,0.3); font-weight: 600;
                            animation: pulse 2s infinite;">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    Changes Detected - New Version on Save
                </div>
                <style>
                    @keyframes pulse {
                        0%, 100% { opacity: 1; }
                        50% { opacity: 0.7; }
                    }
                </style>
            `;
            document.body.appendChild(indicator);
        }
    }

    // ============================================
    // LISTEN FOR FORM SUBMISSIONS
    // ============================================
    document.addEventListener('submit', function(e) {
        const form = e.target;
        const formType = form.querySelector('input[name="form_type"]')?.value;

        // Track specific form types that modify day plans
        const trackedFormTypes = [
            'bulk_delete_all_day_plans',
            'bulk_delete_all_hotels',
            'bulk_delete_all_activities',
            'bulk_delete_all_houseboats',
            'bulk_delete_all_vehicles',
            'destination_select',
            'delete_day_itinerary',
            'select_day_itinerary',
            'edit_day_details'
        ];

        if (formType && trackedFormTypes.includes(formType)) {
            console.log('ðŸŽ¯ Detected change form:', formType);
            markChanges(formType);
        }
    });

    console.log('âœ… Change tracking system initialized');
})();
</script>


<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchBox = document.getElementById('availableItemsSearch');
    const clearBtn = document.getElementById('clearSearchBtn');
    const resultsInfo = document.getElementById('searchResultsInfo');
    const noResultsMsg = document.getElementById('noResultsMessage');

    if (!searchBox) {
        console.warn('Search box not found');
        return;
    }

    // Search functionality
    searchBox.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase().trim();
        const container = document.querySelector('.available-items-box');

        if (!container) return;

        const items = container.querySelectorAll('.item-card');
        let visibleCount = 0;

        // Show/hide clear button
        if (searchTerm) {
            clearBtn.classList.add('show');
        } else {
            clearBtn.classList.remove('show');
        }

        // Filter items
        items.forEach(item => {
            const itemText = item.textContent.toLowerCase();
            const itemHTML = item.innerHTML.toLowerCase();

            // Search in item text, title, description, badges
            const matches =
                itemHTML.includes(searchTerm) ||
                itemText.includes(searchTerm);

            if (searchTerm === '' || matches) {
                item.classList.remove('hidden-by-search');
                item.classList.add('visible-by-search');
                visibleCount++;
            } else {
                item.classList.add('hidden-by-search');
                item.classList.remove('visible-by-search');
            }
        });

        // Update results info and no results message
        if (searchTerm) {
            if (visibleCount === 0) {
                resultsInfo.textContent = `No results found for "${searchTerm}"`;
                resultsInfo.classList.add('no-results');
                noResultsMsg.classList.add('show');
            } else {
                resultsInfo.textContent = `Showing ${visibleCount} of ${items.length} items`;
                resultsInfo.classList.remove('no-results');
                noResultsMsg.classList.remove('show');
            }
        } else {
            resultsInfo.textContent = '';
            resultsInfo.classList.remove('no-results');
            noResultsMsg.classList.remove('show');
        }
    });

    // Clear button functionality
    clearBtn.addEventListener('click', function() {
        searchBox.value = '';
        searchBox.dispatchEvent(new Event('input'));
        searchBox.focus();
    });

    // Keyboard shortcut: Escape to clear
    searchBox.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            this.value = '';
            this.dispatchEvent(new Event('input'));
        }
    });
});
</script>
<script>
    function enableVehicleChangeMode() {
    const bookingId = document.getElementById('vehicleBookingId')?.value;
    const destinationId = document.getElementById('modalVehicleDestinationId')?.value;

    if (!destinationId) {
        alert('Destination not found. Please close and reopen the modal.');
        return;
    }

    // Hide readonly view
    document.getElementById('vehicleReadonlyContainer').style.display = 'none';

    // Show dropdown
    document.getElementById('vehicleChangeContainer').style.display = 'block';

    // Mark as change
    document.getElementById('isVehicleChange').value = 'true';

    // Load vehicles
    BookingSystem.loadVehiclesByDestination(destinationId);
}

</script>
<script>
    // ------------------------------------------------------------
    // 1. TOGGLE HOTEL INPUT MODE (Select vs Manual Text)
    // ------------------------------------------------------------
    function toggleHotelInputMode() {
        const selectContainer = document.getElementById('hotelSelectContainer');
        const inputContainer = document.getElementById('hotelInputContainer');
        const toggleBtn = document.getElementById('toggleDemoHotelBtn');
        const isDemoInput = document.getElementById('isDemoMode');

        const dropdown = document.getElementById('modalHotelNameDropdown');
        const customInput = document.getElementById('modalCustomHotelName');
        const hiddenHotelId = document.getElementById('modalHotelId');

        const destinationId = document.getElementById('modalDestination').value;
        const checkIn = document.getElementById('checkinDate').value;
        const checkOut = document.getElementById('checkoutDate').value;

        if (selectContainer.style.display !== 'none') {
            // ðŸ‘‰ SWITCH TO: DEMO MODE (Text Box)
            console.log("ðŸ”„ Switching to Demo Mode");
            selectContainer.style.display = 'none';
            inputContainer.style.display = 'block';

            toggleBtn.innerHTML = '<i class="fas fa-list me-1"></i> Select Real Hotel';
            toggleBtn.classList.remove('btn-outline-warning');
            toggleBtn.classList.add('btn-outline-primary');

            isDemoInput.value = 'true';
            hiddenHotelId.value = ""; 
            
            dropdown.value = ""; 
            dropdown.removeAttribute('required'); 
            customInput.setAttribute('required', 'true'); 
            
            if (typeof unlockDropdownsForDemo === 'function') unlockDropdownsForDemo();

        } else {
            // ðŸ‘ˆ SWITCH BACK TO: DATABASE MODE (Dropdown)
            console.log("ðŸ”„ Switching back to Database Mode");
            selectContainer.style.display = 'block';
            inputContainer.style.display = 'none';

            toggleBtn.innerHTML = '<i class="fas fa-magic me-1"></i> Use Demo Hotel';
            toggleBtn.classList.add('btn-outline-warning');
            toggleBtn.classList.remove('btn-outline-primary');

            isDemoInput.value = 'false';
            
            customInput.value = ""; 
            customInput.removeAttribute('required');
            dropdown.setAttribute('required', 'true');
            
            // Reload hotels if empty
            if (dropdown.options.length <= 1 && destinationId) {
                const hint = document.getElementById('hotelFieldHint');
                if(hint) hint.innerHTML = '<i class="fas fa-sync fa-spin me-1"></i>Loading hotels...';
                
                if (typeof BookingSystem !== 'undefined') {
                     BookingSystem.loadHotelsByMode('master', destinationId, checkIn, checkOut);
                }
            }
        }
    }

    // ------------------------------------------------------------
    // 2. TOGGLE ROOM TYPE (Select vs Manual)
    // ------------------------------------------------------------
    function toggleRoomTypeMode() {
        const selectContainer = document.getElementById('roomSelectContainer');
        const inputContainer = document.getElementById('roomInputContainer');
        const select = document.getElementById('roomType');
        const input = document.getElementById('customRoomType');
        const toggleText = document.getElementById('roomToggleText');

        if (selectContainer.style.display !== 'none') {
            // ðŸ‘‰ Switch to Manual Input
            selectContainer.style.display = 'none';
            inputContainer.style.display = 'block';
            
            select.removeAttribute('required');
            select.value = ""; 
            input.setAttribute('required', 'true');
            
            if(toggleText) {
                toggleText.innerHTML = '<i class="fas fa-list"></i> Select from List';
                toggleText.classList.add('text-danger');
            }
        } else {
            // ðŸ‘ˆ Switch back to Dropdown
            selectContainer.style.display = 'block';
            inputContainer.style.display = 'none';
            
            input.removeAttribute('required');
            input.value = ""; 
            select.setAttribute('required', 'true');
            
            if(toggleText) {
                toggleText.innerHTML = '<i class="fas fa-pen"></i> Type Manually';
                toggleText.classList.remove('text-danger');
            }
        }
    }

    // ------------------------------------------------------------
    // 3. UNLOCK HELPER: GENERIC OPTIONS FOR DEMO
    // ------------------------------------------------------------
    function unlockDropdownsForDemo() {
        const roomSelect = document.getElementById('roomType');
        const mealSelect = document.getElementById('mealPlan');
        
        if(roomSelect) {
            roomSelect.disabled = false;
            roomSelect.innerHTML = `
                <option value="">-- Select Room Category --</option>
                <option value="1">Standard Room</option>
                <option value="2">Deluxe Room</option>
                <option value="3">Super Deluxe</option>
                <option value="4">Premium Room</option>
                <option value="5">Suite</option>
            `; 
        }
        
        if(mealSelect) {
            mealSelect.disabled = false;
            mealSelect.innerHTML = `
                <option value="">-- Select Meal Plan --</option>
                <option value="1">CPAI (Breakfast Only)</option>
                <option value="2">MAPAI (Breakfast + Dinner)</option>
                <option value="3">APAI (All Meals)</option>
            `;
        }
    }

    // ------------------------------------------------------------
    // 4. RESET MODAL ON CLOSE
    // ------------------------------------------------------------
    document.addEventListener('DOMContentLoaded', function() {
        const modalElement = document.getElementById('hotelBookingModal');

        if (modalElement) {
            modalElement.addEventListener('hidden.bs.modal', function () {
                console.log("ðŸ§¹ Resetting Modal UI");

                // âœ… FIX: RESET WARNING BOX & SAVE BUTTON
                const warningBox = document.getElementById('duplicateHotelWarning');
                const saveBtn = document.getElementById('btnSaveBooking');
                if (warningBox) warningBox.style.display = 'none';
                if (saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = '<i class="fas fa-save me-2"></i>Save Booking';
                }

                const selectContainer = document.getElementById('hotelSelectContainer');
                const inputContainer = document.getElementById('hotelInputContainer');
                const toggleBtn = document.getElementById('toggleDemoHotelBtn');
                const customInput = document.getElementById('modalCustomHotelName');
                const isDemoInput = document.getElementById('isDemoMode');

                // Force display back to Dropdown Mode
                if(selectContainer && inputContainer) {
                    selectContainer.style.display = 'block';
                    inputContainer.style.display = 'none';

                    if(toggleBtn) {
                        toggleBtn.innerHTML = '<i class="fas fa-magic me-1"></i> Use Demo Hotel';
                        toggleBtn.classList.add('btn-outline-warning');
                        toggleBtn.classList.remove('btn-outline-primary');
                    }
                    
                    if(customInput) customInput.value = "";
                    if(isDemoInput) isDemoInput.value = "false";
                }
                
                // Reset Room Type Toggle
                const roomSelect = document.getElementById('roomSelectContainer');
                const roomInput = document.getElementById('roomInputContainer');
                const roomToggleText = document.getElementById('roomToggleText');

                if(roomSelect) roomSelect.style.display = 'block';
                if(roomInput) roomInput.style.display = 'none';
                if(document.getElementById('customRoomType')) document.getElementById('customRoomType').value = "";
                if(roomToggleText) {
                    roomToggleText.innerHTML = '<i class="fas fa-pen"></i> Type Manually';
                    roomToggleText.classList.remove('text-danger');
                }
            });
        }
    });


    // ==========================================
// âœ… DUPLICATE HOTEL CHECKER FUNCTION
// ==========================================
function validateDuplicateHotel() {
    const currentHotelId = document.getElementById('modalHotelId').value;
    const currentOption = document.getElementById('hotelOption').value;
    const currentBookingId = document.getElementById('modalBookingId').value;
    const isDemoMode = document.getElementById('isDemoMode').value === 'true';
    const customName = document.getElementById('modalCustomHotelName').value.trim().toLowerCase();

    const warningBox = document.getElementById('duplicateHotelWarning');
    const saveBtn = document.getElementById('btnSaveBooking');
    const duplicateOptionLabel = document.getElementById('duplicateOptionName');

    // 1. Reset UI (Hide error first)
    warningBox.style.display = 'none';
    saveBtn.disabled = false;
    saveBtn.innerHTML = '<i class="fas fa-save me-2"></i>Save Booking';

    if (!window.EXISTING_HOTEL_BOOKINGS) return;

    // 2. Check logic
    const isDuplicate = window.EXISTING_HOTEL_BOOKINGS.some(existing => {
        // Skip if editing the same booking
        if (currentBookingId && existing.id == currentBookingId) return false;
        
        // Option must match
        if (existing.option !== currentOption) return false;

        // Hotel must match
        if (isDemoMode) {
            return existing.customName === customName;
        } else {
            return existing.hotelId === currentHotelId;
        }
    });

    // 3. Show Error if Duplicate
    if (isDuplicate) {
        duplicateOptionLabel.textContent = currentOption.replace('option_', 'Option '); // Simple formatter
        warningBox.style.display = 'block';
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<i class="fas fa-ban me-2"></i>Duplicate Detected';
    }
}

// ==========================================
// âœ… DUPLICATE HOUSEBOAT CHECKER
// ==========================================
function validateDuplicateHouseboat() {
    const currentId = document.getElementById('modalHouseboatId').value;
    const currentOption = document.getElementById('houseboatOption').value;
    // For houseboats, booking ID might be in the form action or a hidden input depending on your impl.
    // Assuming standard update pattern, we might need to extract it or store it.
    // For now, let's assume we are checking against the list.
    
    // NOTE: In your open() function for houseboat, ensure you set a hidden input for booking_id if editing.
    // Let's assume you added <input type="hidden" id="houseboatBookingId"> to the form.
    const currentBookingId = document.getElementById('houseboatBookingId') ? document.getElementById('houseboatBookingId').value : '';

    const warningBox = document.getElementById('duplicateHouseboatWarning');
    const saveBtn = document.querySelector('#houseboatBookingForm button[type="submit"]');
    const label = document.getElementById('duplicateHouseboatOptionName');

    // Reset
    if(warningBox) warningBox.style.display = 'none';
    if(saveBtn) {
        saveBtn.disabled = false;
        saveBtn.innerHTML = '<i class="fas fa-save me-1"></i>Save Booking';
    }

    if (!window.EXISTING_HOUSEBOAT_BOOKINGS || !currentId) return;

    const isDuplicate = window.EXISTING_HOUSEBOAT_BOOKINGS.some(existing => {
        if (currentBookingId && existing.id == currentBookingId) return false; // Ignore self
        return existing.houseboatId === currentId && existing.option === currentOption;
    });

    if (isDuplicate) {
        const optionMap = {
            'option1': 'Standard', 'option2': 'Deluxe',
            'option3': 'Premium',  'option4': 'Luxury'
        };
        if(label) label.textContent = optionMap[currentOption] || currentOption;
        if(warningBox) warningBox.style.display = 'block';
        if(saveBtn) {
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="fas fa-ban me-1"></i>Duplicate';
        }
    }
}
</script>













<script>
// ==========================================
// âœ… SCROLL POSITION PRESERVATION SYSTEM
// ==========================================

// Save scroll positions for all scrollable columns
function saveScrollPositions() {
    const contentColumn = document.querySelector('.content-column');
    const daysColumn = document.querySelector('.days-list-column');
    const addItemsColumn = document.querySelector('.add-items-column');
    
    const scrollData = {
        contentColumn: contentColumn ? contentColumn.scrollTop : 0,
        daysColumn: daysColumn ? daysColumn.scrollTop : 0,
        addItemsColumn: addItemsColumn ? addItemsColumn.scrollTop : 0,
        pageScroll: window.scrollY,
        timestamp: Date.now()
    };
    
    sessionStorage.setItem('dayPlanScrollPositions', JSON.stringify(scrollData));
}

// Restore scroll positions after page load
function restoreScrollPositions() {
    const savedData = sessionStorage.getItem('dayPlanScrollPositions');
    if (!savedData) return;
    
    try {
        const scrollData = JSON.parse(savedData);
        
        // Only restore if saved within last 30 seconds (prevents stale data)
        if (Date.now() - scrollData.timestamp > 30000) {
            sessionStorage.removeItem('dayPlanScrollPositions');
            return;
        }
        
        // Restore column scroll positions
        setTimeout(() => {
            const contentColumn = document.querySelector('.content-column');
            const daysColumn = document.querySelector('.days-list-column');
            const addItemsColumn = document.querySelector('.add-items-column');
            
            if (contentColumn && scrollData.contentColumn) {
                contentColumn.scrollTop = scrollData.contentColumn;
            }
            if (daysColumn && scrollData.daysColumn) {
                daysColumn.scrollTop = scrollData.daysColumn;
            }
            if (addItemsColumn && scrollData.addItemsColumn) {
                addItemsColumn.scrollTop = scrollData.addItemsColumn;
            }
            if (scrollData.pageScroll) {
                window.scrollTo(0, scrollData.pageScroll);
            }
            
            // Clear saved data after restoring
            sessionStorage.removeItem('dayPlanScrollPositions');
        }, 100);
        
    } catch (e) {
        console.log('Error restoring scroll positions:', e);
        sessionStorage.removeItem('dayPlanScrollPositions');
    }
}

// Attach to all forms to save scroll before submit
document.addEventListener('DOMContentLoaded', function() {
    // Restore scroll positions on page load
    restoreScrollPositions();
    
    // Save scroll before any form submission
    document.querySelectorAll('form').forEach(function(form) {
        form.addEventListener('submit', function() {
            saveScrollPositions();
        });
    });
    
    // Save scroll before clicking links that change pages
    document.querySelectorAll('a[href]').forEach(function(link) {
        link.addEventListener('click', function() {
            saveScrollPositions();
        });
    });
});

// Override selectDay to preserve scroll
(function() {
    const originalSelectDay = window.selectDay;
    window.selectDay = function(dayNumber) {
        saveScrollPositions();
        if (originalSelectDay) {
            originalSelectDay(dayNumber);
        } else {
            const url = new URL(window.location.href);
            url.searchParams.set('day', dayNumber);
            window.location.href = url.toString();
        }
    };
})();

// Also save scroll before navigation (for any edge cases)
window.addEventListener('beforeunload', function() {
    saveScrollPositions();
});
</script>

{% endblock %}
