{% extends 'itinerary_base.html' %}
{% load static %}
{% load booking_tags %}
{% load widget_tweaks %}

{% load custom_tags %}
{% block nav_title %}Build Itinerary{% endblock %}

{% block body %}

<br><br>
{% if messages %}
<script>
    {% for message in messages %}
        Swal.fire({
            toast: false,
            position: 'center',
            icon: '{{ message.tags }}',
            title: '{{ message }}',
            showConfirmButton: false,
            timer: 3000
        });
    {% endfor %}
</script>
{% endif %}
<style>
    /* STYLES ARE UNCHANGED, KEPT FOR COMPLETENESS */
    .section-box {
        background: #ffffff; border: 4px solid #e0e0e0; border-radius: 10px;
        padding: 20px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); height: 100%;
    }
    .date-time-section {
        background-color: #fffbeb; border: 1px solid #ffe58f;
        border-radius: 0.375rem; padding: 1.5rem;
    }
    .section-box h4 {
        margin-bottom: 20px; font-size: 18px; border-bottom: 2px solid #ddd;
        padding-bottom: 10px;
    }
    .list-group .border:hover {
        border-color: #007bff !important; background-color: #f8f9fa;
    }
    .accordion-button { background-color: #f8f9fa; border: none; }
    .accordion-button:not(.collapsed) { background-color: #e3f2fd; box-shadow: none; }
    /* Add these new styles inside your <style> tag */

    .booking-card {
        background-color: #fff;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        display: flex;
        align-items: flex-start;
        gap: 1rem;
    }

    .booking-icon {
        flex-shrink: 0;
        width: 60px;
        height: 60px;
        background-color: #e3f2fd;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        color: #007bff;
        position: relative;
    }

    .booking-icon .edit-overlay {
        position: absolute;
        bottom: 0;
        right: 0;
        width: 24px;
        height: 24px;
        background-color: #343a40;
        color: #fff;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        border: 2px solid #fff;
    }

    .booking-content {
        flex-grow: 1;
    }

    .booking-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
    }

    .hotel-name {
        font-size: 1.1rem;
        font-weight: 600;
        color: #333;
    }

    .star-rating {
        color: #ffc107;
        margin: 0 0.5rem;
    }

    .option-badge {
        font-size: 0.75rem;
        font-weight: 600;
        padding: 0.25em 0.6em;
        border-radius: 20px;
        color: #fff;
    }

    .option-1 { background-color: #0d6efd; }
    .option-2 { background-color: #198754; }
    .option-3 { background-color: #dc3545; }

    .edit-icon a {
        color: #6c757d;
        font-size: 1.25rem;
    }

    .booking-details-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
        font-size: 0.9rem;
        padding-top: 0.75rem;
        border-top: 1px solid #f1f1f1;
    }

    .detail-item .label {
        font-size: 0.8rem;
        color: #6c757d;
        text-transform: uppercase;
        font-weight: 500;
        display: block;
        margin-bottom: 0.25rem;
    }

    .detail-item .data {
        font-weight: 500;
        color: #212529;
    }

    .detail-item .data i {
        margin-right: 0.4rem;
        color: #6c757d;
    }
</style>
<br><br>

<h2 class="mb-4">itinerary Plan Days for: {{ itinerary.name }}<h2>
{% comment %} <h4><a href="{% url ''%}"><button>pricing</button></a></h4> {% endcomment %}
{% comment %} <div> <h1>{{itinerary.start_date}}to{{itinerary.end_date}}</h1></div> {% endcomment %}

<div class="row">
{% if can_manage_destinations %}
<div class="col-lg-3 mb-9">
    
    <div class="section-box">
        <h4>Days & Destinations</h4>
        {% for day in days %}
            <form method="post" class="mb-3">
                {% csrf_token %}
                <input type="hidden" name="form_type" value="destination_select">
                <input type="hidden" name="day_number" value="{{ day }}">
                <label for="dest-day-{{ day }}">Day {{ day }}:</label>
                <select name="destination" id="dest-day-{{ day }}" class="form-select" required>
                    <option value="">-- Select Destination --</option>
                    {% for dest in destinations %}
                        <option value="{{ dest.id }}"
                                {% if plans|get_item:day and plans|get_item:day.destination.id == dest.id %}selected{% endif %}>
                            {{ dest.name }}
                        </option>
                    {% endfor %}
                </select>
                <button type="submit" class="btn btn-primary mt-2 w-100">Save</button>
            </form>
        {% endfor %}
    </div>
</div>
{% endif %}


        {% if can_view_saved_items %}
        <div class="col-lg-{% if can_manage_destinations and can_add_items %}6{% elif can_manage_destinations or can_add_items %}9{% else %}12{% endif %} mb-4">
    <div class="section-box">
        <h4>Saved Items</h4>
        {% if saved_items_by_day %}
            <div class="accordion" id="savedItemsAccordion">
                {% for day_number, day_data in saved_items_by_day.items %}
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="heading{{ day_number }}">
                            <button class="accordion-button {% if not forloop.first %}collapsed{% endif %}" 
                                    type="button" 
                                    data-bs-toggle="collapse" 
                                    data-bs-target="#collapse{{ day_number }}" 
                                    aria-expanded="{% if forloop.first %}true{% else %}false{% endif %}" 
                                    aria-controls="collapse{{ day_number }}">
                                <strong>Day {{ day_number }}</strong>
                                {% if day_data.destination %}
                                    <span class="text-muted ms-2">- {{ day_data.destination }}</span>
                                {% endif %}
                            </button>
                        </h2>
                        
                        <div id="collapse{{ day_number }}" 
                             class="accordion-collapse collapse {% if forloop.first %}show{% endif %}" 
                             aria-labelledby="heading{{ day_number }}" 
                             data-bs-parent="#savedItemsAccordion">
                            <div class="accordion-body">

                                <!-- Day Itinerary Card -->
                                {% if day_data.day_plan %}
                                    {% if day_data.day_plan.title or day_data.day_plan.get_description or day_data.day_plan.get_image %}
                                    <div class="booking-card mb-3" style="border-left: 4px solid #6c757d;">
                                        <div class="booking-icon" style="background-color: #e9ecef; color: #6c757d;">
                                            <i class="fas fa-map-marked-alt"></i>
                                        </div>
                                        <div class="booking-content">
                                            <div class="booking-header">
                                                <div class="d-flex align-items-start w-100">
                                                    {% if day_data.day_plan.get_image %}
                                                    <div class="flex-shrink-0 me-3">
                                                        <img src="{{ day_data.day_plan.get_image.url }}" 
                                                            alt="{{ day_data.day_plan.title }}" 
                                                            style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px;">
                                                    </div>
                                                    {% endif %}
                                                    
                                                    <div class="flex-grow-1">
                                                        {% if day_data.day_plan.title %}
                                                        <span class="hotel-name d-block mb-2">{{ day_data.day_plan.title }}</span>
                                                        {% endif %}
                                                        
                                                        {% if day_data.day_plan.get_description %}
                                                        <p class="text-muted mb-0" style="font-size: 0.9rem; line-height: 1.5;">
                                                            {{ day_data.day_plan.get_description|truncatewords:30 }}
                                                        </p>
                                                        {% endif %}
                                                    </div>
                                                    
                                                    <!-- ✅ EDIT BUTTON - Permission Check -->
                                                    {% if user_type == 'superuser' or current_user.role == 'admin' or current_user.role == 'manager' or current_user.permissions.can_edit_bookings %}
                                                    <div class="edit-icon ms-2">
                                                        <a href="#" class="text-primary"
                                                        data-bs-toggle="modal" 
                                                        data-bs-target="#editDayDetailsModal"
                                                        data-day-number="{{ day_number }}"
                                                        data-title="{{ day_data.day_plan.title|default:'' }}"
                                                        data-description="{{ day_data.day_plan.description|default:'' }}"
                                                        title="Edit Day Details">
                                                            <i class="fas fa-pen"></i>
                                                        </a>
                                                    </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                {% endif %}
                                
                               <!-- Standalone Inclusions Section -->
                                {% if day_data.standalone_inclusions %}
                                <div class="mb-4">
                                    <h6 class="fw-bold text-success mb-3">
                                        <i class="fas fa-mountain me-2"></i>Standalone Activities/Services ({{ day_data.standalone_inclusions|length }})
                                    </h6>
                                    {% for booking in day_data.standalone_inclusions %}
                                    <div class="booking-card mb-3">
                                        <div class="booking-icon" style="background-color: #d4edda; color: #28a745;">
                                            <i class="fas fa-mountain"></i>
                                        </div>
                                        <div class="booking-content">
                                            <div class="booking-header">
                                                <span class="hotel-name">{{ booking.special_inclusion.name }}</span>
                                                <div class="edit-icon d-flex align-items-center">
                                                    <!-- Edit Button -->
                                                    <button type="button" 
                                                            class="btn btn-sm btn-warning me-2"
                                                            data-bs-toggle="modal"
                                                            data-bs-target="#standaloneInclusionModal"
                                                            data-booking-id="{{ booking.id }}"
                                                            data-inclusion-id="{{ booking.special_inclusion.id }}"
                                                            data-inclusion-name="{{ booking.special_inclusion.name }}"
                                                            data-day-number="{{ day }}"
                                                            data-booking-date="{{ booking.booking_date|date:'Y-m-d' }}"
                                                            data-booking-time="{{ booking.booking_time|time:'H:i'|default:'' }}"
                                                            data-num-adults="{{ booking.num_adults }}"
                                                            data-num-children="{{ booking.num_children }}"
                                                            data-adult-price="{{ booking.adult_unit_price }}"
                                                            data-child-price="{{ booking.child_unit_price }}"
                                                            data-notes="{{ booking.notes }}">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    
                                                    <!-- Delete Button -->
                                                    <form action="{% url 'delete_standalone_inclusion' booking.id %}" 
                                                        method="POST" 
                                                        style="display: inline;"
                                                        onsubmit="return confirm('⚠️ Are you sure you want to delete {{ booking.special_inclusion.name }}?\n\nThis action cannot be undone.')">
                                                        {% csrf_token %}
                                                        <button type="submit" class="btn btn-sm btn-danger">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    </form>
                                                </div>
                                            </div>
                                            
                                            <div class="booking-details mt-2">
                                                <div class="detail-item">
                                                    <span class="label">Date & Time</span>
                                                    <span class="data">
                                                        <i class="fas fa-calendar me-1"></i>
                                                        {{ booking.booking_date|date:"d M Y" }}
                                                        {% if booking.booking_time %}
                                                            <i class="fas fa-clock ms-2 me-1"></i>
                                                            {{ booking.booking_time|time:"h:i A" }}
                                                        {% endif %}
                                                    </span>
                                                </div>
                                                <div class="detail-item">
                                                    <span class="label">Participants</span>
                                                    <span class="data">
                                                        <i class="fas fa-users me-1"></i>
                                                        {{ booking.num_adults }} Adult{{ booking.num_adults|pluralize }}
                                                        {% if booking.num_children > 0 %}
                                                            + {{ booking.num_children }} Child{{ booking.num_children|pluralize:"ren" }}
                                                        {% endif %}
                                                    </span>
                                                </div>
                                                <div class="detail-item">
                                                    <span class="label">Price Breakdown</span>
                                                    <span class="data">
                                                        <small class="text-muted">
                                                            {{ booking.num_adults }}×₹{{ booking.adult_unit_price }}
                                                            {% if booking.num_children > 0 %}
                                                                + {{ booking.num_children }}×₹{{ booking.child_unit_price }}
                                                            {% endif %}
                                                        </small>
                                                    </span>
                                                </div>
                                                <div class="detail-item">
                                                    <span class="label">Total Price</span>
                                                    <span class="data">
                                                        <i class="fas fa-rupee-sign me-1"></i>
                                                        <strong class="text-success fs-5">₹{{ booking.total_price|floatformat:2 }}</strong>
                                                    </span>
                                                </div>
                                                {% if booking.notes %}
                                                <div class="detail-item">
                                                    <span class="label">Notes</span>
                                                    <span class="data">
                                                        <i class="fas fa-sticky-note me-1"></i>
                                                        {{ booking.notes|truncatewords:20 }}
                                                    </span>
                                                </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                {% endif %}


                                <!-- Hotel Bookings Section -->
                                {% if day_data.hotel_bookings %}
                                    <div class="mb-4">
                                        <h6 class="fw-bold text-primary mb-3">
                                            <i class="fas fa-hotel me-2"></i>Hotel Bookings ({{ day_data.hotel_bookings|length }})
                                        </h6>
                                        {% for booking in day_data.hotel_bookings %}
                                            <div class="booking-card mb-3">
                                                <div class="booking-icon">
                                                    <i class="fas fa-hotel"></i>
                                                    <div class="edit-overlay"><i class="fas fa-pencil-alt"></i></div>
                                                </div>
                                                <div class="booking-content">
                                                    <div class="booking-header">
                                                        <div>
                                                            <span class="hotel-name">{{ booking.hotel.name }}</span>
                                                            <span class="star-rating">{{ booking.category|get_stars }}</span>
                                                            <span class="option-badge option-{{ booking.option|slice:'-1:' }}">
                                                                {{ booking.get_option_display }}
                                                            </span>
                                                        </div>
                                                        <div class="edit-icon d-flex align-items-center">
                                                            <!-- ✅ EDIT BUTTON - Permission Check -->
                                                            {% if user_type == 'superuser' or current_user.role == 'admin' or current_user.role == 'manager' or current_user.permissions.can_edit_bookings %}
                                                            <a href="#" class="me-2 text-warning"
                                                               data-bs-toggle="modal"
                                                               data-bs-target="#hotelBookingModal"
                                                               data-booking-id="{{ booking.id }}"
                                                               data-hotel-id="{{ booking.hotel.id }}"
                                                               data-hotel-name="{{ booking.hotel.name }}"
                                                               data-day-number="{{ booking.day_number }}"
                                                               data-destination-id="{{ booking.destination.id }}"
                                                               data-category="{{ booking.category }}"
                                                               data-room-type-id="{% if booking.room_type %}{{ booking.room_type.id }}{% endif %}"
                                                               data-meal-plan-id="{% if booking.meal_plan %}{{ booking.meal_plan.id }}{% endif %}"
                                                               data-special-inclusion-id="{% if booking.special_inclusion %}{{ booking.special_inclusion.id }}{% endif %}"
                                                               data-option="{{ booking.option }}"
                                                               data-num-rooms="{{ booking.num_rooms }}"
                                                               data-num-double-beds="{{ booking.num_double_beds }}"
                                                               data-child-with-bed="{{ booking.child_with_bed }}"
                                                               data-child-without-bed="{{ booking.child_without_bed }}"
                                                               data-extra-beds="{{ booking.extra_beds }}"
                                                               data-check-in-date="{{ booking.check_in_date|date:'Y-m-d' }}"
                                                               data-check-out-date="{{ booking.check_out_date|date:'Y-m-d' }}"
                                                               data-check-in-time="{{ booking.check_in_time|time:'H:i' }}"
                                                               data-check-out-time="{{ booking.check_out_time|time:'H:i' }}"
                                                               data-inclusions='[{% for inc in booking.inclusion_items.all %}{"id":{{ inc.special_inclusion.id }},"name":"{{ inc.special_inclusion.name|escapejs }}","adults":{{ inc.num_adults }},"children":{{ inc.num_children }},"price":{{ inc.price|default:0 }}}{% if not forloop.last %},{% endif %}{% endfor %}]'
                                                               title="Edit Booking">
                                                                <i class="fas fa-edit"></i>
                                                            </a>
                                                            {% endif %}
                                                            
                                                            <!-- ✅ DELETE BUTTON - Permission Check -->
                                                            {% if user_type == 'superuser' or current_user.role == 'admin' or current_user.role == 'manager' or current_user.permissions.can_delete_bookings %}
                                                            <form action="{% url 'delete_hotel_booking' booking.id %}" method="post" class="d-inline">
                                                                {% csrf_token %}
                                                                <button type="submit" 
                                                                        class="btn btn-link text-danger p-0" 
                                                                        onclick="return confirm('Are you sure you want to delete this hotel booking?');"
                                                                        title="Delete Booking">
                                                                    <i class="fas fa-trash-alt"></i>
                                                                </button>
                                                            </form>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                    
                                                    <div class="booking-details-grid">
                                                        <div class="detail-item">
                                                            <span class="label">Check-in</span>
                                                            <span class="data">
                                                                <i class="fas fa-calendar-alt"></i> 
                                                                {{ booking.check_in_date|date:"d M Y" }}
                                                            </span>
                                                        </div>
                                                        <div class="detail-item">
                                                            <span class="label">Check-out</span>
                                                            <span class="data">
                                                                <i class="fas fa-calendar-alt"></i> 
                                                                {{ booking.check_out_date|date:"d M Y" }}
                                                            </span>
                                                        </div>
                                                        <div class="detail-item">
                                                            <span class="label">Room Type</span>
                                                            <span class="data">
                                                                <i class="fas fa-building"></i> 
                                                                {% if booking.room_type %}{{ booking.room_type.name }}{% else %}N/A{% endif %}
                                                            </span>
                                                        </div>
                                                        <div class="detail-item">
                                                            <span class="label">Rooms</span>
                                                            <span class="data">
                                                                <i class="fas fa-bed"></i> 
                                                                {{ booking.num_rooms }} room{{ booking.num_rooms|pluralize }}
                                                            </span>
                                                        </div>
                                                        <div class="detail-item">
                                                            <span class="label">Meal Plan</span>
                                                            <span class="data">
                                                                <i class="fas fa-utensils"></i> 
                                                                {% if booking.meal_plan %}{{ booking.meal_plan.name }}{% else %}N/A{% endif %}
                                                            </span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        {% endfor %}
                                    </div>
                                {% endif %}

                                <!-- Vehicle Bookings Section -->
                                {% if day_data.vehicle_bookings %}
                                    <div class="mb-4">
                                        <h6 class="fw-bold text-success mb-3">
                                            <i class="fas fa-car me-2"></i>Vehicle Bookings ({{ day_data.vehicle_bookings|length }})
                                        </h6>
                                        {% for booking in day_data.vehicle_bookings %}
                                            <div class="booking-card mb-3">
                                                <div class="booking-icon" style="background-color: #d1e7dd; color: #198754;">
                                                    <i class="fas fa-car"></i>
                                                    <div class="edit-overlay"><i class="fas fa-pencil-alt"></i></div>
                                                </div>
                                                <div class="booking-content">
                                                    <div class="booking-header">
                                                        <div>
                                                            <span class="hotel-name">{{ booking.vehicle.name }}</span>
                                                            <span class="option-badge option-{{ booking.option|slice:'-1:' }}">
                                                                {{ booking.get_option_display }}
                                                            </span>
                                                        </div>
                                                        <div class="edit-icon d-flex align-items-center">
                                                            <!-- ✅ EDIT BUTTON -->
                                                            {% if user_type == 'superuser' or current_user.role == 'admin' or current_user.role == 'manager' or current_user.permissions.can_edit_bookings %}
                                                            <a href="#" class="me-2 text-warning"
                                                               data-bs-toggle="modal"
                                                               data-bs-target="#bookVehicleModal"
                                                               data-booking-id="{{ booking.id }}"
                                                               data-vehicle-id="{{ booking.vehicle.id }}"
                                                               data-vehicle-name="{{ booking.vehicle.name }}"
                                                               data-day-number="{{ booking.day_number }}"
                                                               data-destination-id="{{ booking.destination.id }}"
                                                               data-pickup-date="{{ booking.pickup_date|date:'Y-m-d' }}"
                                                               data-pickup-time="{{ booking.pickup_time|time:'H:i' }}"
                                                               data-num-passengers="{{ booking.num_passengers }}"
                                                               data-vehicle-type="{{ booking.vehicle_type }}"
                                                               data-total-km="{{ booking.total_km }}"
                                                               data-option="{{ booking.option }}"
                                                               title="Edit Booking">
                                                                <i class="fas fa-edit"></i>
                                                            </a>
                                                            {% endif %}
                                                            
                                                            <!-- ✅ DELETE BUTTON -->
                                                            {% if user_type == 'superuser' or current_user.role == 'admin' or current_user.role == 'manager' or current_user.permissions.can_delete_bookings %}
                                                            <form action="{% url 'delete_vehicle_booking' booking.id %}" method="post" class="d-inline">
                                                                {% csrf_token %}
                                                                <button type="submit" 
                                                                        class="btn btn-link text-danger p-0" 
                                                                        onclick="return confirm('Are you sure you want to delete this vehicle booking?');"
                                                                        title="Delete Booking">
                                                                    <i class="fas fa-trash-alt"></i>
                                                                </button>
                                                            </form>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                    
                                                    <div class="booking-details-grid">
                                                        <div class="detail-item">
                                                            <span class="label">Pickup Date</span>
                                                            <span class="data">
                                                                <i class="fas fa-calendar-alt"></i> 
                                                                {{ booking.pickup_date|date:"d M Y" }}
                                                            </span>
                                                        </div>
                                                        <div class="detail-item">
                                                            <span class="label">Pickup Time</span>
                                                            <span class="data">
                                                                <i class="fas fa-clock"></i> 
                                                                {{ booking.pickup_time|time:"H:i" }}
                                                            </span>
                                                        </div>
                                                        <div class="detail-item">
                                                            <span class="label">Passengers</span>
                                                            <span class="data">
                                                                <i class="fas fa-users"></i> 
                                                                {{ booking.num_passengers }}
                                                            </span>
                                                        </div>
                                                        <div class="detail-item">
                                                            <span class="label">Vehicle Type</span>
                                                            <span class="data">
                                                                <i class="fas fa-car-side"></i> 
                                                                {{ booking.vehicle_type }}
                                                            </span>
                                                        </div>
                                                        <div class="detail-item">
                                                            <span class="label">Distance</span>
                                                            <span class="data">
                                                                <i class="fas fa-road"></i> 
                                                                {{ booking.total_km }} km
                                                            </span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        {% endfor %}
                                    </div>
                                {% endif %}

                                <!-- Houseboat Bookings Section -->
                                {% if day_data.houseboat_bookings %}
                                    <div class="mb-4">
                                        <h6 class="fw-bold text-info mb-3">
                                            <i class="fas fa-ship me-2"></i>Houseboat Bookings ({{ day_data.houseboat_bookings|length }})
                                        </h6>
                                        {% for booking in day_data.houseboat_bookings %}
                                            <div class="booking-card mb-3">
                                                <div class="booking-icon" style="background-color: #cfe2ff; color: #0d6efd;">
                                                    <i class="fas fa-ship"></i>
                                                    <div class="edit-overlay"><i class="fas fa-pencil-alt"></i></div>
                                                </div>
                                                <div class="booking-content">
                                                    <div class="booking-header">
                                                        <span class="hotel-name">{{ booking.houseboat.name }}</span>
                                                        <div class="edit-icon d-flex align-items-center">
                                                            <!-- ✅ EDIT BUTTON -->
                                                            {% if user_type == 'superuser' or current_user.role == 'admin' or current_user.role == 'manager' or current_user.permissions.can_edit_bookings %}
                                                            <a href="#" class="me-2 text-warning"
                                                                data-bs-toggle="modal" 
                                                                data-bs-target="#houseboatBookingModal"
                                                                data-booking-id="{{ booking.id }}"
                                                                data-houseboat-id="{{ booking.houseboat.id }}"
                                                                data-houseboat-name="{{ booking.houseboat.name }}"
                                                                data-day-number="{{ booking.day_plan.day_number }}"
                                                                data-meal-plan-id="{% if booking.meal_plan %}{{ booking.meal_plan.id }}{% endif %}"
                                                                data-room-type-id="{% if booking.room_type %}{{ booking.room_type.id }}{% endif %}"
                                                                data-check-in-date="{{ booking.check_in_date|date:'Y-m-d' }}"
                                                                data-check-out-date="{{ booking.check_out_date|date:'Y-m-d' }}"
                                                                data-num-one-bed-rooms="{{ booking.num_one_bed_rooms }}"
                                                                data-num-two-bed-rooms="{{ booking.num_two_bed_rooms }}"
                                                                data-num-three-bed-rooms="{{ booking.num_three_bed_rooms }}"
                                                                data-num-four-bed-rooms="{{ booking.num_four_bed_rooms }}"
                                                                data-num-five-bed-rooms="{{ booking.num_five_bed_rooms }}"
                                                                data-num-six-bed-rooms="{{ booking.num_six_bed_rooms }}"
                                                                data-num-seven-bed-rooms="{{ booking.num_seven_bed_rooms }}"
                                                                data-num-eight-bed-rooms="{{ booking.num_eight_bed_rooms }}"
                                                                data-num-nine-bed-rooms="{{ booking.num_nine_bed_rooms }}"
                                                                data-num-ten-bed-rooms="{{ booking.num_ten_bed_rooms }}"
                                                                data-num-extra-beds="{{ booking.num_extra_beds }}"
                                                                data-inclusions='[
                                                                    {% for inc in booking.inclusion_items.all %}
                                                                        {
                                                                            "id": {{ inc.special_inclusion.id }},
                                                                            "adults": {{ inc.num_adults }},
                                                                            "children": {{ inc.num_children }}
                                                                        }{% if not forloop.last %},{% endif %}
                                                                    {% endfor %}
                                                                ]'
                                                                title="Edit Booking">
                                                                    <i class="fas fa-edit"></i>
                                                                </a>
                                                            {% endif %}
                                                            
                                                            <!-- ✅ DELETE BUTTON -->
                                                            {% if user_type == 'superuser' or current_user.role == 'admin' or current_user.role == 'manager' or current_user.permissions.can_delete_bookings %}
                                                            <form action="{% url 'delete_houseboat_booking' booking.id %}" method="post" class="d-inline">
                                                                {% csrf_token %}
                                                                <button type="submit" 
                                                                        class="btn btn-link text-danger p-0" 
                                                                        onclick="return confirm('Are you sure you want to delete this houseboat booking?');"
                                                                        title="Delete Booking">
                                                                    <i class="fas fa-trash-alt"></i>
                                                                </button>
                                                            </form>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                    
                                                    <div class="booking-details-grid">
                                                        <div class="detail-item">
                                                            <span class="label">Check-in</span>
                                                            <span class="data">
                                                                <i class="fas fa-calendar-alt"></i> 
                                                                {{ booking.check_in_date|date:"d M Y" }}
                                                            </span>
                                                        </div>
                                                        <div class="detail-item">
                                                            <span class="label">Check-out</span>
                                                            <span class="data">
                                                                <i class="fas fa-calendar-alt"></i> 
                                                                {{ booking.check_out_date|date:"d M Y" }}
                                                            </span>
                                                        </div>
                                                        <div class="detail-item">
                                                            <span class="label">Room Type</span>
                                                            <span class="data">
                                                                <i class="fas fa-building"></i> 
                                                                {% if booking.room_type %}{{ booking.room_type.name }}{% else %}N/A{% endif %}
                                                            </span>
                                                        </div>
                                                        <div class="detail-item">
                                                            <span class="label">Meal Plan</span>
                                                            <span class="data">
                                                                <i class="fas fa-utensils"></i> 
                                                                {% if booking.meal_plan %}{{ booking.meal_plan.name }}{% else %}N/A{% endif %}
                                                            </span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        {% endfor %}
                                    </div>
                                {% endif %}

                                <!-- Activity Bookings Section -->
                                {% if day_data.activity_bookings %}
                                    <div class="mb-4">
                                        <h6 class="fw-bold text-warning mb-3">
                                            <i class="fas fa-hiking me-2"></i>Activity Bookings ({{ day_data.activity_bookings|length }})
                                        </h6>
                                        {% for booking in day_data.activity_bookings %}
                                            <div class="booking-card mb-3">
                                                <div class="booking-icon" style="background-color: #fff3cd; color: #ffc107;">
                                                    <i class="fas fa-hiking"></i>
                                                    <div class="edit-overlay"><i class="fas fa-pencil-alt"></i></div>
                                                </div>
                                                <div class="booking-content">
                                                    <div class="booking-header">
                                                        <span class="hotel-name">{{ booking.activity.name }}</span>
                                                        <div class="edit-icon d-flex align-items-center">
                                                            <!-- ✅ EDIT BUTTON -->
                                                            {% if user_type == 'superuser' or current_user.role == 'admin' or current_user.role == 'manager' or current_user.permissions.can_edit_bookings %}
                                                            <a href="#" class="me-2 text-warning"
                                                               data-bs-toggle="modal"
                                                               data-bs-target="#activityBookingModal"
                                                               data-booking-id="{{ booking.id }}"
                                                               data-activity-id="{{ booking.activity.id }}"
                                                               data-activity-name="{{ booking.activity.name }}"
                                                               data-day-number="{{ booking.day_plan.day_number }}"
                                                               data-booking-date="{{ booking.booking_date|date:'Y-m-d' }}"
                                                               data-booking-time="{{ booking.booking_time|time:'H:i' }}"
                                                               data-num-adults="{{ booking.num_adults }}"
                                                               data-num-children="{{ booking.num_children }}"
                                                               data-notes="{{ booking.notes }}"
                                                               title="Edit Booking">
                                                                <i class="fas fa-edit"></i>
                                                            </a>
                                                            {% endif %}
                                                            
                                                            <!-- ✅ DELETE BUTTON -->
                                                            {% if user_type == 'superuser' or current_user.role == 'admin' or current_user.role == 'manager' or current_user.permissions.can_delete_bookings %}
                                                            <form action="{% url 'delete_activity_booking' booking.id %}" method="post" class="d-inline">
                                                                {% csrf_token %}
                                                                <button type="submit" 
                                                                        class="btn btn-link text-danger p-0" 
                                                                        onclick="return confirm('Are you sure you want to delete this activity booking?');"
                                                                        title="Delete Booking">
                                                                    <i class="fas fa-trash-alt"></i>
                                                                </button>
                                                            </form>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                    
                                                    <div class="booking-details-grid">
                                                        <div class="detail-item">
                                                            <span class="label">Date</span>
                                                            <span class="data">
                                                                <i class="fas fa-calendar-alt"></i> 
                                                                {{ booking.booking_date|date:"d M Y" }}
                                                            </span>
                                                        </div>
                                                        <div class="detail-item">
                                                            <span class="label">Time</span>
                                                            <span class="data">
                                                                <i class="fas fa-clock"></i> 
                                                                {{ booking.booking_time|time:"H:i" }}
                                                            </span>
                                                        </div>
                                                        <div class="detail-item">
                                                            <span class="label">Adults</span>
                                                            <span class="data">
                                                                <i class="fas fa-user"></i> 
                                                                {{ booking.num_adults }}
                                                            </span>
                                                        </div>
                                                        <div class="detail-item">
                                                            <span class="label">Children</span>
                                                            <span class="data">
                                                                <i class="fas fa-child"></i> 
                                                                {{ booking.num_children }}
                                                            </span>
                                                        </div>
                                                        {% if booking.notes %}
                                                        <div class="detail-item" style="grid-column: 1 / -1;">
                                                            <span class="label">Notes</span>
                                                            <span class="data">{{ booking.notes }}</span>
                                                        </div>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                        {% endfor %}
                                    </div>
                                {% endif %}

                                <!-- Empty State for Day -->
                                {% if not day_data.hotel_bookings and not day_data.vehicle_bookings and not day_data.houseboat_bookings and not day_data.activity_bookings %}
                                    <div class="text-center py-3 text-muted">
                                        <i class="fas fa-calendar-times fa-2x mb-2"></i>
                                        <p class="mb-0">No bookings for this day yet.</p>
                                    </div>
                                {% endif %}

                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <!-- Empty State for All -->
            <div class="text-center py-5">
                <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                <p class="text-muted mb-0">No saved items yet. Start adding bookings to your itinerary!</p>
            </div>
        {% endif %}
    </div>
</div>
{% endif %}


<!-- ✅ RIGHT PANEL - Add Items to Day -->
{% if can_add_items %}
<div class="col-lg-3 mb-4">
    <div class="section-box">
        <h4 class="mb-3">
            <i class="fas fa-plus-circle me-2"></i>Add Items to Day
        </h4>
        
        <!-- Day and Section Selection Form -->
        <form method="post" class="mb-4">
            {% csrf_token %}
            <input type="hidden" name="form_type" value="section_select">
            
            <div class="mb-3">
                <label class="form-label fw-bold">
                    <i class="fas fa-calendar-day me-1"></i>Select Day
                </label>
                <select name="day_number" class="form-select" required>
                    <option value="">-- Select Day --</option>
                    {% for day in days %}
                        <option value="{{ day }}" {% if context_day_number == day %}selected{% endif %}>
                            Day {{ day }}
                            {% with day_plan=plans|get_item:day %}
                                {% if day_plan and day_plan.destination %}
                                    - {{ day_plan.destination.name }}
                                {% endif %}
                            {% endwith %}
                        </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="mb-3">
                <label class="form-label fw-bold">
                    <i class="fas fa-list me-1"></i>Select Section
                </label>
                <select name="section" class="form-select" required>
                    <option value="">-- Choose Section --</option>
                    {% for s in sections %}
                        <option value="{{ s }}" {% if selected_section == s %}selected{% endif %}>
                            {{ s|format_section_name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            
            <button type="submit" class="btn btn-primary w-100">
                <i class="fas fa-search me-2"></i>Load Items
            </button>
        </form>

        <!-- Available Items Display -->
        {% if selected_section and context_day_number %}
            <div class="border-top pt-3">
                <h6 class="fw-bold mb-3">
                    <i class="fas fa-box-open me-2"></i>
                   Available {{ selected_section|format_section_name }} for Day {{ context_day_number }}

                </h6>
                
                {% if section_data %}
                    <div class="available-items-list" style="max-height: 400px; overflow-y: auto;">
                        {% for item in section_data %}
                            <div class="item-card d-flex align-items-center justify-content-between mb-2 p-2 border rounded">
                                <div class="item-info flex-grow-1">
                                    <div class="fw-bold small">{{ item.name }}</div>
                                    {% if item.destination %}
                                        <small class="text-muted">
                                            <i class="fas fa-map-marker-alt me-1"></i>
                                            {{ item.destination.name }}
                                        </small>
                                    {% endif %}
                                </div>
                                
                                <div class="item-actions ms-2">
                                    {% with day_plan=plans|get_item:context_day_number %}
                                        {% if selected_section == "hotels" %}
                                            <button type="button" 
                                                    class="btn btn-sm btn-primary"
                                                    data-bs-toggle="modal" 
                                                    data-bs-target="#hotelBookingModal"
                                                    data-hotel-id="{{ item.id }}"
                                                    data-hotel-name="{{ item.name }}"
                                                    data-day-number="{{ context_day_number }}"
                                                    data-destination-id="{% if day_plan.destination %}{{ day_plan.destination.id }}{% endif %}"
                                                    title="Book {{ item.name }}">
                                                <i class="fas fa-calendar-check"></i>
                                            </button>
                                            
                                        {% elif selected_section == "activities" %}
                                            <button type="button" 
                                                    class="btn btn-sm btn-warning"
                                                    data-bs-toggle="modal" 
                                                    data-bs-target="#activityBookingModal"
                                                    data-activity-id="{{ item.id }}"
                                                    data-activity-name="{{ item.name }}"
                                                    data-day-number="{{ context_day_number }}"
                                                    title="Book {{ item.name }}">
                                                <i class="fas fa-calendar-check"></i>
                                            </button>
                                            
                                        {% elif selected_section == "vehicles" %}
                                            <button type="button" 
                                                    class="btn btn-sm btn-success"
                                                    data-bs-toggle="modal" 
                                                    data-bs-target="#bookVehicleModal"
                                                    data-vehicle-id="{{ item.id }}"
                                                    data-vehicle-name="{{ item.name }}"
                                                    data-day-number="{{ context_day_number }}"
                                                    data-destination-id="{% if day_plan.destination %}{{ day_plan.destination.id }}{% endif %}"
                                                    title="Book {{ item.name }}">
                                                <i class="fas fa-calendar-check"></i>
                                            </button>
                                            
                                        {% elif selected_section == "houseboats" %}
                                            <button type="button" 
                                                    class="btn btn-sm btn-info"
                                                    data-bs-toggle="modal" 
                                                    data-bs-target="#houseboatBookingModal"
                                                    data-houseboat-id="{{ item.id }}"
                                                    data-houseboat-name="{{ item.name }}"
                                                    data-day-number="{{ context_day_number }}"
                                                    title="Book {{ item.name }}">
                                                <i class="fas fa-calendar-check"></i>
                                            </button>
                                            
                                        {% elif selected_section == 'standalone_inclusions' %}
                                            <button type="button" 
                                                    class="btn btn-sm btn-danger" 
                                                    data-bs-toggle="modal" 
                                                    data-bs-target="#standaloneInclusionModal" 
                                                    data-inclusion-id="{{ item.id }}"
                                                    data-inclusion-name="{{ item.name }}"
                                                    data-day-number="{{ context_day_number }}"
                                                    data-adult-price="{{ item.adult_price }}"
                                                    data-child-price="{{ item.get_child_price }}"
                                                    data-pricing-type="{{ item.pricing_type }}"
                                                    title="Book {{ item.name }}">
                                                <i class="fas fa-mountain"></i>
                                            </button>
                                        {% endif %}
                                    {% endwith %}
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="alert alert-info small">
                        <i class="fas fa-info-circle me-2"></i>
                        No {{ selected_section|title|format_section_name }} available for booking.
                    </div>
                {% endif %}
            </div>
        {% else %}
            <div class="alert alert-light text-center">
                <i class="fas fa-arrow-up fa-2x mb-2 d-block text-muted"></i>
                <small class="text-muted">Select a day and section above to view available items</small>
            </div>
        {% endif %}

        <!-- ✅ Manage Day Items Dropdown WITH STANDALONE INCLUSIONS -->
        {% if context_day_number %}
            {% with day_plan=plans|get_item:context_day_number %}
                {% if day_plan %}
                    {% with hotel_count=day_plan.hotel_bookings.count %}
                    {% with activity_count=day_plan.activity_bookings.count %}
                    {% with vehicle_count=day_plan.vehicle_bookings.count %}
                    {% with houseboat_count=day_plan.houseboat_bookings.count %}
                    {% with standalone_count=day_plan.standalone_inclusions.count %}
                    {% with total_count=hotel_count|add:activity_count|add:vehicle_count|add:houseboat_count|add:standalone_count %}
                    
                    {% if total_count > 0 %}
                        <!-- ✅ ONLY SHOW IF USER HAS DELETE PERMISSION -->
                        {% if user_type == 'superuser' or current_user.role == 'admin' or current_user.role == 'manager' or current_user.permissions.can_delete_bookings %}
                        <div class="border-top pt-3 mt-3">
                            <div class="dropdown w-100">
                                <button class="btn btn-outline-danger dropdown-toggle w-100" 
                                        type="button" 
                                        data-bs-toggle="dropdown" 
                                        aria-expanded="false">
                                    <i class="fas fa-cog me-2"></i>
                                    Manage Day {{ context_day_number }} 
                                    <span class="badge bg-danger rounded-pill">{{ total_count }}</span>
                                </button>
                                
                                <ul class="dropdown-menu w-100" style="max-height: 400px; overflow-y: auto;">
                                    <!-- Hotels Section -->
                                    {% if hotel_count > 0 %}
                                        <li>
                                            <h6 class="dropdown-header">
                                                <i class="fas fa-hotel me-2 text-primary"></i>
                                                Hotels ({{ hotel_count }})
                                            </h6>
                                        </li>
                                        {% for booking in day_plan.hotel_bookings.all %}
                                            <li>
                                                <span class="dropdown-item-text small ps-4">
                                                    <i class="fas fa-check-circle text-success me-1"></i>
                                                    {{ booking.hotel.name }}
                                                </span>
                                            </li>
                                        {% endfor %}
                                        <li><hr class="dropdown-divider"></li>
                                        <li>
                                            <a class="dropdown-item text-danger small" 
                                               href="#" 
                                               onclick="bulkDeleteConfirm('hotels', {{ context_day_number }}, {{ hotel_count }}); return false;">
                                                <i class="fas fa-trash-alt me-2"></i>
                                                Delete All Hotels
                                            </a>
                                        </li>
                                        <li><hr class="dropdown-divider"></li>
                                    {% endif %}

                                    <!-- Activities Section -->
                                    {% if activity_count > 0 %}
                                        <li>
                                            <h6 class="dropdown-header">
                                                <i class="fas fa-hiking me-2 text-warning"></i>
                                                Activities ({{ activity_count }})
                                            </h6>
                                        </li>
                                        {% for booking in day_plan.activity_bookings.all %}
                                            <li>
                                                <span class="dropdown-item-text small ps-4">
                                                    <i class="fas fa-check-circle text-success me-1"></i>
                                                    {{ booking.activity.name }}
                                                </span>
                                            </li>
                                        {% endfor %}
                                        <li><hr class="dropdown-divider"></li>
                                        <li>
                                            <a class="dropdown-item text-danger small" 
                                               href="#" 
                                               onclick="bulkDeleteConfirm('activities', {{ context_day_number }}, {{ activity_count }}); return false;">
                                                <i class="fas fa-trash-alt me-2"></i>
                                                Delete All Activities
                                            </a>
                                        </li>
                                        <li><hr class="dropdown-divider"></li>
                                    {% endif %}

                                    <!-- Vehicles Section -->
                                    {% if vehicle_count > 0 %}
                                        <li>
                                            <h6 class="dropdown-header">
                                                <i class="fas fa-car me-2 text-success"></i>
                                                Vehicles ({{ vehicle_count }})
                                            </h6>
                                        </li>
                                        {% for booking in day_plan.vehicle_bookings.all %}
                                            <li>
                                                <span class="dropdown-item-text small ps-4">
                                                    <i class="fas fa-check-circle text-success me-1"></i>
                                                    {{ booking.vehicle.name }}
                                                </span>
                                            </li>
                                        {% endfor %}
                                        <li><hr class="dropdown-divider"></li>
                                        <li>
                                            <a class="dropdown-item text-danger small" 
                                               href="#" 
                                               onclick="bulkDeleteConfirm('vehicles', {{ context_day_number }}, {{ vehicle_count }}); return false;">
                                                <i class="fas fa-trash-alt me-2"></i>
                                                Delete All Vehicles
                                            </a>
                                        </li>
                                        <li><hr class="dropdown-divider"></li>
                                    {% endif %}

                                    <!-- Houseboats Section -->
                                    {% if houseboat_count > 0 %}
                                        <li>
                                            <h6 class="dropdown-header">
                                                <i class="fas fa-ship me-2 text-info"></i>
                                                Houseboats ({{ houseboat_count }})
                                            </h6>
                                        </li>
                                        {% for booking in day_plan.houseboat_bookings.all %}
                                            <li>
                                                <span class="dropdown-item-text small ps-4">
                                                    <i class="fas fa-check-circle text-success me-1"></i>
                                                    {{ booking.houseboat.name }}
                                                </span>
                                            </li>
                                        {% endfor %}
                                        <li><hr class="dropdown-divider"></li>
                                        <li>
                                            <a class="dropdown-item text-danger small" 
                                               href="#" 
                                               onclick="bulkDeleteConfirm('houseboats', {{ context_day_number }}, {{ houseboat_count }}); return false;">
                                                <i class="fas fa-trash-alt me-2"></i>
                                                Delete All Houseboats
                                            </a>
                                        </li>
                                        <li><hr class="dropdown-divider"></li>
                                    {% endif %}

                                    <!-- ✅ NEW: Standalone Inclusions Section -->
                                    {% if standalone_count > 0 %}
                                        <li>
                                            <h6 class="dropdown-header">
                                                <i class="fas fa-mountain me-2 text-danger"></i>
                                                Standalone Activities ({{ standalone_count }})
                                            </h6>
                                        </li>
                                        {% for booking in day_plan.standalone_inclusions.all %}
                                            <li>
                                                <span class="dropdown-item-text small ps-4">
                                                    <i class="fas fa-check-circle text-success me-1"></i>
                                                    {{ booking.special_inclusion.name }}
                                                </span>
                                            </li>
                                        {% endfor %}
                                        <li><hr class="dropdown-divider"></li>
                                        <li>
                                            <a class="dropdown-item text-danger small" 
                                               href="#" 
                                               onclick="bulkDeleteConfirm('standalone_inclusions', {{ context_day_number }}, {{ standalone_count }}); return false;">
                                                <i class="fas fa-trash-alt me-2"></i>
                                                Delete All Standalone Activities
                                            </a>
                                        </li>
                                        <li><hr class="dropdown-divider"></li>
                                    {% endif %}

                                    <!-- Delete Everything Option -->
                                    <li>
                                        <a class="dropdown-item text-danger fw-bold small" 
                                           href="#" 
                                           onclick="bulkDeleteConfirm('everything', {{ context_day_number }}, {{ total_count }}); return false;">
                                            <i class="fas fa-exclamation-triangle me-2"></i>
                                            Delete All Items ({{ total_count }})
                                        </a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                        {% endif %}
                    {% endif %}
                    
                    {% endwith %}
                    {% endwith %}
                    {% endwith %}
                    {% endwith %}
                    {% endwith %}
                    {% endwith %}
                {% endif %}
            {% endwith %}
        {% endif %}
    </div>
</div>
{% endif %}

<!-- Bulk Delete Form (Hidden) -->
<form id="bulkDeleteForm" method="POST" action="" style="display: none;">
    {% csrf_token %}
    <input type="hidden" name="form_type" value="bulk_delete">
    <input type="hidden" name="delete_type" id="deleteType">
    <input type="hidden" name="day_number" id="deleteDayNumber">
</form>


<!-- ✅ HOTEL BOOKING MODAL - WITH MULTI-INCLUSIONS SUPPORT - EDITED TO USE ITINERARY ✅ -->
<div class="modal fade" id="hotelBookingModal" tabindex="-1" aria-labelledby="hotelBookingModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-xl modal-dialog-scrollable modal-dialog-centered">
        <div class="modal-content" style="max-height: 90vh;">
            <form method="post" id="hotelBookingForm" action="">
                {% csrf_token %}
                
                <!-- Hidden Fields - EDITED ✅ -->
                <input type="hidden" name="booking_id" id="modalBookingId">
                
                <!-- ITINERARY DATA (NOT QUERY) -->
                <input type="hidden" id="itineraryTravelFrom" value="{{ itinerary.travel_from|date:'Y-m-d' }}">
                <input type="hidden" id="itineraryTravelTo" value="{{ itinerary.travel_to|date:'Y-m-d' }}">
                <input type="hidden" id="itineraryDefaultAdults" value="{{ itinerary.adults|default:'2' }}">
                <input type="hidden" id="itineraryDefaultChildren" value="{{ itinerary.childrens|default:'0' }}">
                <input type="hidden" id="itineraryDefaultInfants" value="{{ itinerary.infants|default:'0' }}">
                
                <input type="hidden" name="inclusions_data" id="inclusionsData">
                <input type="hidden" name="hotel_id" id="modalHotelId">
                <input type="hidden" name="day_number" id="modalDayNumber">

                <!-- Modal Header -->
                <div class="modal-header bg-primary text-white sticky-top" style="z-index: 1050;">
                    <h5 class="modal-title" id="hotelBookingModalLabel">
                        <i class="fas fa-hotel me-2"></i>Hotel Booking Details
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                
                <!-- Modal Body - Scrollable -->
                <div class="modal-body" style="max-height: calc(90vh - 140px); overflow-y: auto;">
                    
                    <!-- Hotel Name (Read-only) -->
                    <div class="mb-3">
                        <label for="modalHotelName" class="form-label fw-semibold">
                            <i class="fas fa-building me-2 text-primary"></i>Hotel Name
                        </label>
                        <input type="text" class="form-control bg-light" id="modalHotelName" readonly>
                    </div>

                    <!-- Destination Field -->
                    <div class="mb-3">
                        <label for="modalDestination" class="form-label fw-semibold">
                            <i class="fas fa-map-marker-alt me-2 text-danger"></i>Destination *
                        </label>
                        <select class="form-select" id="modalDestination" name="destination" required>
                            <option value="">-- Select Destination --</option>
                            {% for destination in destinations %}
                                <option value="{{ destination.id }}">{{ destination.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Category and Room Type Row -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="hotelCategory" class="form-label fw-semibold">
                                <i class="fas fa-star me-2 text-warning"></i>Category
                            </label>
                            <select class="form-select" id="hotelCategory" name="category" required>
                                <option value="">-- Select Category --</option>
                                <option value="1 Star">1 Star</option>
                                <option value="2 Star">2 Star</option>
                                <option value="3 Star">3 Star</option>
                                <option value="4 Star">4 Star</option>
                                <option value="5 Star">5 Star</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="roomType" class="form-label fw-semibold">
                                <i class="fas fa-door-open me-2 text-info"></i>Room Type
                            </label>
                            <select name="room_type" id="roomType" class="form-select" required>
                                <option value="">-- Select Room Type --</option>
                                {% for r in room_types %}
                                    <option value="{{ r.id }}">{{ r.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <!-- Meal Plan and Hotel Option -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="mealPlan" class="form-label fw-semibold">
                                <i class="fas fa-utensils me-2 text-success"></i>Meal Plan
                            </label>
                            <select class="form-select" id="mealPlan" name="meal_plan" required>
                                <option value="">-- Select Meal Plan --</option>
                                {% for plan in meal_plans %}
                                    <option value="{{ plan.id }}">{{ plan.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="hotelOption" class="form-label fw-semibold">
                                <i class="fas fa-list-alt me-2 text-secondary"></i>Hotel Option
                            </label>
                            <select name="option" id="hotelOption" class="form-select">
                                <option value="option_1">Option 1</option>
                                <option value="option_2">Option 2</option>
                                <option value="option_3">Option 3</option>
                            </select>
                        </div>
                    </div>

                    <!-- Special Inclusions Section -->
                    <div class="border p-3 rounded bg-light mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="mb-0 fw-bold">
                                <i class="fas fa-star me-2 text-warning"></i>Special Inclusions (Optional)
                            </h6>
                            <button type="button" class="btn btn-sm btn-primary" id="addInclusionBtn">
                                <i class="fas fa-plus me-1"></i> Add Inclusion
                            </button>
                        </div>
                        
                        <!-- Container for inclusion rows -->
                        <div id="inclusionsContainer">
                            <div class="text-center text-muted py-4" id="noInclusionsMessage">
                                <i class="fas fa-info-circle me-2"></i>
                                No inclusions added yet. Click "Add Inclusion" to add special inclusions.
                            </div>
                        </div>
                        
                        <!-- Total Summary -->
                        <div id="inclusionsSummary" class="mt-3 p-3 bg-white rounded border" style="display: none;">
                            <div class="d-flex justify-content-between align-items-center">
                                <strong class="text-primary">
                                    <i class="fas fa-calculator me-2"></i>Total Inclusions Cost:
                                </strong>
                                <strong id="totalInclusionCost" class="text-success fs-5">₹0.00</strong>
                            </div>
                            <small class="text-muted d-block mt-2" id="inclusionsSummaryText"></small>
                        </div>
                    </div>

                    <!-- Room Configuration -->
                    <div class="border p-3 rounded bg-light mb-4">
                        <h6 class="mb-3 fw-bold">
                            <i class="fas fa-bed me-2 text-info"></i>Room Configuration
                        </h6>
                        
                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label for="numDoubleBeds" class="form-label fw-semibold">
                                    Double Beds *
                                    <small class="text-muted fw-normal">(Rooms auto-match)</small>
                                </label>
                                <input 
                                    type="number" 
                                    name="num_double_beds" 
                                    id="numDoubleBeds" 
                                    class="form-control" 
                                    value="0" 
                                    min="0"
                                    required>
                                <small class="text-muted d-block mt-1">Number of rooms with double beds</small>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="extraBeds" class="form-label fw-semibold">Extra Beds</label>
                                <input 
                                    type="number" 
                                    name="extra_beds" 
                                    id="extraBeds" 
                                    class="form-control" 
                                    value="0" 
                                    min="0">
                                <small class="text-muted d-block mt-1">Additional beds needed</small>
                            </div>
                        </div>
                        
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="childWithBed" class="form-label fw-semibold">Children with Bed</label>
                                <input 
                                    type="number" 
                                    name="child_with_bed" 
                                    id="childWithBed" 
                                    class="form-control" 
                                    value="0" 
                                    min="0">
                                <small class="text-muted d-block mt-1">Children requiring their own bed</small>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="childWithoutBed" class="form-label fw-semibold">Children without Bed</label>
                                <input 
                                    type="number" 
                                    name="child_without_bed" 
                                    id="childWithoutBed" 
                                    class="form-control" 
                                    value="0" 
                                    min="0">
                                <small class="text-muted d-block mt-1">Children sharing parent's bed</small>
                            </div>
                        </div>
                    </div>

                    <!-- Check-in/Check-out Section - EDITED ✅ -->
                    <div class="border p-3 rounded bg-light mb-3">
                        <h6 class="mb-3 fw-bold">
                            <i class="fas fa-calendar-check me-2 text-success"></i>Check-in & Check-out Details
                        </h6>
                        
                        <!-- UPDATED: Show Itinerary dates instead of Query dates -->
                        {% if itinerary.travel_from and itinerary.travel_to %}
                        <div class="alert alert-info py-2 mb-3">
                            <small>
                                <i class="fas fa-info-circle me-1"></i>
                                <strong>Itinerary Date Range:</strong> {{ itinerary.travel_from|date:"d M Y" }} to {{ itinerary.travel_to|date:"d M Y" }}
                            </small>
                        </div>
                        {% endif %}
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="checkinDate" class="form-label fw-semibold">Check-in Date *</label>
                                <input 
                                    type="date" 
                                    name="check_in_date" 
                                    class="form-control" 
                                    id="checkinDate"
                                    min="{{ itinerary.travel_from|date:'Y-m-d' }}"
                                    max="{{ itinerary.travel_to|date:'Y-m-d' }}"
                                    required>
                                <div class="invalid-feedback">
                                    Check-in date must be within the itinerary date range
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label for="checkinTime" class="form-label fw-semibold">Check-in Time *</label>
                                <input type="time" name="check_in_time" class="form-control" id="checkinTime" value="14:00" required>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <label for="checkoutDate" class="form-label fw-semibold">Check-out Date *</label>
                                <input 
                                    type="date" 
                                    name="check_out_date" 
                                    class="form-control" 
                                    id="checkoutDate"
                                    min="{{ itinerary.travel_from|date:'Y-m-d' }}"
                                    max="{{ itinerary.travel_to|date:'Y-m-d' }}"
                                    required>
                                <div class="invalid-feedback">
                                    Check-out date must be after check-in date and within range
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label for="checkoutTime" class="form-label fw-semibold">Check-out Time *</label>
                                <input type="time" name="check_out_time" class="form-control" id="checkoutTime" value="11:00" required>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Modal Footer - Fixed at Bottom -->
                <div class="modal-footer sticky-bottom bg-white border-top" style="z-index: 1050;">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Close
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>Save Booking
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ✅ INCLUSION ROW TEMPLATE (Hidden) -->
<template id="inclusionRowTemplate">
    <div class="inclusion-row border rounded p-3 mb-3 bg-white">
        <div class="d-flex justify-content-between align-items-start mb-2">
            <h6 class="mb-0 text-primary">
                <i class="fas fa-gift me-2"></i>Inclusion <span class="inclusion-number"></span>
            </h6>
            <button type="button" class="btn btn-sm btn-danger remove-inclusion-btn">
                <i class="fas fa-trash"></i>
            </button>
        </div>
        
        <div class="row g-2">
            <!-- Special Inclusion Dropdown -->
            <div class="col-md-6">
                <label class="form-label small fw-semibold">Special Inclusion *</label>
                <select class="form-select form-select-sm inclusion-select" required>
                    <option value="">-- Select Inclusion --</option>
                    {% for inc in hotel_special_inclusions %}
                        <option value="{{ inc.id }}" 
                                data-name="{{ inc.name }}"
                                data-pricing-type="{{ inc.pricing_type }}"
                                data-adult-price="{{ inc.adult_price }}"
                                data-child-price="{{ inc.child_price }}">
                            {{ inc.name }} 
                            ({% if inc.pricing_type == 'free' %}Free
                             {% elif inc.pricing_type == 'per_person' %}₹{{ inc.adult_price }}/person
                             {% elif inc.pricing_type == 'per_booking' %}₹{{ inc.adult_price }}/booking
                             {% elif inc.pricing_type == 'per_room' %}₹{{ inc.adult_price }}/room
                             {% endif %})
                        </option>
                    {% endfor %}
                </select>
            </div>
            
            <!-- Number of Adults -->
            <div class="col-md-3">
                <label class="form-label small fw-semibold">Adults</label>
                <input type="number" class="form-control form-control-sm inclusion-adults" 
                       value="0" min="0" max="50">
            </div>
            
            <!-- Number of Children -->
            <div class="col-md-3">
                <label class="form-label small fw-semibold">Children</label>
                <input type="number" class="form-control form-control-sm inclusion-children" 
                       value="0" min="0" max="50">
            </div>
        </div>
        
        <!-- Price Display -->
        <div class="mt-2 p-2 bg-light rounded">
            <div class="d-flex justify-content-between align-items-center">
                <small class="text-muted">
                    <i class="fas fa-info-circle me-1"></i>
                    <span class="pricing-info">Select an inclusion to see pricing</span>
                </small>
                <strong class="text-success inclusion-price">₹0.00</strong>
            </div>
        </div>
    </div>
</template>


<!-- ✅ ACTIVITY BOOKING MODAL - EDITED FOR ITINERARY -->
<div class="modal fade" id="activityBookingModal" tabindex="-1" aria-hidden="true"
     data-url-edit-prototype="{% url 'update_activity_booking' 9999 %}">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action=""> {% csrf_token %}
                <div class="modal-header bg-warning">
                    <h5 class="modal-title" id="activityBookingModalLabel">
                        <i class="fas fa-map me-2"></i>Book Activity
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- ITINERARY DATA -->
                    <input type="hidden" id="itineraryTravelFrom" value="{{ itinerary.travel_from|date:'Y-m-d' }}">
                    <input type="hidden" id="itineraryTravelTo" value="{{ itinerary.travel_to|date:'Y-m-d' }}">
                    <input type="hidden" id="itineraryDefaultAdults" value="{{ itinerary.adults|default:'2' }}">
                    <input type="hidden" id="itineraryDefaultChildren" value="{{ itinerary.childrens|default:'0' }}">
                    
                    <input type="hidden" name="activity_id" id="modalActivityId">
                    <input type="hidden" name="day_number" id="modalActivityDayNumber">
                    
                    <div class="mb-3">
                        <strong><i class="fas fa-star me-2 text-warning"></i>Activity:</strong> <span id="modalActivityName"></span>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-semibold">Date *</label>
                        <input type="date" name="booking_date" class="form-control" 
                               min="{{ itinerary.travel_from|date:'Y-m-d' }}"
                               max="{{ itinerary.travel_to|date:'Y-m-d' }}"
                               required>
                        <small class="text-muted">Within itinerary dates</small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Time *</label>
                        <input type="time" name="booking_time" class="form-control" required>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col">
                            <label class="form-label fw-semibold">Adults</label>
                            <input type="number" name="num_adults" class="form-control" min="1" value="1">
                        </div>
                        <div class="col">
                            <label class="form-label fw-semibold">Children</label>
                            <input type="number" name="num_children" class="form-control" min="0" value="0">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Notes</label>
                        <textarea name="notes" class="form-control" rows="2" placeholder="Any special requests..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-check me-1"></i>Confirm Booking
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ✅ VEHICLE BOOKING MODAL - EDITED FOR ITINERARY -->
<div class="modal fade" id="bookVehicleModal" tabindex="-1" aria-hidden="true"
     data-url-edit-prototype="{% url 'update_vehicle_booking' 9999 %}">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{% url 'create_vehicle_booking' itinerary.id %}"> 
                {% csrf_token %}
                
                <!-- ITINERARY DATA -->
                <input type="hidden" id="itineraryTravelFrom" value="{{ itinerary.travel_from|date:'Y-m-d' }}">
                <input type="hidden" id="itineraryTravelTo" value="{{ itinerary.travel_to|date:'Y-m-d' }}">
                <input type="hidden" id="itineraryDefaultAdults" value="{{ itinerary.adults|default:'2' }}">
                <input type="hidden" id="itineraryDefaultChildren" value="{{ itinerary.childrens|default:'0' }}">
                
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="vehicleBookingModalLabel">
                        <i class="fas fa-car me-2"></i>Book Vehicle
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="vehicle_id" id="modalVehicleId">
                    <input type="hidden" name="day_number" id="modalVehicleDayNumber">
                    <input type="hidden" name="destination_id" id="modalVehicleDestinationId">
                    
                    <div class="alert alert-info">
                        <strong><i class="fas fa-car me-2"></i>Vehicle:</strong> <span id="modalVehicleName"></span>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-semibold">
                            <i class="fas fa-calendar me-1"></i>Pickup Date *
                        </label>
                        <input type="date" name="pickup_date" class="form-control" 
                               min="{{ itinerary.travel_from|date:'Y-m-d' }}"
                               max="{{ itinerary.travel_to|date:'Y-m-d' }}"
                               required>
                        <small class="text-muted">Within itinerary dates</small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-semibold">
                            <i class="fas fa-clock me-1"></i>Pickup Time *
                        </label>
                        <input type="time" name="pickup_time" class="form-control" required>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-semibold">
                            <i class="fas fa-users me-1"></i>Number of Passengers *
                        </label>
                        <input type="number" name="num_passengers" class="form-control" min="1" required>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-semibold">
                            <i class="fas fa-car-side me-1"></i>Vehicle Type *
                        </label>
                        <input type="text" name="vehicle_type" class="form-control" placeholder="e.g. SUV, Sedan, Bus" required>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-semibold">
                            <i class="fas fa-road me-1"></i>Total Kilometers
                        </label>
                        <input type="number" name="total_km" class="form-control" min="0">
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-semibold">
                            <i class="fas fa-list me-1"></i>Option *
                        </label>
                        <input type="text" name="option" class="form-control" placeholder="e.g. AC/Non-AC, Driver included" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Cancel
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-1"></i>Save Booking
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ✅ HOUSEBOAT BOOKING MODAL - WITH MULTI-INCLUSIONS - EDITED FOR ITINERARY ✅ -->
<div class="modal fade" id="houseboatBookingModal" tabindex="-1" aria-hidden="true" 
     data-url-edit-prototype="{% url 'update_houseboat_booking' 9999 %}"
     data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-xl modal-dialog-scrollable modal-dialog-centered">
        <div class="modal-content" style="max-height: 90vh;">
            <form method="POST" action="" id="houseboatBookingForm">
                {% csrf_token %}
                
                <!-- ITINERARY DATA - EDITED ✅ -->
                <input type="hidden" id="itineraryTravelFrom" value="{{ itinerary.travel_from|date:'Y-m-d' }}">
                <input type="hidden" id="itineraryTravelTo" value="{{ itinerary.travel_to|date:'Y-m-d' }}">
                <input type="hidden" id="itineraryDefaultAdults" value="{{ itinerary.adults|default:'2' }}">
                <input type="hidden" id="itineraryDefaultChildren" value="{{ itinerary.childrens|default:'0' }}">
                <input type="hidden" id="itineraryDefaultInfants" value="{{ itinerary.infants|default:'0' }}">
                
                <!-- Hidden Fields -->
                <input type="hidden" name="houseboat_id" id="modalHouseboatId">
                <input type="hidden" name="day_number" id="house_boat_modalDayNumber">
                <input type="hidden" name="inclusions_data" id="houseboatInclusionsData">
                
                <!-- Modal Header -->
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title" id="houseboatBookingModalLabel">
                        <i class="fas fa-ship me-2"></i>Book Houseboat
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                
                <!-- Modal Body - Scrollable -->
                <div class="modal-body" style="max-height: calc(90vh - 140px); overflow-y: auto;">
                    
                    <!-- Houseboat Name Display -->
                    <div class="alert alert-info">
                        <strong><i class="fas fa-ship me-2"></i>Houseboat:</strong> <span id="modalHouseboatName">N/A</span>
                    </div>
                    
                    <!-- UPDATED: Itinerary Date Range Info -->
                    {% if itinerary.travel_from and itinerary.travel_to %}
                    <div class="alert alert-info py-2 mb-3">
                        <small>
                            <i class="fas fa-info-circle me-1"></i>
                            <strong>Itinerary Date Range:</strong> {{ itinerary.travel_from|date:"d M Y" }} to {{ itinerary.travel_to|date:"d M Y" }}
                        </small>
                    </div>
                    {% endif %}
                    
                    <!-- 1. Check-in & Check-out Dates (MOVED TO TOP) -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="houseboatCheckIn" class="form-label fw-semibold">
                                <i class="fas fa-calendar-check me-1"></i>Check-in Date*
                            </label>
                            <input 
                                type="date" 
                                name="check_in_date" 
                                class="form-control" 
                                id="houseboatCheckIn"
                                min="{{ itinerary.travel_from|date:'Y-m-d' }}"
                                max="{{ itinerary.travel_to|date:'Y-m-d' }}"
                                required>
                            <div class="invalid-feedback">
                                Please select a check-in date within the itinerary date range
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="houseboatCheckOut" class="form-label fw-semibold">
                                <i class="fas fa-calendar-times me-1"></i>Check-out Date*
                            </label>
                            <input 
                                type="date" 
                                name="check_out_date" 
                                class="form-control" 
                                id="houseboatCheckOut"
                                min="{{ itinerary.travel_from|date:'Y-m-d' }}"
                                max="{{ itinerary.travel_to|date:'Y-m-d' }}"
                                required>
                            <div class="invalid-feedback">
                                Please select a check-out date within the itinerary date range
                            </div>
                        </div>
                    </div>
                    
                    <!-- 2. Meal Plan & Room Type (These will be filtered after dates are set) -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">
                                <i class="fas fa-utensils me-1"></i>Meal Plan *
                            </label>
                            <select name="meal_plan" class="form-select" required>
                                <option value="">-- Select Meal Plan --</option>
                                {% for plan in meal_plans %}
                                    <option value="{{ plan.id }}">{{ plan.name }}</option>
                                {% endfor %}
                            </select>
                            <small class="text-muted">Options filtered based on selected dates</small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">
                                <i class="fas fa-bed me-1"></i>Room Type *
                            </label>
                            <select name="room_type" class="form-select" required>
                                <option value="">-- Select Room Type --</option>
                                {% for rt in room_types %}
                                    <option value="{{ rt.id }}">{{ rt.name }}</option>
                                {% endfor %}
                            </select>
                            <small class="text-muted">Options filtered based on selected dates</small>
                        </div>
                    </div>
                    
                    <!-- 3. ✅ Special Inclusions (Multi) - EDITED FOR ITINERARY ✅ -->
                    <div class="border p-3 rounded bg-light mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <label class="form-label mb-0 fw-bold">
                                <i class="fas fa-star me-1 text-warning"></i>Special Inclusions (Optional)
                            </label>
                            <button type="button" class="btn btn-sm btn-primary" id="addHouseboatInclusionBtn">
                                <i class="fas fa-plus me-1"></i> Add Inclusion
                            </button>
                        </div>
                        <small class="form-text text-muted d-block mb-2">
                            Welcome drinks, early check-in, etc.
                        </small>
                        
                        <!-- Container for inclusion rows -->
                        <div id="houseboatInclusionsContainer">
                            <div class="text-center text-muted py-4" id="houseboatNoInclusionsMessage">
                                <i class="fas fa-info-circle me-2"></i>
                                No inclusions added yet. Click "Add Inclusion" to add special inclusions.
                            </div>
                        </div>
                        
                        <!-- Total Summary -->
                        <div id="houseboatInclusionsSummary" class="mt-3 p-3 bg-white rounded border" style="display: none;">
                            <div class="d-flex justify-content-between align-items-center">
                                <strong class="text-primary">
                                    <i class="fas fa-calculator me-2"></i>Total Inclusions Cost:
                                </strong>
                                <strong id="houseboatTotalInclusionCost" class="text-success fs-5">₹0.00</strong>
                            </div>
                            <small class="text-muted d-block mt-2" id="houseboatInclusionsSummaryText"></small>
                        </div>
                    </div>
                    
                    <!-- 4. Room Configuration -->
                    <div class="border p-3 rounded bg-light mb-3">
                        <h6 class="mb-3 fw-bold">
                            <i class="fas fa-door-open me-2"></i>Room Configuration
                        </h6>
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label small">1-Bed Rooms</label>
                                <input type="number" name="num_one_bed_rooms" class="form-control form-control-sm houseboat-room-input" value="0" min="0">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label small">2-Bed Rooms</label>
                                <input type="number" name="num_two_bed_rooms" class="form-control form-control-sm houseboat-room-input" value="0" min="0">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label small">3-Bed Rooms</label>
                                <input type="number" name="num_three_bed_rooms" class="form-control form-control-sm houseboat-room-input" value="0" min="0">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label small">4-Bed Rooms</label>
                                <input type="number" name="num_four_bed_rooms" class="form-control form-control-sm houseboat-room-input" value="0" min="0">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label small">5-Bed Rooms</label>
                                <input type="number" name="num_five_bed_rooms" class="form-control form-control-sm houseboat-room-input" value="0" min="0">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label small">6-Bed Rooms</label>
                                <input type="number" name="num_six_bed_rooms" class="form-control form-control-sm houseboat-room-input" value="0" min="0">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label small">7-Bed Rooms</label>
                                <input type="number" name="num_seven_bed_rooms" class="form-control form-control-sm houseboat-room-input" value="0" min="0">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label small">8-Bed Rooms</label>
                                <input type="number" name="num_eight_bed_rooms" class="form-control form-control-sm houseboat-room-input" value="0" min="0">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label small">9-Bed Rooms</label>
                                <input type="number" name="num_nine_bed_rooms" class="form-control form-control-sm houseboat-room-input" value="0" min="0">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label small">10-Bed Rooms</label>
                                <input type="number" name="num_ten_bed_rooms" class="form-control form-control-sm houseboat-room-input" value="0" min="0">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label small">Extra Beds</label>
                                <input type="number" name="num_extra_beds" class="form-control form-control-sm" value="0" min="0">
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Modal Footer -->
                <div class="modal-footer sticky-bottom bg-white border-top" style="z-index: 1050;">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Cancel
                    </button>
                    <button type="submit" class="btn btn-info text-white">
                        <i class="fas fa-save me-1"></i>Save Booking
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ✅ HOUSEBOAT INCLUSION ROW TEMPLATE -->
<template id="houseboatInclusionRowTemplate">
    <div class="houseboat-inclusion-row border rounded p-3 mb-3 bg-white">
        <div class="d-flex justify-content-between align-items-start mb-2">
            <h6 class="mb-0 text-primary">
                <i class="fas fa-gift me-2"></i>Inclusion #<span class="houseboat-inclusion-number"></span>
            </h6>
            <button type="button" class="btn btn-sm btn-danger remove-houseboat-inclusion-btn">
                <i class="fas fa-trash"></i> Remove
            </button>
        </div>
        
        <div class="row g-2">
            <!-- Special Inclusion Dropdown -->
            <div class="col-md-6">
                <label class="form-label small fw-semibold">Special Inclusion *</label>
                <select class="form-select form-select-sm houseboat-inclusion-select" required>
                    <option value="">-- Select Inclusion --</option>
                </select>
                <small class="text-muted houseboat-pricing-info"></small>
            </div>
            
            <!-- Number of Adults -->
            <div class="col-md-3">
                <label class="form-label small fw-semibold">Adults</label>
                <input type="number" class="form-control form-control-sm houseboat-inclusion-adults" 
                       value="0" min="0" max="50">
            </div>
            
            <!-- Number of Children -->
            <div class="col-md-3">
                <label class="form-label small fw-semibold">Children</label>
                <input type="number" class="form-control form-control-sm houseboat-inclusion-children" 
                       value="0" min="0" max="50">
            </div>
        </div>
        
        <!-- Price Display -->
        <div class="mt-2 p-2 bg-light rounded">
            <div class="d-flex justify-content-between align-items-center">
                <small class="text-muted">
                    <i class="fas fa-calculator me-1"></i>Price:
                </small>
                <strong class="text-success houseboat-inclusion-price">₹0.00</strong>
            </div>
        </div>
    </div>
</template>

<!-- ✅ EDIT DAY DETAILS MODAL -->
<div class="modal fade" id="editDayDetailsModal" tabindex="-1" aria-labelledby="editDayDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="post" enctype="multipart/form-data">
                {% csrf_token %}
                <input type="hidden" name="form_type" value="edit_day_details">
                <input type="hidden" name="day_number" id="editDayNumber">
                
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="editDayDetailsModalLabel">
                        <i class="fas fa-edit me-2"></i>Edit Day Details
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                
                <div class="modal-body">
                    <!-- Info Alert -->
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Tip:</strong> Leave description and image fields empty to use destination defaults
                    </div>
                    
                    <!-- Day Title -->
                    <div class="mb-3">
                        <label for="dayTitle" class="form-label fw-semibold">
                            <i class="fas fa-heading me-1"></i>Day Title
                        </label>
                        <input type="text" 
                               class="form-control" 
                               id="dayTitle" 
                               name="title" 
                               placeholder="e.g., Cochin to Cochin (100 KM)">
                        <small class="text-muted">Route or main activity for this day</small>
                    </div>
                    
                    <!-- Day Description -->
                    <div class="mb-3">
                        <label for="dayDescription" class="form-label fw-semibold">
                            <i class="fas fa-align-left me-1"></i>Description (Optional)
                        </label>
                        <textarea class="form-control" 
                                  id="dayDescription" 
                                  name="description" 
                                  rows="6"
                                  placeholder="Leave empty to use destination's default description..."></textarea>
                        <small class="text-muted">Custom description for this specific day</small>
                    </div>
                    
                    <!-- Day Image -->
                    <div class="mb-3">
                        <label for="dayImage" class="form-label fw-semibold">
                            <i class="fas fa-image me-1"></i>Custom Image (Optional)
                        </label>
                        <input type="file" 
                               class="form-control" 
                               id="dayImage" 
                               name="image" 
                               accept="image/*">
                        <small class="text-muted">Upload only if you want a different image than destination default</small>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Cancel
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-1"></i>Save Details
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ✅ STANDALONE INCLUSION BOOKING MODAL - EDITED FOR ITINERARY ✅ -->
<div class="modal fade" id="standaloneInclusionModal" tabindex="-1" aria-hidden="true" 
     data-url-edit-prototype="{% url 'update_standalone_inclusion' 9999 %}">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <form method="POST" action="{% url 'create_standalone_inclusion' itinerary.id %}" id="standaloneInclusionForm">
        {% csrf_token %}
        
        <!-- ITINERARY DATA - EDITED ✅ -->
        <input type="hidden" id="itineraryTravelFrom" value="{{ itinerary.travel_from|date:'Y-m-d' }}">
        <input type="hidden" id="itineraryTravelTo" value="{{ itinerary.travel_to|date:'Y-m-d' }}">
        <input type="hidden" id="itineraryDefaultAdults" value="{{ itinerary.adults|default:'2' }}">
        <input type="hidden" id="itineraryDefaultChildren" value="{{ itinerary.childrens|default:'0' }}">
        
        <!-- Hidden Fields -->
        <input type="hidden" name="booking_id" id="standaloneBookingId">
        <input type="hidden" name="special_inclusion_id" id="standaloneInclusionId">
        <input type="hidden" name="day_number" id="standaloneDayNumber">
        
        <!-- Modal Header -->
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title" id="standaloneInclusionModalLabel">
            <i class="fas fa-mountain me-2"></i>Book Standalone Activity/Service
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        
        <!-- Modal Body -->
        <div class="modal-body">
          
          <!-- Activity Name Display -->
          <div class="alert alert-info mb-3">
            <strong><i class="fas fa-info-circle me-2"></i>Activity:</strong>
            <span id="standaloneInclusionName" class="fs-5">N/A</span>
          </div>
          
          <!-- Booking Date & Time -->
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="standaloneBookingDate" class="form-label fw-semibold">
                <i class="fas fa-calendar-alt me-1"></i>Booking Date *
              </label>
              <input type="date" 
                     name="booking_date" 
                     id="standaloneBookingDate" 
                     class="form-control" 
                     min="{{ itinerary.travel_from|date:'Y-m-d' }}"
                     max="{{ itinerary.travel_to|date:'Y-m-d' }}"
                     required>
              <small class="text-muted">Within itinerary dates</small>
            </div>
            <div class="col-md-6">
              <label for="standaloneBookingTime" class="form-label fw-semibold">
                <i class="fas fa-clock me-1"></i>Booking Time
              </label>
              <input type="time" 
                     name="booking_time" 
                     id="standaloneBookingTime" 
                     class="form-control">
              <small class="text-muted">Optional</small>
            </div>
          </div>
          
          <!-- Participants -->
          <div class="border p-3 rounded bg-light mb-3">
            <h6 class="mb-3 fw-bold">
              <i class="fas fa-users me-2 text-primary"></i>Participants
            </h6>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="standaloneNumAdults" class="form-label fw-semibold">
                  <i class="fas fa-user me-1"></i>Number of Adults *
                </label>
                <input type="number" 
                       name="num_adults" 
                       id="standaloneNumAdults" 
                       class="form-control" 
                       min="0" 
                       value="1" 
                       onchange="calculateStandalonePrice()" 
                       required>
              </div>
              <div class="col-md-6 mb-3">
                <label for="standaloneNumChildren" class="form-label fw-semibold">
                  <i class="fas fa-child me-1"></i>Number of Children
                </label>
                <input type="number" 
                       name="num_children" 
                       id="standaloneNumChildren" 
                       class="form-control" 
                       min="0" 
                       value="0" 
                       onchange="calculateStandalonePrice()">
              </div>
            </div>
          </div>
          
          <!-- Pricing Information (Auto-calculated) -->
          <div class="border p-3 rounded bg-white mb-3" id="standalonePricingInfo" style="display: none;">
            <h6 class="mb-3 fw-bold">
              <i class="fas fa-calculator me-2 text-success"></i>Pricing Breakdown
            </h6>
            <div class="pricing-breakdown">
              <div class="d-flex justify-content-between mb-2">
                <span><i class="fas fa-user me-1 text-primary"></i>Adults (<span id="adultCount">0</span> × ₹<span id="adultUnitPrice">0.00</span>):</span>
                <strong class="text-success">₹<span id="adultTotal">0.00</span></strong>
              </div>
              <div class="d-flex justify-content-between mb-2">
                <span><i class="fas fa-child me-1 text-info"></i>Children (<span id="childCount">0</span> × ₹<span id="childUnitPrice">0.00</span>):</span>
                <strong class="text-success">₹<span id="childTotal">0.00</span></strong>
              </div>
              <hr class="my-2">
              <div class="d-flex justify-content-between">
                <strong class="text-dark fs-5"><i class="fas fa-rupee-sign me-1"></i>Total Amount:</strong>
                <strong class="text-success fs-4">₹<span id="totalAmount">0.00</span></strong>
              </div>
            </div>
            <div class="alert alert-info mt-3 mb-0">
              <small><i class="fas fa-info-circle me-1"></i>Markup will be applied in the pricing section</small>
            </div>
          </div>
          
          <!-- Notes -->
          <div class="mb-3">
            <label for="standaloneNotes" class="form-label fw-semibold">
              <i class="fas fa-sticky-note me-1"></i>Special Notes (Optional)
            </label>
            <textarea name="notes" 
                      id="standaloneNotes" 
                      class="form-control" 
                      rows="3" 
                      placeholder="Any special instructions, requirements, or preferences..."></textarea>
          </div>
          
        </div>
        
        <!-- Modal Footer -->
        <div class="modal-footer bg-light">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="fas fa-times me-1"></i>Cancel
          </button>
          <button type="submit" class="btn btn-success">
            <i class="fas fa-check-circle me-1"></i>Confirm Booking
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>

    const modalDirtyStates = {
        hotelBookingModal: false,
        activityBookingModal: false,
        bookVehicleModal: false,
        houseboatBookingModal: false,
        editDayDetailsModal: false
    };
    
    // Reset dirty flag for a specific modal
    function resetDirtyFlag(modalId) {
        if (modalDirtyStates.hasOwnProperty(modalId)) {
            modalDirtyStates[modalId] = false;
            console.log(`🧹 Reset dirty flag for ${modalId}`);
        }
    }

    // Set dirty flag for a specific modal
    function setDirtyFlag(modalId) {
        if (modalDirtyStates.hasOwnProperty(modalId)) {
            modalDirtyStates[modalId] = true;
            console.log(`✏️ Set dirty flag for ${modalId}`);
        }
    }

    // Check if modal has unsaved changes
    function hasUnsavedChanges(modalId) {
        return modalDirtyStates[modalId] === true;
    }

    // Attach change listeners to form inputs
    function attachDirtyListeners(modalElement, modalId) {
        const form = modalElement.querySelector('form');
        if (!form) return;
        
        const inputs = form.querySelectorAll('input, select, textarea');
        inputs.forEach(input => {
            input.addEventListener('input', function() {
                setDirtyFlag(modalId);
            });
            input.addEventListener('change', function() {
                setDirtyFlag(modalId);
            });
        });
        
        console.log(`✅ Attached dirty listeners to ${inputs.length} inputs in ${modalId}`);
    }

    // Prevent modal from closing if there are unsaved changes
    function preventUnsavedClose(modalElement, modalId) {
        modalElement.addEventListener('hide.bs.modal', function(event) {
            if (hasUnsavedChanges(modalId)) {
                const confirmClose = confirm(
                    '⚠️ You have unsaved changes!\n\n' +
                    'Are you sure you want to close without saving?\n' +
                    'All changes will be lost.'
                );
                
                if (!confirmClose) {
                    event.preventDefault();
                    console.log(`🛑 Prevented close of ${modalId} due to unsaved changes`);
                } else {
                    resetDirtyFlag(modalId);
                    console.log(`✅ User confirmed close of ${modalId}`);
                }
            }
        });
    }

    // Initialize unsaved changes protection for a modal
    function initializeUnsavedChangesProtection(modalId) {
        const modalElement = document.getElementById(modalId);
        if (!modalElement) {
            console.warn(`⚠️ Modal ${modalId} not found`);
            return;
        }
        
        modalElement.addEventListener('show.bs.modal', function() {
            resetDirtyFlag(modalId);
        });
        
        modalElement.addEventListener('shown.bs.modal', function() {
            attachDirtyListeners(modalElement, modalId);
        });
        
        preventUnsavedClose(modalElement, modalId);
        
        const form = modalElement.querySelector('form');
        if (form) {
            form.addEventListener('submit', function() {
                resetDirtyFlag(modalId);
            });
        }
        
        modalElement.addEventListener('hidden.bs.modal', function() {
            resetDirtyFlag(modalId);
        });
        
        console.log(`✅ Unsaved changes protection initialized for ${modalId}`);
    }

    // ==========================================
    // GET DATA FROM ITINERARY (NOT QUERY) - EDITED ✅
    // ==========================================
    
    const itineraryAdults = parseInt(document.getElementById('itineraryDefaultAdults')?.value) || 2;
    const itineraryChildren = parseInt(document.getElementById('itineraryDefaultChildren')?.value) || 0;
    const itineraryInfants = parseInt(document.getElementById('itineraryDefaultInfants')?.value) || 0;
    const itineraryTravelFrom = document.getElementById('itineraryTravelFrom')?.value || '';
    const itineraryTravelTo = document.getElementById('itineraryTravelTo')?.value || '';
    
    console.log('📋 ITINERARY DATA LOADED:');
    console.log(`👥 Adults: ${itineraryAdults}, Children: ${itineraryChildren}, Infants: ${itineraryInfants}`);
    console.log(`📅 Travel: ${itineraryTravelFrom} to ${itineraryTravelTo}`);

    // ==========================================
    // MULTI-INCLUSION MANAGEMENT FOR ITINERARY (HOTEL)
    // ==========================================
    
    function loadValidHouseboatOptions(houseboatId, checkInDate, checkOutDate) {
        if (!houseboatId || !checkInDate || !checkOutDate) {
            console.log('⚠️ Missing parameters');
            return;
        }
        
        console.log(`🔄 Loading options for houseboat ${houseboatId} (${checkInDate} to ${checkOutDate})`);
        
        fetch(`/houseboat/${houseboatId}/valid-options/?check_in=${checkInDate}&check_out=${checkOutDate}`)
            .then(response => response.json())
            .then(data => {
                console.log('📦 API Response:', data);
                
                if (data.success) {
                    console.log(`✅ Found ${data.room_type_count} room types and ${data.meal_plan_count} meal plans`);
                    
                    // ✅ REBUILD ROOM TYPE DROPDOWN
                    const roomTypeSelect = document.querySelector('#houseboatBookingModal [name="room_type"]');
                    console.log('Room type select element:', roomTypeSelect);
                    
                    if (roomTypeSelect) {
                        const selectedValue = roomTypeSelect.value;
                        console.log('Current room type value:', selectedValue);
                        
                        while (roomTypeSelect.options.length > 0) {
                            roomTypeSelect.remove(0);
                        }
                        console.log('✅ Cleared all room type options');
                        
                        const placeholderOption = document.createElement('option');
                        placeholderOption.value = '';
                        placeholderOption.textContent = '-- Select Room Type --';
                        roomTypeSelect.appendChild(placeholderOption);
                        
                        data.room_types.forEach(rt => {
                            const option = document.createElement('option');
                            option.value = rt.id;
                            option.textContent = rt.name;
                            roomTypeSelect.appendChild(option);
                            console.log(`✅ Added room type: ${rt.name} (ID: ${rt.id})`);
                        });
                        
                        const validIds = data.room_types.map(rt => rt.id);
                        if (selectedValue && validIds.includes(parseInt(selectedValue))) {
                            roomTypeSelect.value = selectedValue;
                            console.log(`✅ Restored room type selection: ${selectedValue}`);
                        }
                        
                        console.log(`✅ Room type dropdown has ${roomTypeSelect.options.length} options now`);
                    }
                    
                    // ✅ REBUILD MEAL PLAN DROPDOWN
                    const mealPlanSelect = document.querySelector('#houseboatBookingModal [name="meal_plan"]');
                    console.log('Meal plan select element:', mealPlanSelect);
                    
                    if (mealPlanSelect) {
                        const selectedValue = mealPlanSelect.value;
                        console.log('Current meal plan value:', selectedValue);
                        
                        while (mealPlanSelect.options.length > 0) {
                            mealPlanSelect.remove(0);
                        }
                        console.log('✅ Cleared all meal plan options');
                        
                        const placeholderOption = document.createElement('option');
                        placeholderOption.value = '';
                        placeholderOption.textContent = '-- Select Meal Plan --';
                        mealPlanSelect.appendChild(placeholderOption);
                        
                        data.meal_plans.forEach(mp => {
                            const option = document.createElement('option');
                            option.value = mp.id;
                            option.textContent = mp.name;
                            mealPlanSelect.appendChild(option);
                            console.log(`✅ Added meal plan: ${mp.name} (ID: ${mp.id})`);
                        });
                        
                        const validIds = data.meal_plans.map(mp => mp.id);
                        if (selectedValue && validIds.includes(parseInt(selectedValue))) {
                            mealPlanSelect.value = selectedValue;
                            console.log(`✅ Restored meal plan selection: ${selectedValue}`);
                        }
                        
                        console.log(`✅ Meal plan dropdown has ${mealPlanSelect.options.length} options now`);
                    }
                    
                } else {
                    console.error('❌ API Error:', data.error);
                    alert(`⚠️ ${data.error}`);
                }
            })
            .catch(error => {
                console.error('❌ Fetch error:', error);
            });
    }

    let inclusionCounter = 0;
    let availableInclusions = [];
    let isLoadingInclusions = false;

    // ✅ Add new inclusion row - EDITED TO USE ITINERARY DATA
    document.getElementById('addInclusionBtn')?.addEventListener('click', function() {
        const hotelId = document.getElementById('modalHotelId')?.value;
        
        if (!hotelId) {
            alert('Please select a hotel first');
            return;
        }
        
        inclusionCounter++;
        const container = document.getElementById('inclusionsContainer');
        
        const noInclusionsMsg = document.getElementById('noInclusionsMessage');
        if (noInclusionsMsg) noInclusionsMsg.style.display = 'none';
        
        const row = document.createElement('div');
        row.className = 'inclusion-row border rounded p-3 mb-3 bg-white';
        row.id = `inclusion-row-${inclusionCounter}`;
        row.dataset.index = inclusionCounter;
        
        row.innerHTML = `
            <div class="row align-items-end">
                <div class="col-md-4">
                    <label class="form-label fw-semibold">Special Inclusion *</label>
                    <select class="form-select inclusion-select" data-index="${inclusionCounter}" required>
                        <option value="">-- Loading... --</option>
                    </select>
                    <small class="text-muted pricing-info" data-index="${inclusionCounter}"></small>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Adults</label>
                    <input type="number" class="form-control inclusion-adults" data-index="${inclusionCounter}" 
                           min="0" max="${itineraryAdults}" value="0">
                    <small class="text-muted">Max: ${itineraryAdults}</small>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Children</label>
                    <input type="number" class="form-control inclusion-children" data-index="${inclusionCounter}" 
                           min="0" max="${itineraryChildren}" value="0">
                    <small class="text-muted">Max: ${itineraryChildren}</small>
                </div>
                <div class="col-md-2">
                    <button type="button" class="btn btn-danger btn-sm w-100" onclick="removeInclusion(${inclusionCounter})">
                        <i class="fas fa-trash"></i> Remove
                    </button>
                </div>
            </div>
            <div class="mt-2 p-2 bg-light rounded">
                <div class="d-flex justify-content-between align-items-center">
                    <small class="text-muted">
                        <i class="fas fa-calculator me-1"></i>Price:
                    </small>
                    <strong class="inclusion-price text-success" data-index="${inclusionCounter}">₹0.00</strong>
                </div>
            </div>
        `;
        
        container.appendChild(row);
        loadInclusionOptionsForRow(inclusionCounter, hotelId);
        
        row.querySelector('.inclusion-select').addEventListener('change', function() {
            updateInclusionInfo(inclusionCounter);
            calculateAllInclusionsPrices();
        });
        row.querySelector('.inclusion-adults').addEventListener('input', calculateAllInclusionsPrices);
        row.querySelector('.inclusion-children').addEventListener('input', calculateAllInclusionsPrices);
        
        const summaryDiv = document.getElementById('inclusionsSummary');
        if (summaryDiv) summaryDiv.style.display = 'block';
        
        console.log(`✅ Added inclusion row ${inclusionCounter}`);
    });
    

    // ✅ Remove inclusion row
    function removeInclusion(index) {
        const row = document.getElementById(`inclusion-row-${index}`);
        if (row) {
            const confirmDelete = confirm('Are you sure you want to remove this inclusion?');
            
            if (confirmDelete) {
                row.remove();
                calculateAllInclusionsPrices();
                
                const remainingRows = document.querySelectorAll('.inclusion-row');
                const noInclusionsMsg = document.getElementById('noInclusionsMessage');
                if (remainingRows.length === 0 && noInclusionsMsg) {
                    noInclusionsMsg.style.display = 'block';
                    const summaryDiv = document.getElementById('inclusionsSummary');
                    if (summaryDiv) summaryDiv.style.display = 'none';
                }
            }
        }
    }

    // ✅ Load options ONCE per row with loading state check
    function loadInclusionOptionsForRow(rowIndex, hotelId) {
        const select = document.querySelector(`.inclusion-select[data-index="${rowIndex}"]`);
        if (!select) {
            console.error(`❌ Select not found for row ${rowIndex}`);
            return;
        }
        
        if (select.dataset.loaded === 'true') {
            console.log(`ℹ️ Options already loaded for row ${rowIndex}`);
            return;
        }
        
        if (select.dataset.loaded === 'loading') {
            console.log(`⏳ Already loading options for row ${rowIndex}`);
            return;
        }
        
        select.dataset.loaded = 'loading';
        console.log(`🔄 Loading options for row ${rowIndex}`);
        
        fetch(`/get-hotel-inclusions/${hotelId}/`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    availableInclusions = data.inclusions;
                    select.innerHTML = '<option value="">-- Select Inclusion --</option>';
                    
                    data.inclusions.forEach(inc => {
                        const option = document.createElement('option');
                        option.value = inc.id;
                        option.textContent = inc.name;
                        option.dataset.adultPrice = inc.adult_price;
                        option.dataset.childPrice = inc.child_price;
                        option.dataset.pricingType = inc.pricing_type;
                        select.appendChild(option);
                    });
                    
                    select.dataset.loaded = 'true';
                    console.log(`✅ Loaded ${data.inclusions.length} options for row ${rowIndex}`);
                } else {
                    select.innerHTML = '<option value="">No inclusions available</option>';
                    select.dataset.loaded = 'error';
                    console.warn(`⚠️ No inclusions for hotel ${hotelId}`);
                }
            })
            .catch(error => {
                console.error(`❌ Error loading inclusions for row ${rowIndex}:`, error);
                select.innerHTML = '<option value="">Error loading inclusions</option>';
                select.dataset.loaded = 'error';
            });
    }

    // ✅ Update inclusion info display
    function updateInclusionInfo(index) {
        const row = document.getElementById(`inclusion-row-${index}`);
        if (!row) return;
        
        const select = row.querySelector('.inclusion-select');
        const infoEl = row.querySelector('.pricing-info');
        
        if (!select.value) {
            infoEl.textContent = '';
            return;
        }
        
        const selectedOption = select.options[select.selectedIndex];
        const pricingType = selectedOption.dataset.pricingType;
        const adultPrice = parseFloat(selectedOption.dataset.adultPrice);
        
        let infoText = '';
        if (pricingType === 'free') {
            infoText = '✅ Free inclusion';
        } else if (pricingType === 'per_person') {
            infoText = `₹${adultPrice}/adult`;
        } else if (pricingType === 'per_booking') {
            infoText = `₹${adultPrice} flat rate`;
        } else if (pricingType === 'per_room') {
            infoText = `₹${adultPrice}/room`;
        }
        
        infoEl.textContent = infoText;
        infoEl.classList.add('text-info');
    }

    // ✅ Calculate prices for all inclusions
    function calculateAllInclusionsPrices() {
        let totalCost = 0;
        let summaryParts = [];
        
        document.querySelectorAll('.inclusion-row').forEach(row => {
            const index = row.dataset.index;
            const selectEl = row.querySelector('.inclusion-select');
            const adultsEl = row.querySelector('.inclusion-adults');
            const childrenEl = row.querySelector('.inclusion-children');
            const priceEl = row.querySelector('.inclusion-price');
            
            if (!selectEl.value) {
                priceEl.textContent = '₹0.00';
                return;
            }
            
            const selectedOption = selectEl.options[selectEl.selectedIndex];
            const adultPrice = parseFloat(selectedOption.dataset.adultPrice) || 0;
            const childPrice = parseFloat(selectedOption.dataset.childPrice) || 0;
            const pricingType = selectedOption.dataset.pricingType;
            const adults = parseInt(adultsEl.value) || 0;
            const children = parseInt(childrenEl.value) || 0;
            
            let itemPrice = 0;
            
            if (pricingType === 'per_person') {
                itemPrice = (adultPrice * adults) + (childPrice * children);
            } else if (pricingType === 'per_booking') {
                itemPrice = adultPrice;
            } else if (pricingType === 'per_room') {
                const numRooms = parseInt(document.getElementById('numDoubleBeds')?.value) || 1;
                itemPrice = adultPrice * numRooms;
            } else if (pricingType === 'free') {
                itemPrice = 0;
            }
            
            priceEl.textContent = `₹${itemPrice.toFixed(2)}`;
            totalCost += itemPrice;
            
            if (itemPrice > 0) {
                const inclusionName = selectedOption.textContent;
                summaryParts.push(`${inclusionName}: ₹${itemPrice.toFixed(2)}`);
            }
        });
        
        const totalCostEl = document.getElementById('totalInclusionCost');
        const summaryTextEl = document.getElementById('inclusionsSummaryText');
        const summaryDiv = document.getElementById('inclusionsSummary');
        
        if (totalCostEl) totalCostEl.textContent = `₹${totalCost.toFixed(2)}`;
        if (summaryTextEl) summaryTextEl.textContent = summaryParts.join(' | ');
        if (summaryDiv) summaryDiv.style.display = totalCost > 0 ? 'block' : 'none';
        
        console.log(`💰 Total inclusions cost: ₹${totalCost.toFixed(2)}`);
    }

    // ==========================================
    // HOUSEBOAT MULTI-INCLUSION MANAGEMENT - EDITED TO USE ITINERARY DATA ✅
    // ==========================================

    let houseboatInclusionCounter = 0;
    let availableHouseboatInclusions = [];

    // ✅ Add new houseboat inclusion row - EDITED TO USE ITINERARY DATA
    document.getElementById('addHouseboatInclusionBtn')?.addEventListener('click', function() {
        const houseboatId = document.getElementById('modalHouseboatId')?.value;
        
        if (!houseboatId) {
            alert('Please select a houseboat first');
            return;
        }
        
        houseboatInclusionCounter++;
        const container = document.getElementById('houseboatInclusionsContainer');
        
        const noInclusionsMsg = document.getElementById('houseboatNoInclusionsMessage');
        if (noInclusionsMsg) noInclusionsMsg.style.display = 'none';
        
        const row = document.createElement('div');
        row.className = 'houseboat-inclusion-row border rounded p-3 mb-3 bg-white';
        row.id = `houseboat-inclusion-row-${houseboatInclusionCounter}`;
        row.dataset.index = houseboatInclusionCounter;
        
        row.innerHTML = `
            <div class="d-flex justify-content-between align-items-start mb-2">
                <h6 class="mb-0 text-primary">
                    <i class="fas fa-gift me-2"></i>Inclusion #${houseboatInclusionCounter}
                </h6>
                <button type="button" class="btn btn-sm btn-danger" onclick="removeHouseboatInclusion(${houseboatInclusionCounter})">
                    <i class="fas fa-trash"></i> Remove
                </button>
            </div>
            <div class="row g-2">
                <div class="col-md-6">
                    <label class="form-label small fw-semibold">Special Inclusion *</label>
                    <select class="form-select form-select-sm houseboat-inclusion-select" data-index="${houseboatInclusionCounter}" required>
                        <option value="">-- Loading... --</option>
                    </select>
                    <small class="text-muted houseboat-pricing-info" data-index="${houseboatInclusionCounter}"></small>
                </div>
                <div class="col-md-3">
                    <label class="form-label small fw-semibold">Adults</label>
                    <input type="number" class="form-control form-control-sm houseboat-inclusion-adults" 
                           data-index="${houseboatInclusionCounter}" value="0" min="0" max="${itineraryAdults}">
                </div>
                <div class="col-md-3">
                    <label class="form-label small fw-semibold">Children</label>
                    <input type="number" class="form-control form-control-sm houseboat-inclusion-children" 
                           data-index="${houseboatInclusionCounter}" value="0" min="0" max="${itineraryChildren}">
                </div>
            </div>
            <div class="mt-2 p-2 bg-light rounded">
                <div class="d-flex justify-content-between align-items-center">
                    <small class="text-muted">
                        <i class="fas fa-calculator me-1"></i>Price:
                    </small>
                    <strong class="text-success houseboat-inclusion-price" data-index="${houseboatInclusionCounter}">₹0.00</strong>
                </div>
            </div>
        `;
        
        container.appendChild(row);
        loadHouseboatInclusionOptionsForRow(houseboatInclusionCounter, houseboatId);
        
        row.querySelector('.houseboat-inclusion-select').addEventListener('change', function() {
            updateHouseboatInclusionInfo(houseboatInclusionCounter);
            calculateAllHouseboatInclusionsPrices();
        });
        row.querySelector('.houseboat-inclusion-adults').addEventListener('input', calculateAllHouseboatInclusionsPrices);
        row.querySelector('.houseboat-inclusion-children').addEventListener('input', calculateAllHouseboatInclusionsPrices);
        
        const summaryDiv = document.getElementById('houseboatInclusionsSummary');
        if (summaryDiv) summaryDiv.style.display = 'block';
        
        console.log(`✅ Added houseboat inclusion row ${houseboatInclusionCounter}`);
    });

    // ✅ Remove houseboat inclusion row
    function removeHouseboatInclusion(index) {
        const row = document.getElementById(`houseboat-inclusion-row-${index}`);
        if (row) {
            const confirmDelete = confirm('Are you sure you want to remove this inclusion?');
            
            if (confirmDelete) {
                row.remove();
                calculateAllHouseboatInclusionsPrices();
                
                const remainingRows = document.querySelectorAll('.houseboat-inclusion-row');
                const noInclusionsMsg = document.getElementById('houseboatNoInclusionsMessage');
                if (remainingRows.length === 0 && noInclusionsMsg) {
                    noInclusionsMsg.style.display = 'block';
                    const summaryDiv = document.getElementById('houseboatInclusionsSummary');
                    if (summaryDiv) summaryDiv.style.display = 'none';
                }
            }
        }
    }

    // ✅ Load houseboat inclusion options for a specific row
    function loadHouseboatInclusionOptionsForRow(rowIndex, houseboatId) {
        const select = document.querySelector(`.houseboat-inclusion-select[data-index="${rowIndex}"]`);
        if (!select) {
            console.error(`❌ Select not found for houseboat row ${rowIndex}`);
            return;
        }
        
        if (select.dataset.loaded === 'true') {
            console.log(`ℹ️ Options already loaded for houseboat row ${rowIndex}`);
            return;
        }
        
        if (select.dataset.loaded === 'loading') {
            console.log(`⏳ Already loading options for houseboat row ${rowIndex}`);
            return;
        }
        
        select.dataset.loaded = 'loading';
        console.log(`🔄 Loading houseboat inclusion options for row ${rowIndex}`);
        
        fetch(`/get-houseboat-inclusions/${houseboatId}/`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    availableHouseboatInclusions = data.inclusions;
                    select.innerHTML = '<option value="">-- Select Inclusion --</option>';
                    
                    data.inclusions.forEach(inc => {
                        const option = document.createElement('option');
                        option.value = inc.id;
                        option.textContent = inc.name;
                        option.dataset.adultPrice = inc.adult_price;
                        option.dataset.childPrice = inc.child_price;
                        option.dataset.pricingType = inc.pricing_type;
                        select.appendChild(option);
                    });
                    
                    select.dataset.loaded = 'true';
                    console.log(`✅ Loaded ${data.inclusions.length} houseboat inclusions for row ${rowIndex}`);
                } else {
                    select.innerHTML = '<option value="">No inclusions available</option>';
                    select.dataset.loaded = 'error';
                    console.warn(`⚠️ No houseboat inclusions for houseboat ${houseboatId}`);
                }
            })
            .catch(error => {
                console.error(`❌ Error loading houseboat inclusions for row ${rowIndex}:`, error);
                select.innerHTML = '<option value="">Error loading inclusions</option>';
                select.dataset.loaded = 'error';
            });
    }

    // ✅ Update houseboat inclusion info display
    function updateHouseboatInclusionInfo(index) {
        const row = document.getElementById(`houseboat-inclusion-row-${index}`);
        if (!row) return;
        
        const select = row.querySelector('.houseboat-inclusion-select');
        const infoEl = row.querySelector('.houseboat-pricing-info');
        
        if (!select.value) {
            infoEl.textContent = '';
            return;
        }
        
        const selectedOption = select.options[select.selectedIndex];
        const pricingType = selectedOption.dataset.pricingType;
        const adultPrice = parseFloat(selectedOption.dataset.adultPrice);
        
        let infoText = '';
        if (pricingType === 'free') {
            infoText = '✅ Free inclusion';
        } else if (pricingType === 'per_person') {
            infoText = `₹${adultPrice}/adult`;
        } else if (pricingType === 'per_booking') {
            infoText = `₹${adultPrice} flat rate`;
        } else if (pricingType === 'per_room') {
            infoText = `₹${adultPrice}/room`;
        }
        
        infoEl.textContent = infoText;
        infoEl.classList.add('text-info');
    }

    // ✅ Calculate prices for all houseboat inclusions
    function calculateAllHouseboatInclusionsPrices() {
        let totalCost = 0;
        let summaryParts = [];
        
        document.querySelectorAll('.houseboat-inclusion-row').forEach(row => {
            const index = row.dataset.index;
            const selectEl = row.querySelector('.houseboat-inclusion-select');
            const adultsEl = row.querySelector('.houseboat-inclusion-adults');
            const childrenEl = row.querySelector('.houseboat-inclusion-children');
            const priceEl = row.querySelector('.houseboat-inclusion-price');
            
            if (!selectEl.value) {
                priceEl.textContent = '₹0.00';
                return;
            }
            
            const selectedOption = selectEl.options[selectEl.selectedIndex];
            const adultPrice = parseFloat(selectedOption.dataset.adultPrice) || 0;
            const childPrice = parseFloat(selectedOption.dataset.childPrice) || 0;
            const pricingType = selectedOption.dataset.pricingType;
            const adults = parseInt(adultsEl.value) || 0;
            const children = parseInt(childrenEl.value) || 0;
            
            let itemPrice = 0;
            
            if (pricingType === 'per_person') {
                itemPrice = (adultPrice * adults) + (childPrice * children);
            } else if (pricingType === 'per_booking') {
                itemPrice = adultPrice;
            } else if (pricingType === 'per_room') {
                let totalRooms = 0;
                document.querySelectorAll('.houseboat-room-input').forEach(input => {
                    totalRooms += parseInt(input.value) || 0;
                });
                itemPrice = adultPrice * (totalRooms || 1);
            } else if (pricingType === 'free') {
                itemPrice = 0;
            }
            
            priceEl.textContent = `₹${itemPrice.toFixed(2)}`;
            totalCost += itemPrice;
            
            if (itemPrice > 0) {
                const inclusionName = selectedOption.textContent;
                summaryParts.push(`${inclusionName}: ₹${itemPrice.toFixed(2)}`);
            }
        });
        
        const totalCostEl = document.getElementById('houseboatTotalInclusionCost');
        const summaryTextEl = document.getElementById('houseboatInclusionsSummaryText');
        const summaryDiv = document.getElementById('houseboatInclusionsSummary');
        
        if (totalCostEl) totalCostEl.textContent = `₹${totalCost.toFixed(2)}`;
        if (summaryTextEl) summaryTextEl.textContent = summaryParts.join(' | ');
        if (summaryDiv) summaryDiv.style.display = totalCost > 0 ? 'block' : 'none';
        
        console.log(`💰 Total houseboat inclusions cost: ₹${totalCost.toFixed(2)}`);
    }

    // ✅ Recalculate when room counts change (for per_room pricing)
    document.querySelectorAll('.houseboat-room-input').forEach(input => {
        input.addEventListener('input', calculateAllHouseboatInclusionsPrices);
        input.addEventListener('change', calculateAllHouseboatInclusionsPrices);
    });

    // ✅ DATE VALIDATION FUNCTIONS
    function validateDateRange(dateInput, dateValue, queryFromDate, queryToDate) {
        if (!queryFromDate || !queryToDate) return true;
        
        const selectedDate = new Date(dateValue);
        const minDate = new Date(queryFromDate);
        const maxDate = new Date(queryToDate);
        
        if (selectedDate < minDate || selectedDate > maxDate) {
            dateInput.setCustomValidity('Date must be within the query date range');
            dateInput.classList.add('is-invalid');
            return false;
        } else {
            dateInput.setCustomValidity('');
            dateInput.classList.remove('is-invalid');
            return true;
        }
    }

    function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
    }

    // ==========================================
    // BULK DELETE CONFIRMATION
    // ==========================================
    function bulkDeleteConfirm(type, dayNumber, count) {
        const typeDisplayMap = {
            'hotels': 'Hotels',
            'activities': 'Activities',
            'vehicles': 'Vehicles',
            'houseboats': 'Houseboats',
            'everything': 'ALL ITEMS'
        };
        
        const typeDisplay = typeDisplayMap[type] || type;
        const message = `Are you sure you want to delete ${typeDisplay.toUpperCase()} (${count} items) from Day ${dayNumber}?\n\nThis action cannot be undone!`;
        
        if (confirm(message)) {
            document.getElementById('deleteType').value = type;
            document.getElementById('deleteDayNumber').value = dayNumber;
            document.getElementById('bulkDeleteForm').submit();
        }
    }

    // ==========================================
    // DOCUMENT READY - INITIALIZE ALL MODALS
    // ==========================================
    document.addEventListener("DOMContentLoaded", function () {
        
        // ==========================================
        // ✅ GET DATA FROM ITINERARY (NOT QUERY) - EDITED
        // ==========================================
        const itineraryFromDateEl = document.getElementById('itineraryTravelFrom');
        const itineraryToDateEl = document.getElementById('itineraryTravelTo');
        const itineraryFromDate = itineraryFromDateEl ? itineraryFromDateEl.value : null;
        const itineraryToDate = itineraryToDateEl ? itineraryToDateEl.value : null;
        
        const itineraryAdults = parseInt(document.getElementById('itineraryDefaultAdults')?.value) || 2;
        const itineraryChildren = parseInt(document.getElementById('itineraryDefaultChildren')?.value) || 0;
        const itineraryInfants = parseInt(document.getElementById('itineraryDefaultInfants')?.value) || 0;
        
        console.log(`📅 ITINERARY Date Range: ${itineraryFromDate} to ${itineraryToDate}`);
        console.log(`👥 ITINERARY Passengers - Adults: ${itineraryAdults}, Children: ${itineraryChildren}, Infants: ${itineraryInfants}`);

        // ✅ SETUP DOUBLE BED INPUT FOR INCLUSION RECALCULATION
        const doubleBedInput = document.getElementById('numDoubleBeds');
        if (doubleBedInput) {
            doubleBedInput.addEventListener('input', calculateAllInclusionsPrices);
            doubleBedInput.addEventListener('change', calculateAllInclusionsPrices);
        }

        // ==========================================
        // HOTEL BOOKING - DATE VALIDATION
        // ==========================================
        const checkinDateInput = document.getElementById('checkinDate');
        const checkoutDateInput = document.getElementById('checkoutDate');
        
        if (checkinDateInput && checkoutDateInput) {
            checkinDateInput.addEventListener('change', function() {
                const checkinDate = this.value;
                
                if (itineraryFromDate && itineraryToDate) {
                    if (!validateDateRange(this, checkinDate, itineraryFromDate, itineraryToDate)) {
                        alert(`Check-in date must be between ${formatDate(itineraryFromDate)} and ${formatDate(itineraryToDate)}`);
                        this.value = '';
                        return;
                    }
                }
                
                if (checkinDate) {
                    checkoutDateInput.min = checkinDate;
                    if (checkoutDateInput.value && checkoutDateInput.value < checkinDate) {
                        checkoutDateInput.value = '';
                    }
                }
            });
            
            checkoutDateInput.addEventListener('change', function() {
                const checkoutDate = this.value;
                const checkinDate = checkinDateInput.value;
                
                if (itineraryFromDate && itineraryToDate) {
                    if (!validateDateRange(this, checkoutDate, itineraryFromDate, itineraryToDate)) {
                        alert(`Check-out date must be between ${formatDate(itineraryFromDate)} and ${formatDate(itineraryToDate)}`);
                        this.value = '';
                        return;
                    }
                }
                
                if (checkinDate && checkoutDate <= checkinDate) {
                    alert('Check-out date must be after check-in date');
                    this.value = '';
                    this.classList.add('is-invalid');
                } else {
                    this.classList.remove('is-invalid');
                }
            });
        }

        // ==========================================
        // HOUSEBOAT BOOKING - DATE VALIDATION
        // ==========================================
        const hbCheckinInput = document.getElementById('houseboatCheckIn');
        const hbCheckoutInput = document.getElementById('houseboatCheckOut');
        
        if (hbCheckinInput && hbCheckoutInput) {
            hbCheckinInput.addEventListener('change', function() {
                const checkinDate = this.value;
                
                if (itineraryFromDate && itineraryToDate) {
                    if (!validateDateRange(this, checkinDate, itineraryFromDate, itineraryToDate)) {
                        alert(`Check-in date must be between ${formatDate(itineraryFromDate)} and ${formatDate(itineraryToDate)}`);
                        this.value = '';
                        return;
                    }
                }
                
                if (checkinDate) {
                    hbCheckoutInput.min = checkinDate;
                    if (hbCheckoutInput.value && hbCheckoutInput.value < checkinDate) {
                        hbCheckoutInput.value = '';
                    }
                }
            });
            
            hbCheckoutInput.addEventListener('change', function() {
                const checkoutDate = this.value;
                const checkinDate = hbCheckinInput.value;
                
                if (itineraryFromDate && itineraryToDate) {
                    if (!validateDateRange(this, checkoutDate, itineraryFromDate, itineraryToDate)) {
                        alert(`Check-out date must be between ${formatDate(itineraryFromDate)} and ${formatDate(itineraryToDate)}`);
                        this.value = '';
                        return;
                    }
                }
                
                if (checkinDate && checkoutDate <= checkinDate) {
                    alert('Check-out date must be after check-in date');
                    this.value = '';
                    this.classList.add('is-invalid');
                } else {
                    this.classList.remove('is-invalid');
                }
            });
        }
        
        // ==========================================
        // EDIT DAY DETAILS MODAL
        // ==========================================
        const editDayDetailsModal = document.getElementById('editDayDetailsModal');
        if (editDayDetailsModal) {
            editDayDetailsModal.addEventListener('show.bs.modal', function (event) {
                const button = event.relatedTarget;
                document.getElementById('editDayNumber').value = button.dataset.dayNumber;
                document.getElementById('dayTitle').value = button.dataset.title || '';
                document.getElementById('dayDescription').value = button.dataset.description || '';
            });
            
            editDayDetailsModal.addEventListener('hidden.bs.modal', function () {
                document.getElementById('editDayNumber').value = '';
                document.getElementById('dayTitle').value = '';
                document.getElementById('dayDescription').value = '';
                document.getElementById('dayImage').value = '';
            });
        }
        
        // ==========================================
        // HOTEL BOOKING MODAL - EDITED ✅
        // ==========================================
        const hotelBookingModal = document.getElementById('hotelBookingModal');
        if (hotelBookingModal) {
            const hotelBookingForm = document.getElementById('hotelBookingForm');
            const hotelBookingTitle = document.getElementById('hotelBookingModalLabel');
            const createUrl = "{% url 'create_hotel_booking' itinerary.id %}";
            const updateUrlTemplate = "{% url 'update_hotel_booking' 0 %}";

            hotelBookingModal.addEventListener('show.bs.modal', function (event) {
                const button = event.relatedTarget;
                const bookingId = button.getAttribute('data-booking-id');
                const hotelId = button.getAttribute('data-hotel-id');

                document.getElementById('modalHotelId').value = hotelId || '';
                document.getElementById('modalDayNumber').value = button.getAttribute('data-day-number') || '';
                document.getElementById('modalHotelName').value = button.getAttribute('data-hotel-name') || '';

                if (bookingId) {
                    // EDIT MODE
                    hotelBookingTitle.textContent = 'Edit Hotel Booking';
                    hotelBookingForm.action = updateUrlTemplate.replace('0', bookingId);
                    document.getElementById('modalBookingId').value = bookingId;
                    
                    document.getElementById('modalDestination').value = button.getAttribute('data-destination-id') || '';
                    document.getElementById('hotelCategory').value = button.getAttribute('data-category') || '';
                    document.getElementById('roomType').value = button.getAttribute('data-room-type-id') || '';
                    document.getElementById('mealPlan').value = button.getAttribute('data-meal-plan-id') || '';
                    document.getElementById('hotelOption').value = button.getAttribute('data-option') || 'option_1';
                    document.getElementById('numDoubleBeds').value = button.getAttribute('data-num-double-beds') || '0';
                    document.getElementById('childWithBed').value = button.getAttribute('data-child-with-bed') || '0';
                    document.getElementById('childWithoutBed').value = button.getAttribute('data-child-without-bed') || '0';
                    document.getElementById('extraBeds').value = button.getAttribute('data-extra-beds') || '0';
                    document.getElementById('checkinDate').value = button.getAttribute('data-check-in-date') || '';
                    document.getElementById('checkinTime').value = button.getAttribute('data-check-in-time') || '';
                    document.getElementById('checkoutDate').value = button.getAttribute('data-check-out-date') || '';
                    document.getElementById('checkoutTime').value = button.getAttribute('data-check-out-time') || '';
                    
                    // ✅ LOAD EXISTING INCLUSIONS - EDITED TO USE ITINERARY DATA
                    const existingInclusionsJson = button.getAttribute('data-inclusions') || '[]';
                    console.log('📦 Loading inclusions:', existingInclusionsJson);
                    
                    try {
                        const existingInclusions = JSON.parse(existingInclusionsJson);
                        
                        // Clear container
                        const container = document.getElementById('inclusionsContainer');
                        container.innerHTML = `
                            <div class="text-center text-muted py-4" id="noInclusionsMessage">
                                <i class="fas fa-info-circle me-2"></i>
                                No inclusions added yet. Click "Add Inclusion" to add special inclusions.
                            </div>
                        `;
                        inclusionCounter = 0;
                        
                        if (existingInclusions && existingInclusions.length > 0) {
                            console.log(`✅ Found ${existingInclusions.length} inclusions to load`);
                            
                            // PRE-FETCH inclusion options ONCE for all rows
                            fetch(`/get-hotel-inclusions/${hotelId}/`)
                                .then(response => response.json())
                                .then(data => {
                                    if (data.success) {
                                        availableInclusions = data.inclusions;
                                        console.log(`✅ Pre-fetched ${data.inclusions.length} inclusion options`);
                                        
                                        // Now add all inclusion rows
                                        existingInclusions.forEach((inc, index) => {
                                            setTimeout(() => {
                                                inclusionCounter++;
                                                const rowIndex = inclusionCounter;
                                                
                                                const noInclusionsMsg = document.getElementById('noInclusionsMessage');
                                                if (noInclusionsMsg) noInclusionsMsg.style.display = 'none';
                                                
                                                const row = document.createElement('div');
                                                row.className = 'inclusion-row border rounded p-3 mb-3 bg-white';
                                                row.id = `inclusion-row-${rowIndex}`;
                                                row.dataset.index = rowIndex;
                                                
                                                row.innerHTML = `
                                                    <div class="row align-items-end">
                                                        <div class="col-md-4">
                                                            <label class="form-label fw-semibold">Special Inclusion *</label>
                                                            <select class="form-select inclusion-select" data-index="${rowIndex}" required>
                                                                <option value="">-- Select Inclusion --</option>
                                                            </select>
                                                            <small class="text-muted pricing-info" data-index="${rowIndex}"></small>
                                                        </div>
                                                        <div class="col-md-3">
                                                            <label class="form-label">Adults</label>
                                                            <input type="number" class="form-control inclusion-adults" data-index="${rowIndex}" 
                                                                min="0" max="${itineraryAdults}" value="${inc.adults || 0}">
                                                            <small class="text-muted">Max: ${itineraryAdults}</small>
                                                        </div>
                                                        <div class="col-md-3">
                                                            <label class="form-label">Children</label>
                                                            <input type="number" class="form-control inclusion-children" data-index="${rowIndex}" 
                                                                min="0" max="${itineraryChildren}" value="${inc.children || 0}">
                                                            <small class="text-muted">Max: ${itineraryChildren}</small>
                                                        </div>
                                                        <div class="col-md-2">
                                                            <button type="button" class="btn btn-danger btn-sm w-100" onclick="removeInclusion(${rowIndex})">
                                                                <i class="fas fa-trash"></i> Remove
                                                            </button>
                                                        </div>
                                                    </div>
                                                    <div class="mt-2 p-2 bg-light rounded">
                                                        <div class="d-flex justify-content-between align-items-center">
                                                            <small class="text-muted">
                                                                <i class="fas fa-calculator me-1"></i>Price:
                                                            </small>
                                                            <strong class="inclusion-price text-success" data-index="${rowIndex}">₹0.00</strong>
                                                        </div>
                                                    </div>
                                                `;
                                                
                                                container.appendChild(row);
                                                
                                                // Populate select options
                                                const select = row.querySelector('.inclusion-select');
                                                data.inclusions.forEach(option => {
                                                    const opt = document.createElement('option');
                                                    opt.value = option.id;
                                                    opt.textContent = option.name;
                                                    opt.dataset.adultPrice = option.adult_price;
                                                    opt.dataset.childPrice = option.child_price;
                                                    opt.dataset.pricingType = option.pricing_type;
                                                    select.appendChild(opt);
                                                });
                                                
                                                select.value = inc.id;
                                                select.dataset.loaded = 'true';
                                                
                                                // Add event listeners
                                                select.addEventListener('change', function() {
                                                    updateInclusionInfo(rowIndex);
                                                    calculateAllInclusionsPrices();
                                                });
                                                row.querySelector('.inclusion-adults').addEventListener('input', calculateAllInclusionsPrices);
                                                row.querySelector('.inclusion-children').addEventListener('input', calculateAllInclusionsPrices);
                                                
                                                updateInclusionInfo(rowIndex);
                                                calculateAllInclusionsPrices();
                                                
                                                if (index === existingInclusions.length - 1) {
                                                    const summaryDiv = document.getElementById('inclusionsSummary');
                                                    if (summaryDiv) summaryDiv.style.display = 'block';
                                                }
                                            }, index * 100);
                                        });
                                    }
                                })
                                .catch(error => {
                                    console.error('❌ Error pre-fetching inclusions:', error);
                                });
                        }
                    } catch (e) {
                        console.error('❌ Error parsing existing inclusions:', e);
                    }
                    
                } else {
                    // CREATE MODE
                    hotelBookingTitle.textContent = 'Create Hotel Booking';
                    hotelBookingForm.action = createUrl;
                    document.getElementById('modalBookingId').value = '';
                    hotelBookingForm.reset();
                    
                    document.getElementById('modalHotelId').value = hotelId || '';
                    document.getElementById('modalDayNumber').value = button.getAttribute('data-day-number') || '';
                    document.getElementById('modalHotelName').value = button.getAttribute('data-hotel-name') || '';
                    document.getElementById('modalDestination').value = button.getAttribute('data-destination-id') || '';
                    
                    if (itineraryFromDate) document.getElementById('checkinDate').value = itineraryFromDate;
                    if (itineraryToDate) document.getElementById('checkoutDate').value = itineraryToDate;
                    
                    document.getElementById('checkinTime').value = '14:00';
                    document.getElementById('checkoutTime').value = '11:00';
                    document.getElementById('hotelOption').value = 'option_1';
                    
                    // Clear inclusions
                    const container = document.getElementById('inclusionsContainer');
                    if (container) {
                        container.innerHTML = `
                            <div class="text-center text-muted py-4" id="noInclusionsMessage">
                                <i class="fas fa-info-circle me-2"></i>
                                No inclusions added yet. Click "Add Inclusion" to add special inclusions.
                            </div>
                        `;
                    }
                    inclusionCounter = 0;
                }
            });

            // ✅ CLEAN UP ON MODAL CLOSE
            hotelBookingModal.addEventListener('hidden.bs.modal', function () {
                hotelBookingTitle.textContent = 'Hotel Booking Details';
                hotelBookingForm.reset();
                hotelBookingForm.action = createUrl;
                document.getElementById('modalBookingId').value = '';
                
                const container = document.getElementById('inclusionsContainer');
                if (container) {
                    container.querySelectorAll('.inclusion-row').forEach(row => row.remove());
                    container.innerHTML = `
                        <div class="text-center text-muted py-4" id="noInclusionsMessage">
                            <i class="fas fa-info-circle me-2"></i>
                            No inclusions added yet.
                        </div>
                    `;
                }
                
                const summaryDiv = document.getElementById('inclusionsSummary');
                if (summaryDiv) summaryDiv.style.display = 'none';
                
                inclusionCounter = 0;
                console.log('🧹 Modal cleaned up');
            });

            // ✅ FORM SUBMISSION - Collect inclusions data
            hotelBookingForm.addEventListener('submit', function(e) {
                const inclusionsData = [];
                document.querySelectorAll('.inclusion-row').forEach(row => {
                    const selectEl = row.querySelector('.inclusion-select');
                    const adultsEl = row.querySelector('.inclusion-adults');
                    const childrenEl = row.querySelector('.inclusion-children');
                    
                    if (selectEl.value && (adultsEl.value > 0 || childrenEl.value > 0)) {
                        inclusionsData.push({
                            id: parseInt(selectEl.value),
                            adults: parseInt(adultsEl.value) || 0,
                            children: parseInt(childrenEl.value) || 0
                        });
                    }
                });
                
                document.getElementById('inclusionsData').value = JSON.stringify(inclusionsData);
                console.log('📦 Submitting inclusions:', inclusionsData);
            });
        }

        // ==========================================
        // ACTIVITY BOOKING MODAL
        // ==========================================
        const activityBookingModal = document.getElementById('activityBookingModal');
        if (activityBookingModal) {
            const form = activityBookingModal.querySelector('form');
            const title = document.getElementById('activityBookingModalLabel');
            const activityNameSpan = document.getElementById('modalActivityName');
            const editUrlPrototype = activityBookingModal.getAttribute('data-url-edit-prototype');
            const createUrl = "{% url 'create_activity_booking' itinerary.id %}";

            activityBookingModal.addEventListener('show.bs.modal', function (event) {
                const button = event.relatedTarget;
                const bookingId = button.getAttribute('data-booking-id');

                form.querySelector('[name="day_number"]').value = button.getAttribute('data-day-number');
                form.querySelector('[name="activity_id"]').value = button.getAttribute('data-activity-id');
                activityNameSpan.textContent = button.getAttribute('data-activity-name');
                
                if (bookingId) {
                    title.textContent = 'Edit Activity Booking';
                    form.action = editUrlPrototype.replace('9999', bookingId);

                    form.querySelector('[name="booking_date"]').value = button.getAttribute('data-booking-date');
                    form.querySelector('[name="booking_time"]').value = button.getAttribute('data-booking-time');
                    form.querySelector('[name="num_adults"]').value = button.getAttribute('data-num-adults');
                    form.querySelector('[name="num_children"]').value = button.getAttribute('data-num-children');
                    form.querySelector('[name="notes"]').value = button.getAttribute('data-notes');
                } else {
                    title.textContent = 'Add Activity Booking';
                    form.action = createUrl;
                    form.reset();
                }
            });

            activityBookingModal.addEventListener('hidden.bs.modal', function () {
                form.reset();
                title.textContent = 'Book Activity';
            });
        }
        
        // ==========================================
        // VEHICLE BOOKING MODAL
        // ==========================================
        const vehicleBookingModal = document.getElementById('bookVehicleModal');
        if (vehicleBookingModal) {
            const vehicleBookingForm = vehicleBookingModal.querySelector('form');
            const vehicleBookingTitle = document.getElementById('vehicleBookingModalLabel');
            const vehicleNameSpan = document.getElementById('modalVehicleName');
            const editUrlPrototype = vehicleBookingModal.getAttribute('data-url-edit-prototype');
            const createUrl = "{% url 'create_vehicle_booking' itinerary.id %}";

            vehicleBookingModal.addEventListener('show.bs.modal', function (event) {
                const button = event.relatedTarget;
                const bookingId = button.getAttribute('data-booking-id');

                vehicleBookingForm.querySelector('[name="vehicle_id"]').value = button.getAttribute('data-vehicle-id');
                vehicleBookingForm.querySelector('[name="day_number"]').value = button.getAttribute('data-day-number');
                vehicleBookingForm.querySelector('[name="destination_id"]').value = button.getAttribute('data-destination-id');
                vehicleNameSpan.textContent = button.getAttribute('data-vehicle-name');

                if (bookingId) {
                    vehicleBookingTitle.textContent = 'Edit Vehicle Booking';
                    vehicleBookingForm.action = editUrlPrototype.replace('9999', bookingId);
                    
                    vehicleBookingForm.querySelector('[name="pickup_date"]').value = button.getAttribute('data-pickup-date');
                    vehicleBookingForm.querySelector('[name="pickup_time"]').value = button.getAttribute('data-pickup-time');
                    vehicleBookingForm.querySelector('[name="num_passengers"]').value = button.getAttribute('data-num-passengers');
                    vehicleBookingForm.querySelector('[name="vehicle_type"]').value = button.getAttribute('data-vehicle-type');
                    vehicleBookingForm.querySelector('[name="option"]').value = button.getAttribute('data-option');
                    vehicleBookingForm.querySelector('[name="total_km"]').value = button.getAttribute('data-total-km');
                } else {
                    vehicleBookingTitle.textContent = 'Book Vehicle';
                    vehicleBookingForm.action = createUrl;
                    vehicleBookingForm.reset();
                    
                    const today = new Date().toISOString().split('T')[0];
                    vehicleBookingForm.querySelector('[name="pickup_date"]').value = today;
                    vehicleBookingForm.querySelector('[name="num_passengers"]').value = '1';
                }
            });

            vehicleBookingModal.addEventListener('hidden.bs.modal', function () {
                vehicleBookingTitle.textContent = 'Book Vehicle';
                vehicleBookingForm.reset();
                vehicleBookingForm.action = createUrl;
            });
        }

        // ==========================================
        // ✅ STANDALONE INCLUSION BOOKING MODAL (WITHOUT MARKUP)
        // ==========================================
        const standaloneModal = document.getElementById('standaloneInclusionModal');
        if (standaloneModal) {
            const form = document.getElementById('standaloneInclusionForm');
            const modalTitle = document.getElementById('standaloneInclusionModalLabel');
            const editUrlPrototype = standaloneModal.getAttribute('data-url-edit-prototype');
            const createUrl = "{% url 'create_standalone_inclusion' itinerary.id %}";
            
            // Store inclusion pricing data
            let currentInclusionPricing = {
                adultPrice: 0,
                childPrice: 0,
                pricingType: 'per_person'
            };
            
            standaloneModal.addEventListener('show.bs.modal', function (event) {
                const button = event.relatedTarget;
                const bookingId = button.getAttribute('data-booking-id');
                const inclusionId = button.getAttribute('data-inclusion-id');
                const inclusionName = button.getAttribute('data-inclusion-name');
                const dayNumber = button.getAttribute('data-day-number');
                
                // Set common fields
                document.getElementById('standaloneInclusionId').value = inclusionId;
                document.getElementById('standaloneDayNumber').value = dayNumber;
                document.getElementById('standaloneInclusionName').textContent = inclusionName;
                
                if (bookingId) {
                    // EDIT MODE
                    modalTitle.innerHTML = '<i class="fas fa-edit me-2"></i>Edit Standalone Booking';
                    form.action = editUrlPrototype.replace('9999', bookingId);
                    document.getElementById('standaloneBookingId').value = bookingId;
                    
                    // Populate fields
                    document.getElementById('standaloneBookingDate').value = button.getAttribute('data-booking-date');
                    document.getElementById('standaloneBookingTime').value = button.getAttribute('data-booking-time') || '';
                    document.getElementById('standaloneNumAdults').value = button.getAttribute('data-num-adults');
                    document.getElementById('standaloneNumChildren').value = button.getAttribute('data-num-children');
                    document.getElementById('standaloneNotes').value = button.getAttribute('data-notes') || '';
                    
                    // Load pricing and calculate
                    currentInclusionPricing.adultPrice = parseFloat(button.getAttribute('data-adult-price') || 0);
                    currentInclusionPricing.childPrice = parseFloat(button.getAttribute('data-child-price') || 0);
                    
                    calculateStandalonePrice();
                } else {
                    // CREATE MODE
                    modalTitle.innerHTML = '<i class="fas fa-mountain me-2"></i>Book Standalone Activity/Service';
                    form.action = createUrl;
                    document.getElementById('standaloneBookingId').value = '';
                    form.reset();
                    
                    // Set defaults
                    document.getElementById('standaloneNumAdults').value = '1';
                    document.getElementById('standaloneNumChildren').value = '0';
                    
                    // Load pricing from button
                    currentInclusionPricing.adultPrice = parseFloat(button.getAttribute('data-adult-price') || 0);
                    currentInclusionPricing.childPrice = parseFloat(button.getAttribute('data-child-price') || 0);
                    
                    calculateStandalonePrice();
                }
            });
            
            // Reset on close
            standaloneModal.addEventListener('hidden.bs.modal', function () {
                form.reset();
                document.getElementById('standalonePricingInfo').style.display = 'none';
            });
            
            // ✅ CALCULATE FUNCTION (NO MARKUP)
            window.calculateStandalonePrice = function() {
                const numAdults = parseInt(document.getElementById('standaloneNumAdults').value) || 0;
                const numChildren = parseInt(document.getElementById('standaloneNumChildren').value) || 0;
                
                const adultPrice = currentInclusionPricing.adultPrice;
                const childPrice = currentInclusionPricing.childPrice;
                
                // Calculate totals
                const adultTotal = numAdults * adultPrice;
                const childTotal = numChildren * childPrice;
                const total = adultTotal + childTotal;
                
                // Update UI
                document.getElementById('adultCount').textContent = numAdults;
                document.getElementById('adultUnitPrice').textContent = adultPrice.toFixed(2);
                document.getElementById('adultTotal').textContent = adultTotal.toFixed(2);
                
                document.getElementById('childCount').textContent = numChildren;
                document.getElementById('childUnitPrice').textContent = childPrice.toFixed(2);
                document.getElementById('childTotal').textContent = childTotal.toFixed(2);
                
                document.getElementById('totalAmount').textContent = total.toFixed(2);
                
                // Show pricing section
                document.getElementById('standalonePricingInfo').style.display = 'block';
            };
        }

        // ==========================================
        // HOUSEBOAT BOOKING MODAL - EDITED ✅
        // ==========================================
        const houseboatModal = document.getElementById('houseboatBookingModal');
        if (houseboatModal) {
            const modalTitle = document.getElementById('houseboatBookingModalLabel');
            const houseboatForm = document.getElementById('houseboatBookingForm');
            const editUrlPrototype = houseboatModal.getAttribute('data-url-edit-prototype');
            const createUrl = "{% url 'create_houseboat_booking' itinerary.id %}";

            houseboatModal.addEventListener('show.bs.modal', function (event) {
                const button = event.relatedTarget;
                const bookingId = button.getAttribute('data-booking-id');
                const houseboatId = button.getAttribute('data-houseboat-id');

                // Set common fields
                document.getElementById('modalHouseboatId').value = houseboatId || '';
                document.getElementById('house_boat_modalDayNumber').value = button.getAttribute('data-day-number') || '';
                document.getElementById('modalHouseboatName').textContent = button.getAttribute('data-houseboat-name') || '';

                if (bookingId) { 
                    // ✅ EDIT MODE
                    modalTitle.innerHTML = '<i class="fas fa-ship me-2"></i>Edit Houseboat Booking';
                    houseboatForm.action = editUrlPrototype.replace('9999', bookingId);

                    // Populate form fields
                    houseboatForm.querySelector('[name="meal_plan"]').value = button.getAttribute('data-meal-plan-id') || '';
                    houseboatForm.querySelector('[name="room_type"]').value = button.getAttribute('data-room-type-id') || '';
                    houseboatForm.querySelector('[name="check_in_date"]').value = button.getAttribute('data-check-in-date');
                    houseboatForm.querySelector('[name="check_out_date"]').value = button.getAttribute('data-check-out-date');
                    houseboatForm.querySelector('[name="num_one_bed_rooms"]').value = button.getAttribute('data-num-one-bed-rooms');
                    houseboatForm.querySelector('[name="num_two_bed_rooms"]').value = button.getAttribute('data-num-two-bed-rooms');
                    houseboatForm.querySelector('[name="num_three_bed_rooms"]').value = button.getAttribute('data-num-three-bed-rooms');
                    houseboatForm.querySelector('[name="num_four_bed_rooms"]').value = button.getAttribute('data-num-four-bed-rooms');
                    houseboatForm.querySelector('[name="num_five_bed_rooms"]').value = button.getAttribute('data-num-five-bed-rooms');
                    houseboatForm.querySelector('[name="num_six_bed_rooms"]').value = button.getAttribute('data-num-six-bed-rooms');
                    houseboatForm.querySelector('[name="num_seven_bed_rooms"]').value = button.getAttribute('data-num-seven-bed-rooms');
                    houseboatForm.querySelector('[name="num_eight_bed_rooms"]').value = button.getAttribute('data-num-eight-bed-rooms');
                    houseboatForm.querySelector('[name="num_nine_bed_rooms"]').value = button.getAttribute('data-num-nine-bed-rooms');
                    houseboatForm.querySelector('[name="num_ten_bed_rooms"]').value = button.getAttribute('data-num-ten-bed-rooms');
                    houseboatForm.querySelector('[name="num_extra_beds"]').value = button.getAttribute('data-num-extra-beds');
                    
                    // ✅ NEW: Load valid room types and meal plans for edit mode
                    const checkInDate = button.getAttribute('data-check-in-date');
                    const checkOutDate = button.getAttribute('data-check-out-date');
                    if (houseboatId && checkInDate && checkOutDate) {
                        loadValidHouseboatOptions(houseboatId, checkInDate, checkOutDate);
                    }
                    
                    // ✅ LOAD EXISTING INCLUSIONS - EDITED TO USE ITINERARY DATA
                    const existingInclusionsJson = button.getAttribute('data-inclusions') || '[]';
                    console.log('📦 Loading houseboat inclusions:', existingInclusionsJson);
                    
                    try {
                        const existingInclusions = JSON.parse(existingInclusionsJson);
                        
                        // Clear container
                        const container = document.getElementById('houseboatInclusionsContainer');
                        container.innerHTML = `
                            <div class="text-center text-muted py-4" id="houseboatNoInclusionsMessage">
                                <i class="fas fa-info-circle me-2"></i>
                                No inclusions added yet.
                            </div>
                        `;
                        houseboatInclusionCounter = 0;
                        
                        if (existingInclusions && existingInclusions.length > 0) {
                            console.log(`✅ Found ${existingInclusions.length} houseboat inclusions to load`);
                            
                            // Load each inclusion with a slight delay
                            existingInclusions.forEach((inc, index) => {
                                setTimeout(() => {
                                    // Trigger add button programmatically
                                    document.getElementById('addHouseboatInclusionBtn').click();
                                    
                                    // Wait for row to be added, then populate
                                    setTimeout(() => {
                                        const latestRow = document.querySelector(`.houseboat-inclusion-row:last-child`);
                                        if (latestRow) {
                                            const select = latestRow.querySelector('.houseboat-inclusion-select');
                                            const adultsInput = latestRow.querySelector('.houseboat-inclusion-adults');
                                            const childrenInput = latestRow.querySelector('.houseboat-inclusion-children');
                                            
                                            select.value = inc.id;
                                            adultsInput.value = inc.adults || 0;
                                            childrenInput.value = inc.children || 0;
                                            
                                            updateHouseboatInclusionInfo(houseboatInclusionCounter);
                                            calculateAllHouseboatInclusionsPrices();
                                        }
                                    }, 200);
                                }, index * 300);
                            });
                        }
                    } catch (e) {
                        console.error('❌ Error parsing houseboat inclusions:', e);
                    }
                    
                } else { 
                    // ✅ CREATE MODE
                    modalTitle.innerHTML = '<i class="fas fa-ship me-2"></i>Add Houseboat Booking';
                    houseboatForm.action = createUrl;
                    
                    houseboatForm.reset();

                    document.getElementById('modalHouseboatId').value = houseboatId || '';
                    document.getElementById('house_boat_modalDayNumber').value = button.getAttribute('data-day-number') || '';
                    document.getElementById('modalHouseboatName').textContent = button.getAttribute('data-houseboat-name') || '';
                    
                    // Set default dates if available - EDITED TO USE ITINERARY
                    if (itineraryFromDate) houseboatForm.querySelector('[name="check_in_date"]').value = itineraryFromDate;
                    if (itineraryToDate) houseboatForm.querySelector('[name="check_out_date"]').value = itineraryToDate;
                    
                    // ✅ NEW: Load valid room types and meal plans for create mode - EDITED
                    if (houseboatId && itineraryFromDate && itineraryToDate) {
                        loadValidHouseboatOptions(houseboatId, itineraryFromDate, itineraryToDate);
                    }
                    
                    // Clear inclusions
                    const container = document.getElementById('houseboatInclusionsContainer');
                    if (container) {
                        container.innerHTML = `
                            <div class="text-center text-muted py-4" id="houseboatNoInclusionsMessage">
                                <i class="fas fa-info-circle me-2"></i>
                                No inclusions added yet.
                            </div>
                        `;
                    }
                    houseboatInclusionCounter = 0;
                    
                    const summaryDiv = document.getElementById('houseboatInclusionsSummary');
                    if (summaryDiv) summaryDiv.style.display = 'none';
                }
            });

            // ✅ CLEAN UP ON MODAL CLOSE
            houseboatModal.addEventListener('hidden.bs.modal', function () {
                modalTitle.innerHTML = '<i class="fas fa-ship me-2"></i>Book Houseboat';
                houseboatForm.reset();
                houseboatForm.action = createUrl;
                
                const container = document.getElementById('houseboatInclusionsContainer');
                if (container) {
                    container.querySelectorAll('.houseboat-inclusion-row').forEach(row => row.remove());
                    container.innerHTML = `
                        <div class="text-center text-muted py-4" id="houseboatNoInclusionsMessage">
                            <i class="fas fa-info-circle me-2"></i>
                            No inclusions added yet.
                        </div>
                    `;
                }
                
                const summaryDiv = document.getElementById('houseboatInclusionsSummary');
                if (summaryDiv) summaryDiv.style.display = 'none';
                
                houseboatInclusionCounter = 0;
                console.log('🧹 Houseboat modal cleaned up');
            });

            // ✅ FORM SUBMISSION - Collect inclusions data
            houseboatForm.addEventListener('submit', function(e) {
                const inclusionsData = [];
                document.querySelectorAll('.houseboat-inclusion-row').forEach(row => {
                    const selectEl = row.querySelector('.houseboat-inclusion-select');
                    const adultsEl = row.querySelector('.houseboat-inclusion-adults');
                    const childrenEl = row.querySelector('.houseboat-inclusion-children');
                    
                    if (selectEl.value && (adultsEl.value > 0 || childrenEl.value > 0)) {
                        inclusionsData.push({
                            id: parseInt(selectEl.value),
                            adults: parseInt(adultsEl.value) || 0,
                            children: parseInt(childrenEl.value) || 0
                        });
                    }
                });
                
                document.getElementById('houseboatInclusionsData').value = JSON.stringify(inclusionsData);
                console.log('📦 Submitting houseboat inclusions:', inclusionsData);
            });
        }

    });

// ==========================================
// PREVENT MODAL CLOSE IF FORM IS DIRTY (has unsaved changes)
// ==========================================

// Track if user has made changes
let hotelFormDirty = false;
let houseboatFormDirty = false;
let vehicleFormDirty = false;
let activityFormDirty = false;

// ✅ HOTEL BOOKING MODAL - Prevent accidental close
const hotelBookingModal = document.getElementById('hotelBookingModal');
if (hotelBookingModal) {
    const hotelBookingForm = document.getElementById('hotelBookingForm');
    
    // Track changes
    hotelBookingForm.addEventListener('input', function() {
        hotelFormDirty = true;
    });
    
    hotelBookingForm.addEventListener('change', function() {
        hotelFormDirty = true;
    });
    
    // Reset on successful submit
    hotelBookingForm.addEventListener('submit', function() {
        hotelFormDirty = false;
    });
    
    // Prevent close if dirty
    hotelBookingModal.addEventListener('hide.bs.modal', function(e) {
        if (hotelFormDirty) {
            const confirmClose = confirm('You have unsaved changes. Are you sure you want to close?');
            if (!confirmClose) {
                e.preventDefault();
                e.stopPropagation();
                return false;
            }
        }
        hotelFormDirty = false; // Reset
    });
}

// ✅ HOUSEBOAT BOOKING MODAL - Prevent accidental close
const houseboatModal = document.getElementById('houseboatBookingModal');
if (houseboatModal) {
    const houseboatForm = document.getElementById('houseboatBookingForm');
    
    // Track changes
    houseboatForm.addEventListener('input', function() {
        houseboatFormDirty = true;
    });
    
    houseboatForm.addEventListener('change', function() {
        houseboatFormDirty = true;
    });
    
    // Reset on successful submit
    houseboatForm.addEventListener('submit', function() {
        houseboatFormDirty = false;
    });
    
    // Prevent close if dirty
    houseboatModal.addEventListener('hide.bs.modal', function(e) {
        if (houseboatFormDirty) {
            const confirmClose = confirm('You have unsaved changes. Are you sure you want to close?');
            if (!confirmClose) {
                e.preventDefault();
                e.stopPropagation();
                return false;
            }
        }
        houseboatFormDirty = false; // Reset
    });
}

// ✅ VEHICLE BOOKING MODAL - Prevent accidental close
const vehicleModal = document.getElementById('bookVehicleModal');
if (vehicleModal) {
    const vehicleForm = vehicleModal.querySelector('form');
    
    // Track changes
    vehicleForm.addEventListener('input', function() {
        vehicleFormDirty = true;
    });
    
    vehicleForm.addEventListener('change', function() {
        vehicleFormDirty = true;
    });
    
    // Reset on successful submit
    vehicleForm.addEventListener('submit', function() {
        vehicleFormDirty = false;
    });
    
    // Prevent close if dirty
    vehicleModal.addEventListener('hide.bs.modal', function(e) {
        if (vehicleFormDirty) {
            const confirmClose = confirm('You have unsaved changes. Are you sure you want to close?');
            if (!confirmClose) {
                e.preventDefault();
                e.stopPropagation();
                return false;
            }
        }
        vehicleFormDirty = false; // Reset
    });
}

// ✅ ACTIVITY BOOKING MODAL - Prevent accidental close
const activityModal = document.getElementById('activityBookingModal');
if (activityModal) {
    const activityForm = activityModal.querySelector('form');
    
    // Track changes
    activityForm.addEventListener('input', function() {
        activityFormDirty = true;
    });
    
    activityForm.addEventListener('change', function() {
        activityFormDirty = true;
    });
    
    // Reset on successful submit
    activityForm.addEventListener('submit', function() {
        activityFormDirty = false;
    });
    
    // Prevent close if dirty
    activityModal.addEventListener('hide.bs.modal', function(e) {
        if (activityFormDirty) {
            const confirmClose = confirm('You have unsaved changes. Are you sure you want to close?');
            if (!confirmClose) {
                e.preventDefault();
                e.stopPropagation();
                return false;
            }
        }
        activityFormDirty = false; // Reset
    });
}

console.log('✅ Modal close prevention initialized');
</script>







{% endblock %}