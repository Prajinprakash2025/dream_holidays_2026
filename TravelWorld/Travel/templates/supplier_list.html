{% extends 'base.html' %}
{% load static %}

{% block content %}

<style>
/* ===== Neutral, professional ERP theme ===== */
:root{
  --bg: #f5f7fb;
  --card: #ffffff;
  --muted: #6b7280;
  --border: #e6e9ef;
  --accent: #0d6efd;
  --danger: #d9534f;
  --success: #28a745;
  --warning: #f0ad4e;
}

/* Layout */
.container-suppliers {
  margin-top: 80px;
  padding: 1.25rem 1.5rem;
  background: var(--bg);
  min-height: calc(100vh - 100px);
  color: #111827;
  font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
}

/* Back button */
.back-button-container {
  margin-bottom: 0.75rem;
}
.back-btn-modern {
  border-radius: 8px;
  padding: .5rem .85rem;
  display: inline-flex;
  align-items: center;
  gap: .5rem;
  border: 1px solid var(--border);
  background: var(--card);
  color: var(--muted);
}
.back-btn-modern:hover {
  background: #f3f4f6;
  color: #0b5ed7;
  transform: none;
}

/* Header */
.suppliers-header {
  background: linear-gradient(180deg, rgba(13,110,253,0.03), rgba(13,110,253,0.01));
  padding: 1rem 1rem;
  border-radius: 10px;
  margin-bottom: 1rem;
  border: 1px solid var(--border);
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.suppliers-header h2 { margin:0; color: #0b5ed7; font-weight: 600; font-size: 1.125rem; }
.suppliers-header p { margin:0; color: var(--muted); font-size: .95rem; }

/* Stats cards */
.row.g-3 > .col-md-3 .stats-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 1rem;
  text-align: center;
}
.stats-card .icon {
  width: 52px;
  height: 52px;
  border-radius: 50%;
  display:flex;
  align-items:center;
  justify-content:center;
  margin: 0 auto .6rem;
  font-size: 20px;
}

/* Search / filter bar */
.search-filter-bar {
  background: var(--card);
  padding: .9rem;
  border-radius: 10px;
  border: 1px solid var(--border);
  margin-bottom: 1rem;
}

/* Table card */
.modern-table {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 10px;
  overflow: hidden;
}

/* Table headings */
.modern-table thead th {
  background: transparent;
  border-bottom: 1px solid var(--border);
  padding: .9rem .85rem;
  font-size: .85rem;
  font-weight: 600;
  color: #111827;
  text-transform: none;
}

/* Table rows */
.modern-table tbody td {
  padding: .85rem .85rem;
  vertical-align: middle;
  border-bottom: 1px solid var(--border);
  font-size: .95rem;
}
.modern-table tbody tr:hover {
  background: #fbfcfd;
  transform: none;
}

/* Serial number */
.serial-number {
  display:inline-flex;
  align-items:center;
  justify-content:center;
  width:36px;
  height:36px;
  border-radius:6px;
  background: #f8fafc;
  color: #111827;
  border: 1px solid var(--border);
  font-weight:600;
}

/* Avatar */
.avatar-circle {
  width:40px; height:40px; border-radius:50%;
  display:flex; align-items:center; justify-content:center;
  color:white; font-weight:700;
}

/* Badges */
.badge-modern {
  padding: .35rem .6rem;
  border-radius: 6px;
  font-weight:600;
  font-size: .82rem;
  display:inline-flex;
  align-items:center;
  gap:.45rem;
}

/* Actions group (buttons) */
.action-btn-group {
  display:flex;
  gap:.5rem;
  justify-content:center;
  align-items:center;
}
.action-btn {
  padding: .45rem .55rem;
  border-radius: 8px;
  border: 1px solid var(--border);
  background: white;
  color: #111827;
  font-size: 13px;
}
.action-btn:hover { background: #f8fafc; transform:none; }

/* Pagination */
.pagination-container {
  margin-top: 1rem;
  display:flex;
  gap:1rem;
  justify-content:space-between;
  align-items:center;
}
.pagination-modern {
  display:inline-flex;
  gap:.4rem;
  list-style:none;
  padding:0;
  margin:0;
  align-items:center;
}
.page-link-modern {
  padding: .45rem .7rem;
  border-radius:8px;
  border: 1px solid var(--border);
  background: white;
  color: #111827;
  font-weight:600;
  text-decoration:none;
  display:inline-flex;
  align-items:center;
  gap:.5rem;
}
.page-item-modern.active .page-link-modern {
  background: var(--accent);
  color:white;
  border-color: var(--accent);
}
.page-item-modern.disabled .page-link-modern {
  opacity:.6;
  cursor:not-allowed;
}

/* Modal header */
.modal-header-gradient {
  background: linear-gradient(180deg, rgba(13,110,253,0.03), rgba(13,110,253,0.01));
  color: #0b5ed7;
  border-bottom:1px solid var(--border);
}

/* Form section title */
.form-section-title {
  color: #0b5ed7;
  font-weight:600;
  padding-bottom:.35rem;
  margin-bottom:.8rem;
  border-bottom: 1px dashed #e9eef8;
}

/* Responsive tweaks */
@media (max-width: 768px) {
  .suppliers-header { flex-direction:column; align-items:flex-start; gap:.75rem; }
  .action-btn-group { gap:.35rem; }
  .avatar-circle { width:34px; height:34px; font-size:.9rem; }
  .serial-number { width:30px; height:30px; font-size:.9rem; }
}
</style>

<!-- Back Button -->
<div class="back-button-container">
    <a href="{% url 'admin_settings' %}" class="back-btn-modern">
        <i class="fas fa-arrow-left"></i>
        <span>Back to Admin Settings</span>
    </a>
</div>

<div class="container-fluid container-suppliers">

  <!-- Header -->
  <div class="suppliers-header">
    <div>
      <h2><i class="fas fa-truck me-2"></i> Suppliers Management</h2>
      <p>Manage all your travel service suppliers</p>
    </div>

    {% if user_type == 'superuser' or current_user.role == 'admin' or current_user.permissions.can_add_supplier %}
    <div>
      <button type="button" class="btn btn-light" 
              data-bs-toggle="modal" 
              data-bs-target="#supplierModal" 
              onclick="resetSupplierForm()">
        <i class="fas fa-plus-circle me-2"></i>Add Supplier
      </button>
    </div>
    {% endif %}
  </div>

  <!-- Stats Cards -->
  <div class="row g-3 mb-4">
    <div class="col-md-3">
      <div class="stats-card">
        <div class="icon" style="background: #e3f2fd;">
          <i class="fas fa-building" style="color: #1e88e5;"></i>
        </div>
        <h3 class="mb-1">{{ total_suppliers }}</h3>
        <p class="text-muted mb-0">Total Suppliers</p>
      </div>
    </div>
    <div class="col-md-3">
      <div class="stats-card">
        <div class="icon" style="background: #e8f5e9;">
          <i class="fas fa-check-circle" style="color: #28a745;"></i>
        </div>
        <h3 class="mb-1">{{ verified_suppliers }}</h3>
        <p class="text-muted mb-0">Verified</p>
      </div>
    </div>
    <div class="col-md-3">
      <div class="stats-card">
        <div class="icon" style="background: #fff7e6;">
          <i class="fas fa-clock" style="color: #ff9800;"></i>
        </div>
        <h3 class="mb-1">{{ pending_suppliers }}</h3>
        <p class="text-muted mb-0">Pending</p>
      </div>
    </div>
    <div class="col-md-3">
      <div class="stats-card">
        <div class="icon" style="background: #ffe8f0;">
          <i class="fas fa-ban" style="color: #e91e63;"></i>
        </div>
        <h3 class="mb-1">{{ inactive_suppliers }}</h3>
        <p class="text-muted mb-0">Inactive</p>
      </div>
    </div>
  </div>

  <!-- Search & Filter Bar -->
  <div class="search-filter-bar">
    <div class="row g-3 align-items-center">
      <div class="col-md-4">
        <div class="input-group">
          <span class="input-group-text border-0 bg-white">
            <i class="fas fa-search text-muted"></i>
          </span>
          <input type="text" class="form-control border-0 bg-white" id="searchInput" placeholder="Search suppliers..." onkeyup="filterTable()">
        </div>
      </div>
      <div class="col-md-3">
        <select class="form-select border-0 bg-white" id="typeFilter" onchange="filterTable()">
          <option value="">All Types</option>
          <option value="Hotel">Hotel</option>
          <option value="Vehicle">Vehicle</option>
          <option value="Activity">Activity</option>
          <option value="Houseboat">Houseboat</option>
          <option value="Special Inclusion">Special Inclusion</option>
          <option value="Other">Other</option>
        </select>
      </div>
      <div class="col-md-2">
        <select class="form-select border-0 bg-white" id="statusFilter" onchange="filterTable()">
          <option value="">All Status</option>
          <option value="verified">Verified</option>
          <option value="pending">Pending</option>
        </select>
      </div>
      <div class="col-md-3 text-end">
        <button class="btn btn-outline-secondary" onclick="resetFilters()">
          <i class="fas fa-redo me-1"></i>Reset Filters
        </button>
      </div>
    </div>
  </div>

  <!-- Modern Table -->
  <div class="modern-table">
    <div class="table-responsive">
      <table class="table table-hover mb-0" id="suppliersTable">
        <thead>
          <tr>
            <th style="width: 60px;"><i class="fas fa-hashtag me-2"></i>#</th>
            <th><i class="fas fa-building me-2"></i>Company</th>
            <th><i class="fas fa-tag me-2"></i>Type</th>
            <th><i class="fas fa-user me-2"></i>Contact</th>
            <th><i class="fas fa-envelope me-2"></i>Email</th>
            <th><i class="fas fa-phone me-2"></i>Mobile</th>
            <th><i class="fas fa-map-marker-alt me-2"></i>City</th>
            <th><i class="fas fa-shield-alt me-2"></i>Status</th>
            {% if user_type == 'superuser' or current_user.role == 'admin' or current_user.permissions.can_edit_supplier %}
            <th class="text-center"><i class="fas fa-cogs me-2"></i>Actions</th>
            {% endif %}
          </tr>
        </thead>
        <tbody>
          {% for supplier in suppliers %}
          <tr data-type="{{ supplier.get_supplier_type_display }}" data-verified="{{ supplier.is_verified|lower }}">
            <!-- Serial Number -->
            <td>
              <span class="serial-number">{{ forloop.counter|add:page_obj.start_index|add:"-1" }}</span>
            </td>
            
            <!-- Company -->
            <td>
              <div class="d-flex align-items-center">
                <div class="avatar-circle me-2" style="background: linear-gradient(135deg,#3b82f6,#6366f1);">
                  {{ supplier.company_name|first|upper }}
                </div>
                <div>
                  <div class="fw-bold">{{ supplier.company_name }}</div>
                  <small class="text-muted">ID: #SUP{{ supplier.id }}</small>
                </div>
              </div>
            </td>
            
            <!-- Type -->
            <td>
              {% if supplier.supplier_type == 'hotel' %}
                <span class="badge-modern" style="background:#e7f2ff;color:#0b5ed7;">
                  <i class="fas fa-hotel me-1"></i>{{ supplier.get_supplier_type_display }}
                </span>
              {% elif supplier.supplier_type == 'vehicle' %}
                <span class="badge-modern" style="background:#e9fbf0;color:#117a37;">
                  <i class="fas fa-car me-1"></i>{{ supplier.get_supplier_type_display }}
                </span>
              {% elif supplier.supplier_type == 'activity' %}
                <span class="badge-modern" style="background:#fff8e6;color:#935116;">
                  <i class="fas fa-ticket-alt me-1"></i>{{ supplier.get_supplier_type_display }}
                </span>
              {% elif supplier.supplier_type == 'houseboat' %}
                <span class="badge-modern" style="background:#e7f8ff;color:#07689f;">
                  <i class="fas fa-ship me-1"></i>{{ supplier.get_supplier_type_display }}
                </span>
              {% elif supplier.supplier_type == 'standalone_inclusion' %}
                <span class="badge-modern" style="background:#f3e8ff;color:#6d28d9;">
                  <i class="fas fa-star me-1"></i>{{ supplier.get_supplier_type_display }}
                </span>
              {% else %}
                <span class="badge-modern" style="background:#f3f4f6;color:#374151;">
                  <i class="fas fa-box me-1"></i>{{ supplier.get_supplier_type_display }}
                </span>
              {% endif %}
            </td>
            
            <!-- Contact -->
            <td>
              <div>{{ supplier.supplier_first_name }} {{ supplier.supplier_last_name }}</div>
            </td>
            
            <!-- Email -->
            <td>
              <a href="mailto:{{ supplier.email }}" class="text-decoration-none text-muted">
                <i class="fas fa-envelope me-1"></i>{{ supplier.email }}
              </a>
            </td>
            
            <!-- Mobile -->
            <td>
              <a href="tel:{{ supplier.mobile_no }}" class="text-decoration-none text-muted">
                <i class="fas fa-phone me-1"></i>{{ supplier.mobile_no }}
              </a>
            </td>
            
            <!-- City -->
            <td>
              <i class="fas fa-map-marker-alt me-1 text-muted"></i>{{ supplier.city }}
            </td>
            
            <!-- Status -->
            <td>
              <div class="d-flex flex-column gap-1">
                {% if supplier.is_verified %}
                  <span class="badge-modern" style="background:#e9fbf0;color:#117a37;">
                    <i class="fas fa-check-circle me-1"></i>Verified
                  </span>
                {% else %}
                  <span class="badge-modern" style="background:#fff8e6;color:#935116;">
                    <i class="fas fa-clock me-1"></i>Pending
                  </span>
                {% endif %}
                
                {% if supplier.is_active %}
                  <span class="badge-modern" style="background:#e9fbf0;color:#117a37;">
                    <i class="fas fa-check me-1"></i>Active
                  </span>
                {% else %}
                  <span class="badge-modern" style="background:#ffe8ea;color:#c53030;">
                    <i class="fas fa-times me-1"></i>Inactive
                  </span>
                {% endif %}
              </div>
            </td>
            
            <!-- Actions -->
            <td>
              <div class="action-btn-group">
                
                {% if user_type == 'superuser' or current_user.role == 'admin' or current_user.permissions.can_edit_supplier %}
                <button type="button" class="btn action-btn" 
                        onclick="editSupplier(this)"
                        data-bs-toggle="modal" 
                        data-bs-target="#supplierModal"
                        data-id="{{ supplier.id }}"
                        data-company-name="{{ supplier.company_name }}"
                        data-supplier-type="{{ supplier.supplier_type }}"
                        data-first-name="{{ supplier.supplier_first_name }}"
                        data-last-name="{{ supplier.supplier_last_name }}"
                        data-email="{{ supplier.email }}"
                        data-mobile-no="{{ supplier.mobile_no }}"
                        data-phone-no="{{ supplier.phone_no|default:'' }}"
                        data-city="{{ supplier.city }}"
                        data-address="{{ supplier.address }}"
                        data-state="{{ supplier.state|default:'' }}"
                        data-postal-code="{{ supplier.postal_code|default:'' }}"
                        data-gst-number="{{ supplier.gst_number|default:'' }}"
                        data-website="{{ supplier.website|default:'' }}"
                        data-description="{{ supplier.description|default:'' }}"
                        data-notes="{{ supplier.notes|default:'' }}"
                        data-is-verified="{{ supplier.is_verified|lower }}"
                        data-is-active="{{ supplier.is_active|lower }}">
                  <i class="fas fa-edit"></i>
                </button>
                {% endif %}

                {% if user_type == 'superuser' or current_user.role == 'admin' or current_user.permissions.can_delete_supplier %}
                <form action="{% url 'delete_supplier' supplier.id %}" method="post" class="d-inline">
                  {% csrf_token %}
                  <button type="submit" class="btn action-btn" 
                          onclick="return confirm('Are you sure you want to delete {{ supplier.company_name }}?')">
                    <i class="fas fa-trash"></i>
                  </button>
                </form>
                {% endif %}

              </div>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="9" class="text-center py-5">
              <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
              <h5 class="text-muted">No suppliers found</h5>
              <p class="text-muted">Start by adding your first supplier</p>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Pagination Section -->
  {% if page_obj.has_other_pages %}
  <div class="pagination-container" id="paginationContainer">
    <nav aria-label="Page navigation">
      <ul class="pagination-modern">
        
        <!-- First Page -->
        {% if page_obj.has_previous %}
        <li class="page-item-modern">
          <a href="?page=1" class="page-link-modern" title="First Page">
            <i class="fas fa-angle-double-left"></i>
          </a>
        </li>
        {% endif %}
        
        <!-- Previous -->
        {% if page_obj.has_previous %}
        <li class="page-item-modern">
          <a href="?page={{ page_obj.previous_page_number }}" class="page-link-modern" title="Previous">
            <i class="fas fa-angle-left"></i>
            <span>Previous</span>
          </a>
        </li>
        {% else %}
        <li class="page-item-modern disabled">
          <span class="page-link-modern">
            <i class="fas fa-angle-left"></i>
            <span>Previous</span>
          </span>
        </li>
        {% endif %}
        
        <!-- Page Numbers -->
        {% for num in page_obj.paginator.page_range %}
          {% if page_obj.number == num %}
            <li class="page-item-modern active">
              <span class="page-link-modern">{{ num }}</span>
            </li>
          {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
            <li class="page-item-modern">
              <a href="?page={{ num }}" class="page-link-modern">{{ num }}</a>
            </li>
          {% elif num == 1 or num == page_obj.paginator.num_pages %}
            <li class="page-item-modern">
              <a href="?page={{ num }}" class="page-link-modern">{{ num }}</a>
            </li>
          {% elif num == page_obj.number|add:'-3' or num == page_obj.number|add:'3' %}
            <li class="page-item-modern disabled">
              <span class="pagination-ellipsis">...</span>
            </li>
          {% endif %}
        {% endfor %}
        
        <!-- Next -->
        {% if page_obj.has_next %}
        <li class="page-item-modern">
          <a href="?page={{ page_obj.next_page_number }}" class="page-link-modern" title="Next">
            <span>Next</span>
            <i class="fas fa-angle-right"></i>
          </a>
        </li>
        {% else %}
        <li class="page-item-modern disabled">
          <span class="page-link-modern">
            <span>Next</span>
            <i class="fas fa-angle-right"></i>
          </span>
        </li>
        {% endif %}
        
        <!-- Last Page -->
        {% if page_obj.has_next %}
        <li class="page-item-modern">
          <a href="?page={{ page_obj.paginator.num_pages }}" class="page-link-modern" title="Last Page">
            <i class="fas fa-angle-double-right"></i>
          </a>
        </li>
        {% endif %}
        
      </ul>
      
      <!-- Page Info -->
      <div class="page-info">
        <span class="badge" style="background:var(--card);border:1px solid var(--border);padding:.45rem .75rem;border-radius:8px;">
          <i class="fas fa-file-alt me-1"></i>
          Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
        </span>
        <span class="text-muted">
          <i class="fas fa-truck me-1"></i>
          {{ page_obj.paginator.count }} total supplier{{ page_obj.paginator.count|pluralize }}
        </span>
      </div>
    </nav>
  </div>
  {% endif %}

</div>

<div class="modal fade" id="supplierModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header modal-header-gradient">
        <h5 class="modal-title" id="supplierModalLabel">
          <i class="fas fa-building me-2"></i>Add New Supplier
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      
      <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
        <form method="POST" id="supplierForm" action="{% url 'add_supplier' %}">
          {% csrf_token %}
          
          <h6 class="form-section-title">
            <i class="fas fa-info-circle me-2"></i>Basic Information
          </h6>
          <div class="row mb-4">
            <div class="col-md-6 mb-3">
              <label class="form-label fw-bold">Company Name *</label>
              <input type="text" class="form-control {% if form.company_name.errors %}is-invalid{% endif %}" 
                     id="company_name" name="company_name" 
                     value="{{ form.company_name.value|default:'' }}" required autocomplete="off">
              {% if form.company_name.errors %}
                  <div class="invalid-feedback">{{ form.company_name.errors.0 }}</div>
              {% endif %}
            </div>

            <div class="col-md-6 mb-3">
              <label class="form-label fw-bold">Type *</label>
              <select class="form-select {% if form.supplier_type.errors %}is-invalid{% endif %}" 
                      id="supplier_type" name="supplier_type" required autocomplete="off">
                <option value="">Select Type</option>
                <option value="hotel" {% if form.supplier_type.value == 'hotel' %}selected{% endif %}>üè® Hotel</option>
                <option value="vehicle" {% if form.supplier_type.value == 'vehicle' %}selected{% endif %}>üöó Vehicle</option>
                <option value="activity" {% if form.supplier_type.value == 'activity' %}selected{% endif %}>üéØ Activity</option>
                <option value="houseboat" {% if form.supplier_type.value == 'houseboat' %}selected{% endif %}>üö§ Houseboat</option>
                <option value="standalone_inclusion" {% if form.supplier_type.value == 'standalone_inclusion' %}selected{% endif %}>‚≠ê Special Inclusion</option>
                <option value="other" {% if form.supplier_type.value == 'other' %}selected{% endif %}>üì¶ Other</option>
              </select>
              {% if form.supplier_type.errors %}
                  <div class="invalid-feedback">{{ form.supplier_type.errors.0 }}</div>
              {% endif %}
            </div>

            <div class="col-12">
              <label class="form-label fw-bold">Description</label>
              <textarea class="form-control" id="description" name="description" rows="3" autocomplete="off">{{ form.description.value|default:'' }}</textarea>
            </div>
          </div>

          <h6 class="form-section-title">
            <i class="fas fa-user me-2"></i>Contact Person
          </h6>
          <div class="row mb-4">
            <div class="col-md-6 mb-3">
              <label class="form-label fw-bold">First Name *</label>
              <input type="text" class="form-control {% if form.supplier_first_name.errors %}is-invalid{% endif %}" 
                     id="supplier_first_name" name="supplier_first_name" 
                     value="{{ form.supplier_first_name.value|default:'' }}" required autocomplete="off">
              {% if form.supplier_first_name.errors %}
                  <div class="invalid-feedback">{{ form.supplier_first_name.errors.0 }}</div>
              {% endif %}
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label fw-bold">Last Name *</label>
              <input type="text" class="form-control {% if form.supplier_last_name.errors %}is-invalid{% endif %}" 
                     id="supplier_last_name" name="supplier_last_name" 
                     value="{{ form.supplier_last_name.value|default:'' }}" required autocomplete="off">
              {% if form.supplier_last_name.errors %}
                  <div class="invalid-feedback">{{ form.supplier_last_name.errors.0 }}</div>
              {% endif %}
            </div>
          </div>

          <h6 class="form-section-title">
            <i class="fas fa-phone me-2"></i>Contact Details
          </h6>
          <div class="row mb-4">
            <div class="col-md-6 mb-3">
              <label class="form-label fw-bold">Email *</label>
              <input type="email" class="form-control {% if form.email.errors %}is-invalid{% endif %}" 
                     id="email" name="email" 
                     value="{{ form.email.value|default:'' }}" required autocomplete="off">
              {% if form.email.errors %}
                  <div class="invalid-feedback">{{ form.email.errors.0 }}</div>
              {% endif %}
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label fw-bold">Mobile *</label>
              <input type="text" class="form-control {% if form.mobile_no.errors %}is-invalid{% endif %}" 
                     id="mobile_no" name="mobile_no" 
                     value="{{ form.mobile_no.value|default:'' }}" required autocomplete="off">
              {% if form.mobile_no.errors %}
                  <div class="invalid-feedback">{{ form.mobile_no.errors.0 }}</div>
              {% endif %}
            </div>
            <div class="col-md-6">
              <label class="form-label fw-bold">Alternate Phone</label>
              <input type="text" class="form-control" id="phone_no" name="phone_no" 
                     value="{{ form.phone_no.value|default:'' }}" autocomplete="off">
            </div>
            <div class="col-md-6">
              <label class="form-label fw-bold">City *</label>
              <input type="text" class="form-control {% if form.city.errors %}is-invalid{% endif %}" 
                     id="city" name="city" 
                     value="{{ form.city.value|default:'' }}" required autocomplete="off">
              {% if form.city.errors %}
                  <div class="invalid-feedback">{{ form.city.errors.0 }}</div>
              {% endif %}
            </div>
          </div>

          <h6 class="form-section-title">
            <i class="fas fa-map-marker-alt me-2"></i>Address
          </h6>
          <div class="row mb-4">
            <div class="col-12 mb-3">
              <label class="form-label fw-bold">Address *</label>
              <textarea class="form-control {% if form.address.errors %}is-invalid{% endif %}" 
                        id="address" name="address" rows="2" required autocomplete="off">{{ form.address.value|default:'' }}</textarea>
              {% if form.address.errors %}
                  <div class="invalid-feedback">{{ form.address.errors.0 }}</div>
              {% endif %}
            </div>
            <div class="col-md-6">
              <label class="form-label fw-bold">State</label>
              <input type="text" class="form-control" id="state" name="state" 
                     value="{{ form.state.value|default:'' }}" autocomplete="off">
            </div>
            <div class="col-md-6">
              <label class="form-label fw-bold">Postal Code</label>
              <input type="text" class="form-control" id="postal_code" name="postal_code" 
                     value="{{ form.postal_code.value|default:'' }}" autocomplete="off">
            </div>
          </div>

          <h6 class="form-section-title">
            <i class="fas fa-briefcase me-2"></i>Business Information
          </h6>
          <div class="row mb-4">
            <div class="col-md-6 mb-3">
              <label class="form-label fw-bold">GST Number</label>
              <input type="text" class="form-control {% if form.gst_number.errors %}is-invalid{% endif %}" 
                     id="gst_number" name="gst_number" 
                     value="{{ form.gst_number.value|default:'' }}" autocomplete="off">
              {% if form.gst_number.errors %}
                  <div class="invalid-feedback">{{ form.gst_number.errors.0 }}</div>
              {% endif %}
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label fw-bold">Website</label>
              <input type="url" class="form-control" id="website" name="website" 
                     value="{{ form.website.value|default:'' }}" autocomplete="off">
            </div>
            <div class="col-12">
              <label class="form-label fw-bold">Notes</label>
              <textarea class="form-control" id="notes" name="notes" rows="2" autocomplete="off">{{ form.notes.value|default:'' }}</textarea>
            </div>
          </div>

          <h6 class="form-section-title">
            <i class="fas fa-toggle-on me-2"></i>Status
          </h6>
          <div class="row">
            <div class="col-md-6">
              <div class="form-check form-switch">
                <input type="checkbox" class="form-check-input" id="is_active" name="is_active" 
                       {% if not form.is_bound or form.is_active.value %}checked{% endif %} 
                       style="width: 48px; height: 24px; cursor: pointer;">
                <label class="form-check-label ms-2" for="is_active">Active</label>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-check form-switch">
                <input type="checkbox" class="form-check-input" id="is_verified" name="is_verified" 
                       {% if form.is_verified.value %}checked{% endif %} 
                       style="width: 48px; height: 24px; cursor: pointer;">
                <label class="form-check-label ms-2" for="is_verified">Verified</label>
              </div>
            </div>
          </div>
        </form>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="fas fa-times me-1"></i>Close
        </button>
        <button type="submit" onclick="submitSupplierForm()" class="btn btn-success">
          <i class="fas fa-save me-1"></i>Save Supplier
        </button>
      </div>
    </div>
  </div>
</div>

<!-- JavaScript -->
<script>
/* Reset form and modal title to "Add" state */
function resetSupplierForm() {
  const form = document.getElementById('supplierForm');
  if (!form) return;
  form.reset();
  form.action = "{% url 'add_supplier' %}";
  const label = document.getElementById('supplierModalLabel');
  if (label) label.innerHTML = '<i class="fas fa-building me-2"></i>Add New Supplier';
  const active = document.getElementById('is_active');
  const verified = document.getElementById('is_verified');
  if (active) active.checked = true;
  if (verified) verified.checked = false;
}

/* Populate form for editing */
function editSupplier(button) {
  if (!button) return;
  const form = document.getElementById('supplierForm');
  if (!form) return;

  const supplierId = button.getAttribute('data-id');
  form.action = "{% url 'edit_supplier' 0 %}".replace('/0/', `/${supplierId}/`);

  const label = document.getElementById('supplierModalLabel');
  if (label) label.innerHTML = '<i class="fas fa-edit me-2"></i>Edit Supplier';

  // Mapping of field-id to data attribute name
  const mapping = {
    'company_name': 'data-company-name',
    'supplier_type': 'data-supplier-type',
    'supplier_first_name': 'data-first-name',
    'supplier_last_name': 'data-last-name',
    'email': 'data-email',
    'mobile_no': 'data-mobile-no',
    'phone_no': 'data-phone-no',
    'city': 'data-city',
    'address': 'data-address',
    'state': 'data-state',
    'postal_code': 'data-postal-code',
    'gst_number': 'data-gst-number',
    'website': 'data-website',
    'description': 'data-description',
    'notes': 'data-notes'
  };

  Object.keys(mapping).forEach(id => {
    const attr = mapping[id];
    const el = document.getElementById(id);
    if (!el) return;
    const val = button.getAttribute(attr) || '';
    el.value = val;
  });

  const isActive = document.getElementById('is_active');
  const isVerified = document.getElementById('is_verified');
  if (isActive) isActive.checked = (button.getAttribute('data-is-active') === 'true');
  if (isVerified) isVerified.checked = (button.getAttribute('data-is-verified') === 'true');
}

/* Submit form with HTML5 validation check */
function submitSupplierForm() {
  const form = document.getElementById('supplierForm');
  if (!form) return false;
  if (!form.checkValidity()) {
    form.reportValidity();
    return false;
  }
  form.submit();
  return false;
}

/* Filter Table with Pagination Hide */
function filterTable() {
  const searchValue = (document.getElementById('searchInput')?.value || '').toLowerCase().trim();
  const typeFilter = (document.getElementById('typeFilter')?.value || '').toLowerCase().trim();
  const statusFilter = (document.getElementById('statusFilter')?.value || '').toLowerCase().trim();

  const table = document.getElementById('suppliersTable');
  if (!table) return;
  const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');

  let visibleCount = 0;
  for (let i = 0; i < rows.length; i++) {
    const row = rows[i];
    const text = (row.textContent || '').toLowerCase();
    const type = (row.getAttribute('data-type') || '').toLowerCase();
    const verified = (row.getAttribute('data-verified') || '').toLowerCase();

    let showRow = true;

    if (searchValue && !text.includes(searchValue)) showRow = false;
    if (typeFilter && !type.includes(typeFilter)) showRow = false;
    if (statusFilter === 'verified' && verified !== 'true') showRow = false;
    if (statusFilter === 'pending' && verified === 'true') showRow = false;

    row.style.display = showRow ? '' : 'none';
    if (showRow) visibleCount++;
  }

  // Hide pagination when filtering
  const paginationContainer = document.getElementById('paginationContainer');
  if (paginationContainer) {
    const anyFilter = searchValue || typeFilter || statusFilter;
    paginationContainer.style.display = anyFilter ? 'none' : 'block';
  }
}

/* Reset filters to default */
function resetFilters() {
  if (document.getElementById('searchInput')) document.getElementById('searchInput').value = '';
  if (document.getElementById('typeFilter')) document.getElementById('typeFilter').value = '';
  if (document.getElementById('statusFilter')) document.getElementById('statusFilter').value = '';
  filterTable();
}

</script>

<script>
document.addEventListener("DOMContentLoaded", function() {
    // If the server sent the show_modal flag, trigger the modal
    {% if show_modal %}
        var supplierModal = new bootstrap.Modal(document.getElementById('supplierModal'));
        
        {% if modal_type == 'edit' %}
            // If it was an edit attempt, ensure the title says Edit
            document.getElementById('supplierModalLabel').innerHTML = '<i class="fas fa-edit me-2"></i>Edit Supplier';
            document.getElementById('supplierForm').action = "{% url 'edit_supplier' edit_id %}";
        {% endif %}
        
        supplierModal.show();
    {% endif %}
});
</script>

{% endblock %}
