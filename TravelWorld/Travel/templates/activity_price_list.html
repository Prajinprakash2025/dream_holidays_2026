{% extends 'base.html' %}
{% load static %}

{% block content %}

<style>
    /* ... (Your existing CSS) ... */
    :root {
        --primary-color: #667eea;
        --primary-hover: #5568d3;
        --danger-color: #ef4444;
        --gray-50: #f9fafb;
        --gray-100: #f3f4f6;
        --gray-200: #e5e7eb;
        --gray-700: #374151;
        --gray-900: #111827;
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }
    
    .page-header {
        background: linear-gradient(135deg, var(--primary-color) 0%, #764ba2 100%);
        color: white;
        padding: 2rem;
        border-radius: 12px;
        margin-bottom: 2rem;
        box-shadow: var(--shadow-lg);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    /* Fix modal z-index if needed */
    .modal-backdrop { z-index: 1040; }
    .modal { z-index: 1050; }
</style>

<div class="container-fluid px-4 py-4">
    
    <!--{% if messages %}-->
    <!--    {% for message in messages %}-->
    <!--        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">-->
    <!--            {{ message }}-->
    <!--            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>-->
    <!--        </div>-->
    <!--    {% endfor %}-->
    <!--{% endif %}-->

    <a href="{% url 'activity_list' %}" class="back-btn-modern">
        <i class="fas fa-arrow-left"></i> Back to Activities
    </a>

    <div class="page-header">
        <div class="header-content">
            <h2>Activity Pricing Manager</h2>
            <div class="subtitle">
                <i class="fas fa-hiking"></i> {{ activity.name }}
            </div>
        </div>
        <button type="button" class="btn-header-action" onclick="openAddModal()">
            <i class="fas fa-plus-circle"></i> Add New Price
        </button>
    </div>

    <div class="table-card">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th width="25%"><i class="far fa-calendar-alt"></i> From Date</th>
                        <th width="25%"><i class="far fa-calendar-check"></i> To Date</th>
                        <th width="25%"><i class="fas fa-tag"></i> Price (Per Person)</th>
                        <th width="25%">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for price in prices %}
                    <tr>
                        <td>{{ price.from_date|date:"d M, Y" }}</td>
                        <td>{{ price.to_date|date:"d M, Y" }}</td>
                        <td>
                            <span class="price-tag">₹{{ price.per_person|floatformat:2 }}</span>
                        </td>
                        <td>
                            <div class="action-icons">
                                <button type="button" 
                                        class="btn-icon btn-edit" 
                                        title="Edit"
                                        onclick="openEditModal(
                                            '{% url 'edit_activity_price' price.id %}', 
                                            '{{ price.from_date|date:'Y-m-d' }}', 
                                            '{{ price.to_date|date:'Y-m-d' }}', 
                                            '{{ price.per_person }}'
                                        )">
                                    <i class="fas fa-pencil-alt"></i>
                                </button>

                                <form action="{% url 'delete_activity_price' price.id %}" method="POST" class="d-inline" onsubmit="return confirm('Are you sure you want to delete this price?');">
                                    {% csrf_token %}
                                    <button type="submit" class="btn-icon btn-delete" title="Delete">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="4">
                            <div class="empty-state">
                                <i class="fas fa-receipt"></i>
                                <h5>No prices found</h5>
                                <p>Click the "Add New Price" button to set up rates for this activity.</p>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="priceModal" tabindex="-1" aria-labelledby="priceModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-light">
        <h5 class="modal-title" id="priceModalLabel">Add New Price</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      
      <form id="priceForm" method="POST" action="">
        {% csrf_token %}
        <div class="modal-body p-4">
            
            {% if form.non_field_errors %}
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i>
                    {% for error in form.non_field_errors %}
                        {{ error }}
                    {% endfor %}
                </div>
            {% endif %}

            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label fw-bold small text-muted">From Date</label>
                    <input type="date" name="from_date" id="id_from_date" class="form-control" 
                           value="{{ form.from_date.value|default:'' }}" required>
                    
                    {% if form.from_date.errors %}
                        <div class="text-danger small mt-1">
                            <i class="fas fa-exclamation-circle"></i> {{ form.from_date.errors.0 }}
                        </div>
                    {% endif %}
                </div>

                <div class="col-md-6">
                    <label class="form-label fw-bold small text-muted">To Date</label>
                    <input type="date" name="to_date" id="id_to_date" class="form-control" 
                           value="{{ form.to_date.value|default:'' }}" required>
                    
                    {% if form.to_date.errors %}
                        <div class="text-danger small mt-1">
                            <i class="fas fa-exclamation-circle"></i> {{ form.to_date.errors.0 }}
                        </div>
                    {% endif %}
                </div>

                <div class="col-12">
                    <label class="form-label fw-bold small text-muted">Price Per Person (₹)</label>
                    <input type="number" step="0.01" name="per_person" id="id_per_person" class="form-control" 
                           placeholder="0.00" value="{{ form.per_person.value|default:'' }}" required>
                    
                    {% if form.per_person.errors %}
                        <div class="text-danger small mt-1">
                            <i class="fas fa-exclamation-circle"></i> {{ form.per_person.errors.0 }}
                        </div>
                    {% endif %}
                </div>
            </div>

        </div>
        <div class="modal-footer border-0 pt-0 pb-4 pe-4">
            <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary px-4" id="modalSubmitBtn">Save Price</button>
        </div>
      </form>

    </div>
  </div>
</div>

<script>
    // 1. ADD URL IS EMPTY (Submits to current page)
    const addUrl = ""; 

    // Initialize Bootstrap modal
    let priceModal;
    document.addEventListener('DOMContentLoaded', function() {
        var modalEl = document.getElementById('priceModal');
        priceModal = new bootstrap.Modal(modalEl);

        // --- KEY LOGIC: If Django returned form errors, open modal immediately ---
        // This makes the modal pop up with the red error text visible
        {% if form.errors %}
            openAddModal();
        {% endif %}
    });

    function openAddModal() {
        document.getElementById('priceModalLabel').innerText = "Add New Price";
        document.getElementById('modalSubmitBtn').innerText = "Save Price";

        // Only clear fields if there are NO errors. 
        // If there ARE errors, we want to keep the user's input.
        {% if not form.errors %}
            document.getElementById('id_from_date').value = "";
            document.getElementById('id_to_date').value = "";
            document.getElementById('id_per_person').value = "";
        {% endif %}

        document.getElementById('priceForm').action = addUrl;
        priceModal.show();
    }

    function openEditModal(editUrl, fromDate, toDate, price) {
        document.getElementById('priceModalLabel').innerText = "Update Price";
        document.getElementById('modalSubmitBtn').innerText = "Update";

        document.getElementById('id_from_date').value = fromDate;
        document.getElementById('id_to_date').value = toDate;
        document.getElementById('id_per_person').value = price;

        document.getElementById('priceForm').action = editUrl;
        priceModal.show();
    }
</script>

{% endblock %}