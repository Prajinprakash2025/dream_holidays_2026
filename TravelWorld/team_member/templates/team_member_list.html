{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container mt-4">

    <!-- Page title + Add button -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3>Team Members</h3>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addTeamModal">
            ➕ Add Member
        </button>
    </div>

    <!-- Messages -->
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        {% endfor %}
    {% endif %}

    <!-- Team Members Table -->
    <div class="table-responsive">
        <table class="table table-striped table-hover align-middle">
            <thead class="table-dark">
                <tr>
                    <th>#</th>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Phone</th>
                    <th>Role</th>
                    <th>Status</th>
                    <th class="text-center">Actions</th>
                </tr>
            </thead>

            <tbody>
            {% for member in team_members %}
                <tr>
                    <td>{{ forloop.counter }}</td>
                    <td>{{ member.get_full_name }}</td>
                    <td>{{ member.email }}</td>
                    <td>{{ member.phone_number }}</td>
                    <td>{{ member.get_role_display }}</td>
                    <td>
                        {% if member.is_active %}
                            <span class="badge bg-success">Active</span>
                        {% else %}
                            <span class="badge bg-danger">Inactive</span>
                        {% endif %}
                    </td>

                    <td class="text-center">

                        <!-- Edit Button with data attributes -->
                        <button class="btn btn-sm btn-warning"
                                data-id="{{ member.id }}"
                                data-first="{{ member.first_name }}"
                                data-last="{{ member.last_name }}"
                                data-email="{{ member.email }}"
                                data-phone="{{ member.phone_number }}"
                                data-role="{{ member.role }}"
                                data-active="{{ member.is_active }}"
                                onclick="openEditModal(this)">
                            ✏ Edit
                        </button>

                        <!-- Delete Form -->
                        <form method="POST"
                              action="{% url 'team_member:delete_team_member' member.id %}"
                              class="d-inline">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-sm btn-danger"
                                    onclick="return confirm('Are you sure?')">
                                ❌ Delete
                            </button>
                        </form>

                    </td>
                </tr>
            {% empty %}
                <tr><td colspan="7" class="text-center text-muted">No Team Members Found</td></tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>


<!-- ADD Modal -->
<div class="modal fade" id="addTeamModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
        <div class="modal-header">
            <h5>Add Team Member</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <form method="POST" action="{% url 'team_member:add_team_member' %}">
            {% csrf_token %}
            <div class="modal-body">
                {{ form.as_p }}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-primary">Save</button>
            </div>
        </form>
    </div>
  </div>
</div>


<!-- EDIT Modal -->
<div class="modal fade" id="editTeamModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
        <form method="POST" id="editTeamForm">
            {% csrf_token %}

            <div class="modal-header">
                <h5>Edit Team Member</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <input name="first_name" id="editFirst" class="form-control mb-2" type="text" required>
                <input name="last_name" id="editLast" class="form-control mb-2" type="text" required>
                <input name="email" id="editEmail" class="form-control mb-2" type="email" required>
                <input name="phone_number" id="editPhone" class="form-control mb-2" type="text">

                <select name="role" id="editRole" class="form-select mb-2">
                    <option value="ADMIN">Admin</option>
                    <option value="STAFF">Staff</option>
                </select>

                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="editActive" name="is_active">
                    <label class="form-check-label">Active</label>
                </div>

                <input name="password" class="form-control" type="password" placeholder="New Password (optional)">
                <small class="text-muted">Leave blank to keep the current password</small>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
                <button type="submit" class="btn btn-success">Update</button>
            </div>

        </form>
    </div>
  </div>
</div>


<script>
function openEditModal(button) {
    const data = button.dataset;

    document.getElementById('editFirst').value = data.first;
    document.getElementById('editLast').value = data.last;
    document.getElementById('editEmail').value = data.email;
    document.getElementById('editPhone').value = data.phone;
    document.getElementById('editRole').value = data.role;
    document.getElementById('editActive').checked = (data.active === 'True');

    // Set correct Django URL
    document.getElementById('editTeamForm').action =
        `/team-members/${data.id}/edit/`;

    const modal = new bootstrap.Modal(document.getElementById('editTeamModal'));
    modal.show();
}
</script>

{% endblock %}
